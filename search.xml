<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Concepts, Properties, and Usage of Homogeneous Coordinates</title>
    <url>/2019/12/02/Concepts-Usage-and-Advantages-of-Homogeneous-Coordinates/</url>
    <content><![CDATA[<html><head></head><body><p>In mathematics history, homogeneous coordinates or projective coordinates were first introduced by August Ferdinand Möbius in 1827. They are a common system of coordinates used in projective geometry, as Cartesian coordinates are used in Euclidean geometry. Nowadays, with the development of computer vision and computer graphics, projective geometry is widely used, and homogeneous coordinates is widely used in many algorithms. In this article, I will present you a brief introduction of homogeneous coordinates about its definitions, properties, usages, and advantages.</p>
<span id="more"></span>
<h2 id="Motivation"><a href="#Motivation" class="headerlink" title="Motivation"></a>Motivation</h2><p>In projective geometry, a 3D Euclidean coordinates space can be projected into a 2D projective coordinates space. This is what happens when we take a photo using a RGB camera. The projection is a kind of space compression or transformation that compresses a geometry structure in 3D space alongside the projective direction into a 2D space. For example, all the points in a line in 3D Euclidean geometry can be projected to a single point in projective geometry if the projective direction is alongside the line. In the scenario, using 2D Euclidean coordinates to express the point in projective geometry is not appropriate. Because we can not tell whether it is a 2D point or 3D line, it will confusing us. Homogeneous coordinates were proposed to effectively address this issue.</p>
<p>For a finite 2D point $$P = {\left[ {\begin{array}{<em>{20}{c}}x&amp;y\end{array}} \right]^T}$$ in projective geometry, there must exist an infinite set of 3D points in Euclidean geometry that can project at the point $$P$$. To be exact, all the 3D points in the line parallel to the projective direction and passing through the projected 2D point satisfy the above condition. Therefore, if we use a 2D coordinate $${\left[ {\begin{array}{</em>{20}{c}}x&amp;y\end{array}} \right]^T}$$ to represent a infinite set of 3D points, the information of the third dimension is compressed alongside the projection direction. From the point view of mathematics, 2D coordinates is not a suitable tool to describe the projection of 3D points in projection geometry. However, if we add an extra dimension to $$P$$, then no information is lost during projection. Maybe, this is the main motivation of homogeneous coordinates.</p>
<h2 id="Definition"><a href="#Definition" class="headerlink" title="Definition"></a>Definition</h2><p>For a finite 2D point $$P = {\left[ {\begin{array}{<em>{20}{c}}X&amp;Y\end{array}} \right]^T}$$, its homogeneous coordinates is defined as $${\left[ {\begin{array}{</em>{20}{c}}{x}&amp;{y}&amp;{w}\end{array}} \right]^T}$$ that satisfies Eq. $\eqref{eq1}$ for any $$w \ne 0$$. Since $$w$$ could be any none zero value in real space $$R$$, homogeneous coordinates keeps all the 3D information in Cartesian coordinates and can be used to describe the 3D-2D projection.<br>$$\begin{equation}<br>\left{ {\begin{array}{<em>{20}{c}}<br>{X = \frac{x}{w}}\<br>{Y = \frac{y}{w}}<br>\end{array}} \right.<br>\end{equation}\label{eq1}$$<br>According to the definition of homogeneous coordinates, we can get the homogeneous coordinates of a point $$P={\left[ {\begin{array}{</em>{20}{c}}X&amp;Y\end{array}} \right]^T}$$ in projective geometry, as shown in Eq. $\eqref{eq2}$.<br>$$\begin{equation}<br>{\left[ {\begin{array}{<em>{20}{c}}X&amp;Y\end{array}} \right]^T} \mapsto {w}\left[ {\begin{array}{</em>{20}{c}}<br>{X}&amp;{Y}&amp;1<br>\end{array}} \right]^T<br>\end{equation}\label{eq2}$$<br>Similarly, we can derive the definition of homogeneous coordinates of a 3D point in projective geometry as Eq. $\eqref{eq3}$.<br>$$\begin{equation}<br>{\left[ {\begin{array}{<em>{20}{c}}X&amp;Y&amp;Z\end{array}} \right]^T} \mapsto {w}\left[ {\begin{array}{</em>{20}{c}}<br>{X}&amp;{Y}&amp;{Z}&amp;1<br>\end{array}} \right]^T<br>\end{equation}\label{eq3}$$</p>
<h2 id="Properties-and-Usage"><a href="#Properties-and-Usage" class="headerlink" title="Properties and Usage"></a>Properties and Usage</h2><h3 id="Scale-takes-no-effect-in-homogeneous-coordinates"><a href="#Scale-takes-no-effect-in-homogeneous-coordinates" class="headerlink" title="Scale takes no effect in homogeneous coordinates"></a>Scale takes no effect in homogeneous coordinates</h3><p>According to Eq. $\eqref{eq2}$, for a homogeneous coordinates $${w}\left[ {\begin{array}{<em>{20}{c}}{X}&amp;{Y}&amp;1\end{array}} \right]$$ when the $$w$$ changes its value, the corresponding Cartesian coordinates keeps constant $${\left[ {\begin{array}{</em>{20}{c}}X&amp;Y\end{array}} \right]^T}$$. That is to say, scale takes no effects in homogeneous coordinates. For simplicity, we can set $$w = 1$$ and ignore it in the mathematical expression. Equation $\eqref{eq2}$ can be formulated as Eq. $\eqref{eq4}$.<br>$$\begin{equation}<br>{\left[ {\begin{array}{<em>{20}{c}}X&amp;Y\end{array}} \right]^T} \mapsto \left[ {\begin{array}{</em>{20}{c}}<br>{X}&amp;{Y}&amp;1<br>\end{array}} \right]^T<br>\end{equation}\label{eq4}$$<br>Equation $\eqref{eq3}$ can be formulated as Eq. $\eqref{eq5}$.<br>$$\begin{equation}<br>{\left[ {\begin{array}{<em>{20}{c}}X&amp;Y&amp;Z\end{array}} \right]^T} \mapsto \left[ {\begin{array}{</em>{20}{c}}<br>{X}&amp;{Y}&amp;{Z}&amp;1<br>\end{array}} \right]^T<br>\end{equation}\label{eq5}$$</p>
<h3 id="Express-infinite-point-without-using-infty"><a href="#Express-infinite-point-without-using-infty" class="headerlink" title="Express infinite point without using $$\infty$$"></a>Express infinite point without using $$\infty$$</h3><p>In Cartesian coordinates, we use $$\infty$$ to express a real value at infinity and use $${\left[ {\begin{array}{<em>{20}{c}}\infty&amp;\infty\end{array}} \right]^T}$$ to express a real 2D point at infinity. According to Eq. $\eqref{eq1}$, when $$w = 0$$, $$X$$ becomes $$\infty$$ and $$Y$$ also becomes $$\infty$$. That is to say, we can use $${\left[ {\begin{array}{</em>{20}{c}}{x}&amp;{y}&amp;{0}\end{array}} \right]^T}$$ to express a point at infinity in homogeneous coordinates. Noting that the original definition of homogeneous coordinates is $${\left[ {\begin{array}{*{20}{c}}{x}&amp;{y}&amp;{w}\end{array}} \right]^T}$$.</p>
<p>Once a point reaches infinity, we immediately loss the direction information in Cartesian coordinates. It means that we don’t know from what direction the point reaches infinity. However, the homogeneous coordinates keeps the direction information at infinity because we still know the values of $$x$$ and $$y$$. In my opinion, this is the most magical property of homogeneous coordinates compared to Cartesian coordinates. </p>
<h3 id="A-homogeneous-coordinates-represents-a-line"><a href="#A-homogeneous-coordinates-represents-a-line" class="headerlink" title="A homogeneous coordinates represents a line"></a>A homogeneous coordinates represents a line</h3><p>Besides the magical property at infinity, another property is that a point and a line have a uniform mathematical expression in projective space, which is also different with Cartesian coordinates. An intuitive explanation is that there exists a scalable variable in the definition of homogeneous coordinates, which makes <strong>a homogeneous coordinates have the ability to express a infinite set of points</strong>. The infinite set of points are all in one line. We can easily verify the above property by mathematical derivation. Equation $\eqref{eq6}$ defines a line in 2D space.<br>$$\begin{equation}<br>ax+by+c=0<br>\end{equation}\label{eq6}$$</p>
<p>Define the coefficients of line $\eqref{eq6}$ as $$l = {\left[ {\begin{array}{<em>{20}{c}}a&amp;b&amp;c\end{array}} \right]^T}$$, then we can factorizing Eq. $\eqref{eq6}$ as:<br>$$\begin{equation}<br>{l^T}p = {p^T}l = 0<br>\end{equation}\label{eq7}$$<br>where $$p = {\left[ {\begin{array}{</em>{20}{c}}x&amp;y&amp;1\end{array}} \right]^T}$$ denotes all the points passing through the line defined by $$l$$. Obviously, $$p$$ is similar to the right part of Eq. $\eqref{eq4}$, which is is a homogeneous coordinates. In other words, <strong>a homogeneous coordinates represents a infinite set of points in a line</strong>. Moreover, Eq. $\eqref{eq7}$ shows that the line $$l$$ and the point $$p$$ are in accord with commutative law, which means that <strong>a line and a homogeneous coordinates have uniform mathematical representation</strong>.</p>
<h3 id="Line-can-be-computed-by-the-cross-product-of-homogeneous-coordinates-of-two-different-points-in-it"><a href="#Line-can-be-computed-by-the-cross-product-of-homogeneous-coordinates-of-two-different-points-in-it" class="headerlink" title="Line can be computed by the cross product of homogeneous coordinates of two different points in it"></a>Line can be computed by the cross product of homogeneous coordinates of two different points in it</h3><p>According to the preceding conclusion and Eq. $\eqref{eq2}$, we substitute two points $$p_1 = {\left[ {\begin{array}{<em>{20}{c}}X_1&amp;Y_1&amp;s_1\end{array}} \right]^T}$$ and $$p_2 = {\left[ {\begin{array}{</em>{20}{c}}X_2&amp;Y_2&amp;s_2\end{array}} \right]^T}$$ into Eq. $\eqref{eq7}$ and get Eq. $\eqref{eq8}$.<br>$$\begin{equation}<br>\begin{array}{*{20}{c}}<br>{l^T{p_1} = {p_1}^Tl = 0}\<br>{l^T{p_2} = {p_2}^Tl = 0}<br>\end{array}<br>\end{equation}\label{eq8}$$</p>
<p>We can easily obtain the solution of Eq. $\eqref{eq8}$ by computing the cross product of $$p_1$$ and $$p_2$$. Note that both $$p_1$$ and $$p_2$$ are homogeneous coordinates of different 2D points.<br>$$\begin{equation}<br>l=p_1 \times p_2<br>\end{equation}\label{eq9}$$</p>
<h3 id="Homogeneous-coordinates-of-the-intersection-point-of-two-non-parallel-lines-also-can-be-computed-by-two-line’s-cross-product"><a href="#Homogeneous-coordinates-of-the-intersection-point-of-two-non-parallel-lines-also-can-be-computed-by-two-line’s-cross-product" class="headerlink" title="Homogeneous coordinates of the intersection point of two non-parallel lines also can be computed by two line’s cross product"></a>Homogeneous coordinates of the intersection point of two non-parallel lines also can be computed by two line’s cross product</h3><p>Swap $$l$$ and $$p$$, we can get Eq. $\eqref{eq10}$ from Eq. $\eqref{eq9}$.<br>$$\begin{equation}<br>p=l_1 \times l_2<br>\end{equation}\label{eq10}$$</p>
<p>Note that $$p$$ is the homogeneous coordinates of the intersection point not the Cartesian coordinates.</p>
<h3 id="There-exists-intersection-point-between-parallel-lines"><a href="#There-exists-intersection-point-between-parallel-lines" class="headerlink" title="There exists intersection point between parallel lines"></a>There exists intersection point between parallel lines</h3><p>As far as we know, there is no intersection point for two parallel lines in Cartesian coordinates. However, there exists a intersection point for two parallel lines in projective coordinates. Suppose the two parallel lines are $$l_1 = {\left[ {\begin{array}{<em>{20}{c}}a&amp;b&amp;c_1\end{array}} \right]^T}$$ and $$l_2 = {\left[ {\begin{array}{</em>{20}{c}}a&amp;b&amp;c_2\end{array}} \right]^T}$$, $$c_1 \neq c_2$$, and there exist two points passing through the two parallel lines correspondingly. We define the two points as $$p_1 = {\left[ {\begin{array}{<em>{20}{c}}X_1&amp;Y_1&amp;w_1\end{array}} \right]^T}$$ and $$p_2 = {\left[ {\begin{array}{</em>{20}{c}}X_2&amp;Y_2&amp;w_2\end{array}} \right]^T}$$ according to the original definition of homogeneous coordinates. Then we can get:<br>$$\begin{equation}<br>\begin{array}{*{20}{c}}<br>{a{X_1} + b{Y_1} + {c_1}{w_1} = 0}\<br>{a{X_2} + b{Y_2} + {c_2}{w_2} = 0}<br>\end{array}<br>\end{equation}\label{eq11}$$</p>
<p>If there exist an intersection point between $$l_1$$ and $$l_2$$, it means that $${\left[ {\begin{array}{<em>{20}{c}}X_1&amp;Y_1&amp;w_1\end{array}} \right]^T} = {\left[ {\begin{array}{</em>{20}{c}}X_2&amp;Y_2&amp;w_2\end{array}} \right]^T}$$. Substitute $$w_1=0$$ and $$w_2=0$$ into Eq. $\eqref{eq11}$, and suppose $$X_1 = X_2 =X$$ and $$Y_1 = Y_2 = Y$$, we can get:<br>$$\begin{equation}<br>\begin{array}{*{20}{c}}<br>{a{X} + b{Y} = 0}\<br>{a{X} + b{Y} = 0}<br>\end{array}<br>\end{equation}\label{eq12}$$</p>
<p>The solution of Eq. $\eqref{eq12}$ is $$X = b$$ and $$Y = -a$$, which indicates that $${\left[ {\begin{array}{*{20}{c}}b&amp;{ - a}&amp;0\end{array}} \right]^T}$$ is the solution of Eq. $\eqref{eq11}$. That is to say, two parallel lines have an intersection point in projective coordinates and the intersection point is at infinity. Fig. 1 gives us an intuitive explanation regarding the intersection point of two parallel lines in projective coordinates.<br><img alt="Fig. 1 Railway to infinity" data-src="/2019/12/02/Concepts-Usage-and-Advantages-of-Homogeneous-Coordinates/train.png"></p>
</body></html>]]></content>
      <categories>
        <category>Mathematics</category>
        <category>Projective Geometry</category>
        <category>Computer Vision</category>
      </categories>
      <tags>
        <tag>Maths</tag>
        <tag>Homogeneous</tag>
      </tags>
  </entry>
  <entry>
    <title>Build and Deploy Your Personal Blog Using Hexo, NexT, and GitHub</title>
    <url>/2019/12/01/Build-and-Deploy-Your-Personal-Blog-Using-Hexo-NexT-and-GitHub/</url>
    <content><![CDATA[<html><head></head><body><p>A personal blog is a useful tool that could help us to record and share our ideas, research work, coding experiences, learning notes, and so on. Nowadays, there are many open source frameworks and online platforms that provide blog service, which could help people build and deploy personal blog easily and quickly either free or not. In this article, I will introduce a popular method to build and deploy our personal blog using <a href="https://hexo.io/">Hexo</a>, <a href="https://theme-next.org/">NexT</a>, and <a href="https://github.com/hexojs/hexo">GitHub</a> step by step. If you follow the succeeding instructions step by step, you will build a well-designed personal blog and deploy it on the Internet as well. Let’s start right now. </p>
<span id="more"></span>
<h2 id="Build-Your-Using-Hexo"><a href="#Build-Your-Using-Hexo" class="headerlink" title="Build Your Using Hexo"></a>Build Your Using Hexo</h2><p><a href="https://hexo.io/">Hexo</a> is a fast and powerful static blog generating framework, it is based on <a href="https://nodejs.org/en/">Node.js</a>. By using Hexo, we can write articles easily using with Markdown. Besides the grammer of Markdown, Hexo also provide <a href="https://hexo.io/docs/tag-plugins">tag plugins</a> that we can use to further customize the format of article content. Please visit the <a href="https://hexo.io/">official website</a> for more information.</p>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><p>Installing Hexo is quite easy and only requires the following beforehand:</p>
<ul>
<li><a href="https://nodejs.org/en/">Node.js</a></li>
<li><a href="https://git-scm.com/">Git</a></li>
</ul>
<h4 id="Install-Git"><a href="#Install-Git" class="headerlink" title="Install Git"></a>Install Git</h4><figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> install git-core</span><br><span class="line">git <span class="comment">--version</span></span><br></pre></td></tr></tbody></table></figure>
<p>If the git version is printed, it means that we have installed git successfully. Then we can go to next step.</p>
<h4 id="Install-Node-js"><a href="#Install-Node-js" class="headerlink" title="Install Node.js"></a>Install Node.js</h4><p>Node.js is an asynchronous event-driven JavaScript runtime that can build scalable network applications. We can install it from source.</p>
<figure class="highlight armasm"><table><tbody><tr><td class="code"><pre><span class="line"><span class="symbol">curl</span> -<span class="built_in">sL</span> https:<span class="comment">//deb.nodesource.com/setup_18.x | sudo -E bash -</span></span><br><span class="line"><span class="symbol">sudo</span> apt-<span class="meta">get</span> install -y nodejs</span><br></pre></td></tr></tbody></table></figure>
<p>The above two steps can install nodejs and npm. We can verify the installation by printing the version of nodejs and npm.</p>
<figure class="highlight coffeescript"><table><tbody><tr><td class="code"><pre><span class="line">nodejs -v</span><br><span class="line"><span class="built_in">npm</span> -v</span><br></pre></td></tr></tbody></table></figure>
<p>If you come from China as me, you had better change the package source from the original one to the one maintained by taobao.</p>
<figure class="highlight stata"><table><tbody><tr><td class="code"><pre><span class="line">sudo npm install -<span class="keyword">g</span> nrm</span><br><span class="line">nrm <span class="keyword">ls</span></span><br><span class="line">nrm <span class="keyword">use</span> taobao</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h5><ul>
<li>Error<br>If you use <em>nrm ls</em>, you may get the following error. The main reason of the error is that the nodejs version is too low, thus we just update nodejs to fix this error.<figure class="highlight roboconf"><table><tbody><tr><td class="code"><pre><span class="line">/usr/local/lib/node_modules/nrm/cli.js:138</span><br><span class="line">function config(attrArray, registry, index = 0) {</span><br><span class="line">                                           ^</span><br><span class="line"></span><br><span class="line"><span class="attribute">SyntaxError</span>: Unexpected token =</span><br><span class="line">    at exports<span class="variable">.runInThisContext</span> (vm<span class="variable">.js</span>:53:16)</span><br><span class="line">    at Module<span class="variable">._compile</span> (module<span class="variable">.js</span>:374:25)</span><br><span class="line">    at Object<span class="variable">.Module</span><span class="variable">._extensions</span>.<span class="variable">.js</span> (module<span class="variable">.js</span>:417:10)</span><br><span class="line">    at Module<span class="variable">.load</span> (module<span class="variable">.js</span>:344:32)</span><br><span class="line">    at Function<span class="variable">.Module</span><span class="variable">._load</span> (module<span class="variable">.js</span>:301:12)</span><br><span class="line">    at Function<span class="variable">.Module</span><span class="variable">.runMain</span> (module<span class="variable">.js</span>:442:10)</span><br><span class="line">    at startup (node<span class="variable">.js</span>:136:18)</span><br><span class="line">    at node<span class="variable">.js</span>:966:3</span><br></pre></td></tr></tbody></table></figure></li>
<li>Solution<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo npm cache clean -f</span><br><span class="line">sudo npm install -g n</span><br><span class="line">sudo n stable</span><br><span class="line">sudo ln -sf <span class="regexp">/usr/</span>local<span class="regexp">/n/</span>versions<span class="regexp">/node/</span><span class="number">12.13</span>.<span class="number">1</span><span class="regexp">/bin/</span>node <span class="regexp">/usr/</span>bin/nodejs</span><br><span class="line">node -v</span><br><span class="line">nrm ls</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h5 id="Warnings"><a href="#Warnings" class="headerlink" title="Warnings"></a>Warnings</h5><ul>
<li>deprecated <a href="mailto:fsevents@1.2.9">fsevents@1.2.9</a>: fsevents 1 will break on node v14+ and could be using insecure binaries. Upgrade to fsevents 2.<figure class="highlight coffeescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> upgrade fsevents</span><br></pre></td></tr></tbody></table></figure></li>
<li>Warning: Accessing non-existent property ‘lineno’ of module exports inside circular dependency<figure class="highlight coffeescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> install stylus</span><br><span class="line"><span class="built_in">npm</span> install lineno</span><br><span class="line"><span class="built_in">npm</span> install column</span><br><span class="line"><span class="built_in">npm</span> install filename</span><br><span class="line"><span class="built_in">npm</span> update</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h4 id="Install-Hexo"><a href="#Install-Hexo" class="headerlink" title="Install Hexo"></a>Install Hexo</h4><p>After Git and Node.js are installed, we can install Hexo right now.</p>
<figure class="highlight avrasm"><table><tbody><tr><td class="code"><pre><span class="line">sudo npm install hexo-<span class="keyword">cli</span> -g</span><br><span class="line">hexo -v</span><br></pre></td></tr></tbody></table></figure>
<p>If the Hexo version is printed, it means that we have installed Hexo successfully. Then we can go to next step to build our personal blog.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">hexo</span>-cli: <span class="number">4</span>.<span class="number">3</span>.<span class="number">0</span></span><br><span class="line"><span class="attribute">os</span>: linux <span class="number">4</span>.<span class="number">15</span>.<span class="number">0</span>-<span class="number">200</span>-generic Ubuntu <span class="number">18</span>.<span class="number">04</span>.<span class="number">6</span> LTS (Bionic Beaver)</span><br><span class="line"><span class="attribute">node</span>: <span class="number">14</span>.<span class="number">21</span>.<span class="number">3</span></span><br><span class="line"><span class="attribute">v8</span>: <span class="number">8.4.371.23</span>-node.<span class="number">88</span></span><br><span class="line"><span class="attribute">uv</span>: <span class="number">1</span>.<span class="number">42</span>.<span class="number">0</span></span><br><span class="line"><span class="attribute">zlib</span>: <span class="number">1</span>.<span class="number">2</span>.<span class="number">11</span></span><br><span class="line"><span class="attribute">brotli</span>: <span class="number">1</span>.<span class="number">0</span>.<span class="number">9</span></span><br><span class="line"><span class="attribute">ares</span>: <span class="number">1</span>.<span class="number">18</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">modules</span>: <span class="number">83</span></span><br><span class="line"><span class="attribute">nghttp2</span>: <span class="number">1</span>.<span class="number">42</span>.<span class="number">0</span></span><br><span class="line"><span class="attribute">napi</span>: <span class="number">8</span></span><br><span class="line"><span class="attribute">llhttp</span>: <span class="number">2</span>.<span class="number">1</span>.<span class="number">6</span></span><br><span class="line"><span class="attribute">openssl</span>: <span class="number">1</span>.<span class="number">1</span>.<span class="number">1</span>t</span><br><span class="line"><span class="attribute">cldr</span>: <span class="number">40</span>.<span class="number">0</span></span><br><span class="line"><span class="attribute">icu</span>: <span class="number">70</span>.<span class="number">1</span></span><br><span class="line"><span class="attribute">tz</span>: <span class="number">2022</span>f</span><br><span class="line"><span class="attribute">unicode</span>: <span class="number">14</span>.<span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Building"><a href="#Building" class="headerlink" title="Building"></a>Building</h3><p>Hexo allows us to maintain and write our blog in a directory, thus we first make a directory at any path as we like.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> blog</span><br><span class="line"><span class="built_in">cd</span> blog</span><br></pre></td></tr></tbody></table></figure>
<p>Then we initialize our blog, generate static blog webpage and serve it on our computer locally using just the following three steps.</p>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line">hexo init</span><br><span class="line">hexo <span class="keyword">generate</span></span><br><span class="line">hexo server</span><br></pre></td></tr></tbody></table></figure>
<p>We can visit the blog we built by <a href="http://localhost:4000/">http://localhost:4000</a>.</p>
<h2 id="Customization"><a href="#Customization" class="headerlink" title="Customization"></a>Customization</h2><p>There are many plugins that could help us customize our blog easily, such as automatically build sitemap, rss, generate archives and categories. We install them before we go to further steps.</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line">npm install hexo-generator-<span class="keyword">index</span> <span class="comment">--save</span></span><br><span class="line">npm install hexo-generator-archive <span class="comment">--save</span></span><br><span class="line">npm install hexo-generator-category <span class="comment">--save</span></span><br><span class="line">npm install hexo-generator-tag <span class="comment">--save</span></span><br><span class="line">npm install hexo-<span class="keyword">server</span> <span class="comment">--save</span></span><br><span class="line">npm install hexo-deployer-git <span class="comment">--save</span></span><br><span class="line">npm install hexo-deployer-heroku <span class="comment">--save</span></span><br><span class="line">npm install hexo-deployer-rsync <span class="comment">--save</span></span><br><span class="line">npm install hexo-deployer-openshift <span class="comment">--save</span></span><br><span class="line">npm install hexo-renderer-marked <span class="comment">--save</span></span><br><span class="line">npm install hexo-renderer-stylus <span class="comment">--save</span></span><br><span class="line">npm install hexo-generator-feed <span class="comment">--save</span></span><br><span class="line">npm install hexo-generator-sitemap <span class="comment">--save</span></span><br><span class="line">npm install hexo-wordcount <span class="comment">--save</span></span><br><span class="line">npm install hexo-symbols-count-<span class="type">time</span> <span class="comment">--save</span></span><br><span class="line">npm install hexo-asset-image <span class="comment">--save</span></span><br><span class="line">npm install hexo-leancloud-counter-<span class="keyword">security</span> <span class="comment">--save</span></span><br><span class="line">npm install babel-runtime <span class="comment">--save</span></span><br><span class="line">npm install hexo-renderer-marked <span class="comment">--save</span></span><br><span class="line">npm install hexo-renderer-kramed <span class="comment">--save</span></span><br><span class="line">npm install hexo-generator-searchdb <span class="comment">--save</span></span><br></pre></td></tr></tbody></table></figure>
<p>Hexo provides an uniformed customization interface file named <strong>_config.yml</strong> in the root directory of our blog. We can customize our blog by modifying <strong>_config.yml</strong>. For more information, please visit the official <a href="https://hexo.io/docs/configuration">configuration</a> docs.</p>
<h3 id="Add-Pages"><a href="#Add-Pages" class="headerlink" title="Add Pages"></a>Add Pages</h3><p>When we initialize a hexo project, only the home page and archive page are added by default. It is recommended to add pages, such as tags, categories, and about, which could make the hierarchy of our blog more clear.</p>
<h4 id="Add-tags-Page"><a href="#Add-tags-Page" class="headerlink" title="Add tags Page"></a>Add tags Page</h4><p>We can add tags to every post we write, and the added tags would help us or readers to quickly the posts that having same tags. The tags page will show the results. We can add tags page by creating a new page named tags with page layout.</p>
<figure class="highlight haxe"><table><tbody><tr><td class="code"><pre><span class="line">hexo <span class="keyword">new</span> <span class="type">page</span> tags</span><br></pre></td></tr></tbody></table></figure>
<p>We can specify its type and close comments by revising the <a href="https://hexo.io/docs/front-matter">front-matter</a> in tags.md</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">tags</span></span><br><span class="line"><span class="attr">data:</span> <span class="number">2019-12-02 16:49:04</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">"tags"</span></span><br><span class="line"><span class="attr">comments:</span> <span class="literal">false</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Add-categories-Page"><a href="#Add-categories-Page" class="headerlink" title="Add categories Page"></a>Add categories Page</h4><p>Similar with tags, categories allows us to maintain our posts using categories and we can add categories page using the same method.</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">hexo</span> <span class="string">new</span> <span class="string">page</span> <span class="string">categories</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">categories</span></span><br><span class="line"><span class="attr">data:</span> <span class="number">2019-12-02 16:50:07</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">"categories"</span></span><br><span class="line"><span class="attr">comments:</span> <span class="literal">false</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Add-about-Page"><a href="#Add-about-Page" class="headerlink" title="Add about Page"></a>Add about Page</h4><p>Usually, a well-designed blog has a page to introduce author and the page is called about page.</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">hexo</span> <span class="string">new</span> <span class="string">page</span> <span class="string">about</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">title:</span> <span class="string">about</span></span><br><span class="line"><span class="attr">data:</span> <span class="number">2019-12-02 16:55:02</span></span><br><span class="line"><span class="attr">comments:</span> <span class="literal">false</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Add-Post"><a href="#Add-Post" class="headerlink" title="Add Post"></a>Add Post</h3><p>After finishing the above steps, we can start to write posts.</p>
<h4 id="Create-a-Draft"><a href="#Create-a-Draft" class="headerlink" title="Create a Draft"></a>Create a Draft</h4><p>Drafts are the same as posts. More specifically, drafts are just unpublished posts that we are still working on. Those are just files that contain the article of our future post in the Markdown format.</p>
<figure class="highlight actionscript"><table><tbody><tr><td class="code"><pre><span class="line">hexo <span class="keyword">new</span> <span class="string">"Post Title"</span></span><br></pre></td></tr></tbody></table></figure>
<p>If the draft is finished, we can publish this draft as a post, then readers will see the post on the website.</p>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">hexo</span> publish <span class="string">"Post Title"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Create-a-Post"><a href="#Create-a-Post" class="headerlink" title="Create a Post"></a>Create a Post</h4><p>Besides creating and publishing a draft, we can also create a post directly.</p>
<figure class="highlight haxe"><table><tbody><tr><td class="code"><pre><span class="line">hexo <span class="keyword">new</span> <span class="type">post</span> <span class="string">"Post Title"</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Use-NexT-theme"><a href="#Use-NexT-theme" class="headerlink" title="Use NexT theme"></a>Use NexT theme</h3><p>There are many free themes that help us to customize our blog pages easily and quickly, even without worry about the front-end coding. NexT is a popular theme for hexo, which has beautiful layout. We can download the source code from github and put it in <strong>themes</strong> directory.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/theme-next/</span>hexo-theme-<span class="keyword">next</span> themes/<span class="keyword">next</span></span><br></pre></td></tr></tbody></table></figure>
<p>Then we use NextT theme in our blog by modifying hexo’s <strong>_config.yml</strong>. Assign the theme keyword as next.</p>
<figure class="highlight vbnet"><table><tbody><tr><td class="code"><pre><span class="line"><span class="symbol">theme:</span> <span class="keyword">next</span></span><br></pre></td></tr></tbody></table></figure>
<p>Similar with Hexo, we can further customize the layout in NexT’s <strong>_config.yml</strong>. The <a href="https://theme-next.org/docs/">official docs</a> has detailed information about how to customize the NexT theme.</p>
<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>We must deploy our blog on the Internet, thus others can visit our blog via Internet. GitHub offers a webpage service that we can used to deploy our blog. Thanks to GitHub, we can publish our posts for free. Hexo has a command that we can easily push our blogs to github account.</p>
<h3 id="GitHub-Webpage-Service"><a href="#GitHub-Webpage-Service" class="headerlink" title="GitHub Webpage Service"></a>GitHub Webpage Service</h3><p>The way to use github webpage service is to create a special repository named <strong>accountname.github.io</strong>. For example, if your github account name is JackMa, the repository name must be JackMa.github.io.</p>
<h3 id="Deployment-Configure-for-Hexo"><a href="#Deployment-Configure-for-Hexo" class="headerlink" title="Deployment Configure for Hexo"></a>Deployment Configure for Hexo</h3><p>The configuration interface is in <strong>_config.yml</strong> with <strong>deploy</strong> keyword.</p>
<figure class="highlight dts"><table><tbody><tr><td class="code"><pre><span class="line"><span class="symbol">deploy:</span></span><br><span class="line"><span class="symbol">  type:</span> git</span><br><span class="line"><span class="symbol">  repository:</span> git@github.com:JackMa/JackMa.github.io.git</span><br><span class="line"><span class="symbol">  branch:</span> master</span><br></pre></td></tr></tbody></table></figure>
<p>Then we can push our static blog to the created repository. And the github webpage service will automatically show the pushed contents.</p>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo <span class="keyword">generate</span></span><br><span class="line">hexo deploy</span><br></pre></td></tr></tbody></table></figure>
<p>Congratulations, you have successfully build and deploy your blog. Now every body can visit your blog via <a href="http://jackma.github.io/">JackMa.github.io</a>.</p>
<h4 id="Errors-1"><a href="#Errors-1" class="headerlink" title="Errors"></a>Errors</h4><h5 id="TypeError-ERR-INVALID-ARG-TYPE-The-“mode”-argument-must-be-of-type-number-Received-an-instance-of-Object"><a href="#TypeError-ERR-INVALID-ARG-TYPE-The-“mode”-argument-must-be-of-type-number-Received-an-instance-of-Object" class="headerlink" title="TypeError [ERR_INVALID_ARG_TYPE]: The “mode” argument must be of type number. Received an instance of Object"></a>TypeError [ERR_INVALID_ARG_TYPE]: The “mode” argument must be of type number. Received an instance of Object</h5><p>You may meet the following error when deploy your blog to git using ‘hexo deploy’.</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">FATAL Something's wrong. Maybe you can find the solution here: https:<span class="comment">//hexo.io/docs/troubleshooting.html</span></span><br><span class="line">TypeError <span class="literal">[ERR<span class="identifier">_INVALID_ARG_TYPE</span>]</span>: The <span class="string">"mode"</span> argument must be <span class="keyword">of</span> <span class="keyword">type</span> number. Received an instance <span class="keyword">of</span> Object</span><br><span class="line">    at copyFile (node:fs:<span class="number">2858</span>:<span class="number">10</span>)</span><br><span class="line">    at tryCatcher (/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/util.js:<span class="number">16</span>:<span class="number">23</span>)</span><br><span class="line">    at ret (eval at makeNodePromisifiedEval (/usr/local/lib/node_modules/hexo-cli/node_modules/bluebird/js/release/promisify.js:<span class="number">184</span>:<span class="number">12</span>), &lt;anonymous&gt;:<span class="number">13</span>:<span class="number">39</span>)</span><br><span class="line">    at /Users/zhaoyongsheng/Gits/blog-github/node_modules/hexo-fs/lib/fs.js:<span class="number">144</span>:<span class="number">39</span></span><br><span class="line">    at tryCatcher (/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/util.js:<span class="number">16</span>:<span class="number">23</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromiseFromHandler</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">547</span>:<span class="number">31</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromise</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">604</span>:<span class="number">18</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromise0</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">649</span>:<span class="number">10</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromises</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">729</span>:<span class="number">18</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_fulfill</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">673</span>:<span class="number">18</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_resolveCallback</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">466</span>:<span class="number">57</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromiseFromHandler</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">559</span>:<span class="number">17</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromise</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">604</span>:<span class="number">18</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromise0</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">649</span>:<span class="number">10</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromises</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">729</span>:<span class="number">18</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_fulfill</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">673</span>:<span class="number">18</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_resolveCallback</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">466</span>:<span class="number">57</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromiseFromHandler</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">559</span>:<span class="number">17</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromise</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">604</span>:<span class="number">18</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromise0</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">649</span>:<span class="number">10</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_settlePromises</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">729</span>:<span class="number">18</span>)</span><br><span class="line">    at <span class="module-access"><span class="module"><span class="identifier">Promise</span>.</span><span class="module"><span class="identifier">_fulfill</span> </span></span>(/Users/zhaoyongsheng/Gits/blog-github/node_modules/bluebird/js/release/promise.js:<span class="number">673</span>:<span class="number">18</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Solution<br>The reason of this error is that the version of the installed hexo is not compatible with Node 14. We have to upgrade the hexo’s version at least to 4.2.1. First, check the current version of Hexo using<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">hexo -v</span></span><br></pre></td></tr></tbody></table></figure>
Second, if the current version of Hexo is lower than 4.2.1 then upgrade Hexo using<figure class="highlight coffeescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> upgrade hexo</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h5 id="Error-Cannot-find-module-‘cheerio’"><a href="#Error-Cannot-find-module-‘cheerio’" class="headerlink" title="Error: Cannot find module ‘cheerio’"></a>Error: Cannot find module ‘cheerio’</h5><p>After upgrade Hexo, we may meet the following error when using ‘hexo generate’. </p>
<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line">Error: Cannot <span class="keyword">find</span> module <span class="string">'cheerio'</span></span><br><span class="line">Require stack:</span><br><span class="line">- <span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/themes/</span><span class="keyword">next</span><span class="regexp">/scripts/</span>filters/post.js</span><br><span class="line">    at Module._resolveFilename (node:internal<span class="regexp">/modules/</span>cjs/loader:<span class="number">1060</span>:<span class="number">15</span>)</span><br><span class="line">    at Module._load (node:internal<span class="regexp">/modules/</span>cjs/loader:<span class="number">905</span>:<span class="number">27</span>)</span><br><span class="line">    at Module.require (node:internal<span class="regexp">/modules/</span>cjs/loader:<span class="number">1127</span>:<span class="number">19</span>)</span><br><span class="line">    at require (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>hexo<span class="regexp">/lib/</span>hexo/index.js:<span class="number">280</span>:<span class="number">23</span>)</span><br><span class="line">    at Hexo.&lt;anonymous&gt; (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/themes/</span><span class="keyword">next</span><span class="regexp">/scripts/</span>filters/post.js:<span class="number">13</span>:<span class="number">19</span>)</span><br><span class="line">    at Hexo.tryCatcher (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/util.js:<span class="number">16</span>:<span class="number">23</span>)</span><br><span class="line">    at Hexo.&lt;anonymous&gt; (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/method.js:<span class="number">15</span>:<span class="number">34</span>)</span><br><span class="line">    at <span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>hexo<span class="regexp">/lib/</span>extend/filter.js:<span class="number">62</span>:<span class="number">52</span></span><br><span class="line">    at tryCatcher (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/util.js:<span class="number">16</span>:<span class="number">23</span>)</span><br><span class="line">    at Object.gotValue (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/reduce.js:<span class="number">166</span>:<span class="number">18</span>)</span><br><span class="line">    at Object.gotAccum (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/reduce.js:<span class="number">155</span>:<span class="number">25</span>)</span><br><span class="line">    at Object.tryCatcher (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/util.js:<span class="number">16</span>:<span class="number">23</span>)</span><br><span class="line">    at Promise._settlePromiseFromHandler (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/promise.js:<span class="number">547</span>:<span class="number">31</span>)</span><br><span class="line">    at Promise._settlePromise (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/promise.js:<span class="number">604</span>:<span class="number">18</span>)</span><br><span class="line">    at Promise._settlePromise0 (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/promise.js:<span class="number">649</span>:<span class="number">10</span>)</span><br><span class="line">    at Promise._settlePromises (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/promise.js:<span class="number">729</span>:<span class="number">18</span>)</span><br><span class="line">    at _drainQueueStep (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/async.js:<span class="number">93</span>:<span class="number">12</span>)</span><br><span class="line">    at _drainQueue (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/async.js:<span class="number">86</span>:<span class="number">9</span>)</span><br><span class="line">    at Async._drainQueues (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/async.js:<span class="number">102</span>:<span class="number">5</span>)</span><br><span class="line">    at Async.drainQueues [as _onImmediate] (<span class="regexp">/Users/</span>zhaoyongsheng<span class="regexp">/Gits/</span>blog-github<span class="regexp">/node_modules/</span>bluebird<span class="regexp">/js/</span>release/async.js:<span class="number">15</span>:<span class="number">14</span>)</span><br><span class="line">    at process.processImmediate (node:internal/timers:<span class="number">475</span>:<span class="number">21</span>)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Solution<br>This is because cheerio is removed from mode_module, we have to install it manually.<figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">npm <span class="keyword">install</span> cheerio</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>NexT</tag>
        <tag>GitHub</tag>
      </tags>
  </entry>
  <entry>
    <title>An Intuitive Understanding of Entropy, Cross Entropy and Kullback Leibler Divergence</title>
    <url>/2019/12/04/An-Intuitive-Understanding-of-Kullback-Leibler-Divergence-and-Cross-Entropy/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://en.wikipedia.org/wiki/Information_theory">Information Theory</a> is initially proposed in a landmark paper <a href="https://en.wikipedia.org/wiki/A_Mathematical_Theory_of_Communication">A Mathematical Theory of Communication</a> published by <a href="https://en.wikipedia.org/wiki/Claude_Shannon">Claude Shannon</a>. One of the most important concepts in information theory is <a href="https://en.wikipedia.org/wiki/Entropy">Entropy</a>. It is used to describe the degree of disorder or uncertainty, which is analogous to the definition used in statistical thermodynamics. From the point view of probability, entropy evaluates how much information a probability distribution can carry. Based on the definition of entropy, people further proposed <a href="https://en.wikipedia.org/wiki/Cross_entropy">Cross Entropy</a> and <a href="https://en.wikipedia.org/wiki/Kullback%E2%80%93Leibler_divergence">Kullback Leibler (KL) Divergence</a> to address the issues of information analysis between two different probability distributions. They are good metric that could measure the similarity or distance between two probability distributions, therefore they are widely used in machine learning and deep learning. In this article, I want to provide you an intuitive understanding of entropy, cross entropy and kullback-leibler divergence.</p>
<span id="more"></span>
<h2 id="Entropy"><a href="#Entropy" class="headerlink" title="Entropy"></a>Entropy</h2><p>In the context of Information Theory, how to understand the definition of entropy, the degree of disorder or uncertainty? I try to present an intuitive explanation from the following several aspects.</p>
<h3 id="Probability-Certainty-and-Uncertainty"><a href="#Probability-Certainty-and-Uncertainty" class="headerlink" title="Probability, Certainty and Uncertainty"></a>Probability, Certainty and Uncertainty</h3><p>In mathematics, a probability is defined to describe the chance an event will happen. The larger a probability is, the more chance an event will happen. And the more chance an event will happen, the more certainty an event is, correspondingly, the less uncertainty an event is. Define the probability of an event is $$p$$, then the certainty is $$p$$ and the uncertainty is $$\frac{1}{p}$$. Note that $$p=0$$ means that the uncertainty is infinity. A probability distribution describe the chances of a series of events will happen, which is more general in real world.  </p>
<h3 id="Information"><a href="#Information" class="headerlink" title="Information"></a>Information</h3><p>What’s the definition of information? There must be different definitions of information from different point of view. However, in my opinion, information is what we do not know or do not expect. For example, if we don’t know how to use an device, then its instruction manual will give us the right information. What’s the relationship between information and certainty from the point of view of probability? The more certainty an event is, the more information the event contains and the less extra information we need to clear the event’s uncertainty. For example, assuming we live in a world that the probability of rainy day is 1, then we have all the information regarding to rainy probability and the weather forecast is useless in this scenario because we do not need extra information to clear the uncertainty of the rainy event. It is the same when we live in a world that the probability of rainy day is 0. As far as we can see, certainty is positively related to information. The larger the certainty of an event is, the more information that the event has and the less extra information we need to make it clear.</p>
<h3 id="Uncertainty-and-Entropy"><a href="#Uncertainty-and-Entropy" class="headerlink" title="Uncertainty and Entropy"></a>Uncertainty and Entropy</h3><p>I believe you already understand the basic concepts of probability, certainty, uncertainty, information and their correlations with each other. Let’s take another example to further explain their relationships with respect to uncertainty and entropy. If Jack tells us he lives in China. We can say that the probability he lives in South China is 0.5, North China is 0.5. The message Jack tells us has more uncertainty, and we need extra information to know whether he lives in South China or not. If Jack tells us he lives in Shanghai, the message Jack tells us has less uncertainty because we already know he lives in South China without extra information. </p>
<p>The extra information is what we called uncertainty. Information theory is proposed by Claude Shannon to address the issues how to efficiently communicate the extra information with others. In modern digital world, information theory address the issues of how many bits we need to clear the uncertainty when we communicate with others. As far as we know, one bit has two states 0 or 1. Therefore, we can use one bit to reduce the uncertainty by dividing 2. That is to say we can use the bits to measure the uncertainty. The more bits we need, the larger the uncertainty is. </p>
<p>For example, if the weather has two equal-probability events, rainy and sunny, each one has 0.5 probability to happen, then we can use 1 bit to clear the rainy event’s uncertainty or sunny event’s uncertainty. The value of the one bit is 1 means that the weather is rainy and 0 means that the weather is not rainy. The same is for sunny event. We can formulate the above conclusion as Eq. $\eqref{eq1}$.<br>$$<br>\begin{equation}<br>\frac{1}{0.5}=2^1<br>\label{eq1}<br>\end{equation}<br>$$<br>The expected uncertainty (bit count) of the weather with two equal-probability events is $$0.5<em>1 + 0.5</em>1 = 1$$.</p>
<p>Similarly, if the weather has eight equal-probability events, each one has 0.125 probability to happen, then we can use 3 bit to clear the each event’s uncertainty. We can formulate it as Eq. $\eqref{eq2}$.<br>$$<br>\begin{equation}<br>\frac{1}{0.125}=2^3<br>\label{eq2}<br>\end{equation}<br>$$<br>The expected uncertainty (bits count) of the weather with eight equal-probability events is $$\sum_{i=1}^{8}{0.125*3} = 3$$.</p>
<p>In conclusion, if the probability of one event is $$p$$, then we can use Eg. $\eqref{eq3}$ compute the bits we need to clear the event’s uncertainty.<br>$$<br>\begin{equation}<br>\frac{1}{p}=2^n<br>\label{eq3}<br>\end{equation}<br>$$<br>where $$n=\log_{2}{\frac{1}{p}}$$ denotes the bit count.</p>
<p>If the weather has two nonequal-probability events, rainy event has 0.25 probability to happen and sunny event has 0.75 probability to happen, how many bits we need to clear the weather’s uncertainty? We first compute the needed bits to clear the rainy event’s uncertainty, as shown in Eg. $\eqref{eq4}$<br>$$<br>\begin{equation}<br>n_{rainy}=\log_{2}{\frac{1}{0.25}}<br>\label{eq4}<br>\end{equation}<br>$$<br>Then we compute the needed bits to clear the sunny event’s uncertainty, as shown in Eg. $\eqref{eq5}$<br>$$<br>\begin{equation}<br>n_{sunny}=\log_{2}{\frac{1}{0.75}}<br>\label{eq5}<br>\end{equation}<br>$$<br>The expected uncertainty (bits count) of the weather is $$0.25<em>n_{rainy} + 0.75</em>n_{sunny} \approx 0.81$$.</p>
<p>In the context of Information Theory, Entropy is defined to evaluate the amount of extra information we need to clear the uncertainty of a series of events given its probability distribution. According to Eq. $\eqref{eq3}$, $\eqref{eq4}$, $\eqref{eq5}$, we derive the mathematical formulation of entropy as Eg. $\eqref{6}$<br>$$<br>\begin{equation}<br>H(P)=-\sum_{i}{p_{i}log_{2}{p_{i}}}<br>\label{eq6}<br>\end{equation}<br>$$<br>where $$H(P)$$ denotes the entropy given $$P$$ probability distribution.</p>
<p>Generally, we use $$log$$ to replace $$log_{2}$$, we derive the general formulation of entropy as Eq. $\eqref{eq7}$.<br>$$<br>\begin{equation}<br>H(P)=-\sum_{i}{p_{i}\log{p_{i}}}<br>\label{eq7}<br>\end{equation}<br>$$</p>
<h2 id="Cross-Entropy"><a href="#Cross-Entropy" class="headerlink" title="Cross Entropy"></a>Cross Entropy</h2><p>According to the preceding sections, we understand that entropy $$H(P)$$ evaluates the degree of uncertainty of a probability distribution $$P$$. That is to say, it evaluates the distance in bits between the uncertain state formulated by a probability distribution and the corresponding certain state. Analogically, cross entropy evaluates the distance in bits between the uncertain state formulated by a probability distribution $$Q$$ and the corresponding certain state, given a target probability distribution $$P$$. Eq. $\eqref{eq8}$ defines the cross entropy.<br>$$<br>\begin{equation}<br>H({P,,Q}) =  - \sum_{i}{p_{i} \log{q_{i}}}<br>\label{eq8}<br>\end{equation}<br>$$<br>where $$\log{q_{i}}$$ denotes the uncertainty (bits count) of each events formulated by the probability distribution $$Q$$ and $$p_{i}$$ denotes the target real probability distribution. Note that the cross entropy is an absolute entropy of probability distribution $$Q$$ given probability distribution $$P$$ because we use the absolute uncertainty $$\log{q_{i}}$$ for each event. To some extent, it is similar to the conditional probability distribution. It measures the total bits we need to clear the uncertainty of probability distribution $$Q$$, given $$P$$.</p>
<h2 id="Kullback-Leibler-Divergence"><a href="#Kullback-Leibler-Divergence" class="headerlink" title="Kullback-Leibler Divergence"></a>Kullback-Leibler Divergence</h2><p>Both entropy and cross entropy evaluate the total bits needed to clear the total uncertainty of a probability distribution. How much bits we need in order to make a probability distribution $$Q$$ identical to the target one $$P$$. Kullback–Leibler Divergence is proposed to address this issue. It is a measurement of how one probability distribution $$Q$$ is similar with a target probability distribution $$P$$.<br>$$<br>\begin{equation}<br>{D_{kl}}({p | q }) = -\sum_{i = 0} {p_{i}[ {\log {q_{i}} - \log{p_{i}}}]}<br>\label{eq9}<br>\end{equation}<br>$$<br>Eq. $\eqref{eq9}$ defines the Kullback-Leibler Divergence.</p>
<p>The more common way to see Kullback-Leibler divergence written is as follows:<br>$$<br>\begin{equation}<br>{D_{kl}}({p | q }) = -\sum_{i = 0} {p_{i}[ {\log\frac{q_{i}}{p_{i}}}]}<br>\label{eq10}<br>\end{equation}<br>$$</p>
<p>Kullback-Leibler divergence is a relative entropy of a probability distribution $$Q$$ with respect to $$P$$. If $${D_{kl}}({p | q })$$ is equal to $$0$$, then we can say that the probability distribution $$Q$$ is identical to $$P$$. </p>
<p>Compare Eq. $\eqref{eq9}$, $\eqref{eq7}$, and $\eqref{eq8}$, we can derive:<br>$$<br>\begin{equation}<br>{D_{kl}}( {P | Q}) = H({P,,Q}) - H(P)<br>\label{eq11}<br>\end{equation}<br>$$<br>From Eq. $\eqref{eq11}$, we draw a conclusion that the cross entropy of $$Q$$ and $$P$$ is same with the entropy $$P$$ when $${D_{kl}}({p | q })$$ is equal to $$0$$. </p>
<p>In the context of machine learning and deep learning, cross entropy loss is a famous loss in solving classification problems, which we want the predicted probability distribution same as the real one. Eq. $\eqref{eq11}$ gives us a clear explanation why we can obtain the optimal solution by minimizing the cross entropy. </p>
<h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h3><ul>
<li>The Kullback–Leibler divergence is always non-negative.<br>$$<br>\begin{equation}<br>{D_{kl}}\left( {P\left| Q \right.} \right) \ge 0<br>\end{equation}<br>$$</li>
<li>The Kullback–Leibler divergence does not conform to commutative law.<br>$$<br>\begin{equation}<br>{D_{kl}}\left( {P\left| Q \right.} \right) \ne {D_{kl}}\left( {Q\left| P \right.} \right)<br>\end{equation}<br>$$</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://eranraviv.com/intuitive-explanation-of-entropy/">https://eranraviv.com/intuitive-explanation-of-entropy/</a></li>
<li><a href="https://math.stackexchange.com/questions/331103/intuitive-explanation-of-entropy">https://math.stackexchange.com/questions/331103/intuitive-explanation-of-entropy</a></li>
<li><a href="http://hanj.cs.illinois.edu/cs412/bk3/KL-divergence.pdf">http://hanj.cs.illinois.edu/cs412/bk3/KL-divergence.pdf</a></li>
<li><a href="https://medium.com/@cotra.marko/making-sense-of-the-kullback-leibler-kl-divergence-b0d57ee10e0a">https://medium.com/@cotra.marko/making-sense-of-the-kullback-leibler-kl-divergence-b0d57ee10e0a</a></li>
</ul>
</body></html>]]></content>
      <categories>
        <category>Mathematics</category>
        <category>Probability</category>
        <category>Deep Learning</category>
        <category>Information Theory</category>
      </categories>
      <tags>
        <tag>Maths</tag>
        <tag>Probability</tag>
        <tag>Deep Learning</tag>
      </tags>
  </entry>
  <entry>
    <title>Repair Grub and Restore Ubuntu</title>
    <url>/2019/12/07/Repair-Grub-and-Restore-Ubuntu/</url>
    <content><![CDATA[<html><head></head><body><p>For convenient, we sometimes install multiple operation systems on one computer, such as Windows 10, Ubuntu 16.04, and Ubuntu 18.04. These operation systems can be installed into different hard disks at different time. The existing Ubuntu’s grub file will be overwritten during the installation of new operation system. When the installation failed or the new installed operation system broken, the grub file may be broken, which results in that the existing Ubuntu can not boot. Fortunately, there are methods to repair the broken grub file and restore the existing Ubuntu system. In this article, I will briefly introduce one useful method, which helps me to save my Ubuntu 16.04.</p>
<span id="more"></span>

<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>When the grub file is broken, the following message will be prompted in terminal during booting.</p>
<figure class="highlight subunit"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">error </span>: unknow filesystem</span><br><span class="line">grub &gt;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">If you see a similar message when you boot a ubuntu system, <span class="keyword">it</span> indicates <span class="keyword">that</span> <span class="keyword">the</span> operation system's grub <span class="built_in">file</span> was broken. You can use <span class="keyword">the</span> following method <span class="keyword">to</span> repair <span class="keyword">the</span> grub <span class="built_in">file</span>. I have tested <span class="keyword">that</span> this method <span class="keyword">is</span> valid.</span><br><span class="line"></span><br><span class="line"><span class="comment">## Solution </span></span><br><span class="line"></span><br><span class="line">* Check partition</span><br></pre></td></tr></tbody></table></figure>
<p>grub &gt; ls</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">We</span> will see <span class="literal">all</span> the partitions <span class="literal">on</span> disk.</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>(hd0) (hd0,gpt0) (hd0,gpt1) (hd0,gpt2) …</p>
<figure class="highlight livecodeserver"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">* Find <span class="keyword">the</span> root <span class="built_in">directory</span> <span class="keyword">of</span> Ubuntu </span><br><span class="line">List contents <span class="keyword">of</span> every partition <span class="keyword">until</span> we find <span class="keyword">the</span> root <span class="built_in">directory</span> <span class="keyword">of</span> <span class="keyword">the</span> Ubuntu <span class="keyword">system</span> we want <span class="built_in">to</span> restore.</span><br></pre></td></tr></tbody></table></figure>
<p>grub &gt; ls (hd0,gpt1)/<br>grub &gt; ls (hd0,gpt2)/<br>grub &gt; ls (hd0,gpt3)/</p>
<figure class="highlight livecodeserver"><table><tbody><tr><td class="code"><pre><span class="line">If we see <span class="keyword">the</span> following message, we find where <span class="keyword">the</span> root <span class="built_in">directory</span> is.</span><br></pre></td></tr></tbody></table></figure>
<p>grub &gt; ./ ../ tmp/ bin/ lib/ proc/ boot/ lib32/ root/ lib64/ run/ lost+found/ sbin/ usr/ media/ srv/ var/ dev/ mnt/ vmlinuz/ etc/ vmlinuz.old sys/ opt/</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">* <span class="keyword">Set</span> booting <span class="keyword">partition</span></span><br></pre></td></tr></tbody></table></figure>
<p>grub &gt; set root=(hd0,gpt3)<br>grub &gt; set prefix=(hd0,gpt3)/boot/grub<br>grub &gt; insmod normal<br>grub &gt; normal</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line">The Ubuntu <span class="keyword">system</span> would booting successfully <span class="keyword">and</span> we can <span class="keyword">login</span> now.</span><br><span class="line"></span><br><span class="line">* <span class="keyword">Update</span> grub file</span><br></pre></td></tr></tbody></table></figure>
<p>sudo update-grub<br>sudo grub-install /dev/sda<br>reboot</p>
<pre><code>If you could not repair the grub file and restore the Ubuntu operation system, please do not hesitate to leave a comment. Thank you very much.
</code></pre>
</body></html>]]></content>
      <categories>
        <category>Ubuntu</category>
        <category>Boot</category>
        <category>Grub</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>Grub</tag>
        <tag>Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Usage Experiences and Skills of Ubuntu</title>
    <url>/2019/12/04/Usage-Experiences-and-Skills-of-Ubuntu/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://ubuntu.com/">Ubuntu</a> is a popular version of <a href="https://www.linux.org/">Linux</a> with a desktop. It is easy to use and widely used in software and algorithm development. There are tens of thousands of open source softwares that support Ubuntu. As a researcher and algorithm engineer, I am using Ubuntu 16.04 and 18.04 to do research and development work. This post contains many useful experiences and skills in using Ubuntu that I want to share with you and make a documentation for myself at the same time.</p>
<span id="more"></span>

<h2 id="Command-Line"><a href="#Command-Line" class="headerlink" title="Command Line"></a>Command Line</h2><h3 id="Command-Line-History"><a href="#Command-Line-History" class="headerlink" title="Command Line History"></a>Command Line History</h3><p><strong>history</strong> command is used to list the commands we used in the terminal. </p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">history</span> #Show <span class="keyword">all</span> the <span class="keyword">history</span> commands</span><br><span class="line"><span class="keyword">history</span> | <span class="keyword">grep</span> <span class="string">"apt-get"</span> #Show <span class="keyword">all</span> the <span class="keyword">history</span> commands that contains apt-<span class="built_in">get</span></span><br><span class="line"><span class="keyword">history</span> | tee &gt; <span class="keyword">history</span>.hist #Show <span class="keyword">all</span> the <span class="keyword">history</span> commands <span class="built_in">and</span> output <span class="keyword">to</span> <span class="keyword">a</span> <span class="keyword">file</span></span><br></pre></td></tr></tbody></table></figure>
<p>Note that the symbol <strong>&gt;</strong> means output the stream to a file. It will create a new file or erase the existing contents if the file is already exits and write the stream to the beginning of the file. While the symbol <strong>&gt;&gt;</strong> will keep the existing contents and write the stream to the end of the file.</p>
<h3 id="Word-Count"><a href="#Word-Count" class="headerlink" title="Word Count"></a>Word Count</h3><p>Ubuntu provides a command to count the word or line of a text content. The command is <strong>wc</strong>. For example, we can use this command to count the items of a directory.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> | <span class="built_in">wc</span> -l</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Show-amp-Kill-Process"><a href="#Show-amp-Kill-Process" class="headerlink" title="Show &amp; Kill Process"></a>Show &amp; Kill Process</h3><h4 id="Show"><a href="#Show" class="headerlink" title="Show"></a>Show</h4><p>We can check all the running process using <strong>ps</strong> command</p>
<figure class="highlight dos"><table><tbody><tr><td class="code"><pre><span class="line">ps -<span class="built_in">aux</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Kill"><a href="#Kill" class="headerlink" title="Kill"></a>Kill</h4><figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">kill</span> -<span class="number">9</span><span class="meta"> [pid]</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Set-Default-Editor"><a href="#Set-Default-Editor" class="headerlink" title="Set Default Editor"></a>Set Default Editor</h4><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><span class="line">sudo <span class="keyword">update</span><span class="operator">-</span>alternatives <span class="comment">--config editor</span></span><br></pre></td></tr></tbody></table></figure>
<p>Run the above command, and you will see a list of editors as follows.</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">There are <span class="number">4</span> choices <span class="keyword">for</span> the alternative editor (providing /usr/bin/editor). And <span class="built_in">input</span> the <span class="keyword">number</span> <span class="keyword">to</span> <span class="keyword">set</span> the default editor.</span><br><span class="line"></span><br><span class="line">  Selection    Path                Priority   Status</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">* <span class="number">0</span>            /bin/nano            <span class="number">40</span>        auto <span class="keyword">mode</span></span><br><span class="line">  <span class="number">1</span>            /bin/ed             -<span class="number">100</span>       manual <span class="keyword">mode</span></span><br><span class="line">  <span class="number">2</span>            /bin/nano            <span class="number">40</span>        manual <span class="keyword">mode</span></span><br><span class="line">  <span class="number">3</span>            /usr/bin/<span class="keyword">vim</span>.basic   <span class="number">30</span>        manual <span class="keyword">mode</span></span><br><span class="line">  <span class="number">4</span>            /usr/bin/<span class="keyword">vim</span>.tiny    <span class="number">15</span>        manual <span class="keyword">mode</span></span><br><span class="line"></span><br><span class="line">Press <span class="symbol">&lt;enter&gt;</span> <span class="keyword">to</span> keep the current choice[*], <span class="built_in">or</span> <span class="built_in">type</span> selection <span class="keyword">number</span>:</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Kernel-Information"><a href="#Kernel-Information" class="headerlink" title="Kernel Information"></a>Kernel Information</h3><p><strong>uname</strong> can be used to print the kernel information.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">uname</span> -r <span class="comment">#print kernel release</span></span><br><span class="line"><span class="built_in">uname</span> -v <span class="comment">#print kernel version</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="ssh"><a href="#ssh" class="headerlink" title="ssh"></a>ssh</h3><p>If we meet ssh command not found error, then we can fix it by installing openssh-server</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> install openssh-<span class="keyword">server</span></span><br></pre></td></tr></tbody></table></figure>
<p>The default port for ssh is <strong>22</strong>. Please make sure this port is authorized by firewall.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo</span> ufw <span class="literal">allow</span> <span class="number">22</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Solution-for-disconnect-frequently"><a href="#Solution-for-disconnect-frequently" class="headerlink" title="Solution for disconnect frequently"></a>Solution for disconnect frequently</h4><p>When we connect a machine via ssh and don’t input any commands for a while, the ssh connection will be disconnected because the pipe is broken. We have to reconnect it via ssh command, which is quite annoying and wasting time. There are method to make ssh connection keep longer time.</p>
<p>First, open the ssh config file using vim.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">vi <span class="regexp">/etc/</span>ssh/sshd_config</span><br></pre></td></tr></tbody></table></figure>
<p>And find the two lines:</p>
<figure class="highlight 1c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#ClientAliveInterval 0</span></span><br><span class="line"><span class="meta">#ClientAliveCountMax 3</span></span><br></pre></td></tr></tbody></table></figure>
<p>Second, uncomment the two lines and set them as follows:</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">ClientAliveInterval</span> <span class="number">30</span> </span><br><span class="line"><span class="attribute">ClientAliveCountMax</span> <span class="number">86400</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>ClientAliveInterval 30</strong> – The client will send heartbeat data to the server every 30 seconds.<br><strong>ClientAliveCountMax 86400</strong> – The server will broken the connection automatically after 86400 seconds that not received heartbeat signals from client.<br>Third, restart the sshd service.</p>
<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">service sshd restart</span></span><br></pre></td></tr></tbody></table></figure>


<h3 id="Scan-LAN-IPs"><a href="#Scan-LAN-IPs" class="headerlink" title="Scan LAN IPs"></a>Scan LAN IPs</h3><p><em>nmap</em> is a tool scanning all the ips in a local network.</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install <span class="keyword">nmap</span></span><br><span class="line"><span class="keyword">nmap</span> -sP <span class="number">192.168</span>.<span class="number">1.0</span>/<span class="number">24</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Module-Operation"><a href="#Module-Operation" class="headerlink" title="Module Operation"></a>Module Operation</h3><p><a href="https://wiki.archlinux.org/index.php/Kernel_module">Kernel modules</a> are pieces of code that can be loaded and unloaded into the kernel upon demand. They extend the functionality of the kernel without the need to reboot the system.</p>
<p>To create a kernel module, you can read <a href="http://tldp.org/LDP/lkmpg/2.6/html/index.html">The Linux Kernel Module Programming Guide</a>. A module can be configured as built-in or loadable. To dynamically load or remove a module, it has to be configured as a loadable module in the kernel configuration.</p>
<ul>
<li>Load A Module<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo modprobe usbmon</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>Unload A Module<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo rmmod usbmon</span></span><br><span class="line"><span class="attribute">sudo modprobe -r usbmon</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>List Modules<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo lsmod</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>Print A Module’s Information<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo modinfo usbmon</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h2 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h2><h3 id="pip"><a href="#pip" class="headerlink" title="pip"></a>pip</h3><h4 id="Change-Source"><a href="#Change-Source" class="headerlink" title="Change Source"></a>Change Source</h4><p>Using the original source to install packages is usually slow and sometime it is unable to visit for users in China. We can change the source to speed the installation.</p>
<ul>
<li>Create a configuration file<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/.pip/</span><br><span class="line"><span class="built_in">cd</span> .pip</span><br><span class="line"><span class="built_in">touch</span> pip.conf</span><br></pre></td></tr></tbody></table></figure></li>
<li>Change source<br>Adding the target source url to the created configuration file.<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">sudo <span class="keyword">vi</span> pip.<span class="keyword">conf</span></span><br><span class="line">[<span class="keyword">global</span>]</span><br><span class="line"><span class="built_in">index</span>-url = https://pypi.tuna.tsinghua.edu.<span class="keyword">cn</span>/simple</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h4 id="Install-Package-Using-A-Specified-Source"><a href="#Install-Package-Using-A-Specified-Source" class="headerlink" title="Install Package Using A Specified Source"></a>Install Package Using A Specified Source</h4><figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">pip install -i https:<span class="regexp">//</span>pypi.tuna.tsinghua.edu.cn/simple matplotlib</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><h3 id="List-Contents-of-Directories-in-A-Tree-Like-Format"><a href="#List-Contents-of-Directories-in-A-Tree-Like-Format" class="headerlink" title="List Contents of Directories in A Tree-Like Format."></a>List Contents of Directories in A Tree-Like Format.</h3><p><strong>Tree</strong> is a recursive directory listing program that produces a depth indented listing of files, which is colorized ala dircolors if the LS_COLORS environment variable is set and output is to tty.</p>
<figure class="highlight dos"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get install <span class="built_in">tree</span></span><br><span class="line"><span class="built_in">tree</span></span><br><span class="line"><span class="built_in">tree</span> -d</span><br><span class="line"><span class="built_in">tree</span> -L <span class="number">1</span></span><br><span class="line"><span class="built_in">tree</span> -u</span><br></pre></td></tr></tbody></table></figure>
<h3 id="DEP-2-RPM-or-RPM-2-DEP"><a href="#DEP-2-RPM-or-RPM-2-DEP" class="headerlink" title="DEP 2 RPM or RPM 2 DEP"></a>DEP 2 RPM or RPM 2 DEP</h3><p><strong>alien</strong> is a program that converts between Red Hat rpm, Debian deb, Stampede slp, Slackware tgz, and Solaris pkg file formats. If you want to use a package from another linux distribution than the one you have installed on your system, you can use alien to convert it to your preferred package format and install it. It also supports LSB packages.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo</span> apt-get install alien</span><br><span class="line"><span class="attribute">sudo</span> alien toec-oep102d-<span class="number">1</span>.<span class="number">4</span>-<span class="number">4</span>.nd7.x86_64.rpm</span><br><span class="line"><span class="attribute">sudo</span> alien -r toec-oep102d_1.<span class="number">4</span>-<span class="number">5</span>_amd64.deb</span><br></pre></td></tr></tbody></table></figure>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Ubuntu</category>
        <category>Commands</category>
        <category>Ubuntu</category>
        <category>SSH</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>tree</tag>
        <tag>alien</tag>
        <tag>history</tag>
        <tag>wc</tag>
        <tag>ssh</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu 18.04 Installation and Development Environment Setups</title>
    <url>/2019/12/07/Ubuntu-19-04-Installation-and-Development-Environment-Setups/</url>
    <content><![CDATA[<html><head></head><body><p>In this article, I will show the detailed installation and configuration of Ubuntu 18.04 step by step using command lines. The development environment contains OpenCV, PCL, CUDA, Tensorflow, and so on, which is suitable for computer vision and deep learning scientific researchers and engineers.</p>
<span id="more"></span>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><h3 id="Make-Installation-Image"><a href="#Make-Installation-Image" class="headerlink" title="Make Installation Image"></a>Make Installation Image</h3><ul>
<li>Download ISO file<br>First, download the original Ubuntu 18.04 ISO file from Internet. If you come from China, I recommend you to visit the famous <a href="https://mirrors.163.com/">open source mirror</a> maintained by NetEase, which is fast and stable.<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">https</span>://mirrors.<span class="number">163</span>.com/ubuntu-releases/<span class="number">18</span>.<span class="number">04</span>.<span class="number">3</span>/ubuntu-<span class="number">18</span>.<span class="number">04</span>.<span class="number">3</span>-desktop-amd64.iso</span><br></pre></td></tr></tbody></table></figure></li>
<li>Make USB installation image<br>UltraISO is a good tool to make an installation image using a USB Storage. We can do this job on Windows.</li>
</ul>
<h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><ul>
<li>Choose boot from USB in BIOS</li>
<li>Install</li>
<li>Disk Partition<br>Generally, <strong>default partition configuration</strong> is recommended, but we can still do partition by ourselves. I prefer to use the following partition configuration according to my experience, which could manage and use the storage space efficiently. Primary partitions hold the operating system files and can be made “Active” partition to boot the computer from. For a Linux operation system, a maximum of 4 primary partitions can be created, or 3 primary and an extended partitions. Logical partitions are created under the extended partition. Logical partitions can be resized or repartitioned by mounting/unmounting it within Linux.<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">1.</span> efi   <span class="number">200</span>Mb, <span class="keyword">primary</span> <span class="keyword">partition</span></span><br><span class="line"><span class="number">2.</span> boot  <span class="number">500</span>Mb, <span class="keyword">primary</span> <span class="keyword">partition</span>, store the <span class="keyword">system</span> kernels <span class="keyword">and</span> boot files</span><br><span class="line"><span class="number">3.</span> SWAP  <span class="number">16</span>Gb,  swap area, virtual memory, the size <span class="keyword">is</span> usually same <span class="keyword">with</span> memory</span><br><span class="line"><span class="number">4.</span> /     <span class="number">64</span>Gb,  <span class="keyword">primary</span> <span class="keyword">partition</span></span><br><span class="line"><span class="number">5.</span> /home rest,  logical <span class="keyword">partition</span> </span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h2 id="Setups"><a href="#Setups" class="headerlink" title="Setups"></a>Setups</h2><h3 id="Change-apt-source"><a href="#Change-apt-source" class="headerlink" title="Change apt source"></a>Change apt source</h3><ul>
<li>Using shortcuts <strong>super+a</strong> to open <strong>Show Applications</strong></li>
<li>Open <strong>Software &amp; Updates</strong></li>
<li>Set <strong>Download from</strong> as <strong><a href="http://mirrors.cn99.com/ubuntu">http://mirrors.cn99.com/ubuntu</a></strong></li>
</ul>
<h3 id="Update-amp-Upgrade"><a href="#Update-amp-Upgrade" class="headerlink" title="Update &amp; Upgrade"></a>Update &amp; Upgrade</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> update</span><br><span class="line">sudo apt-<span class="built_in">get</span> upgrade</span><br></pre></td></tr></tbody></table></figure>
<p>It would takes several minutes for first update &amp; upgrade. The time depends on your network bandwidth.</p>
<h3 id="Setup-Chinese-Input-Method"><a href="#Setup-Chinese-Input-Method" class="headerlink" title="Setup Chinese Input Method"></a>Setup Chinese Input Method</h3><ul>
<li>Using shortcuts <strong>super+a</strong> to open <strong>Language Support</strong><br>If you open <strong>Language Support</strong> for first time, it will prompt “The language support is not installed completely”. We choose the <strong>install</strong> option.</li>
<li>Click <strong>Install/Remove Languages</strong> and make sure <em>Chinese (simplified)</em> is selected.</li>
<li>Install ibus<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ibus ibus-clutter ibus-gtk ibus-gtk3</span><br></pre></td></tr></tbody></table></figure></li>
<li>Install pinyin and setup<figure class="highlight livecodeserver"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ibus-pinyin</span><br><span class="line">sudo reboot (optional, we can <span class="built_in">do</span> <span class="keyword">it</span> latter)</span><br><span class="line">ibus-setup</span><br></pre></td></tr></tbody></table></figure></li>
<li>Choose intelligent pinyin<figure class="highlight pf"><table><tbody><tr><td class="code"><pre><span class="line">System Settings &gt; Region &amp; Language &gt; Input Sources</span><br><span class="line">Pinyin Preferences &gt; Initial <span class="keyword">state</span> &gt; English</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="Install-Mendeley"><a href="#Install-Mendeley" class="headerlink" title="Install Mendeley"></a>Install Mendeley</h3><p><a href="https://www.mendeley.com/?interaction_required=true">Mendeley</a> is a cross-platform paper management tool. It offers free cloud service that could synchronize papers between different devices in one account. <a href="https://www.mendeley.com/guides/download-mendeley-desktop/ubuntu/instructions">Download Mendeley</a></p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo</span> chmod +x mendeleydesktop_1.<span class="number">19</span>.<span class="number">4</span>-stable_amd64.deb</span><br><span class="line"><span class="attribute">sudo</span> dpkg -i mendeleydesktop_1.<span class="number">19</span>.<span class="number">4</span>-stable_amd64.deb</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Install-ZSH"><a href="#Install-ZSH" class="headerlink" title="Install ZSH"></a>Install ZSH</h3><ul>
<li><p>Install git, curl and zsh</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install git</span><br><span class="line">sudo apt-<span class="built_in">get</span> install curl</span><br><span class="line">sudo apt-<span class="built_in">get</span> install zsh</span><br><span class="line">zsh --version</span><br><span class="line">sudo reboot</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>Config your global email and name for git</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">git config <span class="attr">--global</span> user<span class="selector-class">.email</span> <span class="string">"zhaoyongsheng@zju.edu.cn"</span></span><br><span class="line">git config <span class="attr">--global</span> user<span class="selector-class">.name</span> <span class="string">"Alex"</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Install oh-my-zsh</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sh -c <span class="string">"<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)</span>"</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="Install-tmux"><a href="#Install-tmux" class="headerlink" title="Install tmux"></a>Install tmux</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install tmux</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-ssh"><a href="#Install-ssh" class="headerlink" title="Install ssh"></a>Install ssh</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ssh</span><br><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-zeal"><a href="#Install-zeal" class="headerlink" title="Install zeal"></a>Install zeal</h3><figure class="highlight smali"><table><tbody><tr><td class="code"><pre><span class="line">sudo<span class="built_in"> add-apt-repository </span>ppa:zeal-developers/ppa (deprecated)</span><br><span class="line">sudo apt-get update (deprecated)</span><br><span class="line">sudo apt-get install zeal</span><br></pre></td></tr></tbody></table></figure>
<p>Visit <a href="http://zealusercontributions.herokuapp.com/">Offline Docsets</a> and add more docsets such as tensorflow, zsh, and so on.</p>
<h3 id="Install-Java-Runtime-Environment"><a href="#Install-Java-Runtime-Environment" class="headerlink" title="Install Java Runtime Environment"></a>Install Java Runtime Environment</h3><p>When we using <strong>LibreOffice</strong> from terminal, we will see the following warnings.</p>
<figure class="highlight mipsasm"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">javaldx: </span>Could not find a <span class="keyword">Java </span>Runtime Environment!</span><br><span class="line">Please ensure that a <span class="keyword">JVM </span><span class="keyword">and </span>the package libreoffice-<span class="keyword">java-common</span></span><br><span class="line"><span class="keyword"></span>is <span class="keyword">installed.</span></span><br></pre></td></tr></tbody></table></figure>
<p>We can fix it by installing java runtime environment.</p>
<figure class="highlight actionscript"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> install <span class="keyword">default</span>-jre libreoffice-java-common</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Install-gcc-and-cmake"><a href="#Install-gcc-and-cmake" class="headerlink" title="Install gcc and cmake"></a>Install gcc and cmake</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install gcc</span><br><span class="line">sudo apt-<span class="built_in">get</span> install cmake</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-vscode-and-sync"><a href="#Install-vscode-and-sync" class="headerlink" title="Install vscode and sync"></a>Install vscode and sync</h3><ul>
<li>Install vscode<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">curl https:<span class="regexp">//</span>packages.microsoft.com<span class="regexp">/keys/mi</span>crosoft.asc | gpg --dearmor &gt; packages.microsoft.gpg</span><br><span class="line">sudo install -o root -g root -m <span class="number">644</span> packages.microsoft.gpg <span class="regexp">/usr/</span>share<span class="regexp">/keyrings/</span></span><br><span class="line">sudo sh -c <span class="string">'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/vscode stable main" &gt; /etc/apt/sources.list.d/vscode.list'</span></span><br><span class="line">sudo apt-get install apt-transport-https</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install code</span><br></pre></td></tr></tbody></table></figure></li>
<li>Synchronize setups<br>First, add ssh-key to Github and make sure ssh connection from your pc to your github account is valid.<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">From</span> the <span class="string">'Command Palette'</span> (Ctrl+Shift+P), <span class="keyword">type</span> Extensions: Install Extensions, <span class="keyword">and</span> install <span class="string">'Settings Sync'</span></span><br><span class="line"><span class="keyword">Login</span> <span class="keyword">With</span> Github</span><br><span class="line"><span class="keyword">From</span> the <span class="string">'Command Palette'</span> (Ctrl+Shift+P), <span class="keyword">input</span> Command: sync: Download Settings</span><br></pre></td></tr></tbody></table></figure></li>
<li>Set font size<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">"editor.fontSize"</span><span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">"window.zoomLevel"</span><span class="punctuation">:</span> <span class="number">2.0</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="Setup-terminals"><a href="#Setup-terminals" class="headerlink" title="Setup terminals"></a>Setup terminals</h3><figure class="highlight maxima"><table><tbody><tr><td class="code"><pre><span class="line">Preferences &gt; unamed &gt; Colors &gt; Choose Green on black theme &gt; Change Background <span class="built_in">color</span> to #<span class="number">1B7491</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Hide-top-bar-amp-Caffeine"><a href="#Hide-top-bar-amp-Caffeine" class="headerlink" title="Hide top bar &amp; Caffeine"></a>Hide top bar &amp; Caffeine</h3><figure class="highlight mipsasm"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get <span class="keyword">install </span>chrome-gnome-<span class="keyword">shell</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">Preferences </span>(Open Menu) -&gt; <span class="keyword">Add-ons </span>(Ctrl+<span class="keyword">Shift+A), </span><span class="keyword">and </span><span class="keyword">install </span><span class="string">'GNOME Shell integration'</span> <span class="keyword">extension </span>in Firefox</span><br><span class="line">Open <span class="string">'GNOME Shell integration'</span> website <span class="keyword">extension </span>in Firefox</span><br><span class="line">Search hide top <span class="keyword">bar </span><span class="keyword">and </span>choose ON</span><br><span class="line">Search caffeine <span class="keyword">and </span>choose ON</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Setup-Screenshot-Shortcut"><a href="#Setup-Screenshot-Shortcut" class="headerlink" title="Setup Screenshot Shortcut"></a>Setup Screenshot Shortcut</h3><p><strong>gnome-screenshot</strong> is a build-in screenshot tool for Ubuntu 18.04.</p>
<figure class="highlight xl"><table><tbody><tr><td class="code"><pre><span class="line">S<span class="function"><span class="title">ettings</span> -&gt;</span> D<span class="function"><span class="title">evices</span> -&gt;</span> K<span class="function"><span class="title">eyboard</span> -&gt;</span> Add custom shortcut</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/2019/12/07/Ubuntu-19-04-Installation-and-Development-Environment-Setups/gnome-screenshot.png"></p>
<h3 id="Install-tensorflow-gpu-2-0"><a href="#Install-tensorflow-gpu-2-0" class="headerlink" title="Install tensorflow-gpu 2.0"></a>Install tensorflow-gpu 2.0</h3><ul>
<li><p>Install GPU driver</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">Open</span> <span class="string">'Softwares &amp; Updates'</span> -&gt; Additional Drivers</span><br><span class="line">Choose suitable driver <span class="keyword">version</span> <span class="keyword">and</span> install</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/2019/12/07/Ubuntu-19-04-Installation-and-Development-Environment-Setups/nvidia-driver.png"></p>
</li>
<li><p>Check Driver Version and CUDA version</p>
<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">nvidia-smi</span></span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/2019/12/07/Ubuntu-19-04-Installation-and-Development-Environment-Setups/nvidia-smi.png"></p>
</li>
<li><p>Install CUDA</p>
</li>
</ul>
<p>Go to Nvidia Developer <a href="https://developer.nvidia.com/cuda-toolkit-archive">CUDA Toolkit Archive</a> download <strong>cuda_11.0.3_450.51.06_linux.run</strong> and go to <a href="https://developer.nvidia.com/rdp/cudnn-archive">cuDNN Archive</a> <strong>cudnn-11.0-linux-x64-v8.0.5.39.tgz</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo ./cuda_11.0.3_450.51.06_linux.run <span class="comment">## install without driver option</span></span><br><span class="line">tar -xzf cudnn-*</span><br><span class="line"><span class="built_in">cd</span> cuda/lib64</span><br><span class="line">sudo <span class="built_in">cp</span> ** /usr/local/cuda-11.0/lib64</span><br><span class="line"><span class="built_in">cd</span> ../include</span><br><span class="line">sudo <span class="built_in">cp</span> cudnn.h /usr/local/cuda-10.0/include</span><br><span class="line">sudo apt-get install nvidia-driver-418 (deprecated)</span><br><span class="line">sudo modprobe nvidia (deprecated)</span><br><span class="line"><span class="built_in">export</span> PATH=/usr/local/cuda-11.0/bin<span class="variable">${PATH:+:<span class="variable">${PATH}</span>}</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=/usr/local/cuda-11.0/lib64<span class="variable">${LD_LIBRARY_PATH:+:<span class="variable">${LD_LIBRARY_PATH}</span>}</span></span><br><span class="line">nvidia-smi</span><br><span class="line">nvcc -V</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p>Install pip<br>Using Python 3.6.9 as default python</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo rm <span class="regexp">/usr/</span>bin/python</span><br><span class="line">sudo ln -s <span class="regexp">/usr/</span>bin<span class="regexp">/python3 /u</span>sr<span class="regexp">/bin/</span>python</span><br><span class="line">sudo apt-get install python3-pip</span><br><span class="line">sudo ln -s <span class="regexp">/usr/</span>bin<span class="regexp">/pip3 /u</span>sr<span class="regexp">/bin/</span>pip</span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip list</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>Set pip source</p>
<ul>
<li>清华源 <a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a></li>
<li>阿里源 <a href="https://mirrors.aliyun.com/pypi/simple/">https://mirrors.aliyun.com/pypi/simple/</a></li>
<li>腾讯源 <a href="http://mirrors.cloud.tencent.com/pypi/simple">http://mirrors.cloud.tencent.com/pypi/simple</a></li>
<li>豆瓣源 <a href="http://pypi.douban.com/simple/">http://pypi.douban.com/simple/</a></li>
</ul>
</li>
</ul>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> ~/.pip</span><br><span class="line"><span class="keyword">cd</span> ~/.pip</span><br><span class="line">touch pip.<span class="keyword">conf</span></span><br><span class="line">sudo gedit pip.<span class="keyword">conf</span></span><br><span class="line">[<span class="keyword">global</span>]</span><br><span class="line"><span class="built_in">index</span>-url = https://pypi.tuna.tsinghua.edu.<span class="keyword">cn</span>/simple</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Install tensorflow-gpu<br>Tensorflow 2.0 package requires pip version &gt; 19.0.<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">pip install tensorflow-gpu==<span class="number">2.2</span></span><br><span class="line">sudo ln -s <span class="regexp">/usr/</span>local<span class="regexp">/cuda-11.0/</span>lib64<span class="regexp">/libcudnn.so /u</span>sr<span class="regexp">/local/</span>cuda-<span class="number">11.0</span><span class="regexp">/lib64/</span>libcudnn.so.<span class="number">7</span></span><br><span class="line">sudo ln -s <span class="regexp">/usr/</span>local<span class="regexp">/cuda-11.0/</span>lib64<span class="regexp">/libcudart.so /u</span>sr<span class="regexp">/local/</span>cuda-<span class="number">11.0</span><span class="regexp">/lib64/</span>libcudart.so.<span class="number">10.1</span></span><br><span class="line">sudo ln -s <span class="regexp">/usr/</span>local<span class="regexp">/cuda-11.0/</span>lib64<span class="regexp">/libcublas.so /u</span>sr<span class="regexp">/local/</span>cuda-<span class="number">11.0</span><span class="regexp">/lib64/</span>libcublas.so.<span class="number">10</span></span><br><span class="line">sudo ln -s <span class="regexp">/usr/</span>local<span class="regexp">/cuda-11.0/</span>lib64<span class="regexp">/libcusparse.so /u</span>sr<span class="regexp">/local/</span>cuda-<span class="number">11.0</span><span class="regexp">/lib64/</span>libcusparse.so.<span class="number">10</span></span><br></pre></td></tr></tbody></table></figure>
Test is GPU available<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">python</span></span><br><span class="line">import tensorflow <span class="keyword">as</span> <span class="keyword">tf</span></span><br><span class="line"><span class="keyword">tf</span>.test.is_gpu_available()</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="Install-Teamviewer"><a href="#Install-Teamviewer" class="headerlink" title="Install Teamviewer"></a>Install Teamviewer</h3><p>Go to Teamviewer official website and download <strong>teamviewer_xx_amd64.deb</strong>.</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">sudo dpkg -<span class="selector-tag">i</span> teamviewer_xx_amd64<span class="selector-class">.deb</span></span><br><span class="line">sudo apt-get <span class="attr">--fix-broken</span> install</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-x2goclient"><a href="#Install-x2goclient" class="headerlink" title="Install x2goclient"></a>Install x2goclient</h3><figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">add</span>-repository <span class="keyword">pp</span><span class="variable">a:x2go</span>/stable</span><br><span class="line">sudo apt-<span class="built_in">get</span> <span class="keyword">update</span></span><br><span class="line">sudo apt-<span class="built_in">get</span> install x2goclient</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Setup-vim"><a href="#Setup-vim" class="headerlink" title="Setup vim"></a>Setup vim</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">touch .vimrc</span><br><span class="line">vi .vimrc</span><br><span class="line"><span class="built_in">set</span> nocompatible</span><br><span class="line"><span class="built_in">set</span> <span class="attribute">backspace</span>=2</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-pcl"><a href="#Install-pcl" class="headerlink" title="Install pcl"></a>Install pcl</h3><p>Ubuntu 18.04 supports installation of pcl using apt-get, which is different with Ubuntu 16.04.</p>
<figure class="highlight q"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libpcl-<span class="built_in">dev</span></span><br></pre></td></tr></tbody></table></figure>
<p>Eigen 3.3.4, vtk 6.3, boost 1.65.1, libopenni 1.5.4.0, libopenni2 2.2.0.3 are installed at the same time.</p>
<h3 id="Install-glog"><a href="#Install-glog" class="headerlink" title="Install glog"></a>Install glog</h3><p><a href="FindGlog.cmake">Download FindGlog.cmake</a></p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get install libgoogle-glog-dev</span><br><span class="line">sudo cp FindGlog.cmake <span class="regexp">/usr/</span>share<span class="regexp">/cmake-3.10/</span>Modules</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-tinyxml-1-amp-2"><a href="#Install-tinyxml-1-amp-2" class="headerlink" title="Install tinyxml 1 &amp; 2"></a>Install tinyxml 1 &amp; 2</h3><figure class="highlight q"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libtinyxml2-<span class="built_in">dev</span></span><br><span class="line">sudo apt-<span class="built_in">get</span> install libtinyxml-<span class="built_in">dev</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-ceres"><a href="#Install-ceres" class="headerlink" title="Install ceres"></a>Install ceres</h3><figure class="highlight q"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libceres-<span class="built_in">dev</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-opencv"><a href="#Install-opencv" class="headerlink" title="Install opencv"></a>Install opencv</h3><figure class="highlight q"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libopencv-<span class="built_in">dev</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-gtest"><a href="#Install-gtest" class="headerlink" title="Install gtest"></a>Install gtest</h3><figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libgtest-dev</span><br><span class="line"><span class="keyword">cd</span> /usr/src/gtest</span><br><span class="line">sudo <span class="built_in">mkdir</span> build</span><br><span class="line"><span class="keyword">cd</span> build</span><br><span class="line">sudo cmake ..</span><br><span class="line">sudo <span class="keyword">make</span> install</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-Zbar"><a href="#Install-Zbar" class="headerlink" title="Install Zbar"></a>Install Zbar</h3><p><a href="FindZbar.cmake">Download FindZbar.cmake</a></p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get install libzbar-dev</span><br><span class="line">sudo cp FindZbar.cmake <span class="regexp">/usr/</span>share<span class="regexp">/cmake-3.10/</span>Modules</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Fix-“System-program-problem-detected-”"><a href="#Fix-“System-program-problem-detected-”" class="headerlink" title="Fix “System program problem detected.”"></a>Fix “System program problem detected.”</h3><figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo rm <span class="regexp">/var/</span>crash/*</span><br><span class="line">sudo vi <span class="regexp">/etc/</span>default/apport</span><br><span class="line">enable=<span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-Spinnaker"><a href="#Install-Spinnaker" class="headerlink" title="Install Spinnaker"></a>Install Spinnaker</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libusb-dev</span><br><span class="line">sudo apt-<span class="built_in">get</span> install libgtkmm-2.4-dev</span><br><span class="line">sudo apt-<span class="built_in">get</span> install libavcodec57</span><br><span class="line">sudo apt-<span class="built_in">get</span> install libavformat57</span><br><span class="line">sudo apt-<span class="built_in">get</span> install libswscale4</span><br><span class="line">sudo apt-<span class="built_in">get</span> install libswresample2</span><br><span class="line">sudo apt-<span class="built_in">get</span> install libavutil55</span><br><span class="line">sudo sh install_spinnaker.s</span><br><span class="line">sudo apt-<span class="built_in">get</span> install libudev-dev</span><br><span class="line">sudo apt-<span class="built_in">get</span> install libssl-dev</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Fix-Warning-libcrypto-so-1-1"><a href="#Fix-Warning-libcrypto-so-1-1" class="headerlink" title="Fix Warning: libcrypto.so.1.1"></a>Fix Warning: libcrypto.so.1.1</h4><p>Due to the version of openssl, we may meet a warning when compile as follows:</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line">/usr/bin/ld: <span class="built_in">warning</span>: libcrypto.so<span class="number">.1</span><span class="number">.1</span>, needed <span class="keyword">by</span> //usr/lib/x86_64-linux-gnu/libgdcmCommon.so<span class="number">.2</span><span class="number">.8</span>, may <span class="keyword">conflict</span> <span class="keyword">with</span> libcrypto.so<span class="number">.1</span><span class="number">.0</span><span class="number">.0</span></span><br></pre></td></tr></tbody></table></figure>
<p>We can fix it using the following command.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-get install libssl1.<span class="number">1</span></span><br><span class="line">sudo rm <span class="regexp">/usr/</span>lib<span class="regexp">/x86_64-linux-gnu/</span>libcrypto.so</span><br><span class="line">sudo ln -s <span class="regexp">/usr/</span>lib<span class="regexp">/x86_64-linux-gnu/</span>libcrypto.so.<span class="number">1.1</span> <span class="regexp">/usr/</span>lib<span class="regexp">/x86_64-linux-gnu/</span>libcrypto.so</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Manage-Boot-Options"><a href="#Manage-Boot-Options" class="headerlink" title="Manage Boot Options"></a>Manage Boot Options</h3><p>If there are multiple operations, we can delete other operation systems booting options in the current Ubuntu 18.04.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo vi <span class="regexp">/boot/g</span>rub/grub.cfg</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-QT"><a href="#Install-QT" class="headerlink" title="Install QT"></a>Install QT</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install qt5-default</span><br><span class="line">sudo apt-<span class="built_in">get</span> install qtcreator</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-websocketpp"><a href="#Install-websocketpp" class="headerlink" title="Install websocketpp"></a>Install websocketpp</h3><figure class="highlight q"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install libwebsocketpp-<span class="built_in">dev</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-unrar"><a href="#Install-unrar" class="headerlink" title="Install unrar"></a>Install unrar</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install unrar</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-wireshark"><a href="#Install-wireshark" class="headerlink" title="Install wireshark"></a>Install wireshark</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install wireshark</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Install-vlc"><a href="#Install-vlc" class="headerlink" title="Install vlc"></a>Install vlc</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install vlc</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Install-meld"><a href="#Install-meld" class="headerlink" title="Install meld"></a>Install meld</h3><p><em>meld</em> is a useful file and directory compare tool in Linux, similar with <em>beyondcompare</em> in Windows. </p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install meld</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Install-python3-tk"><a href="#Install-python3-tk" class="headerlink" title="Install python3-tk"></a>Install python3-tk</h3><p><em>python3-tk</em> fix the bug of none-GUI backend of matplotlib</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install python3-tk</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Install-xchm"><a href="#Install-xchm" class="headerlink" title="Install xchm"></a>Install xchm</h3><p><em>xchm</em> can view chm files in Ubuntu.</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install xchm</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Ubuntu</category>
        <category>Installation</category>
        <category>Ubuntu</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>Installation</tag>
        <tag>Setups</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ Tutorials - Debug Experience</title>
    <url>/2019/12/24/C-Coding-Debug-Log/</url>
    <content><![CDATA[<html><head></head><body><p>This article records the representative bugs I met when in c++ coding. The bugs are categorized as C++ standard library and the third-party open source libraries, such as OpenCV, PCL, QT. For each bug, I offer the corresponding solution. Therefore, this article is a debug reference and could help me to fix the bugs when I meet them again. </p>
<span id="more"></span>

<h2 id="C-Standard-Library"><a href="#C-Standard-Library" class="headerlink" title="C++ Standard Library"></a>C++ Standard Library</h2><h3 id="Linking-Error-1"><a href="#Linking-Error-1" class="headerlink" title="Linking Error 1"></a>Linking Error 1</h3><h4 id="Bug"><a href="#Bug" class="headerlink" title="Bug"></a>Bug</h4><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">undefined reference <span class="keyword">to</span> symbol <span class="string">'pthread_create@@GLIBC_2.2.5'</span></span><br><span class="line">/lib/x86_64-linux-gnu/libpthread.so.0: <span class="built_in">error</span> adding symbols: DSO missing <span class="keyword">from</span> command line</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h4><figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(Threads)</span><br><span class="line"><span class="keyword">target_link_libraries</span> (<span class="variable">${PROJECT_NAME}</span> <span class="variable">${CMAKE_THREAD_LIBS_INIT}</span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Bug-1"><a href="#Bug-1" class="headerlink" title="Bug"></a>Bug</h4><figure class="highlight ada"><table><tbody><tr><td class="code"><pre><span class="line">invalid <span class="keyword">use</span> <span class="keyword">of</span> incomplete <span class="keyword">type</span> <span class="type">‘class </span>QDesktopWidget’</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h4><p>It means that the compiler could not understand QDesktopWidget due to not including its definition file.</p>
<figure class="highlight arduino"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDesktopWidget&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Bug-2"><a href="#Bug-2" class="headerlink" title="Bug"></a>Bug</h4><figure class="highlight subunit"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">error: </span>default argument given for parameter</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution"></a>Solution</h4><p>You can declare default arguments in the class declaration or in the function definition, but not both.</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">fun</span><span class="params">(int x <span class="comment">/*= 10*/</span>)</span></span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Bug-3"><a href="#Bug-3" class="headerlink" title="Bug"></a>Bug</h4><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line">segmentation.<span class="symbol">cpp:</span><span class="number">1604</span><span class="symbol">:</span><span class="number">8</span>: <span class="symbol">error:</span> prototype <span class="keyword">for</span> ‘double <span class="title class_">BoxSegment</span><span class="symbol">:</span><span class="symbol">:computeWeightedCovarianceMatrix</span>(const <span class="title class_">Ptr</span>&amp;, const <span class="title class_">Eigen</span><span class="symbol">:</span><span class="symbol">:Matrix&lt;float</span>, <span class="number">4</span>, <span class="number">1</span>&gt;&amp;, const std::vector&lt;float&gt;&amp;, <span class="title class_">Eigen</span><span class="symbol">:</span><span class="symbol">:Matrix&lt;float</span>, <span class="number">3</span>, <span class="number">3</span>&gt;&amp;)’ does <span class="keyword">not</span> match any <span class="keyword">in</span> <span class="keyword">class</span> ‘<span class="title class_">BoxSegment</span>’</span><br><span class="line"> double <span class="title class_">BoxSegment</span><span class="symbol">:</span><span class="symbol">:compute</span>(const pcl::<span class="title class_">PointCloud</span>&lt;pcl::<span class="title class_">Point</span>XYZ&gt;<span class="symbol">:</span><span class="symbol">:Ptr&amp;</span> src_cloud,</span><br><span class="line">        ^~~~~~~~~~</span><br><span class="line"><span class="title class_">In</span> file included from segmentation.<span class="symbol">cpp:</span><span class="number">1</span><span class="symbol">:</span><span class="number">0</span>:</span><br><span class="line">segmentation.<span class="symbol">h:</span><span class="number">120</span><span class="symbol">:</span><span class="number">11</span>: <span class="symbol">error:</span> candidate <span class="symbol">is:</span> float <span class="title class_">BoxSegment</span><span class="symbol">:</span><span class="symbol">:computeWeightedCovarianceMatrix</span>(const <span class="title class_">Ptr</span>&amp;, const <span class="title class_">Eigen</span><span class="symbol">:</span><span class="symbol">:Matrix&lt;float</span>, <span class="number">4</span>, <span class="number">1</span>&gt;&amp;, const std::vector&lt;float&gt;&amp;, <span class="title class_">Eigen</span><span class="symbol">:</span><span class="symbol">:Matrix&lt;float</span>, <span class="number">3</span>, <span class="number">3</span>&gt;&amp;)</span><br><span class="line">     float compute(const pcl::<span class="title class_">PointCloud</span>&lt;pcl::<span class="title class_">Point</span>XYZ&gt;<span class="symbol">:</span><span class="symbol">:Ptr&amp;</span> src_cloud,</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Solution-3"><a href="#Solution-3" class="headerlink" title="Solution"></a>Solution</h4><p>The declaration and definition of a function in a class have to match with each other.</p>
<figure class="highlight php"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">float</span> <span class="title class_">BoxSegment</span>::<span class="title function_ invoke__">compute</span>(<span class="keyword">const</span> pcl::<span class="variable constant_">PointCloud</span>&lt;pcl::<span class="variable constant_">PointXYZ</span>&gt;::<span class="variable constant_">Ptr</span>&amp; src_cloud,</span><br></pre></td></tr></tbody></table></figure>
<h2 id="OpenCV"><a href="#OpenCV" class="headerlink" title="OpenCV"></a>OpenCV</h2><h2 id="PCL"><a href="#PCL" class="headerlink" title="PCL"></a>PCL</h2><h2 id="QT"><a href="#QT" class="headerlink" title="QT"></a>QT</h2></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>C++</category>
        <category>Programming</category>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>Tutorials</tag>
        <tag>Debug</tag>
      </tags>
  </entry>
  <entry>
    <title>PCL Tutorials - From Mathematics to Code Snippets</title>
    <url>/2019/12/10/PCL-Tutorials/</url>
    <content><![CDATA[<html><head></head><body><p>The <a href="http://www.pointclouds.org/">Point Cloud Library</a> (<a href="http://www.pointclouds.org/">PCL</a>) is a large scale, open project for point cloud processing. The PCL framework contains numerous state-of-the-art algorithms including filtering, feature estimation, surface reconstruction, registration, model fitting and segmentation. PCL is cross-platform, and has been successfully compiled and deployed on Linux, MacOS, Windows, and Android/iOS. To simplify development, PCL is split into a series of smaller code libraries, that can be compiled separately. This modularity is important for distributing PCL on platforms with reduced computational or size constraints. In this article, I will provide a series of tutorials of how to use a variety of PCL modules to process point cloud data, which could help you to quickly build, verify, and deploy new 3D perception algorithms. </p>
<span id="more"></span>
<h2 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h2><h3 id="Load-PCD-Files"><a href="#Load-PCD-Files" class="headerlink" title="Load PCD Files"></a>Load PCD Files</h3><h3 id="Save-PCD-Files"><a href="#Save-PCD-Files" class="headerlink" title="Save PCD Files"></a>Save PCD Files</h3><h2 id="Visualization"><a href="#Visualization" class="headerlink" title="Visualization"></a>Visualization</h2><p>There are multiple visualization tools in PCL, of which <a href="http://docs.pointclouds.org/trunk/classpcl_1_1visualization_1_1_p_c_l_visualizer.html">PCLVisualizer</a> is a powerful one. It is developed based on VTK and it provides many useful customization interfaces, which is the main reason I prefer to use it.</p>
<h3 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h3><figure class="highlight zephir"><table><tbody><tr><td class="code"><pre><span class="line">#include &lt;pcl/io/pcd_io.h&gt;</span><br><span class="line">#include &lt;pcl/point_types.h&gt;</span><br><span class="line">#include &lt;pcl/visualization/pcl_visualizer.h&gt;</span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span><br><span class="line">{</span><br><span class="line">    std::string file_path(<span class="string">"../data/demo.pcd"</span>);</span><br><span class="line"></span><br><span class="line">    pcl::PointCloud&lt;pcl::PointXYZ&gt;::Ptr cloud(<span class="keyword">new</span> pcl::PointCloud&lt;pcl::PointXYZ&gt;);</span><br><span class="line">    <span class="keyword">if</span>(pcl::io::loadPCDFile&lt;pcl::PointXYZ&gt;(file_path, *cloud) == <span class="number">-1</span>)</span><br><span class="line">    {</span><br><span class="line">        std::cout &lt;&lt; <span class="string">"Could not load the PCD file: "</span> &lt;&lt; file_path &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    boost::shared_ptr&lt;pcl::visualization::PCLVisualizer&gt; viewer(<span class="keyword">new</span> pcl::visualization::PCLVisualizer(<span class="string">"PCD Viewer"</span>));</span><br><span class="line">    viewer-&gt;setBackgroundColor(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    viewer-&gt;addCoordinateSystem(<span class="number">1.0</span>);</span><br><span class="line">    viewer-&gt;initCameraParameters();</span><br><span class="line">    viewer-&gt;addPointCloud&lt;pcl::PointXYZ&gt;(cloud, file_path);</span><br><span class="line">    viewer-&gt;setPointCloudRenderingProperties(pcl::visualization::PCL_VISUALIZER_POINT_SIZE, <span class="number">2</span>, file_path);</span><br><span class="line">    viewer-&gt;setPointCloudRenderingProperties(pcl::visualization::PCL_VISUALIZER_OPACITY, <span class="number">1.0</span>, file_path);</span><br><span class="line">    viewer-&gt;spin();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Customization"><a href="#Customization" class="headerlink" title="Customization"></a>Customization</h3><h4 id="Add-amp-Remove-PointCloud"><a href="#Add-amp-Remove-PointCloud" class="headerlink" title="Add &amp; Remove PointCloud"></a>Add &amp; Remove PointCloud</h4><figure class="highlight xl"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">viewer</span>-&gt;</span>addPointCloud&lt;pcl::PointXYZ&gt;(cloud, file_path);</span><br><span class="line"><span class="function"><span class="title">viewer</span>-&gt;</span>removePointCloud(file_path)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Add-Coordinate"><a href="#Add-Coordinate" class="headerlink" title="Add Coordinate"></a>Add Coordinate</h4><figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">viewer</span>-&gt;addCoordinateSystem(<span class="number">1</span>.<span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>Note that the color of the added coordinate system is red, green, and blue. Red axis represents x direction. Green axis represents y direction. And Blue axis represents z direction.</p>
<h4 id="Set-Point-Size"><a href="#Set-Point-Size" class="headerlink" title="Set Point Size"></a>Set Point Size</h4><figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">viewer-&gt;set<span class="constructor">PointCloudRenderingProperties(<span class="params">pcl</span>::<span class="params">visualization</span>::PCL_VISUALIZER_POINT_SIZE, 2, <span class="params">file_path</span>)</span>;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Set-Opacity"><a href="#Set-Opacity" class="headerlink" title="Set Opacity"></a>Set Opacity</h4><figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">viewer-&gt;set<span class="constructor">PointCloudRenderingProperties(<span class="params">pcl</span>::<span class="params">visualization</span>::PCL_VISUALIZER_OPACITY, 1.0, <span class="params">file_path</span>)</span>;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Set-Point-Color"><a href="#Set-Point-Color" class="headerlink" title="Set Point Color"></a>Set Point Color</h4><figure class="highlight rust"><table><tbody><tr><td class="code"><pre><span class="line">pcl::visualization::PointCloudColorHandlerCustom&lt;pcl::PointXYZ&gt; <span class="title function_ invoke__">x_color</span>(cloud_x, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">viewer_x<span class="punctuation">-&gt;</span>addPointCloud&lt;pcl::PointXYZ&gt;(cloud_x, x_color, <span class="string">"cloud_x"</span>);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Mouse-Event"><a href="#Mouse-Event" class="headerlink" title="Mouse Event"></a>Mouse Event</h3><h3 id="Keyboard-Event"><a href="#Keyboard-Event" class="headerlink" title="Keyboard Event"></a>Keyboard Event</h3><h2 id="Filters"><a href="#Filters" class="headerlink" title="Filters"></a>Filters</h2><h3 id="PassThrough"><a href="#PassThrough" class="headerlink" title="PassThrough"></a>PassThrough</h3><p><a href="http://docs.pointclouds.org/1.8.0/classpcl_1_1_pass_through.html#details">PassThrough</a> is a simple but useful filter that select points in a point cloud based on the limit intervals on one dimensional axis. It iterates through the entire input point cloud, automatically filtering non-finite points and the points outside the interval specified by <strong>setFilterLimits()</strong>, which applies only to the field specified by <strong>setFilterFieldName()</strong>.</p>
<figure class="highlight lasso"><table><tbody><tr><td class="code"><pre><span class="line">pcl<span class="type">::PointCloud</span>&lt;pcl<span class="type">::PointXYZ</span>&gt;<span class="type">::Ptr</span> cloud (<span class="literal">new</span> pcl<span class="type">::PointCloud</span>&lt;pcl<span class="type">::PointXYZ</span>&gt;);</span><br><span class="line">pcl<span class="type">::PointCloud</span>&lt;pcl<span class="type">::PointXYZ</span>&gt;<span class="type">::Ptr</span> cloud_x (<span class="literal">new</span> pcl<span class="type">::PointCloud</span>&lt;pcl<span class="type">::PointXYZ</span>&gt;);</span><br><span class="line">pcl<span class="type">::PointCloud</span>&lt;pcl<span class="type">::PointXYZ</span>&gt;<span class="type">::Ptr</span> cloud_xy (<span class="literal">new</span> pcl<span class="type">::PointCloud</span>&lt;pcl<span class="type">::PointXYZ</span>&gt;);</span><br><span class="line">pcl<span class="type">::PointCloud</span>&lt;pcl<span class="type">::PointXYZ</span>&gt;<span class="type">::Ptr</span> cloud_xyz (<span class="literal">new</span> pcl<span class="type">::PointCloud</span>&lt;pcl<span class="type">::PointXYZ</span>&gt;);</span><br><span class="line"><span class="comment">// code to load pcd</span></span><br><span class="line"></span><br><span class="line">pcl<span class="type">::PassThrough</span>&lt;pcl<span class="type">::PointXYZ</span>&gt; pass;</span><br><span class="line"><span class="comment">// select points in x direction</span></span><br><span class="line">pass.setInputCloud (cloud);</span><br><span class="line">pass.setFilterFieldName(<span class="string">"x"</span>);</span><br><span class="line">pass.setFilterLimits(<span class="number">-1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">pass.filter (*cloud_x);</span><br><span class="line"></span><br><span class="line"><span class="comment">// select points in y direction</span></span><br><span class="line">pass.setInputCloud(cloud_x);</span><br><span class="line">pass.setFilterFieldName(<span class="string">"y"</span>);</span><br><span class="line">pass.setFilterLimits(<span class="number">0</span>, <span class="number">0.5</span>);</span><br><span class="line">pass.filter (*cloud_xy);</span><br><span class="line"></span><br><span class="line"><span class="comment">// select points in z direction</span></span><br><span class="line">pass.setInputCloud(cloud_xy);</span><br><span class="line">pass.setFilterFieldName(<span class="string">"z"</span>);</span><br><span class="line">pass.setFilterLimits(<span class="number">-1.5</span>, <span class="number">-0.5</span>);</span><br><span class="line">pass.filter (*cloud_xyz);</span><br></pre></td></tr></tbody></table></figure>



<h2 id="Segmentation"><a href="#Segmentation" class="headerlink" title="Segmentation"></a>Segmentation</h2></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Point Cloud Library</category>
        <category>Perception</category>
        <category>3D</category>
      </categories>
      <tags>
        <tag>Tutorials</tag>
        <tag>Point Cloud Library</tag>
        <tag>PCL</tag>
      </tags>
  </entry>
  <entry>
    <title>Tensorflow Tutorials - Learning Notes for Beginners</title>
    <url>/2020/02/26/Tensorflow-Learning-Notes/</url>
    <content><![CDATA[<html><head></head><body><p>Tensorflow is a popular end to end deep learning platform developed and maintained by google. It has a whole ecosystem from prototype verification to model deployment. It integrates high level Keras API which could let us build and train models quickly and easily. Besides, it also has low level APIs, which enable us to custom model conveniently. Tensorflow is welcome to researchers and engineers since it is released and thus is widely used in both scientific research and industrial applications. Many state-of-the-art works had published open sources in Tensorflow. In this article, I will write down the key notes during learning Tensorflow. </p>
<span id="more"></span>
<h3 id="Basic-Usage"><a href="#Basic-Usage" class="headerlink" title="Basic Usage"></a>Basic Usage</h3><h4 id="tf-name-scope"><a href="#tf-name-scope" class="headerlink" title="tf.name_scope"></a>tf.name_scope</h4><p>This context manager pushes a name scope, which will make the name of all operations added within it have a prefix.</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">def my<span class="constructor">_op(<span class="params">a</span>, <span class="params">b</span>, <span class="params">c</span>, <span class="params">name</span>=None)</span>:</span><br><span class="line">  <span class="keyword">with</span> tf.name<span class="constructor">_scope(<span class="string">"MyOp"</span>)</span> <span class="keyword">as</span> scope:</span><br><span class="line">    a = tf.convert<span class="constructor">_to_tensor(<span class="params">a</span>, <span class="params">name</span>=<span class="string">"a"</span>)</span></span><br><span class="line">    b = tf.convert<span class="constructor">_to_tensor(<span class="params">b</span>, <span class="params">name</span>=<span class="string">"b"</span>)</span></span><br><span class="line">    c = tf.convert<span class="constructor">_to_tensor(<span class="params">c</span>, <span class="params">name</span>=<span class="string">"c"</span>)</span></span><br><span class="line">    # Define some computation that uses `a`, `b`, <span class="keyword">and</span> `c`.</span><br><span class="line">    return foo<span class="constructor">_op(<span class="operator">...</span>, <span class="params">name</span>=<span class="params">scope</span>)</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="tf-expand-dims"><a href="#tf-expand-dims" class="headerlink" title="tf.expand_dims"></a>tf.expand_dims</h4><p>Returns a tensor with an additional dimension inserted at index axis.</p>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">t = <span class="string">[[1, 2, 3],[4, 5, 6]]</span> # shape [<span class="number">2</span>, <span class="number">3</span>] </span><br><span class="line">tf.expand_dims(t, <span class="number">0</span>) </span><br><span class="line">tf.expand_dims(t, <span class="number">-1</span>) # Last dimension index. In this case, same as <span class="number">2.</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="tf-squeeze"><a href="#tf-squeeze" class="headerlink" title="tf.squeeze"></a>tf.squeeze</h4><p>Removes dimensions of size 1 from the shape of a tensor.</p>
<figure class="highlight mipsasm"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 't' is a tensor of shape [1, 2, 1, 3, 1, 1]</span></span><br><span class="line">tf.<span class="keyword">shape(tf.squeeze(t)) </span> <span class="comment"># [2, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 't' is a tensor of shape [1, 2, 1, 3, 1, 1]</span></span><br><span class="line">tf.<span class="keyword">shape(tf.squeeze(t, </span>[<span class="number">2</span>, <span class="number">4</span>]))  <span class="comment"># [1, 2, 3, 1]</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="tf-repeat"><a href="#tf-repeat" class="headerlink" title="tf.repeat"></a>tf.repeat</h4><p>The operation repeats the elements in a tensor along a specified axis. </p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">x</span> = tf.Variable(tf.random_normal(shape=(<span class="number">2</span>, <span class="number">6</span>, <span class="number">3</span>)))</span><br><span class="line"><span class="attribute">repeats</span> =<span class="meta"> [2, 3]</span></span><br><span class="line"><span class="attribute">y</span> = tf.repeat(x, repeats=repeats, axis=<span class="number">0</span>) # y.shape=(<span class="number">5</span>(<span class="number">2</span>+<span class="number">3</span>), <span class="number">6</span>, <span class="number">3</span>)</span><br><span class="line"><span class="attribute">repeats</span> =<span class="meta"> [2, 3, 4]</span></span><br><span class="line"><span class="attribute">y</span> = tf.repeat(x, repeats=repeats, axis=<span class="number">2</span>) # y.shape=(<span class="number">2</span>, <span class="number">6</span>, <span class="number">9</span>(<span class="number">2</span>+<span class="number">3</span>+<span class="number">4</span>))</span><br></pre></td></tr></tbody></table></figure>

<h4 id="tf-matmul"><a href="#tf-matmul" class="headerlink" title="tf.matmul"></a>tf.matmul</h4><p>In math, matrix multiplication are defined for 2-D matrix. The tf.matmul also follows this law in Tensorflow. Moreover, tf.matmul supports matrix multiplication for matrix which rank &gt; 2. In this case, tf.matmul just slice the most inner 2 dimension of the matrix to do normal matrix multiplication operation and treat other outer dimensions as batch dimensions. For example, C’s shape is (a, b, n, k) in the following operation.</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">A = tf.<span class="constructor">Variable(<span class="params">tf</span>.<span class="params">random_normal</span>(<span class="params">shape</span>=(<span class="params">a</span>, <span class="params">b</span>, <span class="params">n</span>, <span class="params">m</span>)</span>))</span><br><span class="line">B = tf.<span class="constructor">Variable(<span class="params">tf</span>.<span class="params">random_normal</span>(<span class="params">shape</span>=(<span class="params">a</span>, <span class="params">b</span>, <span class="params">m</span>, <span class="params">k</span>)</span>))</span><br><span class="line">C = tf.matmul(A, B) # <span class="module-access"><span class="module"><span class="identifier">C</span>.</span></span>shape=(a, b, n, k)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="tf-transpose"><a href="#tf-transpose" class="headerlink" title="tf.transpose"></a>tf.transpose</h4><p>In mathematics, transpose is a general matrix operation. For example, transpose will exchange the row elements with column elements for a 2-D matrix. In tensorflow, transpose is a similar operation for a tensor. Moreover, it has an extra parameter perm to specify the dimensions to transpose with each other. That is to say, the i-th dimension will transpose with perm[i]-th dimension.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># x.shape=(2, 6)</span></span><br><span class="line"><span class="attribute">x_t</span> = tf.transpose(x) # default perm=[<span class="number">1</span>, <span class="number">0</span>]</span><br><span class="line"><span class="comment"># y.shape=(2, 6, 3)</span></span><br><span class="line"><span class="attribute">y_t</span> = tf.transpose(y, perm=[<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>]) # <span class="number">0</span>-th dimension do not transpose, <span class="number">1</span>-th dimension transposes with <span class="number">2</span>-th (perm[<span class="number">1</span>]) dimension and <span class="number">2</span>-th dimension transposes with <span class="number">1</span>-th (perm[<span class="number">2</span>]) dimension</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Keras-API"><a href="#Keras-API" class="headerlink" title="Keras API"></a>Keras API</h3><p>Keras is a high level API in Tensorflow 2.0, which can be used to build, custom and train deep learning models easily and quickly.</p>
<h4 id="Build-In-Layers"><a href="#Build-In-Layers" class="headerlink" title="Build-In Layers"></a>Build-In Layers</h4><h4 id="Custom-Layers"><a href="#Custom-Layers" class="headerlink" title="Custom Layers"></a>Custom Layers</h4><p>Based on the object-oriented feature of Python, Keras in Tensorflow offers a sub-classing method to custom a Layer.</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Custom Layer</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomLayer</span>(tf.keras.layers.Layer):</span><br><span class="line">    <span class="comment"># __init__ function is called when we make one object of this layer, and parameters can be passed. Usually, operations are defined in it.</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, param, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(CustomLayer, self).__init(**kwargs)</span><br><span class="line">        self.param = param</span><br><span class="line"></span><br><span class="line">    <span class="comment"># build function will be called when the call function first be called and the input_shape will be assigned as the shape of inputs automatically. This layer is used to define the operations that depends on the inputs' shape.</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build</span>(<span class="params">self, input_shape</span>):</span><br><span class="line">        self.batch_size = input_shape[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># call function will do the forward computing operations and it will be invoked when given inputs</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">call</span>(<span class="params">self, inputs, training=<span class="literal">None</span></span>):</span><br><span class="line">        x = self.conv(inputs)</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    <span class="comment"># get_config function will update the configuration information of this layer</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_config</span>(<span class="params">self</span>):</span><br><span class="line">        config=<span class="built_in">super</span>(CustomLayer, self).get_config()</span><br><span class="line">        config.update({</span><br><span class="line">          <span class="string">'param'</span>: self.param</span><br><span class="line">        })</span><br><span class="line">        <span class="keyword">return</span> config</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_config</span>(<span class="params">cls, config</span>):</span><br><span class="line">        <span class="keyword">return</span> cls(**config)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="Build-Models"><a href="#Build-Models" class="headerlink" title="Build Models"></a>Build Models</h4><p>There are three ways to build a model, that is the sequential API, functional API, and the sub-classing API.</p>
<ul>
<li>Sequential API</li>
</ul>
<p><em>keras.Sequntial()</em> will create a model and then we can add layers to this model using its API.</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">import tensorflow as tf</span><br><span class="line"><span class="keyword">from</span> tensorflow.keras import layers</span><br><span class="line"></span><br><span class="line">model = tf.keras.Sequential()</span><br><span class="line"><span class="comment"># Adds a densely-connected layer with 64 units to the model:</span></span><br><span class="line">model.<span class="built_in">add</span>(layers.Dense(64, <span class="attribute">activation</span>=<span class="string">'relu'</span>))</span><br><span class="line"><span class="comment"># Add another:</span></span><br><span class="line">model.<span class="built_in">add</span>(layers.Dense(64, <span class="attribute">activation</span>=<span class="string">'relu'</span>))</span><br><span class="line"><span class="comment"># Add an output layer with 10 output units:</span></span><br><span class="line">model.<span class="built_in">add</span>(layers.Dense(10))</span><br></pre></td></tr></tbody></table></figure>
<p>Sequential API is easy to use but it can only define model of stacking architecture, which limits the ability of customization.</p>
<ul>
<li>Functional API<br>Compared with Sequential API, Functional API has more power to customize models. Besides the stacking architecture, using functional API we can define modes with multiple inputs or outputs, multiple branches, and sharing layers.<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># There are three steps to define a model using functional api.</span></span><br><span class="line"><span class="comment"># The first step is to define the inputs using keras.Input(shape=shape), given the input's shape of the defined model. Note that we shall not give the batch size.</span></span><br><span class="line">inputs = keras.Input(shape=(784,), <span class="attribute">name</span>=<span class="string">'img'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The second step is to define the operations using keras build-in layers or customized layers to obtain the final ouputs</span></span><br><span class="line">x = layers.Dense(64, <span class="attribute">activation</span>=<span class="string">'relu'</span>)(inputs)</span><br><span class="line">x = layers.Dense(64, <span class="attribute">activation</span>=<span class="string">'relu'</span>)(x)</span><br><span class="line">outputs = layers.Dense(10)(x)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The third step is to create the model using keras.Model(), given the inputs and outputs</span></span><br><span class="line">model = keras.Model(<span class="attribute">inputs</span>=inputs, <span class="attribute">outputs</span>=outputs, <span class="attribute">name</span>=<span class="string">'mnist_model'</span>)</span><br></pre></td></tr></tbody></table></figure></li>
<li>Sub-classing API<br>Similarly with customize a layer, we can use the sub-classing feature of Python to define a model.</li>
</ul>
<h4 id="Train-amp-Save-Models"><a href="#Train-amp-Save-Models" class="headerlink" title="Train &amp; Save Models"></a>Train &amp; Save Models</h4><h3 id="Papers"><a href="#Papers" class="headerlink" title="Papers"></a>Papers</h3><h4 id="PointNet-Deep-Learning-on-Point-Sets-for-3D-Classification-and-Segmentation"><a href="#PointNet-Deep-Learning-on-Point-Sets-for-3D-Classification-and-Segmentation" class="headerlink" title="PointNet: Deep Learning on Point Sets for 3D Classification and Segmentation"></a>PointNet: Deep Learning on Point Sets for 3D Classification and Segmentation</h4><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><h4 id="AttributeError-‘int’-object-has-no-attribute-‘value’"><a href="#AttributeError-‘int’-object-has-no-attribute-‘value’" class="headerlink" title="AttributeError: ‘int’ object has no attribute ‘value’"></a>AttributeError: ‘int’ object has no attribute ‘value’</h4><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Bug Code</span></span><br><span class="line"><span class="attr">batch_size</span> = point_cloud.get_shape()[<span class="number">0</span>].value</span><br></pre></td></tr></tbody></table></figure>
<p>The issue is the usage of point_cloud.get_shape()[0].value. In TF 1.x get_shape() works in non-eager mode and returns a list of Dimensions which does have the value. In TF 2.0 get_shape() works in eager mode and returns list of ints so value is not applicable any more.</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Fixed Code</span></span><br><span class="line"><span class="attr">batch_size</span> = point_cloud.get_shape()[<span class="number">0</span>]</span><br></pre></td></tr></tbody></table></figure>
<h4 id="AttributeError-module-‘tensorflow’-has-no-attribute-‘contrib’"><a href="#AttributeError-module-‘tensorflow’-has-no-attribute-‘contrib’" class="headerlink" title="AttributeError: module ‘tensorflow’ has no attribute ‘contrib’"></a>AttributeError: module ‘tensorflow’ has no attribute ‘contrib’</h4><p>In Tensorflow 2.0, contrib attribute was deprecated.</p>
<h4 id="ValueError-Can’t-convert-Python-sequence-with-mixed-types-to-Tensor"><a href="#ValueError-Can’t-convert-Python-sequence-with-mixed-types-to-Tensor" class="headerlink" title="ValueError: Can’t convert Python sequence with mixed types to Tensor."></a>ValueError: Can’t convert Python sequence with mixed types to Tensor.</h4><p>In python, a list can store elements of different types. If a list stores elements of int and of float, Tensorflow could not treat it as an array, thus shall not be used to initialize a Tensor.</p>
<h4 id="ImportError-Failed-to-import-pydot-You-must-install-pydot-and-graphviz-for-pydotprint-to-work"><a href="#ImportError-Failed-to-import-pydot-You-must-install-pydot-and-graphviz-for-pydotprint-to-work" class="headerlink" title="ImportError: Failed to import pydot. You must install pydot and graphviz for pydotprint to work."></a>ImportError: Failed to import pydot. You must install pydot and graphviz for <code>pydotprint</code> to work.</h4><figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">tf.keras.utils.plot<span class="constructor">_model(<span class="params">model</span>, <span class="params">to_file</span>=<span class="params">os</span>.<span class="params">path</span>.<span class="params">join</span>(BASE_DIR, '<span class="params">corint_net</span>.<span class="params">png</span>')</span>, show_shapes=True)</span><br></pre></td></tr></tbody></table></figure>
<p>The error usually happens when we use <em>tf.keras.utils.plot_model</em> to draw the architecture of the model. The main reason is that we do not install pydot and graphviz, therefore the solution is:</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">pip install -i https:<span class="regexp">//</span>pypi.tuna.tsinghua.edu.cn/simple pydot</span><br><span class="line">pip install -i https:<span class="regexp">//</span>pypi.tuna.tsinghua.edu.cn/simple graphviz</span><br><span class="line">sudo apt-get install graphviz</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Tensorflow</category>
        <category>Deep Learning</category>
        <category>Tensorflow</category>
      </categories>
      <tags>
        <tag>Tutorials</tag>
        <tag>Tensorflow</tag>
        <tag>Python</tag>
        <tag>Notes</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ Tutorials - Learning Notes for Beginners</title>
    <url>/2020/03/12/CPlusPlus-Learning-Notes/</url>
    <content><![CDATA[<html><head></head><body><p>Add it latter</p>
<span id="more"></span>
<h3 id="System-APIs"><a href="#System-APIs" class="headerlink" title="System APIs"></a>System APIs</h3><h4 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h4><h4 id="system"><a href="#system" class="headerlink" title="system"></a>system</h4><h4 id="getcwd"><a href="#getcwd" class="headerlink" title="getcwd"></a>getcwd</h4><h4 id="gettimeoftoday"><a href="#gettimeoftoday" class="headerlink" title="gettimeoftoday"></a>gettimeoftoday</h4><h3 id="Build-In-APIs"><a href="#Build-In-APIs" class="headerlink" title="Build-In APIs"></a>Build-In APIs</h3><h4 id="undef"><a href="#undef" class="headerlink" title="undef"></a>undef</h4><h3 id="Third-Party"><a href="#Third-Party" class="headerlink" title="Third-Party"></a>Third-Party</h3></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>C++</category>
      </categories>
      <tags>
        <tag>C++</tag>
        <tag>Tutorials</tag>
      </tags>
  </entry>
  <entry>
    <title>Usage of ASUS RT-AC86U - Firmware Upgrade and Plugin Installation</title>
    <url>/2020/12/11/Usage-of-ASUS-RT-AC86U-Firmware-Upgrade-and-Plugin-Installation/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://www.asus.com/us/Networking/RT-AC86U/">Asus RT-AC86U</a> is a professional dual band gigabit WiFi router, which has arm structure. Moreover, it has officially supported open source firmware, which has much more powerful functions, such like running official and third-part plugins on it. In this article, I will show you how to upgrade its firmware to highly customized version, install shadowsocks plugin and config v2ray service.</p>
<span id="more"></span>
<p>NOTE： There is a reset button on the back of Asus RT-AC86U, if there is anything wrong when upgrading the firmware, we can hold the button for seconds (maybe 30s) to reset the router.</p>
<p>The recommended firmware is developed based on <a href="https://github.com/RMerl/asuswrt-merlin.ng">asuswrt-merlin</a>, and we can download it at <a href="https://koolshare.cn/thread-127878-1-1.html">koolshare</a>.</p>
<ul>
<li>Firmware Upgrade<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">Login ASUS RT-AC86U</span><br><span class="line">系统管理 -&gt; 固件升级 -&gt; 上传</span><br></pre></td></tr></tbody></table></figure>
Choose the downloaded firmware and upload, it will automatically upgrade to the uploaded version. The process takes about 1-2 mins.</li>
<li>Install Shadowsocks Plugin<br>All the plugins are managed in software center. For some reason, we can not download and install shadowsocks from the software center directly and we have to download the <a href="https://github.com/hq450/fancyss_history_package/tree/master/fancyss_hnd">source code</a> and install it manually. <figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">软件中心 -&gt; 离线安装 -&gt; 上传并安装</span><br></pre></td></tr></tbody></table></figure>
<img data-src="/2020/12/11/Usage-of-ASUS-RT-AC86U-Firmware-Upgrade-and-Plugin-Installation/shadowsocks.png"><br>Probably, it could prompt that “illegal keywords is detected and could not install”. In this scenario, we have to login the router through ssh and install it using command line.<br>First, we have to open the ssh function.<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">系统管理 -&gt; 系统设置 -&gt; 启用SSH (LAN only)</span><br></pre></td></tr></tbody></table></figure>
Second, login using a computer in lan and install.<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">ssh admin@10.10.10.1</span><br><span class="line">sed -i <span class="string">'s/\tdetect_package/\t# detect_package/g'</span> /koolshare/scripts/ks_tar_install.sh</span><br><span class="line"><span class="built_in">cd</span> /tmp/upload</span><br><span class="line">tar -xzf shadowsocks_1.9.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> shadowsocks</span><br><span class="line"><span class="built_in">chmod</span> +x install.sh</span><br><span class="line">./install.sh</span><br></pre></td></tr></tbody></table></figure>
After running the above command line, we will sea the shadowsocks plugin in software center. If we want to use the v2ray function, we have to config virtual memory for a better performance. Prepare an USB storage (USB 3.0 is recommended) and format it as ext4. Then download and install the virtual memory plugin directly from software center.</li>
</ul>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Shadowsocks</category>
      </categories>
      <tags>
        <tag>Setups</tag>
        <tag>RT-AC86U</tag>
        <tag>Shadowsocks</tag>
        <tag>V2Ray</tag>
      </tags>
  </entry>
  <entry>
    <title>Python Tutorials - Learning Notes for Beginners</title>
    <url>/2020/02/25/Python-Learning-Notes/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://www.python.org/">Python</a> is an interpreted, high-level, general-purpose programming language. Created by Guido van Rossum and first released in 1991, Python’s design philosophy emphasizes code readability with its notable use of significant whitespace. Its language constructs and object-oriented approach aim to help programmers write clear, logical code for small and large-scale projects. There are many third-party open-source packages and modules, such as numpy, keras, tensorflow, pytorch, which makes it widely used in scientific computing, data mining, deep learning. This article is used to record the key points of python that are useful for Python learning, especially for beginners.</p>
<span id="more"></span>

<h3 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h3><h4 id="Import"><a href="#Import" class="headerlink" title="Import"></a>Import</h4><p>Module is compact way to manage code in separate files in Python. In one module, we can use code defined in other modules by importing them, which is named import machinery. The <em>import</em> statement is the most common way of invoking the importing machinery, but it is not the only one. The module <em>importlib</em> and the build-in function <em><strong>import</strong>()</em> can also be used to import modules.</p>
<p>When one module is imported using import statement, the importing machinery will first search the module in paths listed in <em>sys.path</em>, if found, Python interpreted will create a module object and initialize it. <em>sys.path</em> contains the directory path that contains the current running python script file and all the environment values in <em>PYTHONPATH</em>. Using the following code, we can add extra directories to <em>sys.path</em>.</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"># <span class="keyword">Get</span> the directory <span class="type">path</span> <span class="keyword">of</span> the <span class="keyword">current</span> running module</span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">sys.path.append(BASE_DIR)</span><br><span class="line"># <span class="keyword">Add</span> other directory paths </span><br><span class="line">sys.path.append(os.path.<span class="keyword">join</span>(BASE_DIR, <span class="string">'models'</span>))</span><br><span class="line">sys.path.append(os.path.<span class="keyword">join</span>(BASE_DIR, <span class="string">'utils'</span>))</span><br></pre></td></tr></tbody></table></figure>

<p>Function <em><strong>import</strong>()</em> is c implementation of import, while <em>importlib</em> is a pure python implemented module that provide rich APIs interacting with import machinery. The main difference between using <em>importlib</em> and <em>import</em> statement is that <em>importlib</em> can programmatically import modules, given the modules’ name as a string variable.</p>
<p>There are several importing related module attributes that will be assigned during importing before execute code, such as <em><strong>name</strong></em> and <em><strong>file</strong></em>.</p>
<h4 id="Memory-Address"><a href="#Memory-Address" class="headerlink" title="Memory Address"></a>Memory Address</h4><ul>
<li>id(object)</li>
</ul>
<p>This function returns the identity of an object, that is an integer keeps constant and unique during the lifetime of the object. We can treat it as the address in memory.</p>
<h4 id="Assignment"><a href="#Assignment" class="headerlink" title="Assignment"></a>Assignment</h4><p>Python is an object-centered language, which is different memory-centered language, such as C and C++. Therefore, assignment in python behaves differently also. Assignment a variable is binding the variable to an object as an alias name. Then we can use the bind variable to reference the object.</p>
<p>When an assignment invoked, Python interpreter first search whether the object exits in memory. If the object exists, then a new alias name is bind to the object. If the object does not exist, then Python interpreter creates a new object and bind the variable to the newly created object. Note that one object can be bind with multiple variables.</p>
<p>When an object is mutable, we can change the value of this object by any variable assigned to it. We can retrieve the updated value of this object by other variable referenced to it. When an object is immutable, any variable referenced to it can not change its value. In this case, change the value is a new assignment operation, that creates a new object and assigns the variable to it.</p>
<h4 id="Arguments-Passing"><a href="#Arguments-Passing" class="headerlink" title="Arguments Passing"></a>Arguments Passing</h4><p>For C family language, there are two ways to pass arguments to function, call by value and call by reference. But Python is different. We can treat argument passing as an assignment operation, which binding the argument variable to object.</p>
<h3 id="Modules"><a href="#Modules" class="headerlink" title="Modules"></a>Modules</h3><h4 id="future"><a href="#future" class="headerlink" title="future"></a><strong>future</strong></h4><figure class="highlight angelscript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, division, print_function, unicode_literals</span><br></pre></td></tr></tbody></table></figure>

<p>A <a href="https://docs.python.org/3/reference/simple_stmts.html#future">future statement</a> is a directive to the compiler that a particular module should be compiled using syntax or semantics that will be available in a specified future release of Python where the feature becomes standard.</p>
<p>The future statement is intended to ease migration to future versions of Python that introduce incompatible changes to the language. It allows use of the new features on a per-module basis before the release in which the feature becomes standard.</p>
<p>The future statement will provide support for running your code on Python 2.6, 2.7, and 3.3+ mostly unchanged. It means that we can write standard Python 3 code without worry about its compatibility on Python 2 by putting future statement at the beginning of the code.</p>
<figure class="highlight coffeescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># division_demo.py</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="built_in">print</span> <span class="number">11</span>/<span class="number">4</span></span><br></pre></td></tr></tbody></table></figure>
<p>Run division_demo.py in python 2, the output will be 2.75. However, if without <em>from <strong>future</strong> import division</em>, the output will be 2. Because without <em>from <strong>future</strong> import division</em>, <em>/</em> is mapped to the <strong>div()</strong> build-in method by Python 2 interpreter, while with it, <em>/</em> is mapped to the <strong>truediv()</strong> method, which is a build-in method in Python 3.</p>
<figure class="highlight coffeescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># print_demo.py</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> <span class="built_in">print</span></span><br><span class="line"><span class="built_in">print</span></span><br></pre></td></tr></tbody></table></figure>
<p><em>print</em> becomes a build-in method in Python 3, losing its special properties as a keyword in Python 2. Similarly, <em>from <strong>future</strong> import print</em> makes <em>print</em> as a build-in method when running on Python 2. The print_demo.py will output:</p>
<figure class="highlight ada"><table><tbody><tr><td class="code"><pre><span class="line">&lt;built-<span class="keyword">in</span> <span class="keyword">function</span> <span class="title">print&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<p>In order to use <em>with</em> as a Python keyword in Python 2.5 or older, we will need to use <em>from <strong>future</strong> import with_statement</em>.</p>
<h4 id="argparse"><a href="#argparse" class="headerlink" title="argparse"></a>argparse</h4><p><em>argparse</em> is the recommended module for command line parsing in Python standard library. We can use this module to let the users to pass argument parameters to the code in command line. The basic usage of <em>argparse</em> is:</p>
<figure class="highlight abnf"><table><tbody><tr><td class="code"><pre><span class="line">import argparse</span><br><span class="line"><span class="attribute">parser</span> <span class="operator">=</span> argparse.ArgumentParser()</span><br><span class="line">parser.add_argument()</span><br><span class="line"><span class="attribute">args</span> <span class="operator">=</span> parser.parse_args()</span><br></pre></td></tr></tbody></table></figure>
<p><em>argparse</em> can automatically generate help descriptions using the string we assigned to help argument.</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line"># We can add a summary description <span class="keyword">of</span> the <span class="keyword">module</span>.</span><br><span class="line">parser = argparse.<span class="constructor">ArgumentParser(<span class="params">description</span>='Describe <span class="params">the</span> <span class="params">function</span> <span class="params">and</span> <span class="params">purpose</span> <span class="params">of</span> <span class="params">this</span> <span class="params">module</span>.')</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Positional Argument</li>
</ul>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">import argparse</span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">"square"</span>, <span class="attribute">help</span>=<span class="string">"display a square of a given number"</span>, <span class="attribute">type</span>=int)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"><span class="built_in">print</span>(args.square*<span class="number">*2</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>The identification of positional argument is determined by its position sequence. And the positional arguments are mandatory. If not providing positional arguments in command line, the Python interpreter will invoke exceptions.</p>
<ul>
<li>Optional Argument</li>
</ul>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">import argparse</span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">"square"</span>, <span class="attribute">type</span>=int, <span class="attribute">help</span>=<span class="string">"display a square of a given number"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"-v"</span>, <span class="string">"--verbose"</span>, <span class="attribute">action</span>=<span class="string">"store_true"</span>, <span class="attribute">help</span>=<span class="string">"increase output verbosity"</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line">answer = args.square*<span class="number">*2</span></span><br><span class="line"><span class="keyword">if</span> args.verbose:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"the square of {} equals {}"</span>.format(args.square, answer))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(answer)</span><br></pre></td></tr></tbody></table></figure>
<p>Difference between positional argument and optional argument is that optional argument has “-“ or “–” before argument name. Action <em>store_true</em> indicates that the default value of the argument is false, once the argument is invoked in command line, its value becomes true.</p>
<p>We can also add default value for other types.</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">import argparse</span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument(<span class="string">"--kernel_size"</span>, <span class="attribute">type</span>=int, <span class="attribute">default</span>=3, <span class="attribute">help</span>=<span class="string">"convolutional kernel size"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--learning_rate"</span>, <span class="attribute">type</span>=float, <span class="attribute">default</span>=0.01, <span class="attribute">help</span>=<span class="string">"convolutional kernel size"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--log_dir"</span>, <span class="attribute">default</span>=<span class="string">"log"</span>, <span class="attribute">help</span>=<span class="string">"log directory"</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Advance"><a href="#Advance" class="headerlink" title="Advance"></a>Advance</h3><h4 id="if-name-x3D-x3D-“main“"><a href="#if-name-x3D-x3D-“main“" class="headerlink" title="if name == “main“"></a>if <strong>name</strong> == “<strong>main</strong>“</h4><p>For a program written by a complied language, such as C++, there must exist an entry, the main() function, from which the program start to execute. However, Python as an interpreted language, has no entry function main(). When executing the code, all the code at level 0 indentation (no indentation) gets executed, including the definitions of functions and classes. Note that the code in functions or classes are level 1 or larger indentation, which will not execute.</p>
<p>As far as we all know, we can directly execute the code using <em>Python code.py</em> or execute the code in other code files by <em>import code.py</em>. How to make the two ways execute different code? <em>if <strong>name</strong> == “<strong>main</strong>“</em> provides us a solution. When we run the code using <em>Python code.py</em>, the interpreter will set the value of the special variable <em><strong>name</strong></em> as <em>“<strong>main</strong>“</em> before execute level 0 indentation code. Then the interpreter execute the level 0 indentation code as well as the level 1 indentation code in <em>if <strong>name</strong> == “<strong>main</strong>“</em>.</p>
<p>When we import the code into other module using <em>import code.py</em>, the interpreter will set the value of the special variable as <em>“code”</em> that is the name of the module. In this case, the level 1 indentation code in <em>if <strong>name</strong> == “<strong>main</strong>“</em> will not be executed.</p>
<h4 id="Module-VS-Package"><a href="#Module-VS-Package" class="headerlink" title="Module VS. Package"></a>Module VS. Package</h4><p>A module is one python file. Its name is the file’s base name without the .py extension. A module can be execute directly or be imported by other modules.</p>
<p>A package is a directory of a collection of python modules with an extra <strong>init</strong>.py. Its name is the name of the directory. Packages can be nested to any depth similar with directories, as long as each directory contains a <strong>init</strong>.py. </p>
<h4 id="Context-Manager-and-With-Statement"><a href="#Context-Manager-and-With-Statement" class="headerlink" title="Context Manager and With Statement"></a>Context Manager and With Statement</h4><p>Context Manager is an easy way that Python offers to safely manage resources. Usually, with statement is the right way to invoke a context manager. There are two ways to build a context manager.</p>
<ul>
<li><p>Class: <strong>enter</strong>() and <strong>exit</strong>()<br>If we define <em><strong>enter</strong>()</em> and <em><strong>exit</strong>()</em> in a class, then the class could be a context manager. Usually, we return the object as the resource we intend to safely released in <em><strong>enter</strong>()</em>, then we can do operations in the body of with statement. And we have to manually release the object in <em><strong>exit</strong>()</em>. When the body of with statement is executed, <em><strong>exit</strong>()</em> is automatically invoked, thus the resource is released.</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Python program showing </span></span><br><span class="line"><span class="comment"># file management using  </span></span><br><span class="line"><span class="comment"># context manager </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FileManager</span>(): </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, filename, mode</span>): </span><br><span class="line">        self.filename = filename </span><br><span class="line">        self.mode = mode </span><br><span class="line">        self.file = <span class="literal">None</span></span><br><span class="line">          </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>): </span><br><span class="line">        self.file = <span class="built_in">open</span>(self.filename, self.mode) </span><br><span class="line">        <span class="keyword">return</span> self.file</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_value, exc_traceback</span>): </span><br><span class="line">        self.file.close() </span><br><span class="line">  </span><br><span class="line"><span class="comment"># loading a file  </span></span><br><span class="line"><span class="keyword">with</span> FileManager(<span class="string">'test.txt'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f: </span><br><span class="line">    f.write(<span class="string">'Test'</span>) </span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Function: @contextmanager and yield<br>The <em>contextmanager</em> decorator will make a function as a context manager. <em>yield</em> works like the return in <em><strong>enter</strong>()</em> and all the code after <em>yield</em> is like in <em><strong>exit</strong>()</em>.</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> contextmanager</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">open_file</span>(<span class="params">name</span>):</span><br><span class="line">    f = <span class="built_in">open</span>(name, <span class="string">'w'</span>)</span><br><span class="line">    <span class="keyword">yield</span> f</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open_file(<span class="string">'some_file'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">'hola!'</span>)</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h4 id="virtualenv"><a href="#virtualenv" class="headerlink" title="virtualenv"></a>virtualenv</h4><p><a href="https://virtualenv.pypa.io/en/latest/">virtualenv</a> is a useful tool for creating isolated virtual python environment. We can setup a special version of python environment to run some code without polluting the operation system’s python environment. When we do not need the environment, we can directly delete the folder.</p>
<ul>
<li>Install<figure class="highlight ada"><table><tbody><tr><td class="code"><pre><span class="line">pip install virtualenv</span><br><span class="line">virtualenv <span class="comment">--version</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>Usage<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> project_dir</span><br><span class="line">virtualenv venv</span><br><span class="line"><span class="comment"># start</span></span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line"><span class="comment"># Install packages</span></span><br><span class="line">pip install numpy</span><br><span class="line">pip install tensorflow</span><br><span class="line"><span class="comment"># end</span></span><br><span class="line">deactivate</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><h4 id="Matplotlib-non-GUI-backend"><a href="#Matplotlib-non-GUI-backend" class="headerlink" title="Matplotlib non-GUI backend"></a>Matplotlib non-GUI backend</h4><p>Matplotlib is currently using agg, which is a non-GUI backend, so cannot show the figure.</p>
<figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> python3-tk</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Python</category>
        <category>Programming</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Tutorials</tag>
        <tag>Python</tag>
        <tag>Notes</tag>
      </tags>
  </entry>
  <entry>
    <title>Basic Usage of PostgreSQL</title>
    <url>/2023/02/11/Basic-Usage-of-PostgreSQL/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://www.postgresql.org/">PostgreSQL</a> is a powerful, open source object-relational database system with over 35 years of active development that has earned it a strong reputation for reliability, feature robustness, and performance. Here I will introduce some basic commands of PostgreSQL</p>
<span id="more"></span>
<h2 id="Default-User"><a href="#Default-User" class="headerlink" title="Default User"></a>Default User</h2><p>PostgreSQL creates a default user named <strong>postgres</strong> for you after installation. The default user has full access to PostgreSQL’s database, including creating a new database, reading data from a database, and updating data into a database. </p>
<h3 id="Reset-Password"><a href="#Reset-Password" class="headerlink" title="Reset Password"></a>Reset Password</h3><p>If we want to use PostgreSQL in Django applications, the password is required. However, the default user <strong>postgres</strong> doesn’t have a password and we must set password for <strong>postgres</strong>.</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line">sudo -u postgres psql</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">USER</span> postgres <span class="keyword">WITH</span> <span class="keyword">PASSWORD</span> <span class="string">'12345678'</span>;</span><br><span class="line">\q</span><br><span class="line">service postgresql <span class="keyword">restart</span> / systemctl <span class="keyword">restart</span> postgresql</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Basic-Command"><a href="#Basic-Command" class="headerlink" title="Basic Command"></a>Basic Command</h2><ul>
<li>Check status<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">service postgresql status</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>Start psql with user postgres<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo -u postgres psql</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>Create Database<figure class="highlight n1ql"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> servo;</span><br></pre></td></tr></tbody></table></figure></li>
<li>List Databases<figure class="highlight livescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">\l</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>List Users<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">\<span class="built_in">du</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>Connect to database<figure class="highlight livescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">\c</span> servo</span><br></pre></td></tr></tbody></table></figure></li>
<li>List tables<figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line">\<span class="selector-tag">dt</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>Quit<figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line">\<span class="selector-tag">q</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>Show data<figure class="highlight axapta"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> xxx_table</span><br></pre></td></tr></tbody></table></figure></li>
<li>Show data directory<figure class="highlight abnf"><table><tbody><tr><td class="code"><pre><span class="line">show data_directory<span class="comment">;</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h2 id="Backup-amp-Restore"><a href="#Backup-amp-Restore" class="headerlink" title="Backup &amp; Restore"></a>Backup &amp; Restore</h2><h3 id="Backup"><a href="#Backup" class="headerlink" title="Backup"></a>Backup</h3><figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line">sudo -u postgres pg_dump -Fc servo &gt; servo.bak</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Restore"><a href="#Restore" class="headerlink" title="Restore"></a>Restore</h3><figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line">sudo -u postgres pg_restore -Fc -d servo &lt; /var/lib/postgresql/servo.bak</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>PostgreSQL</category>
        <category>Django</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Expose Local Devices Behind A NAT To The Internet Using frp</title>
    <url>/2023/02/15/Expose-Local-Devices-Behind-A-NAT-To-The-Internet-Using-FRP/</url>
    <content><![CDATA[<html><head></head><body><p>Nowadays, there are lots of intelligent devices at home, such as a personal web server or a NAS. It is quite convenient if we can visit these devices anywhere and anytime. However, the home network provides by broadband providers is usually in a local network and doesn’t have a public IP. Therefore, it is difficult to visit the device at home. <a href="https://github.com/fatedier/frp"><strong>frp</strong></a> is a reverse proxy that can penetrate the broadband providers’ local network and make the devices at home available on the Internet. I will teach you how to deploy a reverse proxy using <strong>frp</strong> step by step. Note that you must have a server with a public IP available on the Internet.</p>
<span id="more"></span>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><h4 id="Confirm-Machine-Architecture"><a href="#Confirm-Machine-Architecture" class="headerlink" title="Confirm Machine Architecture"></a>Confirm Machine Architecture</h4><p>Open a terminal and check the machine architecture of your server using <strong>arch</strong> command.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">arch</span></span><br></pre></td></tr></tbody></table></figure>
<p>If the result is <strong>x86_64</strong>, we can download <strong>amd64</strong> version of <strong>frp</strong>.</p>
<h4 id="Download"><a href="#Download" class="headerlink" title="Download"></a>Download</h4><p>Go the release page of <strong>frp</strong> on GitHub and download the latest release. The os of my server is Ubuntu 18.04, thus I download **frp_0.47.0_linux_amd64.tar.gz<br>** using the following command.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/fatedier/</span>frp<span class="regexp">/releases/</span>download<span class="regexp">/v0.47.0/</span>frp_0.<span class="number">47.0</span>_linux_amd64.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<p>After download, mv the file to the root dir <strong>“/“</strong>, which is more convenient to run it.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">mv</span> frp_0.<span class="number">47</span>.<span class="number">0</span>_linux_amd64.tar.gz ~/..</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Installation-1"><a href="#Installation-1" class="headerlink" title="Installation"></a>Installation</h4><p>The files we download contains the execution and configuration files of <strong>frp</strong> well complied and built using the source code. Unzip them using the following command.</p>
<figure class="highlight jboss-cli"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">cd</span></span><br><span class="line"><span class="keyword">cd</span> <span class="string">..</span></span><br><span class="line">tar -zxvf frp_0.47.0_linux_amd64.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<p>And delete the compressed file.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">rm</span> frp_0.<span class="number">47</span>.<span class="number">0</span>_linux_amd64.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Server-Configuration"><a href="#Server-Configuration" class="headerlink" title="Server Configuration"></a>Server Configuration</h3><p>Go to the directory and show the files.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">cd</span> frp_0.<span class="number">47</span>.<span class="number">0</span>_linux_amd64</span><br><span class="line"><span class="attribute">ls</span></span><br></pre></td></tr></tbody></table></figure>
<p>You will see the following files.</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">├── frpc</span><br><span class="line">├── frpc_full<span class="selector-class">.ini</span></span><br><span class="line">├── frpc<span class="selector-class">.ini</span></span><br><span class="line">├── frps</span><br><span class="line">├── frps_full<span class="selector-class">.ini</span></span><br><span class="line">├── frps<span class="selector-class">.ini</span></span><br><span class="line">├── LICENSE</span><br></pre></td></tr></tbody></table></figure>
<p><strong>frps</strong> and <strong>frps.ini</strong> are the execution and configuration files for server and <strong>frpc</strong> and <strong>frpc.ini</strong> are the files for client.<br>Open <strong>frps.ini</strong> using vim and modify it as follows.</p>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">vi</span> frps.ini</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">token</span> = <span class="number">12345678</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="number">7500</span></span><br><span class="line"><span class="attr">dashboard_user</span> = admin</span><br><span class="line"><span class="attr">dashboard_pwd</span> = <span class="number">12345678</span></span><br><span class="line"><span class="attr">vhost_http_port</span> = <span class="number">10080</span></span><br><span class="line"><span class="attr">vhost_https_port</span> = <span class="number">10443</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>bind_port</strong> set the port used by frps on the server</li>
<li><strong>token</strong> is used by frpc to verify the connection</li>
<li><strong>dashboard</strong> let us check the status of the frps using port 7500.</li>
</ul>
<p>Run the server and test the configuration by the following command.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">./frps -c frps.ini</span><br></pre></td></tr></tbody></table></figure>
<p>If we see the following log, congratulations, the <strong>frps</strong> is deployed successfully.</p>
<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">2023</span><span class="regexp">/02/</span><span class="number">13</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">24</span> [I] [root.go:<span class="number">206</span>] frps uses config <span class="keyword">file</span>: frps.ini</span><br><span class="line"><span class="number">2023</span><span class="regexp">/02/</span><span class="number">13</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">24</span> [I] [service.go:<span class="number">200</span>] frps tcp listen on <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">7000</span></span><br><span class="line"><span class="number">2023</span><span class="regexp">/02/</span><span class="number">13</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">24</span> [I] [service.go:<span class="number">261</span>] http service listen on <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">10080</span></span><br><span class="line"><span class="number">2023</span><span class="regexp">/02/</span><span class="number">13</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">24</span> [I] [service.go:<span class="number">276</span>] https service listen on <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">10443</span></span><br><span class="line"><span class="number">2023</span><span class="regexp">/02/</span><span class="number">13</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">24</span> [I] [service.go:<span class="number">317</span>] Dashboard listen on <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">7500</span></span><br><span class="line"><span class="number">2023</span><span class="regexp">/02/</span><span class="number">13</span> <span class="number">23</span>:<span class="number">54</span>:<span class="number">24</span> [I] [root.go:<span class="number">215</span>] frps started successfully</span><br></pre></td></tr></tbody></table></figure>
<p>You can check the status of <strong>frps</strong> via “<a href="http://127.0.0.1:7500/">http://127.0.0.1:7500</a>“.<br>If we close the ssh connection or terminal, <strong>frps</strong> will stop. <strong>nohup</strong> command can help to make frps run continually in the background ignoring hangup signals.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">nohup</span> ./frps -c frps.ini &amp;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Client-Configuration"><a href="#Client-Configuration" class="headerlink" title="Client Configuration"></a>Client Configuration</h3><p>Put <strong>frpc</strong> and <strong>frpc.ini</strong> on the client. Edit <strong>frpc.ini</strong> as follows.</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">server_addr</span> = <span class="number">8.8</span>.<span class="number">8.8</span></span><br><span class="line"><span class="attr">server_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">token</span> = <span class="number">11232035</span></span><br><span class="line"><span class="attr">log_file</span> = /dev/null</span><br><span class="line"><span class="attr">log_level</span> = info</span><br><span class="line"><span class="attr">log_max_days</span> = <span class="number">3</span></span><br><span class="line"><span class="attr">tcp_mux</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">protocol</span> = tcp</span><br><span class="line"><span class="attr">login_fail_exit</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">user</span> = RT-AC86U</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>server_addr</strong> is the public IP of your server</li>
<li><strong>server_port</strong> is bind_port we set in frps.ini, the client will send data to the server’s bind port.</li>
<li><strong>token</strong> is the token we set in frps.ini, which is used for authentication</li>
<li><strong>log</strong> lines configure the log directory and log level and days to keep.</li>
<li><strong>tcp</strong> lines configure the connection between the server and client is tcp.<br>After the general <figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[router]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">80</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">7080</span></span><br><span class="line"><span class="attr">use_encryption</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">use_compression</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[git]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">10.10</span>.<span class="number">10.10</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">30000</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">30000</span></span><br><span class="line"><span class="attr">use_encryption</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">use_compression</span> = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[git-ssh]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">10.10</span>.<span class="number">10.10</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">30001</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">30001</span></span><br><span class="line"><span class="attr">use_encryption</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">use_compression</span> = <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>frp</category>
      </categories>
      <tags>
        <tag>frp</tag>
      </tags>
  </entry>
  <entry>
    <title>Click-Through Rate Prediction Using GBDT and Linear Regression with Avazu Dataset</title>
    <url>/2020/12/20/Click-Through-Rate-Prediction-Using-GBDT-With-Avazu-Dataset/</url>
    <content><![CDATA[<html><head></head><body><p>In online advertising and online shopping, Click-Through Rate (CTR) is a good metric to evaluate the quality of advertisement recommendation and goods recommendation. CTR prediction is one of the main challenges in building an intelligent recommendation system. It aims to predict the probability of an customer clicking the recommended items, which helps us to explore the interests of customers and to choose items for an customer from the massive amount of items effectively and usefully. In this article, I will show you how to build a CTR prediction model using machine learning methods and avazu dataset. Python, pandas,matplotlib, seaborn, xgboost, scikit-learning are used in this article.   </p>
<span id="more"></span>
<h3 id="Definition-of-Click-Through-Rate"><a href="#Definition-of-Click-Through-Rate" class="headerlink" title="Definition of Click-Through Rate"></a>Definition of Click-Through Rate</h3><p>When we visit a shopping application or a news application, we will see lots of commodities or news that those applications recommend to us and we will click some of the presented commodities or news that we are interested to see the detailed information. In the field of recommendation system, the commodities and news are called item and the presented items are defined as exposed items. When a customer visit a application such as amazon, the application will recommend items that the customer may be interested and hope the customer will click more exposed items. More clicked items means the application knows better about the customer’s interests and therefore recommends higher quality items. </p>
<p>Usually, we use Click-Through Rate (CTR) to evaluate the performance of a recommendation system. CTR is defined as the ratio between the number of clicked items and exposed items, formulated as Eq. $\eqref{eq1}$<br>$$<br>\begin{equation}<br>ctr=\frac{n_{clk}}{n_{exp}}<br>\label{eq1}<br>\end{equation}<br>$$</p>
<h3 id="Introduction-of-Avazu-Dataset"><a href="#Introduction-of-Avazu-Dataset" class="headerlink" title="Introduction of Avazu Dataset"></a>Introduction of Avazu Dataset</h3><p><a href="https://www.kaggle.com/c/avazu-ctr-prediction/overview">Avazu Dataset</a> is a click-through rate prediction competition sponsored by Avazu. </p>
<ul>
<li>Train Set<br>10 days of click-through data, ordered chronologically. Non-clicks and clicks are subsampled according to different strategies.</li>
<li>Test Set<br>1 day of ads to for testing your model predictions.</li>
</ul>
<h3 id="Exploratory-Data-Analysis"><a href="#Exploratory-Data-Analysis" class="headerlink" title="Exploratory Data Analysis"></a>Exploratory Data Analysis</h3><p>In this section, I will analyze the correlation of each column of the raw data with respect to the label and visualize the result using pandas, matplotlib and seaborn.</p>
<ul>
<li>Split Train Set</li>
</ul>
<p>The train set contains 10 days of click-through data and is a csv file with size as 6.3 Gb. It takes more than 24.0 Gb’s memory to load the whole train set using pandas, which requires a higher performance hardware. Therefore, it is better to split the large train set csv file as small ones.</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">#! /usr/bin/Python</span><br><span class="line">import pandas <span class="keyword">as</span> pd</span><br><span class="line">import numpy <span class="keyword">as</span>  np</span><br><span class="line">from matplotlib import pyplot <span class="keyword">as</span> plt</span><br><span class="line">from collections import Counter</span><br><span class="line">import seaborn <span class="keyword">as</span> sns</span><br><span class="line">import json</span><br><span class="line">import datetime</span><br><span class="line">from sklearn import preprocessing</span><br><span class="line">from sklearn.model_selection import StratifiedShuffleSplit</span><br><span class="line">sns.set<span class="literal">()</span></span><br><span class="line"></span><br><span class="line">avazu = pd.read<span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train</span>.<span class="params">csv</span>', <span class="params">nrows</span>=10000000)</span></span><br><span class="line">avazu.<span class="keyword">to</span><span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train_01</span>.<span class="params">csv</span>', <span class="params">header</span>=True, <span class="params">index</span>=False)</span></span><br><span class="line">avazu = pd.read<span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train</span>.<span class="params">csv</span>', <span class="params">skiprows</span>=<span class="params">range</span>(1, 10000000)</span>, nrows=<span class="number">10000000</span>)</span><br><span class="line">avazu.<span class="keyword">to</span><span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train_02</span>.<span class="params">csv</span>', <span class="params">header</span>=True, <span class="params">index</span>=False)</span></span><br><span class="line">avazu = pd.read<span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train</span>.<span class="params">csv</span>', <span class="params">skiprows</span>=<span class="params">range</span>(1, 20000000)</span>, nrows=<span class="number">10000000</span>)</span><br><span class="line">avazu.<span class="keyword">to</span><span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train_03</span>.<span class="params">csv</span>', <span class="params">header</span>=True, <span class="params">index</span>=False)</span></span><br><span class="line">avazu = pd.read<span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train</span>.<span class="params">csv</span>', <span class="params">skiprows</span>=<span class="params">range</span>(1, 30000000)</span>, nrows=<span class="number">10000000</span>)</span><br><span class="line">avazu.<span class="keyword">to</span><span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train_04</span>.<span class="params">csv</span>', <span class="params">header</span>=True, <span class="params">index</span>=False)</span></span><br><span class="line">avazu = pd.read<span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train</span>.<span class="params">csv</span>', <span class="params">skiprows</span>=<span class="params">range</span>(1, 40000000)</span>, nrows=<span class="number">10000000</span>)</span><br><span class="line">avazu.<span class="keyword">to</span><span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train_05</span>.<span class="params">csv</span>', <span class="params">header</span>=True, <span class="params">index</span>=False)</span></span><br></pre></td></tr></tbody></table></figure>

<pre><code>* skiprows - the index of skip rows, supports scalar or array input
* nrows - the number of rows to load
</code></pre>
<ul>
<li>Random Sampling</li>
</ul>
<p>It is more efficient to do exploratory data analysis using a smaller dataset that has same distribution with the raw dataset. We can randomly sample from the raw dataset using <strong>StratifiedShuffleSplit</strong> imported form <strong>sklearn.model_selection</strong>.</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">avazu = pd.read_csv(<span class="string">'../data/avazu/train_01.csv'</span>)</span><br><span class="line">split = StratifiedShuffleSplit(<span class="attribute">n_splits</span>=1, <span class="attribute">train_size</span>=0.05, <span class="attribute">test_size</span>=0.05, <span class="attribute">random_state</span>=42)</span><br><span class="line"><span class="keyword">for</span> train_index, test_index <span class="keyword">in</span> split.split(avazu, avazu[<span class="string">"click"</span>]):</span><br><span class="line">    strat_train_set = avazu.loc[train_index]</span><br><span class="line">    <span class="built_in">print</span>(strat_train_set.<span class="built_in">info</span>())</span><br><span class="line">    strat_test_set = avazu.loc[test_index]</span><br><span class="line">    <span class="built_in">print</span>(strat_test_set.<span class="built_in">info</span>())</span><br><span class="line">    strat_train_set.to_csv(<span class="string">"../data/train_sample_01.csv"</span>, header = <span class="literal">True</span>, <span class="attribute">index</span>=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Merge Sampling<br>Merge the sampled data into one file.<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">avazu_01 = pd.read<span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train_sample_01</span>.<span class="params">csv</span>')</span></span><br><span class="line">avazu_02 = pd.read<span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train_sample_02</span>.<span class="params">csv</span>')</span></span><br><span class="line">avazu_03 = pd.read<span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train_sample_03</span>.<span class="params">csv</span>')</span></span><br><span class="line">avazu_04 = pd.read<span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">avazu</span><span class="operator">/</span><span class="params">train_sample_04</span>.<span class="params">csv</span>')</span></span><br><span class="line">avazu = avazu_01.append(<span class="literal">[<span class="identifier">avazu_02</span>, <span class="identifier">avazu_03</span>, <span class="identifier">avazu_04</span>]</span>)</span><br><span class="line">avazu.<span class="keyword">to</span><span class="constructor">_csv('..<span class="operator">/</span><span class="params">data</span><span class="operator">/</span><span class="params">train_sample</span>.<span class="params">csv</span>', <span class="params">header</span>=True, <span class="params">index</span>=False)</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>Basic Info<br>Load the sampled data and print the basic information.<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">avazu = pd<span class="selector-class">.read_csv</span>(<span class="string">'../data/avazu/train_sample.csv'</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(avazu.head()</span></span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(avazu.info()</span></span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(list(avazu.columns)</span></span>)</span><br></pre></td></tr></tbody></table></figure>
<img alt="Head data of the train sample" data-src="/2020/12/20/Click-Through-Rate-Prediction-Using-GBDT-With-Avazu-Dataset/head.png"><br>The info of the train sample is shown as follows.<figure class="highlight tap"><table><tbody><tr><td class="code"><pre><span class="line">&lt;class 'pandas.core.frame.DataFrame'&gt;</span><br><span class="line">RangeIndex:<span class="number"> 2000000 </span>entries,<span class="number"> 0 </span>to 1999999</span><br><span class="line">Data columns (total<span class="number"> 24 </span>columns):</span><br><span class="line"> <span class="comment">#   Column            Dtype  </span></span><br><span class="line">---  ------            -----  </span><br><span class="line"><span class="number"> 0 </span>  id                float64</span><br><span class="line"><span class="number"> 1 </span>  click             int64  </span><br><span class="line"><span class="number"> 2 </span>  hour              int64  </span><br><span class="line"><span class="number"> 3 </span>  C1                int64  </span><br><span class="line"><span class="number"> 4 </span>  banner_pos        int64  </span><br><span class="line"><span class="number"> 5 </span>  site_id           object </span><br><span class="line"><span class="number"> 6 </span>  site_domain       object </span><br><span class="line"><span class="number"> 7 </span>  site_category     object </span><br><span class="line"><span class="number"> 8 </span>  app_id            object </span><br><span class="line"><span class="number"> 9 </span>  app_domain        object </span><br><span class="line"><span class="number"> 10 </span> app_category      object </span><br><span class="line"><span class="number"> 11 </span> device_id         object </span><br><span class="line"><span class="number"> 12 </span> device_ip         object </span><br><span class="line"><span class="number"> 13 </span> device_model      object </span><br><span class="line"><span class="number"> 14 </span> device_type       int64  </span><br><span class="line"><span class="number"> 15 </span> device_conn_type  int64  </span><br><span class="line"><span class="number"> 16 </span> C14               int64  </span><br><span class="line"><span class="number"> 17 </span> C15               int64  </span><br><span class="line"><span class="number"> 18 </span> C16               int64  </span><br><span class="line"><span class="number"> 19 </span> C17               int64  </span><br><span class="line"><span class="number"> 20 </span> C18               int64  </span><br><span class="line"><span class="number"> 21 </span> C19               int64  </span><br><span class="line"><span class="number"> 22 </span> C20               int64  </span><br><span class="line"><span class="number"> 23 </span> C21               int64  </span><br><span class="line">dtypes: float64(1), int64(14), object(9)</span><br><span class="line">memory usage: 366.2+ MB</span><br><span class="line">None</span><br></pre></td></tr></tbody></table></figure>
The columns are shown as follows.<figure class="highlight scheme"><table><tbody><tr><td class="code"><pre><span class="line">[<span class="symbol">'id</span>', <span class="symbol">'click</span>', <span class="symbol">'hour</span>', <span class="symbol">'C1</span>', <span class="symbol">'banner_pos</span>', <span class="symbol">'site_id</span>', <span class="symbol">'site_domain</span>', <span class="symbol">'site_category</span>', <span class="symbol">'app_id</span>', <span class="symbol">'app_domain</span>', <span class="symbol">'app_category</span>', <span class="symbol">'device_id</span>', <span class="symbol">'device_ip</span>', <span class="symbol">'device_model</span>', <span class="symbol">'device_type</span>', <span class="symbol">'device_conn_type</span>', <span class="symbol">'C14</span>', <span class="symbol">'C15</span>', <span class="symbol">'C16</span>', <span class="symbol">'C17</span>', <span class="symbol">'C18</span>', <span class="symbol">'C19</span>', <span class="symbol">'C20</span>', <span class="symbol">'C21</span>']</span><br></pre></td></tr></tbody></table></figure>
The first column is the index, the second column is the label, the third row the time when the record happened, column 3 and 16-23 are categorical features with dtype as int64, column 5-7 are site features, column 8-10 are app features, column 11-15 are device features.</li>
<li>Label Encode of Categorical Features<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> column <span class="keyword">in</span> <span class="selector-attr">[<span class="string">'C1'</span>, <span class="string">'site_id'</span>, <span class="string">'site_domain'</span>, <span class="string">'site_category'</span>, <span class="string">'app_id'</span>, <span class="string">'app_domain'</span>, <span class="string">'app_category'</span>, <span class="string">'device_id'</span>, <span class="string">'device_ip'</span>, <span class="string">'device_model'</span>]</span>:</span><br><span class="line">    enc = preprocessing<span class="selector-class">.LabelEncoder</span>()</span><br><span class="line">    avazu<span class="selector-attr">[column]</span> = enc<span class="selector-class">.fit_transform</span>(avazu<span class="selector-attr">[column]</span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(avazu.info()</span></span>)</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(avazu.head()</span></span>)</span><br></pre></td></tr></tbody></table></figure></li>
<li>Feature Visualization<ul>
<li>Distribution of positive and negative labels  <figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">sns<span class="selector-class">.countplot</span>(x=avazu<span class="selector-attr">[<span class="string">'click'</span>]</span>)</span><br><span class="line">plt<span class="selector-class">.show</span>()</span><br></pre></td></tr></tbody></table></figure>
  <img alt="Distribution of positive and negative labels" data-src="/2020/12/20/Click-Through-Rate-Prediction-Using-GBDT-With-Avazu-Dataset/click-distribution.png"></li>
<li>Distribution of Banner Position and Label  <figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sns.countplot(<span class="attribute">x</span>=<span class="string">'banner_pos'</span>, <span class="attribute">hue</span>=<span class="string">'click'</span>, <span class="attribute">data</span>=avazu) #广告位置</span><br><span class="line">plt.show()</span><br></pre></td></tr></tbody></table></figure>
  <img alt="Distribution of banner position with respect to labels" data-src="/2020/12/20/Click-Through-Rate-Prediction-Using-GBDT-With-Avazu-Dataset/banner-pos.png"></li>
<li>Distribution of Site Category and Label  <figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sns.countplot(<span class="attribute">x</span>=<span class="string">'site_category'</span>, <span class="attribute">hue</span>=<span class="string">'click'</span>, <span class="attribute">data</span>=avazu)</span><br><span class="line">plt.show()</span><br></pre></td></tr></tbody></table></figure>
  <img alt="Distribution of site category with respect to labels" data-src="/2020/12/20/Click-Through-Rate-Prediction-Using-GBDT-With-Avazu-Dataset/site-cate.png"></li>
<li>Distribution of Application Category and Label  <figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sns.countplot(<span class="attribute">x</span>=<span class="string">'app_category'</span>, <span class="attribute">hue</span>=<span class="string">'click'</span>, <span class="attribute">data</span>=avazu)</span><br><span class="line">plt.show()</span><br></pre></td></tr></tbody></table></figure>
  <img alt="Distribution of application category with respect to labels" data-src="/2020/12/20/Click-Through-Rate-Prediction-Using-GBDT-With-Avazu-Dataset/app-cate.png"></li>
<li>Distribution of Device Type and Label  <figure class="highlight haskell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="title">sns</span>.countplot(x = <span class="string">"device_type"</span>, hue = <span class="string">"click"</span>, <span class="class"><span class="keyword">data</span> = avazu)</span></span><br><span class="line"><span class="title">plt</span>.show()</span><br></pre></td></tr></tbody></table></figure>
  <img alt="Distribution of device type with respect to labels" data-src="/2020/12/20/Click-Through-Rate-Prediction-Using-GBDT-With-Avazu-Dataset/device-type.png"></li>
<li>Covariance of Features  <figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">avazu_drop = avazu<span class="selector-class">.drop</span>(<span class="attribute">columns</span>=[<span class="string">'id'</span>])</span><br><span class="line">avazu_corr = avazu_drop<span class="selector-class">.corr</span>()</span><br><span class="line">plt<span class="selector-class">.figure</span>(figsize=(<span class="number">20</span>, <span class="number">18</span>))</span><br><span class="line">sns<span class="selector-class">.heatmap</span>(avazu_corr<span class="selector-class">.abs</span>(), annot=True)</span><br><span class="line">plt<span class="selector-class">.show</span>()</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(avazu_corr[<span class="string">'click'</span>].sort_values(ascending=False)</span></span>)</span><br></pre></td></tr></tbody></table></figure>
  <img alt="Covariance of Features" data-src="/2020/12/20/Click-Through-Rate-Prediction-Using-GBDT-With-Avazu-Dataset/corr.png"><br>  As we can see, C1 and devece_type have high correlation with each other, C14 and C17 have high correlation with each other</li>
</ul>
</li>
</ul>
<h3 id="Data-Preprocess"><a href="#Data-Preprocess" class="headerlink" title="Data Preprocess"></a>Data Preprocess</h3><h3 id="Hyper-Parameters-Search"><a href="#Hyper-Parameters-Search" class="headerlink" title="Hyper Parameters Search"></a>Hyper Parameters Search</h3><h3 id="Feature-Selection-Using-GBDT"><a href="#Feature-Selection-Using-GBDT" class="headerlink" title="Feature Selection Using GBDT"></a>Feature Selection Using GBDT</h3><h3 id="Linear-Regression-Model"><a href="#Linear-Regression-Model" class="headerlink" title="Linear Regression Model"></a>Linear Regression Model</h3></body></html>]]></content>
      <categories>
        <category>Deep Learning</category>
        <category>Click-Through Rate Prediction</category>
      </categories>
      <tags>
        <tag>Deep Learning</tag>
        <tag>Python</tag>
        <tag>Click-Through Rate(CTR)</tag>
        <tag>Machine Learning</tag>
        <tag>Pandas</tag>
        <tag>Matplotlib</tag>
        <tag>Seaborn</tag>
        <tag>XGBoost</tag>
      </tags>
  </entry>
  <entry>
    <title>Solution For node&#39;s Warning: Accessing non-existent property &#39;column&#39; of module exports inside circular dependency</title>
    <url>/2023/02/19/Solution-For-npm-s-Warning-Accessing-non-existent-property-column-of-module-exports-inside-circular-dependency/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://docs.npmjs.com/about-npm"><strong>npm</strong></a> is the world’s largest software registry, which can help to share and manage packages. <a href="https://blog.zhaoyongsheng.com/2019/12/01/Build-and-Deploy-Your-Personal-Blog-Using-Hexo-NexT-and-GitHub/">Hexo</a> uses <strong>npm</strong> to install and upgrade its dependency packages. When the version of <strong>node</strong> is 14 or latter, you probably meets this annoying warning “Warning: Accessing non-existent property ‘column’ of module exports inside circular dependency”. Here I will show you how to solve this problem using the method that verified by myself.</p>
<span id="more"></span>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>When we use <strong>Hexo</strong> command lines, there are some annoying warnings.</p>
<figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">(<span class="keyword">node</span><span class="title">:82677</span>) Warning: Accessing non-existent <span class="keyword">property</span><span class="title"> </span>'lineno' of module exports inside circular dependency</span><br><span class="line">(Use `<span class="keyword">node</span> <span class="title">--trace-warnings</span> ...` to show where the warning was created)</span><br><span class="line">(<span class="keyword">node</span><span class="title">:82677</span>) Warning: Accessing non-existent <span class="keyword">property</span><span class="title"> </span>'column' of module exports inside circular dependency</span><br><span class="line">(<span class="keyword">node</span><span class="title">:82677</span>) Warning: Accessing non-existent <span class="keyword">property</span><span class="title"> </span>'filename' of module exports inside circular dependency</span><br><span class="line">(<span class="keyword">node</span><span class="title">:82677</span>) Warning: Accessing non-existent <span class="keyword">property</span><span class="title"> </span>'lineno' of module exports inside circular dependency</span><br><span class="line">(<span class="keyword">node</span><span class="title">:82677</span>) Warning: Accessing non-existent <span class="keyword">property</span><span class="title"> </span>'column' of module exports inside circular dependency</span><br><span class="line">(<span class="keyword">node</span><span class="title">:82677</span>) Warning: Accessing non-existent <span class="keyword">property</span><span class="title"> </span>'filename' of module exports inside circular dependency</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>As said by <a href="https://github.com/hexojs/hexo/issues/4257">Hexo Issue 4257</a>, these warnings are because the <strong>node</strong>‘s version is 14 and there are compatible issues in package <strong>stylus</strong>. There is one recommend solution is that downgrade your node to 12 to avoid this annoying warning. Since I don’t want to use the lower version of <strong>Node</strong>, I didn’t try this method.</p>
<p>Some posts in <a href="https://github.com/stylus/stylus/issues/2534">Stylus Issue 2534</a> said that this problem is fixed by <a href="mailto:stylus@0.54.8">stylus@0.54.8</a>. I have installed <strong>stylus 0.54.8</strong> or even <strong>0.59.0</strong> by force, but these warnings still exit. It seems that the problem I met is different and can’t solved by upgrade <strong>stylus</strong> to <strong>0.54.8</strong> or latter. </p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p>With <strong>trace-warnings</strong> option, we can trace the detail info about these warnings.</p>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line">npx <span class="keyword">cross</span>-env NODE_OPTIONS=<span class="string">"--trace-warnings"</span> hexo <span class="keyword">generate</span></span><br></pre></td></tr></tbody></table></figure>
<p>The log shows that these warnings is generate by <strong>stylus</strong>.</p>
<h3 id="Dependency-of-stylus"><a href="#Dependency-of-stylus" class="headerlink" title="Dependency of stylus"></a>Dependency of <strong>stylus</strong></h3><p>Using the following command to show the dependency of <strong>stylus</strong>.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">npm <span class="built_in">ls</span> stylus </span><br></pre></td></tr></tbody></table></figure>
<p>We will see the result. </p>
<figure class="highlight mel"><table><tbody><tr><td class="code"><pre><span class="line">hexo-site@0<span class="number">.0</span><span class="number">.0</span> /Gits/blog-github</span><br><span class="line">├─┬ hexo-<span class="keyword">renderer</span>-stylus@0<span class="number">.2</span><span class="number">.3</span></span><br><span class="line">│ ├─┬ nib@1<span class="number">.2</span><span class="number">.0</span></span><br><span class="line">│ │ └── stylus@0<span class="number">.59</span><span class="number">.0</span> deduped</span><br><span class="line">│ └── stylus@0<span class="number">.50</span><span class="number">.0</span></span><br><span class="line">├─┬ stylus-native-loader@1<span class="number">.4</span><span class="number">.9</span></span><br><span class="line">│ └── stylus@0<span class="number">.59</span><span class="number">.0</span> deduped</span><br><span class="line">└── stylus@0<span class="number">.59</span><span class="number">.0</span></span><br></pre></td></tr></tbody></table></figure>
<p>As we can see, the <strong><a href="mailto:hexo-site@0.0.0">hexo-site@0.0.0</a></strong> depends on <strong><a href="mailto:hexo-renderer-stylus@0.2.3">hexo-renderer-stylus@0.2.3</a></strong> and <strong><a href="mailto:hexo-renderer-stylus@0.2.3">hexo-renderer-stylus@0.2.3</a></strong> depends on <strong><a href="mailto:stylus@0.50.0">stylus@0.50.0</a></strong>. These warnings are fixed by <strong><a href="mailto:stylus@0.54.8">stylus@0.54.8</a></strong> or later. </p>
<h3 id="Update-package-json-of-hexo-renderer-stylus"><a href="#Update-package-json-of-hexo-renderer-stylus" class="headerlink" title="Update package.json of hexo-renderer-stylus"></a>Update package.json of <strong>hexo-renderer-stylus</strong></h3><p>Let <strong>hexo-renderer-stylus</strong> use <strong><a href="mailto:stylus@0.54.8">stylus@0.54.8</a></strong> or later may fix this issue. Open package.json. </p>
<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line">vi node_modules<span class="regexp">/hexo-renderer-stylus/</span><span class="keyword">package</span>.json</span><br></pre></td></tr></tbody></table></figure>
<p>And update the dependency of stylus.</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">"dependencies"</span><span class="punctuation">:</span> <span class="punctuation">{</span></span><br><span class="line">    <span class="attr">"minimatch"</span><span class="punctuation">:</span> <span class="string">"^3.0.2"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"nib"</span><span class="punctuation">:</span> <span class="string">"^1.1.0"</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">"stylus"</span><span class="punctuation">:</span> <span class="string">"^0.54.8"</span></span><br><span class="line">  <span class="punctuation">}</span><span class="punctuation">,</span></span><br></pre></td></tr></tbody></table></figure>
<p>Finally, install the dependency.</p>
<figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">npm <span class="keyword">install</span></span><br></pre></td></tr></tbody></table></figure>
<p>After installation, we try <strong>Hexo</strong> command line to test these warnings are shown or not. If they are not shown anymore, congratulations, you fix this issue successfully. </p>
<h3 id="Another-Solution"><a href="#Another-Solution" class="headerlink" title="Another Solution"></a>Another Solution</h3><p>The reason that <strong>hexo-renderer-stylus</strong> depends <strong><a href="mailto:stylus@0.50.0">stylus@0.50.0</a></strong> is <strong>hexo-renderer-stylus</strong>‘s version is too low to use higher version of <strong>stylus</strong>. Thus the solution is to upgrade <strong>hexo-renderer-stylus</strong> to latest version.<br>First, check the latest version using the following command.</p>
<figure class="highlight coffeescript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">npm</span> view hexo-renderer-stylus versions</span><br></pre></td></tr></tbody></table></figure>
<p>All the available versions will be printed.</p>
<figure class="highlight scheme"><table><tbody><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="symbol">'0.0.1</span>', <span class="symbol">'0.0.2</span>',</span><br><span class="line">  <span class="symbol">'0.1.0</span>', <span class="symbol">'0.2.1</span>',</span><br><span class="line">  <span class="symbol">'0.2.2</span>', <span class="symbol">'0.2.3</span>',</span><br><span class="line">  <span class="symbol">'0.3.0</span>', <span class="symbol">'0.3.1</span>',</span><br><span class="line">  <span class="symbol">'0.3.3</span>', <span class="symbol">'1.0.0</span>',</span><br><span class="line">  <span class="symbol">'1.1.0</span>', <span class="symbol">'2.0.0</span>',</span><br><span class="line">  <span class="symbol">'2.0.1</span>', <span class="symbol">'2.1.0</span>'</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure>
<p>Second, install the latest version using the following command.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">npm</span> install hexo-renderer-stylus@<span class="number">2</span>.<span class="number">1</span>.<span class="number">0</span></span><br></pre></td></tr></tbody></table></figure>
<p>Then check the dependency of <strong>stylus</strong>.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">npm <span class="built_in">ls</span> stylus</span><br></pre></td></tr></tbody></table></figure>
<p>And version of <em>stylus</em> is update to <strong>0.57.0</strong> from <strong>0.50.0</strong></p>
<figure class="highlight mel"><table><tbody><tr><td class="code"><pre><span class="line">hexo-site@0<span class="number">.0</span><span class="number">.0</span> Gits/blog-github</span><br><span class="line">├─┬ hexo-<span class="keyword">renderer</span>-stylus@2<span class="number">.1</span><span class="number">.0</span></span><br><span class="line">│ ├─┬ nib@1<span class="number">.2</span><span class="number">.0</span></span><br><span class="line">│ │ └── stylus@0<span class="number">.59</span><span class="number">.0</span> deduped</span><br><span class="line">│ └── stylus@0<span class="number">.57</span><span class="number">.0</span></span><br><span class="line">├─┬ stylus-native-loader@1<span class="number">.4</span><span class="number">.9</span></span><br><span class="line">│ └── stylus@0<span class="number">.59</span><span class="number">.0</span> deduped</span><br><span class="line">└── stylus@0<span class="number">.59</span><span class="number">.0</span></span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Hexo</category>
        <category>npm</category>
      </categories>
      <tags>
        <tag>-- Hexo -- npm</tag>
      </tags>
  </entry>
  <entry>
    <title>Set Up Jupyter Lab on Ubuntu 22.04</title>
    <url>/2023/02/19/Set-Up-Jupyter-Notebook-on-Ubuntu-18-04/</url>
    <content><![CDATA[<html><head></head><body><p><a href="http://jupyter.org/">Jupyter Lab</a> is an open-source web application that lets you create and share interactive code, visualizations, and more. This tool can be used with several programming languages, including Python, Julia, R, Haskell, and Ruby. It is often used for working with data, statistical modeling, and machine learning.</p>
<p>This tutorial will walk you through setting up Jupyter Notebook to run from an Ubuntu 18.04 server, as well as teach you how to connect to and use the Notebook. Jupyter Notebooks (or simply Notebooks) are documents produced by the Jupyter Notebook app which contain both computer code and rich text elements (paragraph, equations, figures, links, etc.) which aid in presenting and sharing reproducible research. In the final step of this guide, you will run Python 3 code using a Jupyter Notebook running on a remote server.</p>
<span id="more"></span>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><p>Please make sure python3 and pip3 are installed. If not, install them using the following command.</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt <span class="keyword">update</span></span><br><span class="line">sudo apt install <span class="keyword">python3</span>-pip <span class="keyword">python3</span>-dev</span><br></pre></td></tr></tbody></table></figure>
<p><del>Then install jupyter notebook using pip3.</del></p>
<figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> notebook</span><br></pre></td></tr></tbody></table></figure>
<p>Then install jupyter lab using pip3.</p>
<figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> jupyterlab</span><br></pre></td></tr></tbody></table></figure>
<p>Update PATH environment variable.</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH=/home/robot/.local/bin${PATH:+:${PATH}}'</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">source</span> ~/.zshrc</span><br></pre></td></tr></tbody></table></figure>
<p>After installation, check the version of jupyter.</p>
<figure class="highlight ada"><table><tbody><tr><td class="code"><pre><span class="line">jupyter <span class="comment">--version</span></span><br></pre></td></tr></tbody></table></figure>
<p>If you see the following result, the jupyter notebook is installed successfully.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">Selected</span> Jupyter core packages...</span><br><span class="line"><span class="attribute">IPython</span>          : <span class="number">7</span>.<span class="number">16</span>.<span class="number">3</span></span><br><span class="line"><span class="attribute">ipykernel</span>        : <span class="number">5</span>.<span class="number">5</span>.<span class="number">6</span></span><br><span class="line"><span class="attribute">ipywidgets</span>       : not installed</span><br><span class="line"><span class="attribute">jupyter_client</span>   : <span class="number">7</span>.<span class="number">1</span>.<span class="number">2</span></span><br><span class="line"><span class="attribute">jupyter_core</span>     : <span class="number">4</span>.<span class="number">9</span>.<span class="number">2</span></span><br><span class="line"><span class="attribute">jupyter_server</span>   : not installed</span><br><span class="line"><span class="attribute">jupyterlab</span>       : not installed</span><br><span class="line"><span class="attribute">nbclient</span>         : <span class="number">0</span>.<span class="number">5</span>.<span class="number">9</span></span><br><span class="line"><span class="attribute">nbconvert</span>        : <span class="number">6</span>.<span class="number">0</span>.<span class="number">7</span></span><br><span class="line"><span class="attribute">nbformat</span>         : <span class="number">5</span>.<span class="number">1</span>.<span class="number">3</span></span><br><span class="line"><span class="attribute">notebook</span>         : <span class="number">6</span>.<span class="number">4</span>.<span class="number">10</span></span><br><span class="line"><span class="attribute">qtconsole</span>        : not installed</span><br><span class="line"><span class="attribute">traitlets</span>        : <span class="number">4</span>.<span class="number">3</span>.<span class="number">3</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Set-Password"><a href="#Set-Password" class="headerlink" title="Set Password"></a>Set Password</h3><p>jupyter notebook needs a password to login before use it. We can generate a password using the <strong>passwd()</strong> function jupyter provide. First, open a python shell by <strong>python</strong> command in terminal. Then generate a password by the following command.</p>
<figure class="highlight angelscript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> notebook.auth <span class="keyword">import</span> passwd;</span><br><span class="line">passwd()</span><br></pre></td></tr></tbody></table></figure>
<p>Input a password and it will generate a token for this password. Please keep this token and we will use it later to configure jupyter.</p>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>Before using jupyter notebook, we had better set some configurations for it. Using the following command to generate a configuration file.</p>
<figure class="highlight verilog"><table><tbody><tr><td class="code"><pre><span class="line">jupyter notebook --<span class="keyword">generate</span>-<span class="keyword">config</span></span><br></pre></td></tr></tbody></table></figure>
<p>A configuration file named <strong>jupyter_notebook_config.py</strong> is created in directory <strong>~/.jupyter</strong>.<br>Open and edit this file.</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">vi</span> .jupyter/jupyter_notebook_config.<span class="keyword">py</span></span><br></pre></td></tr></tbody></table></figure>
<p>There are lots of configurations and what I set is as follows:</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">## Whether to allow the user to run the notebook as root. If you do not install jupyter in a virtual env, please set this option as True.</span></span><br><span class="line"><span class="attr">c.NotebookApp.allow_root</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## The IP address the notebook server will listen on. '*' means any IP.</span></span><br><span class="line"><span class="attr">c.NotebookApp.ip</span> = <span class="string">'*'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## The directory to use for notebooks and kernels. Please do not use full path, jupyter will add the default path prefix automatically.</span></span><br><span class="line"><span class="attr">c.NotebookApp.notebook_dir</span> = <span class="string">'gits/jupyter/'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Whether to open in a browser after starting. The specific browser used is</span></span><br><span class="line"><span class="comment">#  platform dependent and determined by the python standard library `webbrowser`</span></span><br><span class="line"><span class="comment">#  module, unless it is overridden using the --browser (NotebookApp.browser)</span></span><br><span class="line"><span class="comment">#  configuration option.</span></span><br><span class="line"><span class="attr">c.NotebookApp.open_browser</span> = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##  The string should be of the form type:salt:hashed-password. Copy the token generated by passwd().</span></span><br><span class="line"><span class="attr">c.NotebookApp.password</span> = <span class="string">'argon2:$argon2id$v=19$m=10240,t=10,p=8$x/wZxj7yQsoUagjuidgnaiudgiu9adniaunaneianngda'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## The port the notebook server will listen on (env: JUPYTER_PORT).</span></span><br><span class="line"><span class="attr">c.NotebookApp.port</span> = <span class="number">8888</span></span><br></pre></td></tr></tbody></table></figure>
<p>Then we can run jupyter notebook by executing the following command:</p>
<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">jupyter notebook</span></span><br></pre></td></tr></tbody></table></figure>
<p>The port number used in jupyter is 8888, then we can visit jupyter notebook via <a href="http://127.0.0.1:8888/">http://127.0.0.1:8888</a>. Password is required when visit the page for first time, and we can input the password created by the former step. Please make sure the 8888 port is allowed by firewall. If not allowed, use the following command to set it.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo</span> ufw <span class="literal">allow</span> <span class="number">8888</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Run-Service"><a href="#Run-Service" class="headerlink" title="Run Service"></a>Run Service</h3><p>If we start jupyter notebook by command <strong>jupyter notebook</strong>, it will close when the terminal is close. Usually, we want jupyter notebook to keep running, thus we can use it whenever we need. We can make jupyter as a system service.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo vi <span class="regexp">/lib/</span>systemd<span class="regexp">/system/</span>jupyter.service</span><br></pre></td></tr></tbody></table></figure>
<p>Edit this file as follows.</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="comment"># A short description about the service</span></span><br><span class="line"><span class="attr">Description</span>=Juyper-NoteBook</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="comment"># Use simple run type and define the PIDFile</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">PIDFile</span>=/run/jupyter.pid</span><br><span class="line"></span><br><span class="line"><span class="comment"># The start command</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/jupyter-notebook</span><br><span class="line"><span class="comment"># The stop command</span></span><br><span class="line"><span class="attr">ExecStop</span>=/usr/bin/pkill jupyter-notebook</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set always restart when fail.</span></span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="comment"># The time wait for before restart</span></span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">30</span>s</span><br><span class="line"></span><br><span class="line"><span class="comment"># Set user name</span></span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"><span class="comment"># Set group name</span></span><br><span class="line"><span class="attr">Group</span>=root</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/root</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="comment"># Set Target</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></tbody></table></figure>
<p>Start jupyter service by the following commands.</p>
<figure class="highlight nsis"><table><tbody><tr><td class="code"><pre><span class="line">sudo <span class="params">system</span>ctl daemon-reload</span><br><span class="line">sudo <span class="params">system</span>ctl enable jupyter</span><br><span class="line">sudo <span class="params">system</span>ctl start jupyter</span><br></pre></td></tr></tbody></table></figure>
<p>We can also check the running status of jupyter service if there is anything wrong during start.</p>
<figure class="highlight fortran"><table><tbody><tr><td class="code"><pre><span class="line">systemctl <span class="keyword">status</span> jupyter.service</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Extensions"><a href="#Extensions" class="headerlink" title="Extensions"></a>Extensions</h3><p><a href="https://github.com/ipython-contrib/jupyter_contrib_nbextensions"><strong>jupyter_contrib_nbextensions</strong></a> helps to manage a collect of extensions that can add functionality to jupyter notebook, which make it easier to use.</p>
<figure class="highlight mipsasm"><table><tbody><tr><td class="code"><pre><span class="line">pip <span class="keyword">install </span><span class="keyword">jupyter_contrib_nbextensions</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">jupyter </span>contrib nbextension <span class="keyword">install </span>--user</span><br><span class="line">pip <span class="keyword">install </span><span class="keyword">jupyter_nbextensions_configurator</span></span><br><span class="line"><span class="keyword"></span><span class="keyword">jupyter </span>nbextensions_configurator enable --user</span><br><span class="line">systemctl restart <span class="keyword">jupyter</span></span><br></pre></td></tr></tbody></table></figure>
<p>Then we can configure notebooks’s functions via the web page.<br>Install autopep8, if we want use it in notebook.</p>
<figure class="highlight angelscript"><table><tbody><tr><td class="code"><pre><span class="line">pip install <span class="built_in">auto</span>pep8</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Problems-amp-Solutions"><a href="#Problems-amp-Solutions" class="headerlink" title="Problems &amp; Solutions"></a>Problems &amp; Solutions</h3><h4 id="Content-Security-Policy-Refused-to-frame-‘http-www-zhaoyongsheng-com-8888-‘-because-an-ancestor-violates-the-following-Content-Security-Policy-directive-“frame-ancestors-‘self’”"><a href="#Content-Security-Policy-Refused-to-frame-‘http-www-zhaoyongsheng-com-8888-‘-because-an-ancestor-violates-the-following-Content-Security-Policy-directive-“frame-ancestors-‘self’”" class="headerlink" title="Content Security Policy: Refused to frame ‘http://www.zhaoyongsheng.com:8888/‘ because an ancestor violates the following Content Security Policy directive: “frame-ancestors ‘self’”."></a>Content Security Policy: Refused to frame ‘<a href="http://www.zhaoyongsheng.com:8888/">http://www.zhaoyongsheng.com:8888/</a>‘ because an ancestor violates the following Content Security Policy directive: “frame-ancestors ‘self’”.</h4><p>Domain masking also knows as URL Masking. It is the act of hiding the actual domain name of a website from the user’s web browser and showing another domain name. We can user url masking to allocate a domain name for jupyter notebook instead of visiting it via a specific port. For example, if we deploy jupyter notebook on <a href="http://www.somesite.com:8888/">http://www.somesite.com:8888</a>, then we can allocate a second class domain name, such as <a href="http://jupyter.somesite.com/">http://jupyter.somesite.com</a>.<br>For secure reasons, jupyter notebook refuse this kind of url masking by default. Thus we will meet this error because the url masked frame ancestor is unknown. Here is the solution.<br>Open jupyter notebook’s config file using vim.</p>
<figure class="highlight arcade"><table><tbody><tr><td class="code"><pre><span class="line">vi ~<span class="regexp">/.jupyter/</span>jupyter_notebook_config.py</span><br></pre></td></tr></tbody></table></figure>
<p>And edit tornado settings as follows, which <strong><a href="http://jupoyter.somesite.com/">http://jupoyter.somesite.com</a></strong> is the url we used to mask the original url.</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">c.NotebookApp.tornado_settings</span> = { <span class="string">'headers'</span>: { <span class="string">'Content-Security-Policy'</span>: <span class="string">"frame-ancestors 'self' http://jupyter.somesite.com"</span> } }</span><br></pre></td></tr></tbody></table></figure>
<p>After configuration, restart jupyter service.</p>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Jupyter Notebook</category>
        <category>Jupyter Lab</category>
      </categories>
      <tags>
        <tag>Jupyter Notebook</tag>
        <tag>Jupyter Lab</tag>
      </tags>
  </entry>
  <entry>
    <title>A Method To Make Git Ignore Take Effect</title>
    <url>/2023/02/20/A-Method-To-Make-Git-Ignore-Take-Effect/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://git-scm.com/">Git</a> is a free and open source distributed version control system designed to handle everything from small to very large projects with speed and efficiency. In a git repository, if there are some files or folders that we don’t want to handle by git, we can ignore them by setup a <strong>.gitignore</strong> config file. Sometime, git ignore doesn’t take effect after we add some files or folders to <strong>.gitignore</strong>, especially when the files or folders we add have already been tracked by git. In this tutorial, I will show you how to fix the problem of git ignore not working.</p>
<span id="more"></span>
<p>Adding files or folders to <strong>.gitignore</strong> doesn’t remove them from git cache. We have to remove them from git cache manually.</p>
<h3 id="files"><a href="#files" class="headerlink" title="files"></a>files</h3><p>First, add and commit every changed files.<br>Second, remove the ignore files from git cache using the following command.</p>
<figure class="highlight delphi"><table><tbody><tr><td class="code"><pre><span class="line">git rm --cached <span class="keyword">file</span>.<span class="keyword">name</span></span><br></pre></td></tr></tbody></table></figure>
<p>Third, commit the delete.</p>
<figure class="highlight maxima"><table><tbody><tr><td class="code"><pre><span class="line">git commit -m <span class="string">"ignore file.name"</span></span><br><span class="line">git <span class="built_in">push</span> <span class="built_in">origin</span> master</span><br></pre></td></tr></tbody></table></figure>
<h3 id="folders"><a href="#folders" class="headerlink" title="folders"></a>folders</h3><p>Steps are similar with ignoring files. But the command that removes folders from git cache is different.</p>
<figure class="highlight ada"><table><tbody><tr><td class="code"><pre><span class="line">git rm -rf <span class="comment">--cached folder_name</span></span><br></pre></td></tr></tbody></table></figure>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Gitß</tag>
      </tags>
  </entry>
  <entry>
    <title>Deploy A Django Application on Ubuntu Using Apache and PostgreSQL</title>
    <url>/2023/02/08/Deploy-A-Django-Application-on-Ubuntu-Using-Apache-and-PostgreSQL/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://www.djangoproject.com/">Django</a> is a high-level Python web framework that encourages rapid development and clean, pragmatic design. Built by experienced developers, it takes care of much of the hassle of web development, so you can focus on writing your app without needing to reinvent the wheel. In this tutorial, I will teach you to install, develop and deploy a web application step by step using Django, Apache and PostgreSQL on Ubuntu 18.04.</p>
<span id="more"></span>
<h2 id="Prerequire-Installation"><a href="#Prerequire-Installation" class="headerlink" title="Prerequire Installation"></a>Prerequire Installation</h2><h3 id="Install-and-Use-Python3-and-Pip3"><a href="#Install-and-Use-Python3-and-Pip3" class="headerlink" title="Install and Use Python3 and Pip3"></a>Install and Use Python3 and Pip3</h3><p>The default python on Ubuntu 18.04 is python2, which will be deprecated in future. Django recommend us to use python3 which we have a better compatibility and performance.</p>
<h5 id="Install-Python3"><a href="#Install-Python3" class="headerlink" title="Install Python3"></a>Install Python3</h5><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> update</span><br><span class="line">sudo apt-<span class="built_in">get</span> install python3 libexpat1</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Set-Python3-as-Default-Python"><a href="#Set-Python3-as-Default-Python" class="headerlink" title="Set Python3 as Default Python"></a>Set Python3 as Default Python</h5><figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo rm -rf <span class="regexp">/usr/</span>bin/python</span><br><span class="line">ln -s <span class="regexp">/usr/</span>bin<span class="regexp">/python3 /u</span>sr<span class="regexp">/bin/</span>python</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Install-Pip3"><a href="#Install-Pip3" class="headerlink" title="Install Pip3"></a>Install Pip3</h5><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">apt-<span class="built_in">get</span> install python3-pip</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Set-Pip3-as-Default-Pip"><a href="#Set-Pip3-as-Default-Pip" class="headerlink" title="Set Pip3 as Default Pip"></a>Set Pip3 as Default Pip</h5><figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">ln -s <span class="regexp">/usr/</span>bin<span class="regexp">/pip3 /u</span>sr<span class="regexp">/bin/</span>pip</span><br><span class="line">pip install --upgrade pip</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Install-Apache-with-mod-wsgi-Module"><a href="#Install-Apache-with-mod-wsgi-Module" class="headerlink" title="Install Apache with mod_wsgi Module"></a>Install Apache with mod_wsgi Module</h3><p>Deploying Django with <a href="https://httpd.apache.org/">Apache</a> and <a href="https://modwsgi.readthedocs.io/en/develop/">mod_wsgi</a> is a tried and tested way to get Django into production. mod_wsgi is an Apache module which can host any Python WSGI application, including Django. Django will work with any version of Apache which supports mod_wsgi.</p>
<h4 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h4><figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install apache2 apache2-utils ssl-cert libapache2-<span class="keyword">mod</span>-wsgi-<span class="keyword">py3</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Restart"><a href="#Restart" class="headerlink" title="Restart"></a>Restart</h4><figure class="highlight maxima"><table><tbody><tr><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">restart</span> apache2</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Install-PostgreSQL"><a href="#Install-PostgreSQL" class="headerlink" title="Install PostgreSQL"></a>Install PostgreSQL</h3><p><a href="https://www.postgresql.org/">PostgreSQL</a> is an advanced open source relational database. It has a better performance than django’s default database SQLite, therefore here I use PostgreSQL as Django’s database.</p>
<h4 id="Install-1"><a href="#Install-1" class="headerlink" title="Install"></a>Install</h4><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> update</span><br><span class="line">sudo apt-<span class="built_in">get</span> install postgresql postgresql-contrib</span><br><span class="line">pip install psycopg2</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Check-Status"><a href="#Check-Status" class="headerlink" title="Check Status"></a>Check Status</h4><figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">service postgresql status</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="Django-Installation"><a href="#Django-Installation" class="headerlink" title="Django Installation"></a>Django Installation</h2><p>After finish the installation of python3, pip3, apache and postgresql, we can install django now. The latest version of Django is 4.1, however I install 3.2.13 to avoid compatibility problems and other unpredictable bugs.</p>
<h3 id="Install-Django"><a href="#Install-Django" class="headerlink" title="Install Django"></a><a href="https://docs.djangoproject.com/en/4.1/intro/install/">Install Django</a></h3><h4 id="Install-2"><a href="#Install-2" class="headerlink" title="Install"></a>Install</h4><figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">pip</span> install django==<span class="number">3</span>.<span class="number">2</span>.<span class="number">13</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Verify-Installation"><a href="#Verify-Installation" class="headerlink" title="Verify Installation"></a>Verify Installation</h4><figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">python -m django <span class="attr">--version</span></span><br><span class="line">python</span><br><span class="line">import django</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(django.get_version()</span></span>)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Install-Required-Packages-Optional-you-can-skip-this-step"><a href="#Install-Required-Packages-Optional-you-can-skip-this-step" class="headerlink" title="Install Required Packages (Optional, you can skip this step)"></a>Install Required Packages (Optional, you can skip this step)</h4><h5 id="Install-REST-Framework"><a href="#Install-REST-Framework" class="headerlink" title="Install REST Framework"></a>Install REST Framework</h5><figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> djangorestframework</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Install-PhoneNumberField"><a href="#Install-PhoneNumberField" class="headerlink" title="Install PhoneNumberField"></a>Install PhoneNumberField</h5><figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> django-phonenumber-field</span><br><span class="line">pip <span class="keyword">install</span> phonenumbers</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Install-Image-API"><a href="#Install-Image-API" class="headerlink" title="Install Image API"></a>Install Image API</h5><figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> pillow</span><br><span class="line">pip <span class="keyword">install</span> drf-extra-fields</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Install-cleanup"><a href="#Install-cleanup" class="headerlink" title="Install cleanup"></a>Install cleanup</h5><figure class="highlight mipsasm"><table><tbody><tr><td class="code"><pre><span class="line">pip <span class="keyword">install </span>django-cleanup</span><br><span class="line"><span class="keyword">INSTALLED_APPS </span>= (</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'django_cleanup.apps.CleanupConfig'</span>, <span class="comment"># should be placed after your apps</span></span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Develop-Django-Application"><a href="#Develop-Django-Application" class="headerlink" title="Develop Django Application"></a>Develop Django Application</h2><h3 id="Create-Project"><a href="#Create-Project" class="headerlink" title="Create Project"></a>Create Project</h3><p>From the command line, cd into a directory where you’d like to store your project, then run the following command:</p>
<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">django-admin startproject mysite</span></span><br></pre></td></tr></tbody></table></figure>
<p>This will create a mysite directory in your current directory.</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">mysite/</span><br><span class="line">    manage.<span class="keyword">py</span></span><br><span class="line">    mysite/</span><br><span class="line">        __init__.<span class="keyword">py</span></span><br><span class="line">        settings.<span class="keyword">py</span></span><br><span class="line">        urls.<span class="keyword">py</span></span><br><span class="line">        asgi.<span class="keyword">py</span></span><br><span class="line">        wsgi.<span class="keyword">py</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Deploy-Project"><a href="#Deploy-Project" class="headerlink" title="Deploy Project"></a>Deploy Project</h3><h4 id="Run-Server"><a href="#Run-Server" class="headerlink" title="Run Server"></a>Run Server</h4><p>By default, the runserver command starts the development server on the internal IP at port 8000. If you want to change the server’s port, pass it as a command-line argument. For instance, this command starts the server on port 8080:</p>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">python</span> manage.py runserver <span class="number">0.0.0.0:8080</span></span><br></pre></td></tr></tbody></table></figure>
<p>Then we can visit mysite application via <a href="http://127.0.0.1:8080/">http://127.0.0.1:8080</a>. Note that runserver is only used for django developing and debug.</p>
<h4 id="Open-Port"><a href="#Open-Port" class="headerlink" title="Open Port"></a>Open Port</h4><p>For safety, the port we used may not open by default on Ubuntu 18.04. We can manually open it.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo</span> ufw <span class="literal">allow</span> <span class="number">8080</span></span><br></pre></td></tr></tbody></table></figure>
<p>If the port is already in user, we have to kill it before runserver.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo</span> fuser -k <span class="number">8080</span>/tcp</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Create-App"><a href="#Create-App" class="headerlink" title="Create App"></a>Create App</h3><p>Now that your environment – a “project” – is set up, you’re set to start doing work. Each application you write in Django consists of a Python package that follows a certain convention. Django comes with a utility that automatically generates the basic directory structure of an app, so you can focus on writing code rather than creating directories.</p>
<p>To create your app, make sure you’re in the same directory as manage.py and type this command:</p>
<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">django-admin startapp api</span></span><br></pre></td></tr></tbody></table></figure>
<p>That’ll create a directory api, which is laid out like this:</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">api/</span><br><span class="line">    __init__.<span class="keyword">py</span></span><br><span class="line">    admin.<span class="keyword">py</span></span><br><span class="line">    apps.<span class="keyword">py</span></span><br><span class="line">    migrations/</span><br><span class="line">        __init__.<span class="keyword">py</span></span><br><span class="line">    models.<span class="keyword">py</span></span><br><span class="line">    tests.<span class="keyword">py</span></span><br><span class="line">    views.<span class="keyword">py</span></span><br></pre></td></tr></tbody></table></figure>
<p>This directory structure will house the api application.</p>
<h4 id="Install-App"><a href="#Install-App" class="headerlink" title="Install App"></a>Install App</h4><p>After create the api app, we need to install api app to mysite project. Edit the mysite/settings.py file again, and change the INSTALLED_APPS setting to include the string ‘api’. So it’ll look like this:</p>
<figure class="highlight sml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="type">INSTALLED_APPS</span> = (</span><br><span class="line">    <span class="symbol">'django</span>.contrib.admin',</span><br><span class="line">    <span class="symbol">'django</span>.contrib.auth',</span><br><span class="line">    <span class="symbol">'django</span>.contrib.contenttypes',</span><br><span class="line">    <span class="symbol">'django</span>.contrib.sessions',</span><br><span class="line">    <span class="symbol">'django</span>.contrib.messages',</span><br><span class="line">    <span class="symbol">'django</span>.contrib.staticfiles',</span><br><span class="line">    <span class="symbol">'api'</span>,</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Difference between project and application in Django<br> An app is a web application that does something – e.g., a blog system, a database of public records or a small poll app. A project is a collection of configuration and apps for a particular website. A project can contain multiple apps. An app can be in multiple projects.</li>
</ul>
<h4 id="Create-Super-User-and-Login"><a href="#Create-Super-User-and-Login" class="headerlink" title="Create Super User and Login"></a>Create Super User and Login</h4><p>We’ll need to create a user who can login to the admin site. Run the following command:</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">python</span> manage.<span class="keyword">py</span> createsuperuser</span><br></pre></td></tr></tbody></table></figure>
<p>Input the user name, email address and password, the above command will create a super user for mysite. Then we can login <a href="http://127.0.0.1:8080/admin/">http://127.0.0.1:8080/admin/</a> as an administrator and manipulate the data defined by Django’s model.</p>
<h4 id="Make-Migrations"><a href="#Make-Migrations" class="headerlink" title="Make Migrations"></a>Make Migrations</h4><p>When we define new models or change the defined models, we need let django known the definitions and changes by the following commands.</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">python</span> manage.<span class="keyword">py</span> makemigrations</span><br><span class="line"><span class="keyword">python</span> manage.<span class="keyword">py</span> migrate</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Deploy-Django-Application-Using-Apache2"><a href="#Deploy-Django-Application-Using-Apache2" class="headerlink" title="Deploy Django Application Using Apache2"></a>Deploy Django Application Using Apache2</h2><p>Although we can serve the django application using the command ‘python manage.py runserver 0.0.0.0:8080’, it is not recommended to use this command to deploy Django’s application. Because this command is designed for developing and debug. It’s performance is poor and it will runout the server’s memory when the application is visited in high concurrency. <a href="https://httpd.apache.org/">Apache</a> is a famous open-source HTTP server for modern operating systems Unix and Windows. The official documents of Django recommends us to use Apache to deploy Django’s application.</p>
<p>There are two points we need to know before we take further steps into apache configuration.</p>
<ul>
<li>configuration files’ path<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">cd <span class="regexp">/etc/</span>apache2/</span><br><span class="line">tree -L <span class="number">1</span></span><br></pre></td></tr></tbody></table></figure>
We should see the following contents:<figure class="highlight stata"><table><tbody><tr><td class="code"><pre><span class="line">├── apache2.<span class="keyword">conf</span></span><br><span class="line">├── <span class="keyword">conf</span>-available</span><br><span class="line">├── <span class="keyword">conf</span>-enabled</span><br><span class="line">├── envvars</span><br><span class="line">├── magic</span><br><span class="line">├── mods-available</span><br><span class="line">├── mods-enabled</span><br><span class="line">├── ports.<span class="keyword">conf</span></span><br><span class="line">├── sites-available</span><br><span class="line">└── sites-enabled</span><br></pre></td></tr></tbody></table></figure>
The <strong>apache2.conf</strong> is the apache’s configuration file and the <strong>ports.conf</strong> defines the port that apache listens. The directory <strong>sites-available</strong> contains configurations of sites that apache can serve and the directory <strong>sites-enabled</strong> contains configurations of sites that apache is serving.</li>
<li>log’s path<figure class="highlight stata"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">cd</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/apache2</span><br><span class="line">tree</span><br></pre></td></tr></tbody></table></figure>
And we will see the following files:<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">├── access.<span class="built_in">log</span></span><br><span class="line">├── <span class="keyword">error</span>.<span class="built_in">log</span></span><br><span class="line">├── other_vhosts_access.<span class="built_in">log</span></span><br></pre></td></tr></tbody></table></figure>
Logs can offer us useful information when there is something wrong during configure apache.</li>
</ul>
<h3 id="Set-Port"><a href="#Set-Port" class="headerlink" title="Set Port"></a>Set Port</h3><p>The default port is <strong>80</strong> for http, but we can use other ports if port <strong>80</strong> is reserved. Open <strong>ports.conf</strong> and listen the port we want to use for Django application.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">vi <span class="regexp">/etc/</span>apache2/ports.conf</span><br></pre></td></tr></tbody></table></figure>
<p>And add the following configuration to let apache listen <strong>8080</strong> port.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">Listen</span> <span class="number">8080</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Enable-Rewrite-Module"><a href="#Enable-Rewrite-Module" class="headerlink" title="Enable Rewrite Module"></a>Enable Rewrite Module</h3><p><a href="https://httpd.apache.org/docs/current/mod/mod_rewrite.html">Rewrite Module</a> is a rule-based rewrite engine and it rewrites the requested URLs by the defined rules using regular-expression parser. Usually, it is used to redirect one URL to another URL. Here will use it to redirect http request to https request, which is more secure. </p>
<figure class="highlight coq"><table><tbody><tr><td class="code"><pre><span class="line">a2enmod <span class="built_in">rewrite</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Configure-Site"><a href="#Configure-Site" class="headerlink" title="Configure Site"></a>Configure Site</h3><p>There is a default enabled site defined in <strong>000-default.conf</strong>. Here we edit this site configuration to deploy Django application.</p>
<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line">cp <span class="regexp">/etc/</span>apache2<span class="regexp">/sites-available/</span><span class="number">000</span>-<span class="keyword">default</span>.conf <span class="regexp">/etc/</span>apache2<span class="regexp">/sites-available/</span><span class="number">000</span>-<span class="keyword">default</span>.conf.cp</span><br><span class="line">vi <span class="regexp">/etc/</span>apache2<span class="regexp">/sites-available/</span><span class="number">000</span>-<span class="keyword">default</span>.conf</span><br></pre></td></tr></tbody></table></figure>
<p>And replace the default configuration with the following one:</p>
<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line">&lt;VirtualHost *:<span class="number">8080</span>&gt;</span><br><span class="line">    # ServerName <span class="number">172.30</span>.<span class="number">92.118</span></span><br><span class="line">    # ServerAlias zhaoyongsheng.com</span><br><span class="line">    # ServerAdmin yongsheng.zhao.csc@gmail.com</span><br><span class="line"></span><br><span class="line">    WSGIScriptAlias <span class="regexp">/ /</span>django<span class="regexp">/servo/</span>servo/wsgi.py</span><br><span class="line"></span><br><span class="line">    ProxyPass <span class="regexp">/media/</span> !</span><br><span class="line">    Alias <span class="regexp">/media/</span> <span class="regexp">/django/m</span>edia/</span><br><span class="line">    ProxyPass <span class="regexp">/static/</span> !</span><br><span class="line">    Alias <span class="regexp">/static/</span> <span class="regexp">/django/</span>servo<span class="regexp">/static/</span></span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="regexp">/django/m</span>edia&gt;</span><br><span class="line">         Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="regexp">/django/</span>servo/<span class="keyword">static</span>&gt;</span><br><span class="line">         Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">    # WSGIDaemonProcess blog python-home=<span class="regexp">/home/</span>sammy<span class="regexp">/myproject/my</span>projectenv python-path=<span class="regexp">/home/</span>sammy/myproject</span><br><span class="line">    # WSGIProcessGroup %{GLOBAL}</span><br><span class="line">    # WSGIDaemonProcess ziqiangxuetang.com python-path=<span class="regexp">/home/</span>tu<span class="regexp">/blog:/</span>home<span class="regexp">/tu/</span>.virtualenvs<span class="regexp">/blog/</span>lib<span class="regexp">/python2.7/</span>site-packages</span><br><span class="line">    # WSGIProcessGroup ziqiangxuetang.com</span><br><span class="line">    # WSGIApplicationGroup %{GLOBAL}</span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="regexp">/django/</span>servo/servo&gt;</span><br><span class="line">            &lt;Files wsgi.py&gt;</span><br><span class="line">                Require all granted</span><br><span class="line">            &lt;/Files&gt;</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">    ErrorLog ${APACHE_LOG_DIR}/error.log</span><br><span class="line">    CustomLog ${APACHE_LOG_DIR}/access.log combined</span><br><span class="line">    # RewriteEngine on</span><br><span class="line">    # RewriteCond   %{HTTPS} !=on </span><br><span class="line">    # RewriteRule   ^(.*)  https:<span class="comment">//%{SERVER_NAME}$1 [L,R]</span></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>The first bit in the WSGIScriptAlias line is the base URL path you want to serve your application at (/ indicates the root url), and the second is the location of a “WSGI file” . And the <directory> piece ensures that Apache can access your wsgi.py file.</directory></p>
<ul>
<li>** ProxyPass /static/ !** – Do not deal with <strong>/static/</strong> urls, otherwise it will add a <strong>static/</strong> prefix to the url, such as make “static/admin/base.html” as “static/static/admin/base.html”, for more details please visit the <a href="https://djangodeployment.readthedocs.io/en/latest/05-static-files.html">Static and media files</a></li>
<li><strong>Alias /media/ /django/media/</strong> – Let apache know where the media directory is.</li>
<li><strong>Alias /static/ /django/servo/static/</strong> – Let apache know where the static directory is.<br>The <a href="https://docs.djangoproject.com/en/4.1/howto/deployment/wsgi/modwsgi/">official documents</a> provides more details about how to deploy Django using apache.</li>
</ul>
<h3 id="Config-Apache"><a href="#Config-Apache" class="headerlink" title="Config Apache"></a>Config Apache</h3><p>The apache’s configuration file is in <strong>/etc/apache2/apache2.conf</strong>. Similarly, we had better make a copy of the default <strong>apache2.conf</strong> before modified it.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">cp <span class="regexp">/etc/</span>apache2<span class="regexp">/apache2.conf /</span>etc<span class="regexp">/apache2/</span>apache2.conf.cp</span><br><span class="line">vi <span class="regexp">/etc/</span>apache2/apache2.conf</span><br></pre></td></tr></tbody></table></figure>
<p>Find and edit the following lines:</p>
<figure class="highlight nsis"><table><tbody><tr><td class="code"><pre><span class="line">&lt;<span class="literal">Directory</span> /&gt;</span><br><span class="line"><span class="number">160</span>         Options FollowSymLinks</span><br><span class="line"><span class="number">161</span>         AllowOverride <span class="literal">None</span></span><br><span class="line"><span class="number">162</span>         Require <span class="literal">all</span> granted</span><br><span class="line"><span class="number">163</span> &lt;/<span class="literal">Directory</span>&gt;</span><br><span class="line"><span class="number">164</span> </span><br><span class="line"><span class="number">165</span> &lt;<span class="literal">Directory</span> /usr/share&gt;</span><br><span class="line"><span class="number">166</span>         AllowOverride <span class="literal">None</span></span><br><span class="line"><span class="number">167</span>         Require <span class="literal">all</span> granted</span><br><span class="line"><span class="number">168</span> &lt;/<span class="literal">Directory</span>&gt;</span><br><span class="line"><span class="number">169</span> </span><br><span class="line"><span class="number">170</span> <span class="comment"># &lt;Directory /var/www/&gt;</span></span><br><span class="line"><span class="number">171</span> <span class="comment">#       Options Indexes FollowSymLinks</span></span><br><span class="line"><span class="number">172</span> <span class="comment">#       AllowOverride None</span></span><br><span class="line"><span class="number">173</span> <span class="comment">#       Require all granted</span></span><br><span class="line"><span class="number">174</span> <span class="comment"># &lt;/Directory&gt;</span></span><br><span class="line"><span class="number">175</span> </span><br><span class="line"><span class="number">176</span> <span class="comment">#&lt;Directory /srv/&gt;</span></span><br><span class="line"><span class="number">177</span> <span class="comment">#       Options Indexes FollowSymLinks</span></span><br><span class="line"><span class="number">178</span> <span class="comment">#       AllowOverride None</span></span><br><span class="line"><span class="number">179</span> <span class="comment">#       Require all granted</span></span><br><span class="line"><span class="number">180</span> <span class="comment">#&lt;/Directory&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>Add the following line at the end of the file.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">WSGIPythonPath <span class="regexp">/django/</span>servo</span><br></pre></td></tr></tbody></table></figure>
<p><strong>WSGIPythonPath</strong> ensures that your project package is available for import on the Python path; in other words, that import servo works.</p>
<h3 id="Close-Debug-Mode-in-Django"><a href="#Close-Debug-Mode-in-Django" class="headerlink" title="Close Debug Mode in Django"></a>Close Debug Mode in Django</h3><p>Django’s debug mode can print logs which is useful for debug, but its performance is poor. Thus we had better close the debug mode before serving it to web.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">vi <span class="regexp">/django/</span>servo<span class="regexp">/servo/</span>settings.py</span><br></pre></td></tr></tbody></table></figure>
<p>Find the line <strong>DEBUG = True</strong>, and set it as False.</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">DEBUG</span> = <span class="literal">False</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Change-Owner-of-Django-Directory"><a href="#Change-Owner-of-Django-Directory" class="headerlink" title="Change Owner of Django Directory"></a>Change Owner of Django Directory</h3><p>Generally, the owner of django’s directory is the admin user of the operation system. We must change the owner to apache to let it have full access to Django’s directory. </p>
<figure class="highlight haskell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="title">cd</span> /</span><br><span class="line"><span class="title">chown</span> -<span class="type">R</span> www-<span class="class"><span class="keyword">data</span>:www-<span class="keyword">data</span> django</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Restart-Apache"><a href="#Restart-Apache" class="headerlink" title="Restart Apache"></a>Restart Apache</h3><p>Finishing the above steps, restart apache to deploy Django’s application.</p>
<figure class="highlight maxima"><table><tbody><tr><td class="code"><pre><span class="line">service apache2 <span class="built_in">restart</span></span><br></pre></td></tr></tbody></table></figure>
<p>Now we can visit the Django’s application via http:xxx.xxx.xxx.xxx:8080/admin/. <strong>Congratulations!</strong><br>If there are any problems, feel free to contact me.</p>
<h3 id="Warnings-Errors-And-Solutions"><a href="#Warnings-Errors-And-Solutions" class="headerlink" title="Warnings, Errors And Solutions"></a>Warnings, Errors And Solutions</h3><h4 id="AH00558-apache2-Could-not-reliably-determine-the-server’s-fully-qualified-domain-name-using-172-30-92-119-Set-the-‘ServerName’-directive-globally-to-suppress-this-message"><a href="#AH00558-apache2-Could-not-reliably-determine-the-server’s-fully-qualified-domain-name-using-172-30-92-119-Set-the-‘ServerName’-directive-globally-to-suppress-this-message" class="headerlink" title="AH00558: apache2: Could not reliably determine the server’s fully qualified domain name, using 172.30.92.119. Set the ‘ServerName’ directive globally to suppress this message"></a>AH00558: apache2: Could not reliably determine the server’s fully qualified domain name, using 172.30.92.119. Set the ‘ServerName’ directive globally to suppress this message</h4><p>Apache uses the ServerName directive to map incoming HTTP requests to an IP address or DNS hostname using VirtualHost directives in order to handle requests for multiple sites using a single server. The error message notes that a global ServerName directive should also be set. Doing so will ensure that Apache can gracefully handle incoming requests that do not map to a VirtualHost without generating additional errors.</p>
<p>For maximum compatibility with various Apache configurations, use the value of 127.0.0.1 for your global ServerName directive. You can use a different IP address or DNS name that corresponds to your server’s configuration if you need to, but it is safest to use 127.0.0.1.</p>
<p>Open the <strong>/etc/apache2/apache2.conf</strong> file using vim.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">vi <span class="regexp">/etc/</span>apache2/apache2.conf</span><br></pre></td></tr></tbody></table></figure>
<p>And add the following line to the end of the file.</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">. . .</span><br><span class="line"># Include the virtual host configurations:</span><br><span class="line">IncludeOptional sites-enabled/*.<span class="keyword">conf</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">vim</span>: <span class="keyword">syntax</span>=apache <span class="keyword">ts</span>=<span class="number">4</span> <span class="keyword">sw</span>=<span class="number">4</span> <span class="keyword">sts</span>=<span class="number">4</span> sr noet</span><br><span class="line">ServerName <span class="number">127.0</span>.<span class="number">0.1</span></span><br></pre></td></tr></tbody></table></figure>
<p>Then restart apache and the <strong>AH00558</strong> error will disappear.</p>
<h4 id="Authentication-credentials-were-not-provided"><a href="#Authentication-credentials-were-not-provided" class="headerlink" title="Authentication credentials were not provided."></a>Authentication credentials were not provided.</h4><p>The token authentication works well when I run django project using <strong>python manage.py runserver 0.0.0.0:8080</strong>. I met this error when running django project using apache2. Obviously, this error is a privilege problem. Since I deploy django using wsgi module, I can enable <strong>WSGIPassAuthorization</strong> to solve this problem.<br>Open the site configuration file using vim.</p>
<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line">vi <span class="regexp">/etc/</span>apache2<span class="regexp">/sites-enabled/</span><span class="number">000</span>-<span class="keyword">default</span>.conf</span><br></pre></td></tr></tbody></table></figure>
<p>And put the following line to the file.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">WSGIPassAuthorization</span> <span class="literal">On</span></span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Ubuntu</category>
        <category>PostgreSQL</category>
        <category>Django</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>PostgreSQL</tag>
        <tag>Django</tag>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>Basic Usage of Git</title>
    <url>/2023/02/23/Basic-Usage-of-Git/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://git-scm.com/">Git</a> is a free and open source distributed version control system designed to handle everything from small to very large projects with speed and efficiency. In this article, I will introduce some useful skills of using git to manage version control.</p>
<span id="more"></span>
<h3 id="Manage-Remote-Repository"><a href="#Manage-Remote-Repository" class="headerlink" title="Manage Remote Repository"></a>Manage Remote Repository</h3><h4 id="Add"><a href="#Add" class="headerlink" title="Add"></a>Add</h4><figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">git remote add origin ssh:<span class="regexp">//gi</span>t@gitlab.com:<span class="number">30001</span><span class="regexp">/yongsheng/</span>jupyter.git</span><br></pre></td></tr></tbody></table></figure>
<p>The above command will add a remote repository to a git project named <strong>origin</strong>. We can add multiple remote repositories using different names, such <strong>backup</strong>, <strong>test</strong> and so on. </p>
<h4 id="Change-URL"><a href="#Change-URL" class="headerlink" title="Change URL"></a>Change URL</h4><figure class="highlight dsconfig"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">git</span> <span class="string">remote</span> <span class="built_in">set-url</span> <span class="string">origin</span> <span class="string">ssh</span>://<span class="string">git</span>@<span class="string">gitlab</span>.<span class="string">com:30001/</span><span class="string">yongsheng</span>/<span class="string">jupyter</span>.<span class="string">git</span></span><br></pre></td></tr></tbody></table></figure>
<p>The <strong>set-url</strong> option can change the url of an existing repository. It takes two parameters, one is the repository’s name and the other one is the new url of remote repository.</p>
<h4 id="Delete"><a href="#Delete" class="headerlink" title="Delete"></a>Delete</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">git remote <span class="built_in">rm</span> origin</span><br></pre></td></tr></tbody></table></figure>
<p>The <strong>rm</strong> option can remove an repository using its name.</p>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Basic Usage Of Apache</title>
    <url>/2023/02/25/Basic-Usage-Of-Apache/</url>
    <content><![CDATA[<html><head></head><body><p>This article contains the configuration and command lines of <strong>Apache2</strong>.</p>
<span id="more"></span>
<h3 id="Apache-Configuration"><a href="#Apache-Configuration" class="headerlink" title="Apache Configuration"></a>Apache Configuration</h3><p>The config file of apache is <strong>/etc/apache2/apache2.conf</strong>.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">WSGIPythonPath</span> /django/servo</span><br><span class="line"><span class="attribute">ServerName</span> <span class="number">127.0.0.1</span></span><br><span class="line"><span class="attribute">Header</span> set X-Frame-Options <span class="string">"allow from http://www.demo.com/"</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>WSGIPythonPath /django/servo – let apache knows where to load the django project.</li>
<li>ServerName 127.0.0.1 – local ip is recommended.</li>
<li>Header set X-Frame-Options “allow from <a href="http://www.demo.com/">http://www.demo.com/</a>“ – allow the page can be embedded in a <strong>frame</strong> from <strong><a href="http://www.demo.com/">http://www.demo.com</a></strong>, undefined frames are forbidden. For more detail information, please visit <a href="https://cloud.tencent.com/developer/section/1190032">X-Frame-Options</a> or <a href="https://help.aliyun.com/document_detail/118166.html">URL Masking</a>.<br>The ports that apache is listening are defined in <strong>/etc/apache2/ports.conf</strong></li>
</ul>
<h3 id="Site-Configuration"><a href="#Site-Configuration" class="headerlink" title="Site Configuration"></a>Site Configuration</h3><p>The site configurations are in <strong>/etc/apache2/site-available</strong> and one file is for one site.</p>
<ul>
<li>Http Site<br>The default port for http host is <strong>80</strong>.<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line">&lt;VirtualHost *:<span class="number">80</span>&gt;</span><br><span class="line">    # ServerName www.demo.com</span><br><span class="line">    # ServerAlias demo.com</span><br><span class="line">    # ServerAdmin demo.csc@gmail.com</span><br><span class="line"></span><br><span class="line">    WSGIScriptAlias <span class="regexp">/ /</span>django<span class="regexp">/servo/</span>servo/wsgi.py</span><br><span class="line">    WSGIPassAuthorization On</span><br><span class="line"></span><br><span class="line">    Alias <span class="regexp">/media/</span> <span class="regexp">/django/m</span>edia/</span><br><span class="line">    Alias <span class="regexp">/static/</span> <span class="regexp">/django/</span>servo<span class="regexp">/static/</span></span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="regexp">/django/m</span>edia&gt;</span><br><span class="line">         Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="regexp">/django/</span>servo/<span class="keyword">static</span>&gt;</span><br><span class="line">         Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">    # WSGIDaemonProcess blog python-home=<span class="regexp">/home/</span>sammy<span class="regexp">/myproject/my</span>projectenv python-path=<span class="regexp">/home/</span>sammy/myproject</span><br><span class="line">    # WSGIProcessGroup %{GLOBAL}</span><br><span class="line">    # WSGIDaemonProcess ziqiangxuetang.com python-path=<span class="regexp">/home/</span>tu<span class="regexp">/blog:/</span>home<span class="regexp">/tu/</span>.virtualenvs<span class="regexp">/blog/</span>lib<span class="regexp">/python2.7/</span>site-packages</span><br><span class="line">    # WSGIProcessGroup ziqiangxuetang.com</span><br><span class="line">    # WSGIApplicationGroup %{GLOBAL}</span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="regexp">/django/</span>servo/servo&gt;</span><br><span class="line">        &lt;Files wsgi.py&gt;</span><br><span class="line">            Require all granted</span><br><span class="line">        &lt;/Files&gt;</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">    ErrorLog ${APACHE_LOG_DIR}/error.log</span><br><span class="line">    CustomLog ${APACHE_LOG_DIR}/access.log combined</span><br><span class="line"></span><br><span class="line">    RewriteEngine on</span><br><span class="line">    RewriteCond   %{HTTPS} !=on </span><br><span class="line">    # Rewrite all urls</span><br><span class="line">    RewriteRule ^(.*)?$ https:<span class="comment">//%{SERVER_NAME}/$1 [R,L]</span></span><br><span class="line"> &lt;/VirtualHost&gt;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>WSGIPassAuthorization On – make sure token is passed for authorization.</li>
<li>RewriteEngine On – make sure all http request is rewritten to https request.<ul>
<li>$1 – the content that the regression rule <strong>^(.*)?$</strong> extracts.</li>
<li>^(.*)?$ – ignore the http prefix and the domain name</li>
<li>SERVER_NAME – the domain name</li>
</ul>
</li>
</ul>
</li>
<li>Https Site<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line">&lt;VirtualHost *:<span class="number">443</span>&gt;</span><br><span class="line">    # ServerName www.demo.com</span><br><span class="line">    # ServerAlias demo.com</span><br><span class="line">    # ServerAdmin demo.csc@gmail.com</span><br><span class="line"></span><br><span class="line">    WSGIScriptAlias <span class="regexp">/ /</span>django<span class="regexp">/servo/</span>servo/wsgi.py</span><br><span class="line">    WSGIPassAuthorization On</span><br><span class="line"></span><br><span class="line">    Alias <span class="regexp">/media/</span> <span class="regexp">/django/m</span>edia/</span><br><span class="line">    Alias <span class="regexp">/static/</span> <span class="regexp">/django/</span>servo<span class="regexp">/static/</span></span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="regexp">/django/m</span>edia&gt;</span><br><span class="line">         Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="regexp">/django/</span>servo/<span class="keyword">static</span>&gt;</span><br><span class="line">         Require all granted</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line"></span><br><span class="line">    # WSGIDaemonProcess blog python-home=<span class="regexp">/home/</span>sammy<span class="regexp">/myproject/my</span>projectenv python-path=<span class="regexp">/home/</span>sammy/myproject</span><br><span class="line">    # WSGIProcessGroup %{GLOBAL}</span><br><span class="line">    # WSGIDaemonProcess ziqiangxuetang.com python-path=<span class="regexp">/home/</span>tu<span class="regexp">/blog:/</span>home<span class="regexp">/tu/</span>.virtualenvs<span class="regexp">/blog/</span>lib<span class="regexp">/python2.7/</span>site-packages</span><br><span class="line">    # WSGIProcessGroup ziqiangxuetang.com</span><br><span class="line">    # WSGIApplicationGroup %{GLOBAL}</span><br><span class="line"></span><br><span class="line">    &lt;Directory <span class="regexp">/django/</span>servo/servo&gt;</span><br><span class="line">            &lt;Files wsgi.py&gt;</span><br><span class="line">                Require all granted</span><br><span class="line">            &lt;/Files&gt;</span><br><span class="line">    &lt;/Directory&gt;</span><br><span class="line">    ErrorLog ${APACHE_LOG_DIR}/error.log</span><br><span class="line">    CustomLog ${APACHE_LOG_DIR}/access.log combined</span><br><span class="line">    SSLEngine on</span><br><span class="line">    # SSLCertificateFile directive is needed.</span><br><span class="line">    SSLCertificateFile    <span class="regexp">/path/</span>to<span class="regexp">/ssl/</span><span class="number">1234567</span>_www.demo.com_public.crt</span><br><span class="line">    SSLCertificateKeyFile <span class="regexp">/path/</span>to<span class="regexp">/ssl/</span><span class="number">1234567</span>_www.demo.com.key</span><br><span class="line"> &lt;/VirtualHost&gt;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>SSLEngine on – Open SSL for Https, all we need is providing the <strong>SSLCertificateFile</strong> and the <strong>SSLCertificateKeyFile</strong></li>
</ul>
</li>
</ul>
<h3 id="Command-Lines"><a href="#Command-Lines" class="headerlink" title="Command Lines"></a>Command Lines</h3><h4 id="Enable-Module"><a href="#Enable-Module" class="headerlink" title="Enable Module"></a>Enable Module</h4><figure class="highlight coq"><table><tbody><tr><td class="code"><pre><span class="line">a2enmod <span class="built_in">rewrite</span></span><br><span class="line">a2enmod header</span><br><span class="line">a2enmod ssl</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Enable-Site"><a href="#Enable-Site" class="headerlink" title="Enable Site"></a>Enable Site</h4><figure class="highlight actionscript"><table><tbody><tr><td class="code"><pre><span class="line">a2ensite <span class="number">001</span>-<span class="keyword">default</span></span><br></pre></td></tr></tbody></table></figure>
<p>The site is defined in <strong>/etc/apache2/site_available</strong> with name <strong>001-default.conf</strong>.</p>
<h3 id="Problems-amp-Solutions"><a href="#Problems-amp-Solutions" class="headerlink" title="Problems &amp; Solutions"></a>Problems &amp; Solutions</h3><h4 id="Invalid-command-‘Header’-perhaps-misspelled-or-defined-by-a-module-not-included-in-the-server-configuration"><a href="#Invalid-command-‘Header’-perhaps-misspelled-or-defined-by-a-module-not-included-in-the-server-configuration" class="headerlink" title="Invalid command ‘Header’, perhaps misspelled or defined by a module not included in the server configuration"></a>Invalid command ‘Header’, perhaps misspelled or defined by a module not included in the server configuration</h4><p>The solution is enable <strong>header</strong> module.</p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line"># Enabling <span class="keyword">module</span> headers.</span><br><span class="line">a2enmod headers</span><br><span class="line">service apache2 restart</span><br></pre></td></tr></tbody></table></figure>
<p>Test <strong>header</strong> module.</p>
<figure class="highlight 1c"><table><tbody><tr><td class="code"><pre><span class="line">apachectl -M <span class="string">| grep head</span></span><br><span class="line">headers_module (shared)</span><br><span class="line">Syntax OK</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Invalid-command-‘ProxyPass’-perhaps-misspelled-or-defined-by-a-module-not-included-in-the-server-configuration"><a href="#Invalid-command-‘ProxyPass’-perhaps-misspelled-or-defined-by-a-module-not-included-in-the-server-configuration" class="headerlink" title="Invalid command ‘ProxyPass’, perhaps misspelled or defined by a module not included in the server configuration"></a>Invalid command ‘ProxyPass’, perhaps misspelled or defined by a module not included in the server configuration</h4><p><strong>ProxyPass</strong> directive is defined in module <strong>proxy_http</strong>. We have to enable this module before using <strong>ProxyPass</strong></p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line"># Enabling <span class="keyword">module</span> headers.</span><br><span class="line">a2enmod proxy_http</span><br></pre></td></tr></tbody></table></figure>
<h4 id="SSL-Certificate-Not-Trusted"><a href="#SSL-Certificate-Not-Trusted" class="headerlink" title="SSL Certificate Not Trusted"></a>SSL Certificate Not Trusted</h4><p>If the certificate is indeed signed by a trusted certificate authority (CA) and is not expired then such warning indicates the possibility that one of the intermediate/chain certificates is not installed on the web server in between the primary and root certificate. Add the following configuration to solve this problem.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">SSLCertificateChainFile <span class="regexp">/django/</span>servo<span class="regexp">/ssl/</span><span class="number">9123456</span>_www.example.com_chain.crt</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Apache</tag>
      </tags>
  </entry>
  <entry>
    <title>Coding Skills Of SwiftUI For Beginners</title>
    <url>/2023/02/23/Coding-Skills-Of-SwiftUI-For-Beginners/</url>
    <content><![CDATA[<html><head></head><body><p>This article records the problems I met when developing an ios app as a beginner and the corresponding solutions. Besides, there are some useful coding skills that deserve to share with you. If you are a beginner of SwiftUI, I hope this article will help you to learning SwiftUI quickly and easily.</p>
<span id="more"></span>
<h3 id="Errors-amp-Solutions"><a href="#Errors-amp-Solutions" class="headerlink" title="Errors &amp; Solutions"></a>Errors &amp; Solutions</h3><h4 id="UICalendarView-UICalendarView’s-height-is-smaller-than-it-can-render-its-content-in-defaulting-to-the-minimum-height"><a href="#UICalendarView-UICalendarView’s-height-is-smaller-than-it-can-render-its-content-in-defaulting-to-the-minimum-height" class="headerlink" title="[UICalendarView] UICalendarView’s height is smaller than it can render its content in; defaulting to the minimum height."></a>[UICalendarView] UICalendarView’s height is smaller than it can render its content in; defaulting to the minimum height.</h4><p>This warning seems to be a bug of swiftui. It is because the width of <strong>DatePicker</strong> is larger than the device’s width. Therefore solve this warning by the following modifier.</p>
<figure class="highlight arduino"><table><tbody><tr><td class="code"><pre><span class="line">.<span class="built_in">frame</span>(width: UIScreen.main.bounds.width - <span class="number">20</span>)</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>SwiftUI</category>
      </categories>
      <tags>
        <tag>SwiftUI</tag>
        <tag>ios app</tag>
      </tags>
  </entry>
  <entry>
    <title>Deploy Gitlab Using Docker On Synology DS218+</title>
    <url>/2023/02/25/Deploy-Gitlab-Using-Docker-On-Synology-DS218/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://about.gitlab.com/">Gitlab</a> is a perfect software that we can use to build a personal git repository manage system on local servers. In this article, I will deploy a gitlab using docker on synology DS218+ step by step.</p>
<span id="more"></span>
<h3 id="Install-Gitlab"><a href="#Install-Gitlab" class="headerlink" title="Install Gitlab"></a>Install Gitlab</h3><h4 id="Install-Docker"><a href="#Install-Docker" class="headerlink" title="Install Docker"></a>Install Docker</h4><p>Docker is supported by a series of synology nas hardwares. We can install docker in suite center.</p>
<h4 id="Download-Gitlab-Image"><a href="#Download-Gitlab-Image" class="headerlink" title="Download Gitlab Image"></a>Download Gitlab Image</h4><p>Open docker and search <strong>gitlab</strong> in registration tab page. You can download the latest release or the release that has the most downloads. I choose <em>gitlab-ce</em> that has the most downloads, which is more stable.</p>
<h4 id="Install-amp-Config-Gitlab"><a href="#Install-amp-Config-Gitlab" class="headerlink" title="Install &amp; Config Gitlab"></a>Install &amp; Config Gitlab</h4><p>Double click the downloaded image to install it. Input the name of the docker, for example, <strong>gitlab-ce</strong>. And click the button <strong>Advanced Settings</strong>.</p>
<h5 id="Directory"><a href="#Directory" class="headerlink" title="Directory"></a>Directory</h5><p>In the volume tab, we build and configure three directories for gitlab to store logs, configurations and data correspondingly.</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">docker<span class="regexp">/gitlab/</span>logs -&gt; <span class="regexp">/var/</span>log/gitlab</span><br><span class="line">docker<span class="regexp">/gitlab/</span>config -&gt; <span class="regexp">/etc/gi</span>tlab</span><br><span class="line">docker<span class="regexp">/gitlab/</span>data -&gt; <span class="regexp">/var/</span>opt/gitlab</span><br></pre></td></tr></tbody></table></figure>
<h5 id="Port"><a href="#Port" class="headerlink" title="Port"></a>Port</h5><p>We need set the http, https and ssh port map for serving gitlab. The default ports of http, https on docker are 80, 443 and 22. These three ports are reserved in synology nas and we had better use other ports instead. Here I use 30000 to map 80, 30001 to map 22.<br>Finish the above steps, we can run this docker. A few minutes latter, we can visit gitlab via “<a href="http://192.168.1.2:30000/">http://192.168.1.2:30000</a>“, where “192.168.1.2” is the ip of synology nas.</p>
<h3 id="Customize-Gitlab"><a href="#Customize-Gitlab" class="headerlink" title="Customize Gitlab"></a>Customize Gitlab</h3><p>We can further customize gitlab for better performance.</p>
<h4 id="external-url"><a href="#external-url" class="headerlink" title="external_url"></a>external_url</h4><p><strong>external_url</strong> defines the http url of gitlab.</p>
<figure class="highlight 1c"><table><tbody><tr><td class="code"><pre><span class="line">external_url 'http://192.168.1.2:<span class="number">3000</span>0'</span><br></pre></td></tr></tbody></table></figure>
<h4 id="ssh-host-name-and-port"><a href="#ssh-host-name-and-port" class="headerlink" title="ssh host name and port"></a>ssh host name and port</h4><p>The default ssh host name is the ip address, which is difficult to use. We can custom the ssh host name using a domain name such as <strong>gitlab.com</strong></p>
<figure class="highlight prolog"><table><tbody><tr><td class="code"><pre><span class="line">gitlab_rails[<span class="string">'gitlab_ssh_host'</span>] = <span class="string">'gitlab.com'</span></span><br><span class="line">gitlab_rails[<span class="string">'gitlab_shell_ssh_port'</span>] = <span class="number">30001</span></span><br></pre></td></tr></tbody></table></figure>
<p>The remote url of a repository become “ssh://<a href="mailto:git@gitlab.com">git@gitlab.com</a>:30001/yongsheng/jupyter.git”, which is more readable.</p>
<h4 id="close-email-service"><a href="#close-email-service" class="headerlink" title="close email service"></a>close email service</h4><p>It is better to close email function if the gitlab is a personal one to achieve a better performance.</p>
<figure class="highlight actionscript"><table><tbody><tr><td class="code"><pre><span class="line">gitlab_rails[<span class="string">'smtp_enable'</span>] = <span class="literal">false</span></span><br><span class="line">gitlab_rails[<span class="string">'gitlab_email_enabled'</span>] = <span class="literal">false</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="content-security-policy"><a href="#content-security-policy" class="headerlink" title="content_security_policy"></a>content_security_policy</h4><p>Set frame ancestors for url masking. Thus we can visit gitlab by the masked url, for example, “<a href="http://gitlab.demo.com/">http://gitlab.demo.com</a>“</p>
<figure class="highlight sml"><table><tbody><tr><td class="code"><pre><span class="line">gitlab_rails[<span class="symbol">'content_security_policy'</span>] = {</span><br><span class="line"> <span class="symbol">'enabled'</span> =&gt; <span class="literal">true</span>,</span><br><span class="line"> <span class="symbol">'report_only'</span> =&gt; <span class="literal">false</span>,</span><br><span class="line"># <span class="type">Each</span> directive is a <span class="type">String</span> (e.g. <span class="string">"'self'"</span>).</span><br><span class="line"> <span class="symbol">'directives'</span> =&gt; {</span><br><span class="line">   <span class="symbol">'base_uri'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'child_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'connect_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'default_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'font_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'form_action'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'frame_ancestors'</span> =&gt; <span class="string">"gitlab.demo.com"</span>,</span><br><span class="line">   <span class="symbol">'frame_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'img_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'manifest_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'media_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'object_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'script_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'style_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'worker_src'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line">   <span class="symbol">'report_uri'</span> =&gt; <span class="literal">nil</span>,</span><br><span class="line"> }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="better-performance"><a href="#better-performance" class="headerlink" title="better performance"></a>better performance</h4><p>Close the functions that are rarely use.</p>
<figure class="highlight prolog"><table><tbody><tr><td class="code"><pre><span class="line">gitlab_rails[<span class="string">'terraform_state_enabled'</span>] = false</span><br><span class="line">gitlab_rails[<span class="string">'usage_ping_enabled'</span>] = false</span><br><span class="line">gitlab_rails[<span class="string">'registry_enabled'</span>] = false</span><br><span class="line">registry[<span class="string">'enable'</span>] = false</span><br><span class="line">sidekiq[<span class="string">'metrics_enabled'</span>] = false</span><br><span class="line">gitlab_ci[<span class="string">'gitlab_ci_all_broken_builds'</span>] = false</span><br><span class="line">gitlab_rails[<span class="string">'gitlab_kas_enabled'</span>] = false</span><br><span class="line">gitlab_kas[<span class="string">'enable'</span>] = false</span><br><span class="line">mattermost[<span class="string">'enable'</span>] = false</span><br><span class="line">prometheus[<span class="string">'enable'</span>] = false</span><br><span class="line">alertmanager[<span class="string">'enable'</span>] = false</span><br><span class="line">node_exporter[<span class="string">'enable'</span>] = false</span><br><span class="line">redis_exporter[<span class="string">'enable'</span>] = false</span><br><span class="line">postgres_exporter[<span class="string">'enable'</span>] = false</span><br><span class="line">gitlab_exporter[<span class="string">'enable'</span>] = false</span><br><span class="line">prometheus_monitoring[<span class="string">'enable'</span>] = false</span><br><span class="line">grafana[<span class="string">'enable'</span>] = false</span><br><span class="line">grafana[<span class="string">'reporting_enabled'</span>] = false</span><br><span class="line">gitlab_rails[<span class="string">'kerberos_enabled'</span>] = false</span><br><span class="line">sentinel[<span class="string">'enable'</span>] = false</span><br></pre></td></tr></tbody></table></figure>
<p>This is my <a href="gitlab.rb">gitlab.rb</a>. Feel free to download and use it.</p>
<h3 id="Commands"><a href="#Commands" class="headerlink" title="Commands"></a>Commands</h3><h4 id="start"><a href="#start" class="headerlink" title="start"></a>start</h4><figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">gitlab-ctl <span class="literal">start</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="stop"><a href="#stop" class="headerlink" title="stop"></a>stop</h4><figure class="highlight arduino"><table><tbody><tr><td class="code"><pre><span class="line">gitlab-ctl stop</span><br></pre></td></tr></tbody></table></figure>
<h4 id="reconfigure"><a href="#reconfigure" class="headerlink" title="reconfigure"></a>reconfigure</h4><figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">gitlab-ctl reconfigure</span></span><br></pre></td></tr></tbody></table></figure>
<p>This command will make the configuration take effect and restart gitlab.</p>
<h4 id="restart"><a href="#restart" class="headerlink" title="restart"></a>restart</h4><figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">gitlab-ctl restart</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="status"><a href="#status" class="headerlink" title="status"></a>status</h4><figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">gitlab-ctl status</span></span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Gitlab</category>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Gitlab</tag>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Coding Skills of Django</title>
    <url>/2023/03/03/Coding-Skills-of-Django/</url>
    <content><![CDATA[<html><head></head><body><p>In this article, I will share some useful coding skills of Django. Hope it helps you.</p>
<span id="more"></span>
<h3 id="Errors-amp-Solutions"><a href="#Errors-amp-Solutions" class="headerlink" title="Errors &amp; Solutions"></a>Errors &amp; Solutions</h3><h4 id="Related-Field-has-invalid-lookup-icontains"><a href="#Related-Field-has-invalid-lookup-icontains" class="headerlink" title="Related Field has invalid lookup: icontains"></a>Related Field has invalid lookup: icontains</h4><h5 id="Error-Condition"><a href="#Error-Condition" class="headerlink" title="Error Condition"></a>Error Condition</h5><p>When using search function in <strong>admin</strong> module, we may meet this error.</p>
<ul>
<li>The search configuration<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">class <span class="built_in">RecItemAdmin</span>(admin.ModelAdmin):</span><br><span class="line">    <span class="selector-tag">form</span> = RecItemAdminForm</span><br><span class="line">    search_fields = <span class="selector-attr">[<span class="string">'category'</span>, <span class="string">'brand'</span>, <span class="string">'title'</span>,]</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>The model definition<ul>
<li><p>RecItem</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">class RecItem(models.Model):</span><br><span class="line">    category = models.ForeignKey(Category, <span class="attribute">on_delete</span>=models.CASCADE, <span class="attribute">related_name</span>=<span class="string">'rec_items'</span>)</span><br><span class="line">    title = models.CharField(<span class="attribute">max_length</span>=64, <span class="attribute">null</span>=<span class="literal">True</span>, <span class="attribute">blank</span>=<span class="literal">True</span>)</span><br><span class="line">    brand = models.ForeignKey(Brand, <span class="attribute">on_delete</span>=models.CASCADE, <span class="attribute">related_name</span>=<span class="string">'rec_items'</span>)</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>Category</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">class Category(models.Model):</span><br><span class="line">    card = models.ForeignKey(CardInfo, <span class="attribute">on_delete</span>=models.CASCADE, <span class="attribute">related_name</span>=<span class="string">'cates'</span>)</span><br><span class="line">    name = models.CharField(<span class="attribute">max_length</span>=32, <span class="attribute">null</span>=<span class="literal">True</span>, <span class="attribute">blank</span>=<span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>
<pre><code>* Brand
</code></pre>
<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="constructor">Brand(<span class="params">models</span>.Model)</span>:</span><br><span class="line">    name = models.<span class="constructor">CharField(<span class="params">max_length</span>=64, <span class="params">unique</span> = True, <span class="params">verbose_name</span>='中文名称')</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h5><p>The search fields category and brand are foreign keys. Django does not support search on foreign key and manytomany field. We have to search on string field. Thus we can use the double under score symbol to get the model’s string properties.</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">class <span class="built_in">RecItemAdmin</span>(admin.ModelAdmin):</span><br><span class="line">    <span class="selector-tag">form</span> = RecItemAdminForm</span><br><span class="line">    search_fields = <span class="selector-attr">[<span class="string">'category__name'</span>, <span class="string">'brand__name'</span>, <span class="string">'title'</span>,]</span></span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Django</category>
      </categories>
      <tags>
        <tag>Django</tag>
      </tags>
  </entry>
  <entry>
    <title>Setup Source Of pip On MacBook</title>
    <url>/2023/05/07/Setup-Source-Of-pip-On-MacBook/</url>
    <content><![CDATA[<html><head></head><body><p>The default index url of <strong>pip</strong> is <a href="https://pypi.org/simple">https://pypi.org/simple</a>, which is slow for Chinese users. In this article, I will show you how to configure the index url to sources in China globally.</p>
<span id="more"></span>
<h3 id="Sources-In-China"><a href="#Sources-In-China" class="headerlink" title="Sources In China"></a>Sources In China</h3><p>There are several sources managed by organized by institutions in China.</p>
<ul>
<li>清华：&nbsp;<a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a></li>
<li>阿里云：&nbsp;<a href="http://mirrors.aliyun.com/pypi/simple/">http://mirrors.aliyun.com/pypi/simple/</a></li>
<li>中国科技大学 &nbsp;<a href="https://pypi.mirrors.ustc.edu.cn/simple/">https://pypi.mirrors.ustc.edu.cn/simple/</a></li>
<li>华中理工大学：&nbsp;<a href="http://pypi.hustunique.com/">http://pypi.hustunique.com/</a></li>
<li>山东理工大学：&nbsp;<a href="http://pypi.sdutlinux.org/">http://pypi.sdutlinux.org/</a></li>
<li>豆瓣：&nbsp;<a href="http://pypi.douban.com/simple/">http://pypi.douban.com/simple/</a><figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">### Use Temporarily</span><br></pre></td></tr></tbody></table></figure>
pip install package -i <a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a><figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">### Configuration</span><br><span class="line">#### Create Configure File</span><br></pre></td></tr></tbody></table></figure>
cd<br>mkdir .pip<br>cd .pip<br>touch pip.conf<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">#### Configure</span><br></pre></td></tr></tbody></table></figure>
vi pip.conf<br>[global]<br>index-url = <a href="https://pypi.tuna.tsinghua.edu.cn/simple">https://pypi.tuna.tsinghua.edu.cn/simple</a><br>[install]<br>trusted-host = <a href="https://pypi.tuna.tsinghua.edu.cn/">https://pypi.tuna.tsinghua.edu.cn/</a></li>
</ul>
<p>```</p>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Python</category>
        <category>pip</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>pip</tag>
      </tags>
  </entry>
  <entry>
    <title>Using scipy and numpy in Django</title>
    <url>/2023/05/08/Using-scipy-in-Django/</url>
    <content><![CDATA[<html><head></head><body><p>When <strong>import scipy</strong> or <strong>import numpy as np</strong> in a Django project, it works very well in development mode. However, it will get stuck when deploy Django project using apache. In this article, I will show you how to solve this problem.</p>
<span id="more"></span>
<p>Some third party packages for Python which use C extension modules, and this includes scipy and numpy, will only work in the Python main interpreter and cannot be used in sub interpreters as mod_wsgi by default uses. The result can be thread deadlock, incorrect behavior or processes crashes. These is detailed in:<a href="http://code.google.com/p/modwsgi/wiki/ApplicationIssues#Python_Simplified_GIL_State_API">http://code.google.com/p/modwsgi/wiki/ApplicationIssues#Python_Simplified_GIL_State_API</a></p>
<p>The workaround is to force the WSGI application to run in the main interpreter of the process using:</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">WSGIApplicationGroup</span> <span class="variable">%{GLOBAL}</span></span><br></pre></td></tr></tbody></table></figure>
<p>Add the above line to the apache’s configure file, which is probably locate in <strong>/etc/apache/sites-available</strong>. And then reload apache service using:</p>
<figure class="highlight jboss-cli"><table><tbody><tr><td class="code"><pre><span class="line">systemctl <span class="keyword">reload</span> apache2.service</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Django</category>
      </categories>
      <tags>
        <tag>Django</tag>
      </tags>
  </entry>
  <entry>
    <title>Configure Host for SSH</title>
    <url>/2023/02/20/Configure-Host-for-SSH/</url>
    <content><![CDATA[<html><head></head><body><p><strong>SSH</strong> is secure way to login a server. It is difficult to remember the IPs of several servers. In this tutorials, I will teach to setup host of <strong>SSH</strong> to login using hostname instead of IP.</p>
<span id="more"></span>
<h3 id="Create-Config-File"><a href="#Create-Config-File" class="headerlink" title="Create Config File"></a>Create Config File</h3><p>Create a custom ssh config file by the following command.</p>
<figure class="highlight arcade"><table><tbody><tr><td class="code"><pre><span class="line">vi ~<span class="regexp">/.ssh/</span>config</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Add-Host"><a href="#Add-Host" class="headerlink" title="Add Host"></a>Add Host</h3><figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">Host gitlab.com</span><br><span class="line">    HostName <span class="number">10.10</span>.<span class="number">10.10</span></span><br><span class="line">    <span class="keyword">User</span> <span class="title">git</span></span><br><span class="line">    Port <span class="number">30001</span></span><br><span class="line">    IdentityFile ~/.ssh/id_rsa</span><br></pre></td></tr></tbody></table></figure>
<p>The above host is a ssh connect for git. With this host, we can use <strong>ssh://<a href="mailto:git@gitlab.com">git@gitlab.com</a>:30001/</strong> to clone and push.</p>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Git</category>
        <category>SSH</category>
      </categories>
      <tags>
        <tag>Git</tag>
        <tag>SSH</tag>
      </tags>
  </entry>
  <entry>
    <title>ROS2 Learning Notes - ROS2 Humble For Beginners</title>
    <url>/2023/12/09/ROS2-Learning-Notes-ROS2-Humble-For-Beginners/</url>
    <content><![CDATA[<html><head></head><body><p>本文为<strong>ROS 2</strong>初学者的学习笔记，主要记录了我学习ROS 2过程中的重要信息，防止遗漏。主要参考资料为<a href="https://docs.ros.org/en/humble/index.html">ROS 2: Humble</a>的官方文档和<a href="https://www.youtube.com/watch?v=0aPbWsyENA8&amp;list=PLLSegLrePWgJudpPUof4-nVFHGkB62Izy">ROS 2 Tutorials - ROS2 Humble For Beginners</a>。<br><span id="more"></span></p>
<h2 id="ROS2-VS-ROS1"><a href="#ROS2-VS-ROS1" class="headerlink" title="ROS2 VS. ROS1"></a>ROS2 VS. ROS1</h2><ul>
<li>适用不可靠的无线网络</li>
<li>适用于机器人集群</li>
<li>通信安全</li>
<li>适用于嵌入式系统</li>
<li>支持实时系统<h2 id="ROS2的结构"><a href="#ROS2的结构" class="headerlink" title="ROS2的结构"></a>ROS2的结构</h2>底层的通信协议使用的是<strong>DDS</strong></li>
<li>Cyclone DDS</li>
<li>Fast DDS</li>
<li>Connext DDS<br>上面是中间件， <strong>ROS 2 Middleeare</strong><br>再上面是<strong>rcl</strong>， <strong>ROS 2 Client Library</strong><br>再上面是各种语言接口，例如<strong>C++</strong>, <strong>Python</strong>, <strong>Java</strong><br>顶层的是这些语言开发的<strong>Applications</strong></li>
</ul>
<p><strong>ROS2</strong>可以帮助我们实现硬件抽象，设备底层控制， 通信和包管理的功能。</p>
<h2 id="安装ROS2-Humble"><a href="#安装ROS2-Humble" class="headerlink" title="安装ROS2 Humble"></a>安装ROS2 Humble</h2><p><strong>ROS</strong>的全称是<strong>Robot Operation System</strong>，主要特点是分布式的结构，节点之间通过通信实现数据交换。ROS还提供了一系列即插即用的库。</p>
<h3 id="按照官网教程安装"><a href="#按照官网教程安装" class="headerlink" title="按照官网教程安装"></a>按照官网教程安装</h3><p>ROS2 Humble支持在Ubuntu22.04上包安装，所以直接按照<a href="https://docs.ros.org/en/humble/Installation/Ubuntu-Install-Debians.html">官网教程</a>安装即可。</p>
<h3 id="其他设置"><a href="#其他设置" class="headerlink" title="其他设置"></a>其他设置</h3><ul>
<li>安装ROS工具包<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-gazebo-ros2-control</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-gazebo-ros-pkgs</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-moveit</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-urdf-tutorial</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-tf2-tools</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-navigation2</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-nav2-bringup</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-turtlebot3</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-turtlebot3-gazebo</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-tf-transformations</span><br><span class="line">sudo apt-<span class="built_in">get</span> install python3-transforms3d</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-joint-trajectory-controller</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-joint-state-broadcaster</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-forward-command-controller</span><br></pre></td></tr></tbody></table></figure></li>
<li>安装Python编译工具—colcon<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install <span class="keyword">python3</span>-colcon-common-extensions</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"source /usr/share/colcon_argcomplete/hook/colcon-argcomplete.zsh"</span> &gt;&gt; ~/.zshrc</span><br></pre></td></tr></tbody></table></figure></li>
<li>解决setuptools版本问题导致的warning<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line"><span class="regexp">/usr/</span>lib<span class="regexp">/python3/</span>dist-packages<span class="regexp">/setuptools/</span>command/install.py:<span class="number">34</span>: SetuptoolsDeprecationWarning: setup.py install is deprecated. Use build and pip and other standards-based tools.</span><br><span class="line">  warnings.warn(</span><br></pre></td></tr></tbody></table></figure>
setuptools默认安装的版本为59.6.0，需要降级为58.2.0。<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">pip</span> install setuptools==<span class="number">58</span>.<span class="number">2</span>.<span class="number">0</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>解决ros的指令在terminal中自动补全<br>将以下内容添加到zshrc配置文件中：<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># argcomplete for ros2 &amp; colcon</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">"<span class="subst">$(register-python-argcomplete3 ros2)</span>"</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">"<span class="subst">$(register-python-argcomplete3 colcon)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
需要将<strong>rosidl-argcomplete.zsh</strong>文件中的一行代码注释掉。<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo vi <span class="regexp">/opt/</span>ros<span class="regexp">/humble/</span>share<span class="regexp">/rosidl_cli/</span>environment/rosidl-argcomplete.zsh</span><br></pre></td></tr></tbody></table></figure>
注释<figure class="highlight 1c"><table><tbody><tr><td class="code"><pre><span class="line">autoload -U +X compinit <span class="meta">&amp;&amp; compinit</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="Source-Configuration"><a href="#Source-Configuration" class="headerlink" title="Source Configuration"></a>Source Configuration</h3>ROS的很多配置需要source之后才能生效，为了避免每次启动terminal都需要重新source，我们把source语句加入到配置文件中。<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">source</span> <span class="regexp">/opt/</span>ros<span class="regexp">/humble/</span>setup.zsh</span><br><span class="line"><span class="keyword">source</span> <span class="regexp">/usr/</span>share<span class="regexp">/colcon_argcomplete/</span>hook/colcon-argcomplete.zsh</span><br><span class="line"><span class="keyword">source</span> ~<span class="regexp">/ros2_ws/i</span>nstall/setup.zsh</span><br><span class="line"><span class="keyword">source</span> <span class="regexp">/usr/</span>share<span class="regexp">/gazebo/</span>setup.sh</span><br></pre></td></tr></tbody></table></figure>
第一句是source ros安装包配置，第二句是source自动补全配置，第三句是source工作空间的配置。每次ros包重新编译后都需要重新source ros的工作空间。<h3 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h3><strong>ROS</strong>所有的代码均开源，连接见：<a href="https://github.com/orgs/ros2/repositories">https://github.com/orgs/ros2/repositories</a>。</li>
<li>rclcpp<br>cpp开发接口：<a href="https://github.com/ros2/rclcpp">https://github.com/ros2/rclcpp</a></li>
<li>rclpy<br>python开发接口：<a href="https://github.com/ros2/rclpy">https://github.com/ros2/rclpy</a></li>
<li>ros2cli<br>命令行接口：<a href="https://github.com/ros2/ros2cli">https://github.com/ros2/ros2cli</a></li>
<li>ros2bag<br>记录数据包：<a href="https://github.com/ros2/rosbag2">https://github.com/ros2/rosbag2</a></li>
<li>common interfaces<br><strong>msg</strong>和<strong>srv</strong>源码：<a href="https://github.com/ros2/common_interfaces">https://github.com/ros2/common_interfaces</a></li>
<li>rviz<br>3D可视化接口：<a href="https://github.com/ros2/rviz">https://github.com/ros2/rviz</a><br>除了源码，<strong>ROS</strong>还提供了一份<a href="https://design.ros2.org/">设计文档</a>，详细说明了设计思路和接口说明。源码见：<a href="git@github.com:ros2/design.git">git@github.com:ros2/design.git</a><h2 id="创建WorkSpace"><a href="#创建WorkSpace" class="headerlink" title="创建WorkSpace"></a>创建WorkSpace</h2><h3 id="创建文件夹"><a href="#创建文件夹" class="headerlink" title="创建文件夹"></a>创建文件夹</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> &amp; <span class="built_in">mkdir</span> ros2_ws</span><br><span class="line"><span class="built_in">cd</span> ros2_ws</span><br><span class="line"><span class="built_in">mkdir</span> src</span><br></pre></td></tr></tbody></table></figure>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight ada"><table><tbody><tr><td class="code"><pre><span class="line">colcon build <span class="comment">--symlink-install</span></span><br></pre></td></tr></tbody></table></figure>
<strong>—symlink-install</strong>参数可以让python代码立即生效，而不需要重新build。<br>编译后会创建<strong>build</strong>，<strong>install</strong>，<strong>log</strong>文件夹，需要将<strong>install</strong>文件夹内的<strong>setup.zsh</strong>放到zshrc配置文件中，让工作空间全局生效。<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── build</span><br><span class="line">│&nbsp;&nbsp; └── COLCON_IGNORE</span><br><span class="line">├── install</span><br><span class="line">│&nbsp;&nbsp; ├── COLCON_IGNORE</span><br><span class="line">│&nbsp;&nbsp; ├── local_setup<span class="selector-class">.bash</span></span><br><span class="line">│&nbsp;&nbsp; ├── local_setup<span class="selector-class">.ps1</span></span><br><span class="line">│&nbsp;&nbsp; ├── local_setup<span class="selector-class">.sh</span></span><br><span class="line">│&nbsp;&nbsp; ├── _local_setup_util_ps1<span class="selector-class">.py</span></span><br><span class="line">│&nbsp;&nbsp; ├── _local_setup_util_sh<span class="selector-class">.py</span></span><br><span class="line">│&nbsp;&nbsp; ├── local_setup<span class="selector-class">.zsh</span></span><br><span class="line">│&nbsp;&nbsp; ├── setup<span class="selector-class">.bash</span></span><br><span class="line">│&nbsp;&nbsp; ├── setup<span class="selector-class">.ps1</span></span><br><span class="line">│&nbsp;&nbsp; ├── setup<span class="selector-class">.sh</span></span><br><span class="line">│&nbsp;&nbsp; └── setup<span class="selector-class">.zsh</span></span><br><span class="line">├── log</span><br><span class="line">│&nbsp;&nbsp; ├── build_2023-<span class="number">12</span>-<span class="number">13</span>_15-<span class="number">55</span>-<span class="number">37</span></span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; ├── events<span class="selector-class">.log</span></span><br><span class="line">│&nbsp;&nbsp; │&nbsp;&nbsp; └── logger_all<span class="selector-class">.log</span></span><br><span class="line">│&nbsp;&nbsp; ├── COLCON_IGNORE</span><br><span class="line">│&nbsp;&nbsp; ├── latest -&gt; latest_build</span><br><span class="line">│&nbsp;&nbsp; └── latest_build -&gt; build_2023-<span class="number">12</span>-<span class="number">13</span>_15-<span class="number">55</span>-<span class="number">37</span></span><br><span class="line">└── <span class="attribute">src</span></span><br></pre></td></tr></tbody></table></figure>
<strong>注意：编译必须在工作空间的根目录进行。</strong><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"source ros2_ws/install/setup.zsh"</span> &gt;&gt; ~/.zshrc</span><br></pre></td></tr></tbody></table></figure>
有多个package的情况下，如果仅需要编译指定的package，则可以使用<strong>—packages-select</strong>参数指定。<figure class="highlight n1ql"><table><tbody><tr><td class="code"><pre><span class="line">colcon <span class="keyword">build</span> --packages-<span class="keyword">select</span> my_py_pkg</span><br></pre></td></tr></tbody></table></figure>
编译成功后，会在工作空间<strong>install/lib</strong>文件夹下面生成对应package的可执行文件。具体目录在<strong>setup.cfg</strong>中配置。<br>编译成功后，需要重新source，以让新编译的内容生效。</li>
</ul>
<h2 id="创建Package"><a href="#创建Package" class="headerlink" title="创建Package"></a>创建Package</h2><p>每一个package都是独立的单元，例如可以创建一个camera package，可以创建一个hardware control package, 可以创建一个motion planning package</p>
<h3 id="Python-Package"><a href="#Python-Package" class="headerlink" title="Python Package"></a>Python Package</h3><figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line">cd ros2_ws/<span class="attribute">src</span></span><br><span class="line">ros2 pkg create my_robot_controller <span class="attr">--build-type</span> ament_python <span class="attr">--dependencies</span> rclpy</span><br></pre></td></tr></tbody></table></figure>
<p>可以在任意目录下创建package，但是为了代码便于管理，推荐在src目录下创建package。<br><strong>build-type</strong>选项可以设置是package的编写语言，可以是python也可以是c++。<br><strong>dependencies</strong>选项可以设置语言，对于python而言，是rclpy。<br>指令会创建一个名字为my_robot_controller的package，是一个单独的文件夹，文件结构如下所示：<br></p><figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">.</span><br><span class="line">└── my_robot_controller</span><br><span class="line">    ├── my_robot_controller</span><br><span class="line">    │&nbsp;&nbsp; └── __init__<span class="selector-class">.py</span></span><br><span class="line">    ├── package<span class="selector-class">.xml</span></span><br><span class="line">    ├── resource</span><br><span class="line">    │&nbsp;&nbsp; └── my_robot_controller</span><br><span class="line">    ├── setup<span class="selector-class">.cfg</span></span><br><span class="line">    ├── setup<span class="selector-class">.py</span></span><br><span class="line">    └── test</span><br><span class="line">        ├── test_copyright<span class="selector-class">.py</span></span><br><span class="line">        ├── test_flake8<span class="selector-class">.py</span></span><br><span class="line">        └── test_pep257<span class="selector-class">.py</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span> directories, <span class="number">8</span> files</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><br>然后回到ros2_ws根目录，使用<strong>colcon build</strong>指令编译刚刚创建的package。<p></p>
<h4 id="创建节点"><a href="#创建节点" class="headerlink" title="创建节点"></a>创建节点</h4><p>节点是机器人操作系统的最小运行单元，多个节点组成一张图，共同构成一个机器人操作系统。一个节点一般只用于完成一件事情。多个节点之间通过<strong>topic</strong>、<strong>service</strong>和<strong>parameters</strong>进行通信。<br>多节点架构降低了机器人操作系统的复杂度，便于开发和调试；提升了系统的鲁棒性，一个节点挂了不影响其他节点；节点可以使用python和C++编写。<br>节点命名不能冲突。<br>节点的源代码存在于package包的同名文件夹下面，例如对于<strong>my_robot_controller</strong>package而言，节点源码应该存在于<strong>my_robot_controller/my_robot_controller</strong>文件夹下面。</p>
<ul>
<li>节点的源码文件是一个可执行文件<br>使用以下命令创建节点源码文件<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">touch</span> my_first_node.py</span><br><span class="line"><span class="built_in">chmod</span> +x my_first_node.py</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h5 id="import-rclpy"><a href="#import-rclpy" class="headerlink" title="import rclpy"></a>import rclpy</h5><p>使用python开发的ros节点需要使用<strong>rclpy</strong>(ROS Client Library for Python)。<br></p><figure class="highlight elm"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> rclpy</span><br></pre></td></tr></tbody></table></figure><p></p>
<h5 id="定义main函数"><a href="#定义main函数" class="headerlink" title="定义main函数"></a>定义main函数</h5><ul>
<li>main函数<figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">def main(<span class="attr">args=</span>None):</span><br><span class="line">    rclpy.init(<span class="attr">args=</span>args)</span><br><span class="line">    <span class="keyword">node</span> <span class="title">= MyNode</span>()</span><br><span class="line">    rclpy.spin(<span class="keyword">node</span><span class="title">=node</span>)</span><br><span class="line">    rclpy.shutdown()</span><br></pre></td></tr></tbody></table></figure>
main函数开头用<strong>rclpy.init</strong>函数进行初始化，载入ros资源；结尾用<strong>rclpy.shutdown</strong>函数进行结束，释放ros资源。在init和shutdown中间，可以定义节点对象，并使用<strong>rclpy.spin</strong>函数保证节点一直运行。</li>
<li>入口<figure class="highlight isbl"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">if</span></span> <span class="variable">__name__</span> == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="function"><span class="title">main</span>()</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h5 id="继承Node创建节点类"><a href="#继承Node创建节点类" class="headerlink" title="继承Node创建节点类"></a>继承Node创建节点类</h5><p>节点类需要继承<strong>rclpy.node</strong>中的<strong>Node</strong>。<br></p><figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">from rclpy.node import <span class="keyword">Node</span></span><br><span class="line"><span class="title">class</span> MyNode(<span class="keyword">Node</span><span class="title">):</span></span><br><span class="line"><span class="title">    def</span> __init__(self):</span><br><span class="line">        super().__init__(<span class="string">"first_node"</span>)</span><br></pre></td></tr></tbody></table></figure><br>在初始函数中对父类进行初始化，定义节点名称。<p></p>
<h5 id="安装node"><a href="#安装node" class="headerlink" title="安装node"></a>安装node</h5><p>在包的<strong>setup.py</strong>中的<strong>entry_points</strong>安装node。<br></p><figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">entry_points</span>={</span><br><span class="line">    <span class="string">'console_scripts'</span>: [</span><br><span class="line">        <span class="string">"test_node = my_robot_controller.my_first_node:main"</span>,</span><br><span class="line">        <span class="string">"draw_circle = my_robot_controller.draw_circle:main"</span></span><br><span class="line">    ],</span><br><span class="line">},</span><br></pre></td></tr></tbody></table></figure><br>主要定义可执行文件的名称和代码执行路径。可执行文件名为使用ros命令运行的名称，节点名称在定义节点时指定。<p></p>
<h3 id="C-Package"><a href="#C-Package" class="headerlink" title="C++ Package"></a>C++ Package</h3><figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line">cd ros2_ws/<span class="attribute">src</span></span><br><span class="line">ros2 pkg create my_cpp_pkg <span class="attr">--build-type</span> ament_cmake <span class="attr">--dependencies</span> rclcpp</span><br></pre></td></tr></tbody></table></figure>
<p>通过<strong>pkg create</strong>指令创建包，参数中指定<strong>ament_cmake</strong>和<strong>rclcpp</strong>。</p>
<h4 id="include-rclcpp"><a href="#include-rclcpp" class="headerlink" title="include rclcpp"></a>include rclcpp</h4><figure class="highlight arduino"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/rclcpp.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"rclcpp/executors.hpp"</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>引入<strong>rclcpp.hpp</strong>就够了，但是使用<strong>rclcpp::spin</strong>时，vscode会提示在<strong>rclcpp</strong>命名空间中找不到<strong>spin</strong>，因此引入<strong>executors.hpp</strong>解决这个问题。</p>
<h4 id="定义main函数-1"><a href="#定义main函数-1" class="headerlink" title="定义main函数"></a>定义main函数</h4><p>与python节点类似，需要在main函数中依次使用init、spin、shutdown函数来实现ros节点的初始化、运行和结束功能。<br></p><figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    rclcpp::<span class="built_in">init</span>(argc, argv);</span><br><span class="line">    <span class="keyword">auto</span> node = std::<span class="built_in">make_shared</span>&lt;rclcpp::Node&gt;(<span class="string">"cpp_test"</span>);</span><br><span class="line">    <span class="built_in">RCLCPP_INFO</span>(node-&gt;<span class="built_in">get_logger</span>(), <span class="string">"Hello Cpp Node"</span>);</span><br><span class="line">    rclcpp::<span class="built_in">spin</span>(node);</span><br><span class="line">    rclcpp::<span class="built_in">shutdown</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>打印日志使用了<strong>RCLCPP_INFO</strong>宏定义来实现，传入logger对象和日志内容字符串即可。<p></p>
<h4 id="继承Node创建节点类-1"><a href="#继承Node创建节点类-1" class="headerlink" title="继承Node创建节点类"></a>继承Node创建节点类</h4><figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> MyNode: public rclcpp::Node </span><br><span class="line">{</span><br><span class="line">    public:</span><br><span class="line">    <span class="constructor">MyNode()</span>: <span class="constructor">Node(<span class="string">"cpp_test"</span>)</span>, counter<span class="constructor">_(0)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="constructor">RCLCPP_INFO(<span class="params">this</span> -&gt; <span class="params">get_logger</span>()</span>, <span class="string">"Hello Cpp Node"</span>);</span><br><span class="line">        timer_ = this -&gt; create<span class="constructor">_wall_timer(<span class="params">std</span>::<span class="params">chrono</span>::<span class="params">seconds</span>(1)</span>,</span><br><span class="line">                                           std::bind(&amp;MyNode::timeCallback, this));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    void time<span class="constructor">Callback()</span></span><br><span class="line">    {</span><br><span class="line">        counter_++;</span><br><span class="line">        <span class="constructor">RCLCPP_INFO(<span class="params">this</span> -&gt; <span class="params">get_logger</span>()</span>, <span class="string">"Hello Cpp %d"</span>, counter_);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    rclcpp::TimerBase::SharedPtr timer_;</span><br><span class="line">    <span class="built_in">int</span> counter_;</span><br><span class="line">};</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>需要public继承<strong>rclcpp::Node</strong>，在初始化函数中完成节点名称的定义。</p>
<h4 id="CMake配置"><a href="#CMake配置" class="headerlink" title="CMake配置"></a>CMake配置</h4><p>在<strong>CMakeLists.txt</strong>中增加执行文件、依赖关系和安装路经的配置。<br></p><figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(cpp_node src/my_first_node.cpp)</span></span></span><br><span class="line"><span class="function"><span class="title">ament_target_dependencies</span><span class="params">(cpp_node rclcpp)</span></span></span><br><span class="line"><span class="function"><span class="title">install</span><span class="params">(TARGETS cpp_node DESTINATION lib/${PROJECT_NAME})</span></span></span><br></pre></td></tr></tbody></table></figure><p></p>
<h4 id="VSCode配置AutoComplete"><a href="#VSCode配置AutoComplete" class="headerlink" title="VSCode配置AutoComplete"></a>VSCode配置AutoComplete</h4><p>在VSCode中使用快捷键<strong>Ctrl+Shift+P</strong>打开命令索引框，输入<strong>c/c++</strong>，在候选中选择<strong>Edit Configuration JSON</strong>，然后将ros的include路径添加到<strong>includePath</strong>中，具体如下所示：<br></p><figure class="highlight prolog"><table><tbody><tr><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="string">"configurations"</span>: [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"Linux"</span>,</span><br><span class="line">            <span class="string">"includePath"</span>: [</span><br><span class="line">                <span class="string">"${workspaceFolder}/**"</span>,</span><br><span class="line">                <span class="string">"/usr/include/**"</span>,</span><br><span class="line">                <span class="string">"/usr/local/include/**"</span>,</span><br><span class="line">                <span class="string">"/opt/ros/humble/include/**"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="string">"defines"</span>: [],</span><br><span class="line">            <span class="string">"compilerPath"</span>: <span class="string">"/usr/bin/gcc"</span>,</span><br><span class="line">            <span class="string">"cStandard"</span>: <span class="string">"c11"</span>,</span><br><span class="line">            <span class="string">"cppStandard"</span>: <span class="string">"c17"</span>,</span><br><span class="line">            <span class="string">"intelliSenseMode"</span>: <span class="string">"linux-gcc-x64"</span></span><br><span class="line">        }</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"version"</span>: <span class="number">4</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br>除了修改<strong>includePath</strong>，还需要添加<strong>cppStandard</strong>。<br>上述指令运行节点并且将节点重命名为<strong>abs</strong>.<p></p>
<h3 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h3><p><strong>Topic</strong>提供了节点之间的通信机制，由名称和消息类型共同定义。其内容由publisher发布，subscriber会对内容进行监听和消费。一个topic可有有多个publisher，也可以有多个subscriber。</p>
<h4 id="时间回调函数"><a href="#时间回调函数" class="headerlink" title="时间回调函数"></a>时间回调函数</h4><p>时间回调函数一般用于周期性的完成工作。</p>
<h5 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h5><ul>
<li>定义时间回调函数<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">timer_callback</span>(<span class="params"><span class="variable language_">self</span></span>):</span><br><span class="line">    pass</span><br></pre></td></tr></tbody></table></figure></li>
<li>注册时间回调函数<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">self.create<span class="constructor">_timer(1.0, <span class="params">self</span>.<span class="params">timer_callback</span>)</span></span><br></pre></td></tr></tbody></table></figure>
一般在初始化函数中注册时间回调函数。时间回调函数的第一个参数是时间周期，第二个参数是调用的回调函数。</li>
</ul>
<h5 id="C"><a href="#C" class="headerlink" title="C++"></a>C++</h5><ul>
<li>定义时间回调函数<figure class="highlight lasso"><table><tbody><tr><td class="code"><pre><span class="line"><span class="literal">void</span> publishNews() {</span><br><span class="line">    auto msg = example_interfaces<span class="type">::msg</span><span class="type">::String</span>();</span><br><span class="line">    msg.<span class="built_in">data</span> = std<span class="type">::string</span>(<span class="string">"Hi, this is "</span>) + robot_name_ +</span><br><span class="line">        std<span class="type">::string</span>(<span class="string">" from the Robot News Station"</span>);</span><br><span class="line">    publisher_-&gt;publish(msg);</span><br><span class="line">    counter_++;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
<li>注册时间回调函数<figure class="highlight dts"><table><tbody><tr><td class="code"><pre><span class="line"><span class="symbol">rclcpp:</span>:TimerBase::SharedPtr timer_<span class="punctuation">;</span></span><br><span class="line">timer_ = this-&gt;create_wall_timer(</span><br><span class="line"><span class="symbol">    std:</span>:chrono::seconds(<span class="number">1</span>),</span><br><span class="line"><span class="symbol">    std:</span>:bind(<span class="variable">&amp;</span>RobotNewsStationNode::publishNews, this))<span class="punctuation">;</span></span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h4 id="publisher"><a href="#publisher" class="headerlink" title="publisher"></a>publisher</h4><h5 id="Python-1"><a href="#Python-1" class="headerlink" title="Python"></a>Python</h5><ul>
<li>定义publisher<br>一般在节点的init函数中定义publisher。<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable language_">self</span>.cmd_vel_pub_ = <span class="variable language_">self</span>.create_publisher(<span class="title class_">Twist</span>, <span class="string">"/turtle1/cmd_vel"</span>, <span class="number">10</span>)</span><br></pre></td></tr></tbody></table></figure>
通过<strong>create_publisher</strong>函数定义publisher，需要传入一个消息类型，然后传入一个topic名字, 第三个参数代表消息的大小。<br><strong>注意：引入新的包后，需要在package.xml中添加新的depend。</strong></li>
<li>周期性发送消息<br>周期性运行主要依赖时间回调函数实现，首先定义一个时间回调函数，然后在节点的init函数中注册时间回调函数，具体可参照上一章节。<br>在时间回调函数中，定义消息内容，并通过publisher发布消息。<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">def</span> send_velocity_command(self):</span><br><span class="line">    <span class="attribute">msg</span> = Twist()</span><br><span class="line">    <span class="attribute">msg</span>.linear.x = <span class="number">2</span>.<span class="number">0</span></span><br><span class="line">    <span class="attribute">msg</span>.angular.z = <span class="number">1</span>.<span class="number">0</span></span><br><span class="line">    <span class="attribute">self</span>.cmd_vel_pub_.publish(msg)</span><br></pre></td></tr></tbody></table></figure>
上述代码中定义了<strong>send_velocity_command</strong>回调函数。</li>
</ul>
<h5 id="C-1"><a href="#C-1" class="headerlink" title="C++"></a>C++</h5><ul>
<li>定义publisher<figure class="highlight rust"><table><tbody><tr><td class="code"><pre><span class="line">rclcpp::Publisher&lt;example_interfaces::msg::<span class="type">String</span>&gt;::SharedPtr publisher_;</span><br><span class="line">publisher_ = this<span class="punctuation">-&gt;</span>create_publisher&lt;example_interfaces::msg::<span class="type">String</span>&gt;(</span><br><span class="line">            <span class="string">"robot_news"</span>, <span class="number">10</span>);</span><br></pre></td></tr></tbody></table></figure>
声明时，在<strong>Publisher<template></template></strong>模板类中指明消息的类型，声明是一个SharedPtr类型的变量。<br>定义时，同样在模板函数中指明消息的数据类型，同时在构造函数中指明topic的名称。</li>
<li>周期性发送消息<h4 id="subscriber"><a href="#subscriber" class="headerlink" title="subscriber"></a>subscriber</h4>与publisher类似，同样在init函数中定义subscriber。<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable language_">self</span>.pose_subscriber_ = <span class="variable language_">self</span>.create_subscription(<span class="title class_">Pose</span>, <span class="string">"/turtle1/pose"</span>, <span class="variable language_">self</span>.pose_callback, <span class="number">10</span>)</span><br></pre></td></tr></tbody></table></figure>
使用<strong>create_subscription</strong>函数定义subscriber，需要传入topic的数据类型，topic的名称，回调函数，以及buffer大小。回调函数用于收到数据后的处理逻辑。</li>
</ul>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p><strong>service</strong>与<strong>topic</strong>的区别是，<strong>service</strong>类似于web服务，有server也有client，通过传入参数直接调用，而<strong>topic</strong>更像是消息广告板，有发布者也有订阅者。<br><strong>service</strong>的server只有一个，而client可以有很多个。<br><strong>topic</strong>主要用于节点之间发送数据，而不需要节点之间的response。如果需要response，则需要使用<strong>service</strong>。<br>频繁调用service会影响ros的整体性能。</p>
<h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><h5 id="Python-2"><a href="#Python-2" class="headerlink" title="Python"></a>Python</h5><ul>
<li>定义Server<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable language_">self</span>.server_ = <span class="variable language_">self</span>.create_service(<span class="title class_">AddTwoInts</span>, <span class="string">"add_two_ints"</span>, <span class="variable language_">self</span>.add_two_ints_callback)</span><br></pre></td></tr></tbody></table></figure>
使用<strong>create_service</strong>函数创建server，需要传入三个参数。第一个参数是Service的数据类型，该数据类型定义了Request和Response的数据结构；第二个参数为Service的名称，唯一的ID；第三个参数为Server的回调函数，用于实现业务逻辑。</li>
<li>定义Callback<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_two_ints_callback</span>(<span class="params">self, request, response</span>):</span><br><span class="line">    response.<span class="built_in">sum</span> = request.a + request.b</span><br><span class="line">    self.get_logger().info(<span class="built_in">str</span>(request.a) + <span class="string">"+"</span> + <span class="built_in">str</span>(request.b) + <span class="string">"="</span> + <span class="built_in">str</span>(response.<span class="built_in">sum</span>))</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></tbody></table></figure>
回调函数需要传入两个参数，一个是<strong>request</strong>入参，另外一个是<strong>response</strong>出参。<h5 id="C-2"><a href="#C-2" class="headerlink" title="C++"></a>C++</h5></li>
<li>定义Server<figure class="highlight zephir"><table><tbody><tr><td class="code"><pre><span class="line">rclcpp::Service&lt;example_interfaces::srv::AddTwoInts&gt;::SharedPtr server_;</span><br><span class="line">server_ = this-&gt;create_service&lt;example_interfaces::srv::AddTwoInts&gt;(<span class="string">"add_two_ints"</span>, std::bind(&amp;AddTwoIntsServerNode::callbackAddTwoInts, this, std::placeholders::_1, std::placeholders::_2));</span><br></pre></td></tr></tbody></table></figure>
使用<strong>create_service</strong>函数创建Service的Server，需要指定数据类型，且传入两个参数，一个是Service的名称，这是一个唯一的标识，在client中也需要用到；另外一个是回调函数。</li>
<li>定义Callback<figure class="highlight rust"><table><tbody><tr><td class="code"><pre><span class="line">void <span class="title function_ invoke__">callbackAddTwoInts</span>(<span class="keyword">const</span> example_interfaces::srv::AddTwoInts::Request::SharedPtr request,</span><br><span class="line">    <span class="keyword">const</span> example_interfaces::srv::AddTwoInts::Response::SharedPtr response)</span><br><span class="line">{</span><br><span class="line">    response<span class="punctuation">-&gt;</span>sum = request<span class="punctuation">-&gt;</span>a + request<span class="punctuation">-&gt;</span>b;</span><br><span class="line">    <span class="title function_ invoke__">RCLCPP_INFO</span>(this<span class="punctuation">-&gt;</span><span class="title function_ invoke__">get_logger</span>(), <span class="string">"%ld+%ld=%ld"</span>, request<span class="punctuation">-&gt;</span>a, request<span class="punctuation">-&gt;</span>b, response<span class="punctuation">-&gt;</span>sum);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
Server的回调函数返回值类型为<strong>void</strong>，且有两个入参，一个为<strong>Request</strong>，另外一个为<strong>Response</strong>，类型均为<strong>const SharePtr</strong>.<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><h5 id="Python-3"><a href="#Python-3" class="headerlink" title="Python"></a>Python</h5></li>
<li>定义Client<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">client</span> = self.create_client(AddTwoInts, <span class="string">"add_two_ints"</span>)</span><br></pre></td></tr></tbody></table></figure>
使用<strong>create_client</strong>函数创建client，需要传入两个参数。第一个是Service的数据类型，第二个是Service的名称。</li>
<li>等待Server Ready<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> not client.wait<span class="constructor">_for_service(1.0)</span>:</span><br><span class="line">    node.get<span class="constructor">_logger()</span>.warn(<span class="string">"Waiting for server AddTwoInts."</span>)</span><br></pre></td></tr></tbody></table></figure>
<strong>wait_for_service</strong>如果成功则返回true，否则则返回false；传入的参数为等待时间，不传入则永远等待。</li>
<li>请求Server<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">request = AddTwoInts.<span class="constructor">Request()</span></span><br><span class="line">request.a = <span class="number">45</span></span><br><span class="line">request.b = <span class="number">67</span></span><br><span class="line"></span><br><span class="line">future = client.call<span class="constructor">_async(<span class="params">request</span>=<span class="params">request</span>)</span></span><br><span class="line">rclpy.spin<span class="constructor">_until_future_complete(<span class="params">node</span>=<span class="params">node</span>, <span class="params">future</span>=<span class="params">future</span>)</span></span><br></pre></td></tr></tbody></table></figure>
使用数据类型的<strong>Request</strong>部分创建request。<strong>call_async</strong>可以实现异步调用，返回一个future对象。<strong>spin_until_feature_complete</strong>可以等待直到请求返回，需要传入两个参数，一个是节点对象，另外一个是异步调用的future对象。<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">request = AddTwoInts.<span class="constructor">Request()</span></span><br><span class="line">request.a = a</span><br><span class="line">request.b = b</span><br><span class="line">future = self.client_.call<span class="constructor">_async(<span class="params">request</span>=<span class="params">request</span>)</span></span><br><span class="line">future.add<span class="constructor">_done_callback(<span class="params">partial</span>(<span class="params">self</span>.<span class="params">add_two_ints_callback</span>, <span class="params">a</span>=<span class="params">a</span>, <span class="params">b</span>=<span class="params">b</span>)</span>)</span><br></pre></td></tr></tbody></table></figure>
<strong>spin_until_feature_complete</strong>适用于在main函数中直接定义client时使用，如果是在class中定义client，则需要使用future的<strong>add_done_callback</strong>函数，在异步请求server完成后，调用回调函数。<strong>partial</strong>类可以在传入回调函数的时候，传入其他参数。</li>
<li>处理Response<figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line">try:</span><br><span class="line">    response = future.<span class="built_in">result</span>()</span><br><span class="line">    node.<span class="built_in">get_logger</span>().<span class="built_in">info</span>(<span class="built_in">str</span>(request.a) + <span class="string">"+"</span> + <span class="built_in">str</span>(request.b) + <span class="string">"="</span> + <span class="built_in">str</span>(response.sum))</span><br><span class="line">except Exception as e:</span><br><span class="line">    node.<span class="built_in">get_logger</span>().<span class="built_in">error</span>(<span class="string">"Service call failed %r"</span> % (e,))</span><br></pre></td></tr></tbody></table></figure>
需要使用try-except结构处理返回的response。<h5 id="C-3"><a href="#C-3" class="headerlink" title="C++"></a>C++</h5></li>
<li>定义Client<figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">auto client = <span class="keyword">node</span><span class="title">-&gt;create_client</span><span class="tag">&lt;example_interfaces::srv::AddTwoInts&gt;</span>(<span class="string">"add_two_ints"</span>);</span><br></pre></td></tr></tbody></table></figure>
使用<strong>create_client</strong>函数定义client，需要指定数据类型，仅需要传入一个参数，即Service的名字。client根据名字与server进行通信。</li>
<li>等待Server Ready<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(!client-&gt;wait<span class="constructor">_for_service(<span class="params">std</span>::<span class="params">chrono</span>::<span class="params">seconds</span>(1)</span>))</span><br><span class="line">{</span><br><span class="line">    <span class="constructor">RCLCPP_WARN(<span class="params">node</span>-&gt;<span class="params">get_logger</span>()</span>, <span class="string">"Waiting for server to be ready..."</span>);</span><br><span class="line">}</span><br><span class="line"><span class="constructor">RCLCPP_INFO(<span class="params">node</span>-&gt;<span class="params">get_logger</span>()</span>, <span class="string">"AddTwoInts server is ready."</span>);</span><br></pre></td></tr></tbody></table></figure>
使用<strong>wait_for_service</strong>函数等待server ready。与python接口类似，当server ready时，<strong>wait_for_service</strong>函数返回true，否则返回false；入参为等待时间。</li>
<li>请求Server<figure class="highlight rust"><table><tbody><tr><td class="code"><pre><span class="line">auto request = std::make_shared&lt;example_interfaces::srv::AddTwoInts::Request&gt;();</span><br><span class="line">request<span class="punctuation">-&gt;</span>a = <span class="number">34</span>;</span><br><span class="line">request<span class="punctuation">-&gt;</span>b = <span class="number">56</span>;</span><br><span class="line">auto future = client<span class="punctuation">-&gt;</span><span class="title function_ invoke__">async_send_request</span>(request);</span><br></pre></td></tr></tbody></table></figure>
使用异步接口发送请求，入参为<strong>request</strong>，返回值为<strong>future</strong>。</li>
<li>处理Response<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(rclcpp::spin<span class="constructor">_until_future_complete(<span class="params">node</span>, <span class="params">future</span>)</span><span class="operator"> == </span>rclcpp::FutureReturnCode::SUCCESS)</span><br><span class="line">{</span><br><span class="line">    <span class="constructor">RCLCPP_INFO(<span class="params">node</span>-&gt;<span class="params">get_logger</span>()</span>, <span class="string">"%ld+%ld=%ld"</span>, request-&gt;a, request-&gt;b, future.get<span class="literal">()</span>-&gt;sum);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">{</span><br><span class="line">    <span class="constructor">RCLCPP_ERROR(<span class="params">node</span>-&gt;<span class="params">get_logger</span>()</span>, <span class="string">"Error while calling add_two_ints service"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
使用<strong>spin_until_future_complete</strong>函数等待future完成，并校验完成状态。状态为成功，则处理返回值；失败，则打印失败信息。<br>上述方法是使用<strong>no_oop</strong>的方法实现，直接在main函数中利用ros提供的<strong>spin_until_future_complete</strong>接口实现异步请求的阻塞。对于<strong>oop</strong>的方式，在类中无法使用上述接口，需要直接使用<strong>future.get</strong>接口实现阻塞，为了能保证初始化函数完成，需要将请求放在多线程中实现。<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">std::vector&lt;std::thread&gt; threads_;</span><br><span class="line">threads_.push<span class="constructor">_back(<span class="params">std</span>::<span class="params">thread</span>(<span class="params">std</span>::<span class="params">bind</span>(&amp;AddTwoIntsClientNode::<span class="params">callAddTwoIntsService</span>, <span class="params">this</span>, 89, 12)</span>));</span><br><span class="line"><span class="comment">// parse response</span></span><br><span class="line"><span class="keyword">try</span></span><br><span class="line">{</span><br><span class="line">    auto response = future.get<span class="literal">()</span>;</span><br><span class="line">    <span class="constructor">RCLCPP_INFO(<span class="params">this</span>-&gt;<span class="params">get_logger</span>()</span>, <span class="string">"%d+%d=%ld"</span>, a, b, response-&gt;sum);</span><br><span class="line">}</span><br><span class="line">catch(const std::<span class="keyword">exception</span>&amp; e)</span><br><span class="line">{</span><br><span class="line">    <span class="constructor">RCLCPP_ERROR(<span class="params">this</span>-&gt;<span class="params">get_logger</span>()</span>, <span class="string">"Service call failed: %s"</span>, e.what<span class="literal">()</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Interfaces"><a href="#Interfaces" class="headerlink" title="Interfaces"></a>Interfaces</h3>在<strong>topic</strong>和<strong>service</strong>中均须提供消息类型，在ros中这部分统一放在<strong>interfaces</strong>中。<h4 id="Common-Interfaces"><a href="#Common-Interfaces" class="headerlink" title="Common Interfaces"></a>Common Interfaces</h4>为了便于开发和使用，<strong>ROS</strong>针对机器人领域常用的功能，提供了一份官方的<strong>msg</strong>和<strong>srv</strong>，统一放在<a href="https://github.com/ros2/common_interfaces">common interfaces</a></li>
<li>geometry_msgs<br>定义了几何本原相关的消息类型，例如点、向量、姿态等。具体见：<a href="https://github.com/ros2/common_interfaces/tree/rolling/geometry_msgs">https://github.com/ros2/common_interfaces/tree/rolling/geometry_msgs</a></li>
<li>nav_msgs<br>定义了机器人导航相关的消息和服务类型，例如地图、里程计和轨迹等。具体见：<a href="https://github.com/ros2/common_interfaces/tree/rolling/nav_msgs">https://github.com/ros2/common_interfaces/tree/rolling/nav_msgs</a></li>
<li>sensor_msgs<br>定义了与传感器设备相关的消息和服务类型，例如图像、IMU、点云、手柄等。具体见：<a href="https://github.com/ros2/common_interfaces/tree/rolling/sensor_msgs">https://github.com/ros2/common_interfaces/tree/rolling/sensor_msgs</a></li>
<li>shape_msgs<br>定义了三维形状，例如平面、刚体等。具体见：<a href="https://github.com/ros2/common_interfaces/tree/rolling/shape_msgs">https://github.com/ros2/common_interfaces/tree/rolling/shape_msgs</a></li>
<li>std_msgs<br>定义了基础数据类型的消息，例如bool、string、int、float等。具体见：<a href="https://github.com/ros2/common_interfaces/tree/rolling/std_msgs">https://github.com/ros2/common_interfaces/tree/rolling/std_msgs</a></li>
<li>std_srvs<br>定义了基础数据类型的服务，例如bool、string、int、float等。具体见：<a href="https://github.com/ros2/common_interfaces/tree/rolling/std_srvs">https://github.com/ros2/common_interfaces/tree/rolling/std_srvs</a></li>
<li>stereo_msgs<br>定义了视差图像相关的消息，具体见：<a href="https://github.com/ros2/common_interfaces/tree/rolling/stereo_msgs">https://github.com/ros2/common_interfaces/tree/rolling/stereo_msgs</a></li>
<li>trajectory_msgs<br>定义了机器人关节轨迹相关的消息，具体见：<a href="https://github.com/ros2/common_interfaces/tree/rolling/trajectory_msgs">https://github.com/ros2/common_interfaces/tree/rolling/trajectory_msgs</a></li>
<li>visualization_msgs<br>定义了3D可视化相关的消息和服务类型，例如在rviz中使用的。具体见：<a href="https://github.com/ros2/common_interfaces/tree/rolling/visualization_msgs">https://github.com/ros2/common_interfaces/tree/rolling/visualization_msgs</a></li>
</ul>
<h4 id="Custom-Interfaces"><a href="#Custom-Interfaces" class="headerlink" title="Custom Interfaces"></a>Custom Interfaces</h4><p>除了<strong>ROS</strong>提供的消息和服务类型，我们还可以自己定义消息和服务类型。</p>
<h5 id="Create-Interface-Package"><a href="#Create-Interface-Package" class="headerlink" title="Create Interface Package"></a>Create Interface Package</h5><p>自定义<strong>interfaces</strong>一般统一放在一个package中，因此需要创建一个package。<br></p><figure class="highlight gauss"><table><tbody><tr><td class="code"><pre><span class="line">ros2 pkg <span class="keyword">create</span> my_robot_interfaces</span><br></pre></td></tr></tbody></table></figure><br><strong>interfaces</strong>的包不需要指定<strong>build-type</strong>和<strong>dependencies</strong>参数。默认创建的是一个cpp语言的包，但是<strong>interfaces</strong>不需要<strong>include</strong>和<strong>src</strong>文件夹，因此用以下指令删除。<br><figure class="highlight stata"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">cd</span> my_robot_interfaces</span><br><span class="line"><span class="keyword">rm</span> -rf <span class="keyword">include</span></span><br><span class="line"><span class="keyword">rm</span> -rf src</span><br></pre></td></tr></tbody></table></figure><br><strong>interfaces</strong>一般包括支持<strong>topic</strong>的消息和支持<strong>service</strong>的服务，因此分别创建两个文件夹。<br><figure class="highlight arduino"><table><tbody><tr><td class="code"><pre><span class="line">mkdir msg</span><br><span class="line">mkdir srv</span><br></pre></td></tr></tbody></table></figure><p></p>
<h5 id="Setup-Configuration"><a href="#Setup-Configuration" class="headerlink" title="Setup Configuration"></a>Setup Configuration</h5><ul>
<li>package.xml<br><strong>interfaces</strong>的包与其他包的配置不一样，需要单独配置。首先在<strong>package.xml</strong>中添加以下配置：<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build_depend</span>&gt;</span>rosidl_default_generators<span class="tag">&lt;/<span class="name">build_depend</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>rosidl_default_runtime<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">member_of_group</span>&gt;</span>rosidl_interface_packages<span class="tag">&lt;/<span class="name">member_of_group</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>CMakeLists.txt<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="title">find_package</span><span class="params">(rosidl_default_generators REQUIRED)</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rosidl_generate_interfaces</span>(${PROJECT_NAME}</span><br><span class="line">  <span class="string">"msg/HardwareStatus.msg"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ament_export_dependencies</span><span class="params">(rosidl_default_runtime)</span></span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="topic消息"><a href="#topic消息" class="headerlink" title="topic消息"></a>topic消息</h5>一个topic消息为一个后缀为<strong>msg</strong>的文件，统一放在<strong>msg/</strong>文件夹下面。<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> msg</span><br><span class="line">create HardwareStatus.msg</span><br></pre></td></tr></tbody></table></figure>
创建文件之后，在<strong>CMakeLists.txt</strong>中的<strong>rosidl_generate_interfaces</strong>添加文件路径。<br>使用基础类型定义消息，如下所示：<figure class="highlight angelscript"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">int64</span> temperature</span><br><span class="line"><span class="built_in">bool</span> are_motors_ready</span><br><span class="line"><span class="built_in">string</span> debug_message</span><br></pre></td></tr></tbody></table></figure>
以上消息定义了三个变量，分别为int64类型的temperature，bool类型的are_motors_ready和string类型的debug_message<h5 id="编译-1"><a href="#编译-1" class="headerlink" title="编译"></a>编译</h5>使用以下指令编译interfaces包。<figure class="highlight n1ql"><table><tbody><tr><td class="code"><pre><span class="line">colcon <span class="keyword">build</span> --packages-<span class="keyword">select</span> my_robot_interfaces </span><br></pre></td></tr></tbody></table></figure>
编译完需要source一下。<h5 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h5>根其他包一样，编译好的包会统一放在工作空间的<strong>install</strong>文件夹下面。<br>使用方法根使用ros提供的common interfaces一样，但是需要在vscode中配置auto complete的支持。</li>
<li>python auto complete<br>在<strong>setting.json</strong>中的<strong>python.autoComplete.extraPaths</strong>和<strong>python.analysis.extraPaths</strong>配置中将编译好的路径添加进去，如下所示<figure class="highlight 1c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">"/home/robot/ros2_ws/install/my_robot_interfaces/local/lib/python3.10/dist-packages"</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>cpp auto complete<br>在<strong>c_cpp_properties.json</strong>中将编译好的<strong>interfaces</strong>包路径添加进去。<figure class="highlight 1c"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">"/home/robot/ros2_ws/install/my_robot_interfaces/include/**"</span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="service服务"><a href="#service服务" class="headerlink" title="service服务"></a>service服务</h5>一个Service服务为一个后缀为<strong>srv</strong>的文件，统一放在<strong>srv/</strong>文件夹下面。</li>
</ul>
<h3 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a>Parameters</h3><p><strong>Parameters</strong>模块可以在节点运行时提供参数配置。</p>
<h4 id="Declare-Parameters"><a href="#Declare-Parameters" class="headerlink" title="Declare Parameters"></a>Declare Parameters</h4><ul>
<li>Python<figure class="highlight lasso"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">self</span>.declare_parameter(<span class="string">"test123"</span>, <span class="literal">True</span>)</span><br></pre></td></tr></tbody></table></figure>
<strong>declare_parameter</strong>的python接口需要传入两个参数，一个是parameter的名称，另外一个是parameter的默认值。</li>
<li>C++<figure class="highlight lisp"><table><tbody><tr><td class="code"><pre><span class="line">this-&gt;declare_parameter(<span class="string">"test123"</span>, rclcpp:<span class="symbol">:ParameterType</span>:<span class="symbol">:PARAMETER_STRING</span>)<span class="comment">;</span></span><br></pre></td></tr></tbody></table></figure>
<strong>declare_parameter</strong>的C++接口调用方式多样，除了parameter名称，还可以指定参数的类型。<h4 id="Use-Parameters"><a href="#Use-Parameters" class="headerlink" title="Use Parameters"></a>Use Parameters</h4></li>
<li>Python<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable language_">self</span>.number_ = <span class="variable language_">self</span>.get_parameter(<span class="string">"number_to_publish"</span>).value</span><br></pre></td></tr></tbody></table></figure>
<strong>get_parameter</strong>接口可以获取声明好的参数，用<em>value*</em>取出对应的值。</li>
<li>C++<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">number_</span> = this-&gt;get_parameter(<span class="string">"number_to_publish"</span>).as_int()<span class="comment">;</span></span><br></pre></td></tr></tbody></table></figure>
<strong>get_parameter</strong>接口需要显示返回指定类型的数据。</li>
</ul>
<h3 id="Launch-File"><a href="#Launch-File" class="headerlink" title="Launch File"></a>Launch File</h3><p><strong>Launch File</strong>用于配置多个节点的运行信息，可以很方便的管理每个节点的的名称、入参等信息。</p>
<h4 id="Create-Launch-Package"><a href="#Create-Launch-Package" class="headerlink" title="Create Launch Package"></a>Create Launch Package</h4><p>跟<strong>interfaces</strong>类似，<strong>launch file</strong>也单独放在一个package中进行管理。因此，首先使用以下命令创建package。<br></p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/ros2_ws/src</span><br><span class="line">ros2 pkg create my_robot_bringup</span><br></pre></td></tr></tbody></table></figure><br>创建package不需要指定<strong>build-type</strong>和<strong>dependencies</strong>。默认创建的package文件夹是cpp结构的，将不需要的文件夹删除。<br><figure class="highlight stata"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">rm</span> -rf <span class="keyword">include</span></span><br><span class="line"><span class="keyword">rm</span> -rf src</span><br></pre></td></tr></tbody></table></figure><br>创建<strong>launch</strong>文件夹<br><figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">mkdir <span class="built_in">launch</span></span><br></pre></td></tr></tbody></table></figure><br>在<strong>CMakeLists.txt</strong>中配置编译后的安装目录。<br><figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">install</span>(DIRECTORY</span><br><span class="line">  launch</span><br><span class="line">  DESTINATION share/<span class="variable">${PROJECT_NAME}</span></span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><br>上述配置将在/home/robot/ros2_ws/install/my_robot_bringup/share/my_robot_bringup/文件夹下面创建<strong>launch</strong>文件夹，所有的launch file都在这个文件夹中。<p></p>
<h4 id="Create-Launch-File"><a href="#Create-Launch-File" class="headerlink" title="Create Launch File"></a>Create Launch File</h4><p>在<strong>launch</strong>文件夹下面，创建后缀为.launch.py的文件，并使其变成可执行文件。<br></p><figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">touch number_app<span class="selector-class">.launch</span><span class="selector-class">.py</span></span><br><span class="line">chmod +x number_app<span class="selector-class">.launch</span><span class="selector-class">.py</span></span><br><span class="line"><span class="selector-tag">code</span> number_app<span class="selector-class">.launch</span>.py</span><br></pre></td></tr></tbody></table></figure><br><strong>launch file</strong>为一个特殊的python文件，具体如下所示：<br><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> launch import LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions import Node</span><br><span class="line"></span><br><span class="line">def generate_launch_description():</span><br><span class="line">    ld = LaunchDescription()</span><br><span class="line">    remap_number_topic = (<span class="string">"number"</span>, <span class="string">"my_number"</span>)</span><br><span class="line">    number_publisher_node = Node(</span><br><span class="line">        <span class="attribute">package</span>=<span class="string">"test_py_pkg"</span>,</span><br><span class="line">        <span class="attribute">executable</span>=<span class="string">"number_publisher"</span>,</span><br><span class="line">        <span class="attribute">name</span>=<span class="string">"my_number_publisher"</span>,</span><br><span class="line">        remappings=[</span><br><span class="line">            remap_number_topic</span><br><span class="line">        ],</span><br><span class="line">        parameters=[</span><br><span class="line">            {<span class="string">"number_to_publish"</span>: 4}</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    number_counter_node = Node(</span><br><span class="line">        <span class="attribute">package</span>=<span class="string">"test_cpp_pkg"</span>,</span><br><span class="line">        <span class="attribute">executable</span>=<span class="string">"number_counter"</span>,</span><br><span class="line">        <span class="attribute">name</span>=<span class="string">"my_number_counter"</span>,</span><br><span class="line">        remappings=[</span><br><span class="line">            remap_number_topic,</span><br><span class="line">            (<span class="string">"number_count"</span>, <span class="string">"my_number_count"</span>)</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    ld.add_action(number_publisher_node)</span><br><span class="line">    ld.add_action(number_counter_node)</span><br><span class="line">    return ld</span><br></pre></td></tr></tbody></table></figure><br>从<strong>launch</strong>中引入<strong>LaunchDescription</strong>，从<strong>launch_ros.actions</strong>中引入<strong>Node</strong>。在python文件中创建固定名为<strong>generate_launch_description</strong>的函数，所有的launch description都在该函数中。<br>使用<strong>Node</strong>创建启动节点的配置，具体具体如下所示。<br><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">number_publisher_node = Node(</span><br><span class="line">    <span class="attribute">package</span>=<span class="string">"test_py_pkg"</span>,</span><br><span class="line">    <span class="attribute">executable</span>=<span class="string">"number_publisher"</span>,</span><br><span class="line">    <span class="attribute">name</span>=<span class="string">"my_number_publisher"</span>,</span><br><span class="line">    remappings=[</span><br><span class="line">        remap_number_topic</span><br><span class="line">    ],</span><br><span class="line">    parameters=[</span><br><span class="line">        {<span class="string">"number_to_publish"</span>: 4}</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure><br><strong>package</strong>参数指定运行节点的包名称；<br><strong>executable</strong>指定节点的可执行文件名称；<br><strong>name</strong>指定节点的名称，不提供该参数，则使用节点的默认名；提供该参数，则等同于使用remap参数重命名节点名称；<br><strong>remappings</strong>对topic名称进行重命名，通过tuple进行remap，例如(“old_name”, “new_name”)；<br><strong>parameters</strong>对节点内定义的parameters进行赋值，传入的是一个map，key是parameters的名称，value是parameter值。<p></p>
<p>创建完节点的launch description之后，需要在<strong>package.xml</strong>中添加依赖，具体如下所示：<br></p><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>test_py_pkg<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">exec_depend</span>&gt;</span>test_cpp_pkg<span class="tag">&lt;/<span class="name">exec_depend</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><br>因为是运行节点的配置，所以添加<strong>exec_depend</strong>即可。<p></p>
<h4 id="编译launch-file"><a href="#编译launch-file" class="headerlink" title="编译launch file"></a>编译launch file</h4><p>使用<strong>colcon build</strong>命令编译包<br></p><figure class="highlight n1ql"><table><tbody><tr><td class="code"><pre><span class="line">colcon <span class="keyword">build</span> --packages-<span class="keyword">select</span> my_robot_bringup</span><br></pre></td></tr></tbody></table></figure><br>编译并source配置之后，即可使用命令行运行。<br><figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">launch</span> my_robot_bringup number_app.<span class="built_in">launch</span>.py</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="Data-Bag"><a href="#Data-Bag" class="headerlink" title="Data Bag"></a>Data Bag</h3><p><strong>bag</strong>命令用于记录ros的topic数据。<br></p><figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line">ros2 bag record <span class="selector-attr">[topic_name1]</span> <span class="selector-attr">[topic_name2]</span> <span class="attr">--output</span> <span class="selector-attr">[record name]</span></span><br></pre></td></tr></tbody></table></figure><br>上述指令用于记录指定<strong>topics</strong>的数据，并将其记录在指定文件夹中。<p></p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line">ros2 bag <span class="keyword">info</span> [<span class="type">record</span> <span class="type">name</span>]</span><br></pre></td></tr></tbody></table></figure>
<p>上述指令用于查看记录的<strong>record</strong>信息。</p>
<figure class="highlight delphi"><table><tbody><tr><td class="code"><pre><span class="line">ros2 bag play [<span class="keyword">record</span> <span class="keyword">name</span>]</span><br></pre></td></tr></tbody></table></figure>
<p>上述指令用于重新播放<strong>record</strong>的数据。</p>
<figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line">ros2 bag record <span class="attr">--all</span> <span class="attr">--output</span> <span class="selector-attr">[record name]</span></span><br></pre></td></tr></tbody></table></figure>
<p>上述指令用于记录所有的<strong>topic</strong>数据。</p>
<h3 id="函数接口"><a href="#函数接口" class="headerlink" title="函数接口"></a>函数接口</h3><h4 id="日志接口"><a href="#日志接口" class="headerlink" title="日志接口"></a>日志接口</h4><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">self.get_logger().<span class="built_in">info</span>(<span class="string">"Hello World"</span>)</span><br></pre></td></tr></tbody></table></figure>
<h2 id="基本指令"><a href="#基本指令" class="headerlink" title="基本指令"></a>基本指令</h2><h3 id="运行节点"><a href="#运行节点" class="headerlink" title="运行节点"></a>运行节点</h3><figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">ros2 run [package name] [<span class="keyword">node</span> <span class="title">name</span>]</span><br></pre></td></tr></tbody></table></figure>
<p>示例：<br></p><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> demo_nodes_cpp talker</span><br></pre></td></tr></tbody></table></figure><br>上述指令会运行<strong>demo_nodes_cpp</strong>包下面的<strong>talker</strong>节点。<p></p>
<figure class="highlight stata"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="keyword">run</span> my_cpp_pkg cpp_node --ros-<span class="keyword">args</span> --<span class="keyword">remap</span> __node:=abs</span><br></pre></td></tr></tbody></table></figure>
<p>上述指令运行节点并且将节点重命名为<strong>abs</strong>.</p>
<figure class="highlight stata"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="keyword">run</span> my_cpp_pkg robot_news_station --ros-<span class="keyword">args</span> --<span class="keyword">remap</span> __node:=my_station --<span class="keyword">remap</span> robot_news:=my_news</span><br><span class="line">ros2 <span class="keyword">run</span> my_cpp_pkg smartphone --ros-<span class="keyword">args</span> -<span class="keyword">remap</span> robot_news:=my_news</span><br></pre></td></tr></tbody></table></figure>
<p><strong>remap</strong>指令除了可以将节点重命名，还可以将topic命名。</p>
<h3 id="查看节点graph"><a href="#查看节点graph" class="headerlink" title="查看节点graph"></a>查看节点graph</h3><figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">rqt_graph</span></span><br></pre></td></tr></tbody></table></figure>
<p>可以以graph的形式中展示了所有运行的节点，以及节点之间的关系。<br><strong>注意：rqt_graph不能查看Services</strong></p>
<h3 id="查看节点"><a href="#查看节点" class="headerlink" title="查看节点"></a>查看节点</h3><ul>
<li>列举正在运行的所有node<figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="keyword">node</span> <span class="title">list</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>查看指定node的信息<figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="keyword">node</span> <span class="title">info</span> [<span class="keyword">node</span> <span class="title">name</span>]</span><br></pre></td></tr></tbody></table></figure>
<h3 id="查看服务"><a href="#查看服务" class="headerlink" title="查看服务"></a>查看服务</h3></li>
<li>列举正在运行的所有服务<figure class="highlight lsl"><table><tbody><tr><td class="code"><pre><span class="line">ros2 service <span class="type">list</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>查看指定service的类型信息<figure class="highlight ada"><table><tbody><tr><td class="code"><pre><span class="line">ros2 service <span class="keyword">type</span> <span class="type">[<span class="keyword">type</span> </span>name]</span><br></pre></td></tr></tbody></table></figure></li>
<li>调用指定的service<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><span class="line">ros2 service <span class="keyword">call</span> [<span class="keyword">type</span> <span class="type">name</span>] [<span class="keyword">type</span>] [<span class="keyword">values</span>]</span><br><span class="line">ros2 service <span class="keyword">call</span> /add_two_ints example_interfaces/srv/AddTwoInts "{'a':1, 'b':2}"</span><br></pre></td></tr></tbody></table></figure>
传入的values是json格式的数据。</li>
</ul>
<h3 id="turtlesim-package"><a href="#turtlesim-package" class="headerlink" title="turtlesim package"></a>turtlesim package</h3><p>运行turtlesim 仿真环境<br></p><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> turtlesim turtlesim_node</span><br></pre></td></tr></tbody></table></figure><br>运行键盘控制节点<br><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> turtlesim turtle_teleop_key</span><br></pre></td></tr></tbody></table></figure><p></p>
<h3 id="查看topic"><a href="#查看topic" class="headerlink" title="查看topic"></a>查看topic</h3><p><strong>topic</strong>用于ros节点之间通信，<strong>publisher</strong>向<strong>topic</strong>发送信息，<strong>subscriber</strong>从<strong>topic</strong>接收信息。<strong>topic</strong>保证了ros节点之间是独立运行的。</p>
<p><strong>topic</strong>一般由三部分组成：topic类型、发布者、监听者。</p>
<p><strong>topic</strong>是匿名的，<strong>subscriber</strong>可以通过名字订阅<strong>topic</strong>，但是并不知道是哪个<strong>publisher</strong>发布的。<br></p><figure class="highlight lsl"><table><tbody><tr><td class="code"><pre><span class="line">ros2 topic <span class="type">list</span></span><br></pre></td></tr></tbody></table></figure><br>上述指令可以列举正在运行的topic。<br><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 topic <span class="built_in">info</span> [topic name]</span><br><span class="line">ros2 topic <span class="built_in">info</span> /chatter</span><br></pre></td></tr></tbody></table></figure><br>上述指令查看指定topic的详细信息，包括topic的数据类型，publisher的数量和subscriber的数量。<br><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">ros2 topic <span class="built_in">echo</span> [topic name]</span><br><span class="line">ros2 topic <span class="built_in">echo</span> /chatter</span><br></pre></td></tr></tbody></table></figure><br>上述指令可以打印指定topic的内容。<br><figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">ros2 topic hz [topic name]</span><br><span class="line">ros2 topic hz <span class="regexp">/turtle1/</span>pose</span><br></pre></td></tr></tbody></table></figure><br>上述指令可以监听指定topic的周期。<br><figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">ros2 topic bw [topic name]</span><br><span class="line">ros2 topic bw <span class="regexp">/turtle1/</span>pose</span><br></pre></td></tr></tbody></table></figure><br>上述指令可以监听指定topic的消息的带宽。<br><figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">ros2 topic pub -r <span class="number">10</span> <span class="regexp">/robot_news  example_interfaces/m</span>sg/String <span class="string">"{data: 'This is a test.'}"</span></span><br><span class="line">ros2 topic pub <span class="regexp">/cmd_vel geometry_msgs/m</span>sg/Twist <span class="string">"{linear: {x: 0.1, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 1.0}}"</span></span><br></pre></td></tr></tbody></table></figure><br>上述指令可以向指定topic发送消息。<p></p>
<h3 id="查看接口定义"><a href="#查看接口定义" class="headerlink" title="查看接口定义"></a>查看接口定义</h3><figure class="highlight angelscript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="keyword">interface</span> <span class="symbol">show</span> [<span class="symbol">Object</span>]</span><br><span class="line"><span class="symbol">ros2</span> <span class="symbol">interface</span> <span class="symbol">show</span> <span class="symbol">std_msgs</span>/<span class="symbol">msg</span>/<span class="symbol">String</span></span><br></pre></td></tr></tbody></table></figure>
<p>使用上述指令可以查看制定内容的接口信息。例如可以查看数据类型的详细定义。</p>
<figure class="highlight angelscript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="keyword">interface</span> <span class="symbol">list</span></span><br></pre></td></tr></tbody></table></figure>
<p>展示所有的<strong>msg</strong>和<strong>srv</strong>，包括ros官方定义的和自定义的。</p>
<figure class="highlight ada"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="keyword">interface</span> <span class="keyword">package</span> <span class="title">geometry_msgs</span></span><br></pre></td></tr></tbody></table></figure>
<p>展示指定package下面的所有<strong>msg</strong>和<strong>srv</strong>。</p>
<h3 id="Parameter"><a href="#Parameter" class="headerlink" title="Parameter"></a>Parameter</h3><ul>
<li>查看节点的所有参数<figure class="highlight livecodeserver"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">param</span> list</span><br></pre></td></tr></tbody></table></figure>
可以列举所有节点的所有参数。</li>
<li>查看指定节点指定参数的值<figure class="highlight livecodeserver"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">param</span> <span class="built_in">get</span> [node_name] [param_name]</span><br><span class="line">ros2 <span class="built_in">param</span> <span class="built_in">get</span> /number_publisher test123</span><br></pre></td></tr></tbody></table></figure></li>
<li>运行节点，提供参数值<figure class="highlight dsconfig"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">ros2</span> <span class="string">run</span> <span class="string">test_cpp_pkg</span>  <span class="string">number_publisher</span> <span class="built_in">--ros-args</span> <span class="built_in">--param</span> <span class="string">test123</span>:=<span class="string">"Hello"</span></span><br><span class="line"><span class="string">ros2</span> <span class="string">run</span> <span class="string">my_cpp_pkg</span> <span class="string">led_panel</span> <span class="built_in">--ros-args</span> <span class="built_in">--param</span> <span class="string">led_states</span>:=<span class="string">"[3,4,5]"</span></span><br></pre></td></tr></tbody></table></figure>
第一条指令传入了“Hello”字符串给<strong>test123</strong>，第二条指令传入了{3,4,5}的int类型的array给<strong>led_states</strong>。</li>
</ul>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>ROS</category>
      </categories>
      <tags>
        <tag>ROS</tag>
      </tags>
  </entry>
  <entry>
    <title>Make Operation System ISO Installation File Using Systemback</title>
    <url>/2023/12/25/Make-Operation-System-ISO-Installation-File-Using-Systemback/</url>
    <content><![CDATA[<html><head></head><body><p>本文主要讲解如何使用<strong>systemback</strong>打包操作系统，并制作U盘启动盘。</p>
<span id="more"></span>
<h3 id="安装systemback"><a href="#安装systemback" class="headerlink" title="安装systemback"></a>安装systemback</h3><p>通过以下指令安装：</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo bash -c <span class="string">'echo "deb [arch=amd64] https://mirrors.bwbot.org/ stable main" &gt; /etc/apt/sources.list.d/systemback.list'</span></span><br><span class="line">sudo apt-key adv --keyserver <span class="string">'hkp://keyserver.ubuntu.com:80'</span> --recv-key 50B2C005A67B264F</span><br><span class="line">sudo apt-<span class="built_in">get</span> update</span><br><span class="line">sudo apt-<span class="built_in">get</span><span class="built_in"> upgrade</span></span><br><span class="line"><span class="built_in"></span>sudo apt-<span class="built_in">get</span> install systemback</span><br></pre></td></tr></tbody></table></figure>
<h3 id="删除firefox"><a href="#删除firefox" class="headerlink" title="删除firefox"></a>删除firefox</h3><p><strong>FireFox</strong>浏览器会导致<strong>systemback</strong>制作系统盘报错，因此删除之。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sudo snap remove firefox</span><br><span class="line"><span class="built_in">cd</span> snap</span><br><span class="line"><span class="built_in">rm</span> -rf firefox</span><br></pre></td></tr></tbody></table></figure>

<h3 id="制作系统盘"><a href="#制作系统盘" class="headerlink" title="制作系统盘"></a>制作系统盘</h3><p>在terminal中输入以下指令打开<strong>systemback</strong></p>
<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">systemback-sustart</span></span><br></pre></td></tr></tbody></table></figure>
<p>在弹出的对话框中选择<strong>Live system create</strong>按钮。<br><img data-src="/2023/12/25/Make-Operation-System-ISO-Installation-File-Using-Systemback/live-system-create.png"><br>在弹出的对话框中将安装iso文件重命名为<strong>ubuntu-22.04-robot</strong>，勾选<strong>include user data files</strong>，然后点击<strong>create new</strong>。<br><img data-src="/2023/12/25/Make-Operation-System-ISO-Installation-File-Using-Systemback/create-new.png"></p>
<h3 id="写入U盘"><a href="#写入U盘" class="headerlink" title="写入U盘"></a>写入U盘</h3><p>在iso文件制作成功后，插入U盘，可以将其写入U盘。<br><img data-src="/2023/12/25/Make-Operation-System-ISO-Installation-File-Using-Systemback/write-to-target"></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>U盘启动后，选择第一项进入系统后，在terminal中使用<strong>systemback-sustart</strong>命令启动，然后选在<strong>system install</strong>即可安装系统。<br><img data-src="/2023/12/25/Make-Operation-System-ISO-Installation-File-Using-Systemback/system-install.png"></p>
</body></html>]]></content>
      <categories>
        <category>Ubuntu</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>OS</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu 2204 Installatson and Development Environment Setups</title>
    <url>/2023/12/25/Ubuntu-2204-Installatson-and-Development-Environment-Setups/</url>
    <content><![CDATA[<html><head></head><body><p>本文主要记录Ubuntu22.04的系统安装和配置步骤。</p>
<span id="more"></span>
<h3 id="下载Ubuntu22-04"><a href="#下载Ubuntu22-04" class="headerlink" title="下载Ubuntu22.04"></a>下载Ubuntu22.04</h3><p>推荐到<a href="https://mirrors.tuna.tsinghua.edu.cn/ubuntu-releases/">清华源</a>下载，速度很快。</p>
<h3 id="安装Cuda-amp-Cudnn"><a href="#安装Cuda-amp-Cudnn" class="headerlink" title="安装Cuda &amp; Cudnn"></a>安装Cuda &amp; Cudnn</h3><p><strong>cuda</strong>和<strong>cudnn</strong>是使用<strong>tensorflow</strong>GPU版本的基础，因此在安装<strong>tensorflow</strong>之前，首先安装配置<strong>cuda</strong>和<strong>cudnn</strong>。</p>
<h4 id="安装Nvidia-Driver"><a href="#安装Nvidia-Driver" class="headerlink" title="安装Nvidia Driver"></a>安装Nvidia Driver</h4><p>打开<strong>Software Updater</strong>，点击<strong>setting</strong>, 点击<strong>Additional Drivers</strong>，刷新后选择<strong>Using NVIDIA driver metapackage from nvidia-driver-525(proprietary)<strong>，然后点击</strong>Apply Changes</strong>，按照要求重启电脑。<br><img data-src="/2023/12/25/Ubuntu-2204-Installatson-and-Development-Environment-Setups/nvidia-drivers.png"><br>重启后在<strong>terminal</strong>中验证显卡驱动是否安装成功。</p>
<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">nvidia-smi</span></span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/2023/12/25/Ubuntu-2204-Installatson-and-Development-Environment-Setups/nvidia-smi.png"></p>
<h4 id="安装CUDA"><a href="#安装CUDA" class="headerlink" title="安装CUDA"></a>安装CUDA</h4><p>选择安装的CUDA版本是<strong>cuda_11.8.0_520.61.05_linux.run</strong>，到Nvidia官网下载<a href="https://developer.nvidia.com/cuda-11-8-0-download-archive">CUDA Toolkit 11.8 Downloads</a>，根据操作系统版本选择，使用以下指令下载安装：</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">wget</span> https://developer.download.nvidia.com/compute/cuda/<span class="number">11</span>.<span class="number">8</span>.<span class="number">0</span>/local_installers/cuda_11.<span class="number">8</span>.<span class="number">0</span>_520.<span class="number">61</span>.<span class="number">05</span>_linux.run</span><br><span class="line"><span class="attribute">sudo</span> sh cuda_11.<span class="number">8</span>.<span class="number">0</span>_520.<span class="number">61</span>.<span class="number">05</span>_linux.run</span><br></pre></td></tr></tbody></table></figure>
<p>安装的时候需要将<strong>drivers</strong>注释掉，否则会安装出错。<br>安装成功之后设置环境变量，将以下内容写入<strong>zshrc</strong>的配置文件中</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">vi ~/.zshrc</span><br><span class="line">export PATH=<span class="regexp">/usr/</span>local<span class="regexp">/cuda/</span>bin<span class="variable">${PATH:+:${PATH}</span>}</span><br><span class="line">export LD_LIBRARY_PATH=<span class="regexp">/usr/</span>local<span class="regexp">/cuda-11.8/</span>lib64<span class="variable">${LD_LIBRARY_PATH:+:${LD_LIBRARY_PATH}</span>}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="安装cudnn"><a href="#安装cudnn" class="headerlink" title="安装cudnn"></a>安装cudnn</h4><p>与<strong>cuda 11.8</strong>适配的<strong>cudnn</strong>版本是8.6，到nvidia官网<a href="https://developer.nvidia.com/rdp/cudnn-archive">cudnn-archive</a>下载对应安装包，然后使用以下指令安装。</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">tar -xvf cudnn-linux-x86_64-<span class="number">8.6</span>.<span class="number">0.163</span>_cuda11-archive.tar.xz</span><br><span class="line">sudo cp cudnn-linux-x86_64-<span class="number">8.6</span>.<span class="number">0.163</span>_cuda11-archive<span class="regexp">/include/</span>cudnn*.h <span class="regexp">/usr/</span>local<span class="regexp">/cuda/i</span>nclude</span><br><span class="line">sudo cp -p cudnn-linux-x86_64-<span class="number">8.6</span>.<span class="number">0.163</span>_cuda11-archive<span class="regexp">/lib/</span>libcudnn* <span class="regexp">/usr/</span>local<span class="regexp">/cuda/</span>lib64</span><br><span class="line">sudo chmod a+r <span class="regexp">/usr/</span>local<span class="regexp">/cuda/i</span>nclude<span class="regexp">/cudnn*.h /u</span>sr<span class="regexp">/local/</span>cuda<span class="regexp">/lib64/</span>libcudnn*</span><br></pre></td></tr></tbody></table></figure>
<p>主要是将cudnn的include和lib文件拷贝到cuda目录下面。</p>
<h3 id="Tensorflow"><a href="#Tensorflow" class="headerlink" title="Tensorflow"></a>Tensorflow</h3><p>不同版本的<strong>tensorflow</strong>对应不同版本的<strong>cuda</strong>和<strong>cudnn</strong>，具体可到<a href="https://www.tensorflow.org/install/source#gpu">tensorflow source</a>查看。<br>使用以下指令安装：</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo ln -s /usr/bin/python3 /usr/bin/python</span><br><span class="line">sudo apt-<span class="built_in">get</span> update</span><br><span class="line">sudo apt-<span class="built_in">get</span><span class="built_in"> upgrade</span></span><br><span class="line"><span class="built_in"></span>sudo apt-<span class="built_in">get</span> install python3-pip</span><br><span class="line">pip install <span class="attribute">tensorflow</span>==2.12.0</span><br><span class="line">pip install tensorflow_datasets</span><br></pre></td></tr></tbody></table></figure>
<p>安装完之后使用以下指令检查是否安装成功和是否支持GPU。也可以运行以下文件检测是否调用gpu进行训练。<br><a href="tf_gpu_test.py">tf_gpu_test.py</a></p>
<figure class="highlight gcode"><table><tbody><tr><td class="code"><pre><span class="line">pytho<span class="symbol">n3</span> -c <span class="string">"import tensorflow as tf; print(tf.config.list_physical_devices('GPU'))"</span></span><br></pre></td></tr></tbody></table></figure>
<p>打印的日志中有以下信息，则证明安装成功。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">[PhysicalDevice(<span class="attribute">name</span>=<span class="string">'/physical_device:GPU:0'</span>, <span class="attribute">device_type</span>=<span class="string">'GPU'</span>)]</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>报错<br>可能不需要处理。<figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">uccessful NUMA <span class="keyword">node</span> <span class="title">read</span> from SysFS had negative value (-<span class="number">1</span>), but there must be at least one NUMA <span class="keyword">node</span><span class="title">, so</span> returning NUMA <span class="keyword">node</span> <span class="title">zero</span>. </span><br></pre></td></tr></tbody></table></figure>
使用以下指令解决。<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> /sys/bus/pci/devices/*; <span class="keyword">do</span> <span class="built_in">echo</span> 0 | sudo <span class="built_in">tee</span> -a <span class="variable">$a</span>/numa_node; <span class="keyword">done</span></span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="PyTorch"><a href="#PyTorch" class="headerlink" title="PyTorch"></a>PyTorch</h3><p>直接使用pip安装支持cuda的pytorch即可。</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># pip install torch==2.1.2 torchvision==0.16.2 torchaudio==2.1.2 --index-url https://download.pytorch.org/whl/cu118 -i https://pypi.tuna.tsinghua.edu.cn/simple</span></span><br><span class="line">pip install torch torchvision torchaudio --index-url https:<span class="regexp">//</span>download.pytorch.org<span class="regexp">/whl/</span>cu118</span><br></pre></td></tr></tbody></table></figure>
<p>安装完成后，可以验证安装的版本</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">pip</span> list | grep torch</span><br><span class="line"><span class="attribute">torch</span>                                <span class="number">2</span>.<span class="number">2</span>.<span class="number">1</span>+cu118</span><br><span class="line"><span class="attribute">torchaudio</span>                           <span class="number">2</span>.<span class="number">2</span>.<span class="number">1</span>+cu118</span><br><span class="line"><span class="attribute">torchvision</span>                          <span class="number">0</span>.<span class="number">17</span>.<span class="number">1</span>+cu118</span><br></pre></td></tr></tbody></table></figure>
<p>验证是否支持cuda。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">import torch</span><br><span class="line">torch<span class="selector-class">.cuda</span><span class="selector-class">.is_available</span>()</span><br><span class="line"><span class="function"><span class="title">print</span><span class="params">(torch.cuda.get_device_name(<span class="number">0</span>)</span></span>)</span><br></pre></td></tr></tbody></table></figure>
<p>打印True，则表示支持cuda。可以正常输出显卡型号。<br>使用以下代码验证反向推理是否可正常使用GPU。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">t = torch<span class="selector-class">.nn</span><span class="selector-class">.Linear</span>(<span class="number">3</span>,<span class="number">3</span>)</span><br><span class="line">t<span class="selector-class">.to</span>(<span class="string">"cuda:0"</span>)</span><br><span class="line">input=torch<span class="selector-class">.randn</span>((<span class="number">3</span>,<span class="number">3</span>))<span class="selector-class">.requires_grad_</span>()<span class="selector-class">.to</span>(<span class="string">"cuda:0"</span>)</span><br><span class="line">output=<span class="built_in">t</span>(input)</span><br><span class="line">loss = torch<span class="selector-class">.sum</span>(output)</span><br><span class="line">torch<span class="selector-class">.autograd</span><span class="selector-class">.grad</span>(loss, <span class="selector-tag">input</span>, retain_graph=True)</span><br><span class="line">loss<span class="selector-class">.backward</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>若代码正常执行且没有打印异常信息，表明可使用GPU进行反向推理。</p>
<h3 id="设置中文输入法"><a href="#设置中文输入法" class="headerlink" title="设置中文输入法"></a>设置中文输入法</h3><h4 id="安装更新"><a href="#安装更新" class="headerlink" title="安装更新"></a>安装更新</h4><p>打开<strong>Settings</strong>，依次点击<strong>Region &amp; Language</strong>–&gt;<strong>Manage Installed Languages</strong>，更新数据。<br><img data-src="/2023/12/25/Ubuntu-2204-Installatson-and-Development-Environment-Setups/manage-installed-languiages.png"><br>点击<strong>Language</strong>，选择中文。之后重启。<br><img data-src="/2023/12/25/Ubuntu-2204-Installatson-and-Development-Environment-Setups/select-chinese.png"></p>
<h4 id="设置中文输入法-1"><a href="#设置中文输入法-1" class="headerlink" title="设置中文输入法"></a>设置中文输入法</h4><p>依次点击<strong>Keyboard</strong>–&gt;<strong>Input Sources</strong>–&gt;**+**，选择中文输入法。</p>
<h3 id="其他工具包安装"><a href="#其他工具包安装" class="headerlink" title="其他工具包安装"></a>其他工具包安装</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install git</span><br><span class="line">sudo apt-<span class="built_in">get</span> install curl</span><br><span class="line">sudo apt-<span class="built_in">get</span> install zsh</span><br><span class="line">sudo apt-<span class="built_in">get</span> install vim</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ssh</span><br><span class="line">sudo apt-<span class="built_in">get</span> install gcc</span><br><span class="line">sudo apt-<span class="built_in">get</span> install cmake</span><br><span class="line">sudo apt-<span class="built_in">get</span> install python3-pip</span><br><span class="line">sudo apt-<span class="built_in">get</span> install tmux</span><br><span class="line">sudo apt-<span class="built_in">get</span> install tree</span><br><span class="line">sudo apt-<span class="built_in">get</span> install htop</span><br></pre></td></tr></tbody></table></figure>
<h4 id="安装oh-my-zsh"><a href="#安装oh-my-zsh" class="headerlink" title="安装oh-my-zsh"></a>安装oh-my-zsh</h4><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">sh -c <span class="string">"<span class="subst">$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<p>若是在国内，无法访问github，则运行以下脚本使用国内的源安装。<br><img alt="install_oh_my_zsh.sh" data-src="/2023/12/25/Ubuntu-2204-Installatson-and-Development-Environment-Setups/install_oh_my_zsh.sh"></p>
<h4 id="设置git"><a href="#设置git" class="headerlink" title="设置git"></a>设置git</h4><figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">git config <span class="attr">--global</span> user<span class="selector-class">.email</span> <span class="string">"zhaoyongsheng@zju.edu.cn"</span></span><br><span class="line">git config <span class="attr">--global</span> user<span class="selector-class">.name</span> <span class="string">"Alex"</span></span><br></pre></td></tr></tbody></table></figure>

<h4 id="安装微信"><a href="#安装微信" class="headerlink" title="安装微信"></a>安装微信</h4><p>腾讯官方推出了<a href="https://linux.weixin.qq.com/en">Linux版微信</a>，直接下载安装即可。</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># wget https://archive.ubuntukylin.com/software/pool/partner/weixin_2.1.1_amd64.deb</span></span><br><span class="line"><span class="attribute">sudo</span> dpkg -i weixin_2.<span class="number">1</span>.<span class="number">1</span>_amd64.deb</span><br></pre></td></tr></tbody></table></figure>

<h4 id="安装Zotero"><a href="#安装Zotero" class="headerlink" title="安装Zotero"></a>安装Zotero</h4><p><a href="https://github.com/retorquere/zotero-deb">Zotero</a></p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">wget -qO- https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/retorquere/</span>zotero-deb<span class="regexp">/master/i</span>nstall.sh | sudo bash</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install zotero</span><br></pre></td></tr></tbody></table></figure>
<p>安装后登陆账号，设置坚果云同步即可。</p>
<h4 id="安装Typora"><a href="#安装Typora" class="headerlink" title="安装Typora"></a>安装Typora</h4><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install typora</span><br></pre></td></tr></tbody></table></figure>
<h4 id="安装VSCode"><a href="#安装VSCode" class="headerlink" title="安装VSCode"></a>安装VSCode</h4><figure class="highlight css"><table><tbody><tr><td class="code"><pre><span class="line">sudo snap install <span class="attr">--classic</span> <span class="selector-tag">code</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="安装Anaconda"><a href="#安装Anaconda" class="headerlink" title="安装Anaconda"></a>安装Anaconda</h4><figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">wget</span> https://repo.anaconda.com/archive/Anaconda3-<span class="number">2023</span>.<span class="number">03</span>-Linux-x86_64.sh</span><br><span class="line"><span class="attribute">bash</span> Anaconda3-<span class="number">2023</span>.<span class="number">03</span>-Linux-x86_64.sh</span><br></pre></td></tr></tbody></table></figure>

<h4 id="安装ROS"><a href="#安装ROS" class="headerlink" title="安装ROS"></a>安装ROS</h4><figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">#### 设置vim</span><br><span class="line">Ubuntu自带vi，需要配置以下，方便使用：</span><br></pre></td></tr></tbody></table></figure>
<p>touch .vimrc<br>vi .vimrc<br>set nocompatible<br>set backspace=2</p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">#### libserial-dev</span><br><span class="line">在ROS中会用到这个库。</span><br></pre></td></tr></tbody></table></figure>
<p>sudo apt-get install libserial-dev<br>sudo pip install pyserial</p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">#### flask</span><br><span class="line">在ROS中会用到这个库。</span><br></pre></td></tr></tbody></table></figure>
<p>pip install flask<br>pip install flask-ask-sdk<br>pip install ask-sdk</p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">#### 调整微信分辨率</span><br><span class="line">在**terminal**中输入以下指令，打开设置界面。</span><br><span class="line">* deepin-wine6-stable</span><br></pre></td></tr></tbody></table></figure>
<p>WINEPREFIX=~/.deepinwine/Deepin-WeChat deepin-wine6-stable winecfg</p>
<figure class="highlight asciidoc"><table><tbody><tr><td class="code"><pre><span class="line"><span class="bullet">* </span>ukylin-wine</span><br></pre></td></tr></tbody></table></figure>
<p>WINEPREFIX=~/.ukylin-wine/wechat /usr/bin/ukylin-wine winecfg</p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">在**graphics**tab页中，调整分辨率大小即可。分辨率调整完成后，需要重启微信才能需要。</span><br><span class="line"></span><br><span class="line">#### 安装截图工具</span><br><span class="line">##### 安装</span><br><span class="line">推荐的截图工具是**flameshot**，使用以下命令安装：</span><br></pre></td></tr></tbody></table></figure>
<p>sudo apt-get install flameshot</p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">##### 设置快捷键</span><br><span class="line">打开**Settings**，依次点击**Keyboard**--&gt;**View and Customize Shortcuts**--&gt;**Custom Shortcuts**--&gt;**Add Shortcut**。</span><br><span class="line"></span><br><span class="line">#### 安装Shadowsocks</span><br><span class="line">Ubuntu22<span class="number">.04</span>软件商店中自带**shadowsocks-electron**，点击安装即可。</span><br><span class="line"></span><br><span class="line">#### 安装google chrome</span><br></pre></td></tr></tbody></table></figure>
<p>wget <a href="https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb">https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb</a><br>ls<br>sudo dpkg -i google-chrome-stable_current_amd64.deb</p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line"></span><br><span class="line">#### 创建ssh key</span><br></pre></td></tr></tbody></table></figure>
<p>ssh-keygen -t rsa<br>cat ~/.ssh/id_rsa.pub</p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">将public key拷贝到github中。</span><br><span class="line"></span><br><span class="line">#### 映射CAPS按键</span><br><span class="line">首先使用以下指令查看支持的映射关系。</span><br></pre></td></tr></tbody></table></figure>
<p>cat /usr/share/X11/xkb/rules/base.lst | grep caps</p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">然后打开配置文件。</span><br></pre></td></tr></tbody></table></figure>
<p>sudo gedit /etc/default/keyboard</p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><span class="line">添加以下配置</span><br></pre></td></tr></tbody></table></figure>
<h1 id="KEYBOARD-CONFIGURATION-FILE"><a href="#KEYBOARD-CONFIGURATION-FILE" class="headerlink" title="KEYBOARD CONFIGURATION FILE"></a>KEYBOARD CONFIGURATION FILE</h1><h1 id="Consult-the-keyboard-5-manual-page"><a href="#Consult-the-keyboard-5-manual-page" class="headerlink" title="Consult the keyboard(5) manual page."></a>Consult the keyboard(5) manual page.</h1><p>XKBMODEL=”pc105”<br>XKBLAYOUT=”us”<br>XKBVARIANT=””<br>XKBOPTIONS=”caps:shift”</p>
<p>BACKSPACE=”guess”</p>
<pre><code>重启之后生效。
</code></pre>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Ubuntu</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>Environment</tag>
      </tags>
  </entry>
  <entry>
    <title>ROS2 Learning Notes Navigation 2 Stack</title>
    <url>/2023/12/29/ROS2-Learning-Notes-Navigation-2-Stack/</url>
    <content><![CDATA[<html><head></head><body><p>本文主要为ROS2导航功能模块的学习笔记。</p>
<span id="more"></span>
<h3 id="Navigation2-Stack"><a href="#Navigation2-Stack" class="headerlink" title="Navigation2 Stack"></a>Navigation2 Stack</h3><ul>
<li>安装工具包<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-navigation2</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-nav2-bringup</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-turtlebot3</span><br></pre></td></tr></tbody></table></figure></li>
<li>修复依赖问题<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">wget</span> http://archive.ubuntu.com/ubuntu/pool/universe/l/lua5.<span class="number">2</span>/liblua5.<span class="number">2</span>-<span class="number">0</span>_5.<span class="number">2</span>.<span class="number">4</span>-<span class="number">2</span>_amd64.deb</span><br><span class="line"><span class="attribute">sudo</span> dpkg -i liblua5.<span class="number">2</span>-<span class="number">0</span>_5.<span class="number">2</span>.<span class="number">4</span>-<span class="number">2</span>_amd64.deb</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="Generate-a-map-with-SLAM"><a href="#Generate-a-map-with-SLAM" class="headerlink" title="Generate a map with SLAM"></a>Generate a map with SLAM</h3><h4 id="Make-a-Robot-Move-in-the-World"><a href="#Make-a-Robot-Move-in-the-World" class="headerlink" title="Make a Robot Move in the World"></a>Make a Robot Move in the World</h4><ul>
<li>配置环境变量<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo vi ~/.zshrc</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">TURTLEBOT3_MODEL</span>=waffle</span><br></pre></td></tr></tbody></table></figure></li>
<li>启动gazebo环境<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">launch</span> turtlebot3_gazebo turtlebot3_world.<span class="built_in">launch</span>.py</span><br></pre></td></tr></tbody></table></figure></li>
<li>启动键盘控制<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> turtlebot3_teleop teleop_keyboard</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h4 id="Create-and-Save-a-Map-with-SLAM"><a href="#Create-and-Save-a-Map-with-SLAM" class="headerlink" title="Create and Save a Map with SLAM"></a>Create and Save a Map with SLAM</h4><p>首先启动gazebo仿真环境，生成机器人。<br>然后启动<strong>cartographer</strong>。</p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">launch</span> turtlebot3_cartographer cartographer.<span class="built_in">launch</span>.py use_sim_time:=True</span><br></pre></td></tr></tbody></table></figure>
<p>启动键盘控制机器人在环境中移动就可以建图。<br>最后保存地图。</p>
<figure class="highlight dockerfile"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="keyword">run</span><span class="language-bash"> nav2_map_server map_saver_cli -f maps/my_map</span></span><br></pre></td></tr></tbody></table></figure>
<p>地图保存后可以使用<strong>gimp</strong>编辑保存。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install gimp</span><br><span class="line">gimp</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Navigation-in-Map"><a href="#Navigation-in-Map" class="headerlink" title="Navigation in Map"></a>Navigation in Map</h3><h4 id="Fix-Some-Errors"><a href="#Fix-Some-Errors" class="headerlink" title="Fix Some Errors"></a>Fix Some Errors</h4><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-rmw-cyclonedds-cpp</span><br><span class="line">sudo vi ~/.zshrc</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">RMW_IMPLEMENTATION</span>=rmw_cyclonedds_cpp</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">cd <span class="regexp">/opt/</span>ros<span class="regexp">/humble/</span>share<span class="regexp">/turtlebot3_navigation2/</span>param</span><br><span class="line">sudo vi waffle.yaml</span><br><span class="line"><span class="comment"># robot_model_type: "differential"</span></span><br><span class="line">robot_model_type: <span class="string">"nav2_amcl::DifferentialMotionModel"</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Navigation"><a href="#Navigation" class="headerlink" title="Navigation"></a>Navigation</h4><p>首先运行机器人的仿真环境，然后开启<strong>navigation</strong>节点</p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">launch</span> turtlebot3_gazebo turtlebot3_world.<span class="built_in">launch</span>.py</span><br><span class="line">cd</span><br><span class="line">ros2 <span class="built_in">launch</span> turtlebot3_navigation2 navigation2.<span class="built_in">launch</span>.py use_sim_time:=True map:=maps/my_map.yaml</span><br></pre></td></tr></tbody></table></figure>
<p>需要提供地图的配置文件，成功载入后使用<strong>2D Pose Estimation</strong>工具初始化机器人的位置。</p>
<h4 id="Use-Experiences"><a href="#Use-Experiences" class="headerlink" title="Use Experiences"></a>Use Experiences</h4><p>在<strong>rqt</strong>的插件里面可以配置参数。</p>
<p>Nav2架构</p>
<p>输入：TF, Map, Sensor Data<br>目标： global planner –&gt; local planner(controller) –&gt; hardware controller</p>
<p>Behavior Tree–&gt;决策树</p>
<h4 id="Odometry"><a href="#Odometry" class="headerlink" title="Odometry"></a>Odometry</h4><p>根据底盘的运动信息定位机器人。<br>随着时间和距离有累积误差，但是短时间内定位很稳定。<br>map frame -&gt; odom frame -&gt; base_link。<br>根据轮子的编码器计算，根据速度计算位置。也可以使用<strong>diff_drive_controller</strong>实现。<br>还可以使用<strong>robot_localization</strong>包自己实现更复杂的算法, 发布<strong>filtered topic</strong>。<br>Topic名称为：<strong>odom</strong>，数据类型为<strong>nav_msgs/Odometry.msg</strong>。</p>
<h4 id="Sensor-Data"><a href="#Sensor-Data" class="headerlink" title="Sensor Data"></a>Sensor Data</h4><ul>
<li>wheel encoder</li>
<li>lidar<br>发布<strong>sensor_msgs/msg/LaserScan</strong>消息，名字为<strong>scan</strong>。</li>
<li>camera<br>发布<strong>sensor_msgs/msg/Image</strong>消息，名字为<strong>camera/image_raw</strong>。</li>
</ul>
<h4 id="Hardware-Controller"><a href="#Hardware-Controller" class="headerlink" title="Hardware Controller"></a>Hardware Controller</h4><p>发布的消息类型为<strong>geometry_msgs/Twist</strong>。<br>既可以自己实现电机驱动器，在这样的情况下，需要自己实现<strong>Odometry</strong>。<br>也可以使用ros2自带的<strong>diff_drive_controller</strong>。</p>
<h4 id="slam-toolbox"><a href="#slam-toolbox" class="headerlink" title="slam_toolbox"></a>slam_toolbox</h4><p>除了使用<strong>cartographer</strong>建图，我们还可以使用<strong>slam_toolbox</strong>建图。步骤如下所示：</p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">launch</span> turtlebot3_gazebo turtlebot3_world.<span class="built_in">launch</span>.py</span><br><span class="line">ros2 <span class="built_in">launch</span> nav2_bringup navigation_launch.py use_sim_time:=True</span><br><span class="line">ros2 <span class="built_in">launch</span> slam_toolbox online_async_launch.py use_sim_time:=True</span><br><span class="line">ros2 <span class="built_in">run</span> rviz2 rviz2</span><br></pre></td></tr></tbody></table></figure>

<h4 id="tf-transformations"><a href="#tf-transformations" class="headerlink" title="tf_transformations"></a>tf_transformations</h4><ul>
<li>安装<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-tf-transformations</span><br><span class="line">sudo apt-<span class="built_in">get</span> install python3-transforms3d</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h4 id="通过程序发送初始位置"><a href="#通过程序发送初始位置" class="headerlink" title="通过程序发送初始位置"></a>通过程序发送初始位置</h4><p>使用<strong>nav2</strong>提供的命令接口实现。</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="attribute">import</span> rclpy</span><br><span class="line"><span class="attribute">from</span> nav2_simple_commander.robot_navigator import BasicNavigator</span><br><span class="line"><span class="attribute">from</span> geometry_msgs.msg import PoseStamped</span><br><span class="line"><span class="attribute">import</span> tf_transformations</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">def</span> main():</span><br><span class="line">    <span class="comment"># init</span></span><br><span class="line">    <span class="attribute">rclpy</span>.init()</span><br><span class="line">    <span class="attribute">nav</span> = BasicNavigator()</span><br><span class="line">    <span class="comment"># set initial pose</span></span><br><span class="line">    <span class="attribute">q_x</span>, q_y, q_z, q_w = tf_transformations.quaternion_from_euler(<span class="number">0</span>.<span class="number">0</span>, <span class="number">0</span>.<span class="number">0</span>, <span class="number">0</span>.<span class="number">0</span>)</span><br><span class="line">    <span class="attribute">initial_pose</span> = PoseStamped()</span><br><span class="line">    <span class="attribute">initial_pose</span>.header.frame_id = 'map'</span><br><span class="line">    <span class="attribute">initial_pose</span>.header.stamp = nav.get_clock().now().to_msg()</span><br><span class="line">    <span class="attribute">initial_pose</span>.pose.position.x = <span class="number">0</span>.<span class="number">0</span></span><br><span class="line">    <span class="attribute">initial_pose</span>.pose.position.y = <span class="number">0</span>.<span class="number">0</span></span><br><span class="line">    <span class="attribute">initial_pose</span>.pose.position.z = <span class="number">0</span>.<span class="number">0</span></span><br><span class="line">    <span class="attribute">initial_pose</span>.pose.orientation.x = q_x</span><br><span class="line">    <span class="attribute">initial_pose</span>.pose.orientation.y = q_y</span><br><span class="line">    <span class="attribute">initial_pose</span>.pose.orientation.z = q_z</span><br><span class="line">    <span class="attribute">initial_pose</span>.pose.orientation.w = q_w</span><br><span class="line"></span><br><span class="line">    <span class="attribute">nav</span>.setInitialPose(initial_pose=initial_pose)</span><br><span class="line">    <span class="attribute">nav</span>.waitUntilNav2Active()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># shutdown</span></span><br><span class="line">    <span class="attribute">rclpy</span>.shutdown()</span><br></pre></td></tr></tbody></table></figure>

<h4 id="通过程序发送目标位置"><a href="#通过程序发送目标位置" class="headerlink" title="通过程序发送目标位置"></a>通过程序发送目标位置</h4><figure class="highlight gams"><table><tbody><tr><td class="code"><pre><span class="line">#!/usr/bin/env python3</span><br><span class="line">import rclpy</span><br><span class="line">from nav2_simple_commander.robot_navigator import BasicNavigator</span><br><span class="line">from geometry_msgs.msg import PoseStamped</span><br><span class="line">import tf_transformations</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    # init</span><br><span class="line">    rclpy.init()</span><br><span class="line">    nav = BasicNavigator()</span><br><span class="line">    # <span class="keyword">set</span> initial <span class="comment">pose</span></span><br><span class="line">    q_x, q_y, q_z, q_w <span class="comment">= tf_transformations.quaternion_from_euler(0.0, 0.0, 0.0)</span></span><br><span class="line">    initial_pose <span class="comment">= PoseStamped()</span></span><br><span class="line">    initial_pose.header.frame_id <span class="comment">=</span> <span class="comment">'map'</span></span><br><span class="line">    initial_pose.header.stamp <span class="comment">= nav.get_clock().now().to_msg()</span></span><br><span class="line">    initial_pose.pose.position.x <span class="comment">= 0.0</span></span><br><span class="line">    initial_pose.pose.position.y <span class="comment">= 0.0</span></span><br><span class="line">    initial_pose.pose.position.z <span class="comment">= 0.0</span></span><br><span class="line">    initial_pose.pose.orientation.x <span class="comment">= q_x</span></span><br><span class="line">    initial_pose.pose.orientation.y <span class="comment">= q_y</span></span><br><span class="line">    initial_pose.pose.orientation.z <span class="comment">= q_z</span></span><br><span class="line">    initial_pose.pose.orientation.w <span class="comment">= q_w</span></span><br><span class="line"></span><br><span class="line">    nav.setInitialPose(initial_pose=initial_pose)</span><br><span class="line">    nav.waitUntilNav2Active()</span><br><span class="line"></span><br><span class="line">    # <span class="keyword">set</span> <span class="comment">goal pose</span></span><br><span class="line">    q_x, q_y, q_z, q_w <span class="comment">= tf_transformations.quaternion_from_euler(0.0, 0.0, 1.57)</span></span><br><span class="line">    goal_pose <span class="comment">= PoseStamped()</span></span><br><span class="line">    goal_pose.header.frame_id <span class="comment">=</span> <span class="comment">'map'</span></span><br><span class="line">    goal_pose.header.stamp <span class="comment">= nav.get_clock().now().to_msg()</span></span><br><span class="line">    goal_pose.pose.position.x <span class="comment">= 3.5</span></span><br><span class="line">    goal_pose.pose.position.y <span class="comment">= 1.0</span></span><br><span class="line">    goal_pose.pose.position.z <span class="comment">= 0.0</span></span><br><span class="line">    goal_pose.pose.orientation.x <span class="comment">= q_x</span></span><br><span class="line">    goal_pose.pose.orientation.y <span class="comment">= q_y</span></span><br><span class="line">    goal_pose.pose.orientation.z <span class="comment">= q_z</span></span><br><span class="line">    goal_pose.pose.orientation.w <span class="comment">= q_w</span></span><br><span class="line">    nav.goToPose(goal_pose)</span><br><span class="line"></span><br><span class="line">    while <span class="comment">not nav.isTaskComplete():</span></span><br><span class="line">        feedback <span class="comment">= nav.getFeedback()</span></span><br><span class="line">        # print(feedback)</span><br><span class="line">    </span><br><span class="line">    # shutdown</span><br><span class="line">    rclpy.shutdown()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if <span class="comment">__name__ ==</span> <span class="comment">'__main__'</span><span class="comment">:</span></span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Waypoints发送一系列点"><a href="#Waypoints发送一系列点" class="headerlink" title="Waypoints发送一系列点"></a>Waypoints发送一系列点</h4><p><img alt="nav2_test.py" data-src="/2023/12/29/ROS2-Learning-Notes-Navigation-2-Stack/nav2_test.py"></p>
<h4 id="继续学习"><a href="#继续学习" class="headerlink" title="继续学习"></a>继续学习</h4><ul>
<li>ros2_control</li>
<li>robotic arm (moveit 2)</li>
<li>advanced ros2 core concepts</li>
</ul>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>ROS</category>
      </categories>
      <tags>
        <tag>ROS</tag>
        <tag>Navigation</tag>
      </tags>
  </entry>
  <entry>
    <title>ROS2 Learning Notes RViz &amp; Gazebo</title>
    <url>/2023/12/24/ROS2-Learning-Notes-RViz-Gazebo/</url>
    <content><![CDATA[<html><head></head><body><p>本文主要为<strong>ROS2 Humble</strong>的学习笔记，主要包括如何使用<strong>URDF</strong>在仿真环境<strong>Gazebo</strong>中控制机器人。* </p>
<ul>
<li>使用<strong>URDF</strong>定义机器人</li>
<li>在<strong>Gazebo</strong>中仿真机器人</li>
<li>使用<strong>Gazebo</strong>的插件控制机器人运动</li>
<li>打包整个机器人应用<span id="more"></span></li>
</ul>
<h2 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h2><h3 id="Visualize-a-robot-tfs-in-RViz2"><a href="#Visualize-a-robot-tfs-in-RViz2" class="headerlink" title="Visualize a robot tfs in RViz2"></a>Visualize a robot tfs in RViz2</h3><p>安装urdf tutorial package 和 tf2 tools.</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-urdf-tutorial</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-tf2-tools</span><br></pre></td></tr></tbody></table></figure>

<p>安装成功后，可以到以下路径查看已经定义好的urdf文件。</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">cd <span class="regexp">/opt/</span>ros<span class="regexp">/humble/</span>share<span class="regexp">/urdf_tutorial/u</span>rdf</span><br></pre></td></tr></tbody></table></figure>
<p><strong>share</strong>文件夹是所有ros package放置的地方。</p>
<p>使用以下命令可以查看一个指定的urdf文件定义的robot。</p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">launch</span> urdf_tutorial display.<span class="built_in">launch</span>.py model:=urdf/<span class="number">08</span>-macroed.urdf.xacro</span><br></pre></td></tr></tbody></table></figure>
<p>启动机器人后，会在<strong>RViz</strong>中显示机器人以及机器人的<strong>tf</strong>。并会有一个<strong>tf</strong>的topic，以array的形式实时发布每个关节的<strong>tf</strong>值。</p>
<figure class="highlight nestedtext"><table><tbody><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">header:</span></span><br><span class="line">    <span class="attribute">stamp</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">sec</span><span class="punctuation">:</span> <span class="string">1703555328</span></span><br><span class="line">      <span class="attribute">nanosec</span><span class="punctuation">:</span> <span class="string">545975035</span></span><br><span class="line">    <span class="attribute">frame_id</span><span class="punctuation">:</span> <span class="string">gripper_pole</span></span><br><span class="line">  <span class="attribute">child_frame_id</span><span class="punctuation">:</span> <span class="string">left_gripper</span></span><br><span class="line">  <span class="attribute">transform</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">translation</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">x</span><span class="punctuation">:</span> <span class="string">0.2</span></span><br><span class="line">      <span class="attribute">y</span><span class="punctuation">:</span> <span class="string">0.01</span></span><br><span class="line">      <span class="attribute">z</span><span class="punctuation">:</span> <span class="string">0.0</span></span><br><span class="line">    <span class="attribute">rotation</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">x</span><span class="punctuation">:</span> <span class="string">0.0</span></span><br><span class="line">      <span class="attribute">y</span><span class="punctuation">:</span> <span class="string">0.0</span></span><br><span class="line">      <span class="attribute">z</span><span class="punctuation">:</span> <span class="string">0.0</span></span><br><span class="line">      <span class="attribute">w</span><span class="punctuation">:</span> <span class="string">1.0</span></span><br></pre></td></tr></tbody></table></figure>
<p>消息结构主要有三部分，<strong>header</strong>主要包括时间戳和帧id，<strong>child_frame_id</strong>主要是与当前<strong>tf</strong>刚性关联的子<strong>tf</strong>，<strong>transform</strong>表示了当前<strong>tf</strong>和child <strong>tf</strong>的平移旋转关系。<br>机器人的所有<strong>tf</strong>会以树状结构显示，具体可以使用以下指令查看。</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">ros2</span> run tf2_tools view_frames</span><br><span class="line"><span class="attribute">open</span> frames_2023-<span class="number">12</span>-<span class="number">26</span>_09.<span class="number">52</span>.<span class="number">01</span>.pdf</span><br></pre></td></tr></tbody></table></figure>
<p>除了查看<strong>urdf</strong>所定义的<strong>tf tree</strong>，我们还可以查看两个关节之间的变换关系。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> tf2_ros tf2_echo base_link horizontal_arm</span><br></pre></td></tr></tbody></table></figure>
<p>上述指令可以实时查看两个关节之间的变换关系。</p>
<h3 id="Create-a-URDF-File"><a href="#Create-a-URDF-File" class="headerlink" title="Create a URDF File"></a>Create a URDF File</h3><ul>
<li>Unified Robot Description Format</li>
<li>Used to generate TFs</li>
<li>XML format</li>
</ul>
<h4 id="Create-and-Visualize-a-Link"><a href="#Create-and-Visualize-a-Link" class="headerlink" title="Create and Visualize a Link"></a>Create and Visualize a Link</h4><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">robot</span> <span class="attr">name</span>=<span class="string">"my_robot"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">material</span> <span class="attr">name</span>=<span class="string">"green"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">color</span> <span class="attr">rgba</span>=<span class="string">"0 0.5 0 1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">material</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">material</span> <span class="attr">name</span>=<span class="string">"blue"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">color</span> <span class="attr">rgba</span>=<span class="string">"0 0.0 0.5 1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">material</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">material</span> <span class="attr">name</span>=<span class="string">"grey"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">color</span> <span class="attr">rgba</span>=<span class="string">"0.5 0.5 0.5 1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">material</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"base_link"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">box</span> <span class="attr">size</span>=<span class="string">"0.6 0.4 0.2"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 0.1"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">material</span> <span class="attr">name</span>=<span class="string">"green"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"second_link"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">cylinder</span> <span class="attr">radius</span>=<span class="string">"0.1"</span> <span class="attr">length</span>=<span class="string">"0.2"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 0.1"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">material</span> <span class="attr">name</span>=<span class="string">"grey"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"third_link"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">box</span> <span class="attr">size</span>=<span class="string">"0.1 0.1 0.1"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 0.05"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">material</span> <span class="attr">name</span>=<span class="string">"blue"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"base_second_joint"</span> <span class="attr">type</span>=<span class="string">"fixed"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"base_link"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"second_link"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 0.2"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"second_third_joint"</span> <span class="attr">type</span>=<span class="string">"fixed"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"second_link"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"third_link"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 0.2"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">robot</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>第一句标明urdf文件的xml版本。</p>
<h5 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h5><ul>
<li>robot, 定义了一个机器人，名称使用name属性标签命名<ul>
<li>link，定义了机器人的一个部位，内部包含一个visual标签<ul>
<li>geometry, 定义了几何形状，例如box，cylinder等等</li>
<li>origin，定义了几何体的中心原点相对于link坐标系的相对位置关系，二者默认重叠。</li>
<li>material，定义了link的材料，例如颜色等等</li>
</ul>
</li>
<li>joint，定义了两个link之间的关系，用name标识命名，还有type属性值。<ul>
<li>parent，定义了父link</li>
<li>child，定义了子link</li>
<li>origin，定义了子link坐标系与父link坐标系之间的相对位置关系</li>
</ul>
</li>
<li>material，定义了材料属性，使用name命名标识，例如颜色等等。</li>
</ul>
</li>
</ul>
<h5 id="joint-类型"><a href="#joint-类型" class="headerlink" title="joint 类型"></a>joint 类型</h5><p><strong>joint</strong>定义了两个刚体之间的运动，因此其类型是多种多样的。</p>
<ul>
<li><p>fixed<br>两个刚体之间是固定的，无法移动，因此只需要定义<strong>parent link</strong>、<strong>child link</strong>和<strong>origin</strong>即可。</p>
</li>
<li><p>revolute</p>
<figure class="highlight abnf"><table><tbody><tr><td class="code"><pre><span class="line">&lt;joint name<span class="operator">=</span><span class="string">"base_second_joint"</span> type<span class="operator">=</span><span class="string">"revolute"</span>&gt;</span><br><span class="line">    &lt;parent link<span class="operator">=</span><span class="string">"base_link"</span>/&gt;</span><br><span class="line">    &lt;child link<span class="operator">=</span><span class="string">"second_link"</span>/&gt;</span><br><span class="line">    &lt;origin xyz<span class="operator">=</span><span class="string">"0 0 0.2"</span> rpy<span class="operator">=</span><span class="string">"0 0 0"</span>/&gt;</span><br><span class="line">    &lt;axis xyz<span class="operator">=</span><span class="string">"0 0 1"</span>/&gt;</span><br><span class="line">    &lt;limit lower<span class="operator">=</span><span class="string">"-1.57"</span> upper<span class="operator">=</span><span class="string">"1.57"</span> velocity<span class="operator">=</span><span class="string">"100"</span> effort<span class="operator">=</span><span class="string">"100"</span> /&gt;</span><br><span class="line">&lt;/joint&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>子刚体是旋转的，需要指定旋转轴<strong>axis</strong>以及旋转运动的<strong>limit</strong>。旋转轴<strong>axis</strong>需要用xyz向量表示；<strong>limit</strong>使用下限<strong>lower</strong>、上限<strong>upper</strong>、速度<strong>velocity</strong>、加速度<strong>effort</strong>。</p>
</li>
<li><p>continuous</p>
<figure class="highlight abnf"><table><tbody><tr><td class="code"><pre><span class="line">&lt;joint name<span class="operator">=</span><span class="string">"base_second_joint"</span> type<span class="operator">=</span><span class="string">"continuous"</span>&gt;</span><br><span class="line">    &lt;parent link<span class="operator">=</span><span class="string">"base_link"</span>/&gt;</span><br><span class="line">    &lt;child link<span class="operator">=</span><span class="string">"second_link"</span>/&gt;</span><br><span class="line">    &lt;origin xyz<span class="operator">=</span><span class="string">"0 0 0.2"</span> rpy<span class="operator">=</span><span class="string">"0 0 0"</span>/&gt;</span><br><span class="line">    &lt;axis xyz<span class="operator">=</span><span class="string">"0 0 1"</span>/&gt;</span><br><span class="line">    &lt;limit lower<span class="operator">=</span><span class="string">"-1.57"</span> upper<span class="operator">=</span><span class="string">"1.57"</span> velocity<span class="operator">=</span><span class="string">"100"</span> effort<span class="operator">=</span><span class="string">"100"</span> /&gt;</span><br><span class="line">&lt;/joint&gt;</span><br></pre></td></tr></tbody></table></figure>
<p><strong>continuous</strong>类型与<strong>revolute</strong>类似，但是没有<strong>limit</strong>限制，因此只需要提供一个<strong>axis</strong>即可。</p>
</li>
<li><p>prismatic</p>
<figure class="highlight abnf"><table><tbody><tr><td class="code"><pre><span class="line">&lt;joint name<span class="operator">=</span><span class="string">"base_second_joint"</span> type<span class="operator">=</span><span class="string">"prismatic"</span>&gt;</span><br><span class="line">    &lt;parent link<span class="operator">=</span><span class="string">"base_link"</span>/&gt;</span><br><span class="line">    &lt;child link<span class="operator">=</span><span class="string">"second_link"</span>/&gt;</span><br><span class="line">    &lt;origin xyz<span class="operator">=</span><span class="string">"0 0 0.2"</span> rpy<span class="operator">=</span><span class="string">"0 0 0"</span>/&gt;</span><br><span class="line">    &lt;axis xyz<span class="operator">=</span><span class="string">"1 0 0"</span>/&gt;</span><br><span class="line">    &lt;limit lower<span class="operator">=</span><span class="string">"0.0"</span> upper<span class="operator">=</span><span class="string">"0.2"</span> velocity<span class="operator">=</span><span class="string">"100"</span> effort<span class="operator">=</span><span class="string">"100"</span> /&gt;</span><br><span class="line">&lt;/joint&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>定义了刚体之间的平移运动，需要平移的方向<strong>axis</strong>和平移的限制<strong>limit</strong></p>
</li>
</ul>
<h4 id="Create-a-Robot"><a href="#Create-a-Robot" class="headerlink" title="Create a Robot"></a>Create a Robot</h4><p>我已经创建好了一个robot的urdf文件，<img alt="my_robot.urdf" data-src="/2023/12/24/ROS2-Learning-Notes-RViz-Gazebo/my_robot.urdf"><br>使用以下指令可视化已经定义好的机器人。</p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">launch</span> urdf_tutorial display.<span class="built_in">launch</span>.py model:=/home/robot/my_robot.urdf</span><br></pre></td></tr></tbody></table></figure>
<p><strong>model</strong>参数需要提供完整的绝对路径。<br>在RViz中即可显示机器人。<br><img data-src="/2023/12/24/ROS2-Learning-Notes-RViz-Gazebo/my-robot.png"><br>使用以下指令可以查看定义好的tf树状结构。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> tf2_tools view_frames</span><br></pre></td></tr></tbody></table></figure>
<p><img data-src="/2023/12/24/ROS2-Learning-Notes-RViz-Gazebo/my-robot-view.png"></p>
<h4 id="Launch-URDF-Step-by-Step"><a href="#Launch-URDF-Step-by-Step" class="headerlink" title="Launch URDF Step by Step"></a>Launch URDF Step by Step</h4><p>除了使用<strong>urdf_tutorial</strong>提供的<strong>display.launch.py</strong>运行定义好的urdf，我们还可以使用ros的命令行一步一步地运行。<br><img data-src="/2023/12/24/ROS2-Learning-Notes-RViz-Gazebo/urdf-rqt-graph.png"><br>如上图所是，可视化<strong>urdf</strong>之后，ros会默认发起两个节点，<strong>robot_state_publisher</strong>和<strong>joint_state_publisher</strong>。</p>
<h5 id="robot-state-publisher"><a href="#robot-state-publisher" class="headerlink" title="robot_state_publisher"></a>robot_state_publisher</h5><p><strong>robot_state_publisher</strong>负责解析机器人的<strong>urdf</strong>文件，并将解析结果向两个<strong>topic</strong>发送。一个是<strong>robot_description</strong>，包含了<strong>urdf</strong>提供的机器人描述信息，例如机器人的<strong>link</strong>和<strong>joint</strong>；另外一个是<strong>tf</strong>，包含了机器人机器人所有的<strong>tf</strong>信息。与此同时，该节点还监听一个<strong>topic</strong>，名字为<strong>joint_states</strong>，主要监听可运动关节的实时状态信息，并根据这些信息实时计算<strong>tf</strong>结果。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> robot_state_publisher robot_state_publisher --ros-args --param robot_description:=<span class="string">"<span class="variable">$(xacro my_robot.urdf)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<p>上述指令需要传入事先定义好的<strong>urdf</strong>文件。如果不是在统一目录下运行，则需要传入完整的<strong>path</strong>。</p>
<h5 id="joint-state-publisher"><a href="#joint-state-publisher" class="headerlink" title="joint_state_publisher"></a>joint_state_publisher</h5><p><strong>joint_state_publisher</strong>监听<strong>robot_description</strong>的信息，并生成提供驱动机器人关节运动的接口，驱动机器人的关节运动，并将运动结果发送到<strong>joint_states</strong>。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> joint_state_publisher_gui joint_state_publisher_gui</span><br></pre></td></tr></tbody></table></figure>
<h5 id="rviz"><a href="#rviz" class="headerlink" title="rviz"></a>rviz</h5><p><strong>RViz</strong>默认可以解析上述<strong>topic</strong>的结果，因此启动后可以在界面手动添加<strong>robot model</strong>和<strong>tf</strong>。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> rviz2 rviz2</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Launch-File"><a href="#Launch-File" class="headerlink" title="Launch File"></a>Launch File</h3><h4 id="XML"><a href="#XML" class="headerlink" title="XML"></a>XML</h4><figure class="highlight abnf"><table><tbody><tr><td class="code"><pre><span class="line">&lt;launch&gt;</span><br><span class="line">    &lt;let name<span class="operator">=</span><span class="string">"urdf_path"</span> value<span class="operator">=</span><span class="string">"$(find-pkg-share my_robot_description)/urdf/my_robot.urdf"</span>/&gt;</span><br><span class="line">    &lt;node pkg<span class="operator">=</span><span class="string">"robot_state_publisher"</span> exec<span class="operator">=</span><span class="string">"robot_state_publisher"</span>&gt;</span><br><span class="line">        &lt;param name<span class="operator">=</span><span class="string">"robot_description"</span> value<span class="operator">=</span><span class="string">"$(command 'xacro $(var urdf_path)')"</span>/&gt;</span><br><span class="line">    &lt;/node&gt;</span><br><span class="line">    &lt;node pkg<span class="operator">=</span><span class="string">"joint_state_publisher_gui"</span> exec<span class="operator">=</span><span class="string">"joint_state_publisher_gui"</span>/&gt;</span><br><span class="line">    &lt;node pkg<span class="operator">=</span><span class="string">"rviz2"</span> exec<span class="operator">=</span><span class="string">"rviz2"</span> output<span class="operator">=</span><span class="string">"screen"</span>/&gt;</span><br><span class="line">&lt;/launch&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>所有的定义在<strong>launch</strong>标签内。<br>变量的定义在<strong>let</strong>标签内，变量名为name，变量值为value。<br><strong>$()<strong>可以提供可执行函数逻辑，</strong>find-pkg-share my_robot_description</strong>可以提供当前package安装的绝对路径，<strong>command ‘’<strong>可以运行命令行指令，具体命令行在单引号内。<br>节点的定义在</strong>node</strong>标签内，需要至少提供两个参数，一个是<strong>pkg</strong>指定节点包的名字，另外一个是<strong>exec</strong>制定可执行文件的名字。<br>参数的定义在<strong>param</strong>标签内，标签需要放置在<strong>node</strong>标签内，需要提供<strong>name</strong>和<strong>value</strong>两个属性值。</p>
<h4 id="Python"><a href="#Python" class="headerlink" title="Python"></a>Python</h4><figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> launch <span class="keyword">import</span> LaunchDescription</span><br><span class="line"><span class="keyword">from</span> launch.substitutions <span class="keyword">import</span> Command</span><br><span class="line"><span class="keyword">from</span> launch_ros.parameter_descriptions <span class="keyword">import</span> ParameterValue</span><br><span class="line"><span class="keyword">from</span> launch_ros.actions <span class="keyword">import</span> Node</span><br><span class="line"><span class="keyword">from</span> ament_index_python.packages <span class="keyword">import</span> get_package_share_path</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> generate_launch_description():</span><br><span class="line">    ld = LaunchDescription()</span><br><span class="line">    urdf_path = os.path.<span class="keyword">join</span>(get_package_share_path(<span class="string">'my_robot_description'</span>), <span class="string">'urdf'</span>, <span class="string">'my_robot.urdf'</span>)</span><br><span class="line">    rviz_config_path = os.path.<span class="keyword">join</span>(get_package_share_path(<span class="string">'my_robot_description'</span>), <span class="string">'rviz'</span>, <span class="string">'default.rviz'</span>)</span><br><span class="line">    robot_description = ParameterValue(Command([<span class="string">'xacro '</span>, urdf_path]), value_type=str)</span><br><span class="line">    </span><br><span class="line">    robot_state_publisher_node = Node(</span><br><span class="line">        <span class="keyword">package</span>=<span class="string">"robot_state_publisher"</span>,</span><br><span class="line">        executable=<span class="string">"robot_state_publisher"</span>,</span><br><span class="line">        parameters=[</span><br><span class="line">            {<span class="string">'robot_description'</span>: robot_description}</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    joint_state_publisher_node = Node(</span><br><span class="line">        <span class="keyword">package</span>=<span class="string">"joint_state_publisher_gui"</span>,</span><br><span class="line">        executable=<span class="string">"joint_state_publisher_gui"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    rviz2_node = Node(</span><br><span class="line">        <span class="keyword">package</span>=<span class="string">"rviz2"</span>,</span><br><span class="line">        executable=<span class="string">"rviz2"</span>,</span><br><span class="line">        arguments=[</span><br><span class="line">            rviz_config_path</span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line">    ld.add_action(robot_state_publisher_node)</span><br><span class="line">    ld.add_action(joint_state_publisher_node)</span><br><span class="line">    ld.add_action(rviz2_node)</span><br><span class="line">    <span class="keyword">return</span> ld</span><br></pre></td></tr></tbody></table></figure>
<p>Python版本的launch文件内必须有一个名为<strong>generate_launch_description</strong>的文件。然后从<strong>launch</strong>引入<strong>LaunchDescription</strong>，从<strong>launch_ros.actions</strong>引入<strong>Node</strong>。<br><strong>get_package_share_path</strong>函数可以帮助我们发现指定包的安装路径。<br><strong>ParameterValue</strong>可以定义一个parameter参数，并且使用<strong>Command</strong>指令。</p>
<h3 id="Improve-URDF-with-Xacro"><a href="#Improve-URDF-with-Xacro" class="headerlink" title="Improve URDF with Xacro"></a>Improve URDF with Xacro</h3><h4 id="Support-for-Xacro"><a href="#Support-for-Xacro" class="headerlink" title="Support for Xacro"></a>Support for Xacro</h4><p>首先将urdf文件名的后缀由.urdf修改为.urdf.xacro</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">mv my_robot<span class="selector-class">.urdf</span> my_robot<span class="selector-class">.urdf</span>.xacro</span><br></pre></td></tr></tbody></table></figure>
<p>然后在<strong>robot</strong>标签添加一行代码。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">&lt;robot <span class="attribute">name</span>=<span class="string">"my_robot"</span>&gt;</span><br><span class="line">&lt;robot <span class="attribute">name</span>=<span class="string">"my_robot"</span> xmlns:<span class="attribute">xacro</span>=<span class="string">"http://wwww.ros.org/wiki/xacro"</span>&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Create-Variables-with-Xacro-Properties"><a href="#Create-Variables-with-Xacro-Properties" class="headerlink" title="Create Variables with Xacro Properties"></a>Create Variables with Xacro Properties</h4><ul>
<li>定义变量<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">&lt;xacro:property <span class="attribute">name</span>=<span class="string">"base_length"</span> <span class="attribute">value</span>=<span class="string">"0.6"</span>/&gt;</span><br></pre></td></tr></tbody></table></figure>
使用<strong>xacro:property</strong>标签定义变量，变量名用<strong>name</strong>标识，变量值用<strong>value</strong>标识。</li>
<li>使用变量<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">&lt;origin <span class="attribute">xyz</span>=<span class="string">"<span class="variable">${-base_length/4.0}</span> -0.225 0"</span> <span class="attribute">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span><br></pre></td></tr></tbody></table></figure>
使用${}表达式引用变量。</li>
</ul>
<h4 id="Create-Functions-with-Xacro-Properties"><a href="#Create-Functions-with-Xacro-Properties" class="headerlink" title="Create Functions with Xacro Properties"></a>Create Functions with Xacro Properties</h4><p>除了可以使用<strong>property</strong>定义变量，<strong>xacro</strong>还提供了<strong>macro</strong>用于定义函数体， 定义好的函数体可以像函数一样重复使用。</p>
<figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">xacro:macro</span> <span class="attr">name</span>=<span class="string">"example_macro"</span> <span class="attr">params</span>=<span class="string">"a b c"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"dummy_link"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">box</span> <span class="attr">size</span>=<span class="string">"$</span></span></span><span class="template-variable">{a}</span><span class="language-xml"><span class="tag"><span class="string"> $</span></span></span><span class="template-variable">{b}</span><span class="language-xml"><span class="tag"><span class="string"> $</span></span></span><span class="template-variable">{c}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">xacro:macro</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>上述代码定义了一个名为<strong>example_macro</strong>的函数体，需要传入a、b和c三个参数。</p>
<p>使用函数体。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">&lt;xacro:example_macro <span class="attribute">a</span>=<span class="string">"2"</span> <span class="attribute">b</span>=<span class="string">"3"</span> <span class="attribute">c</span>=<span class="string">"4"</span>/&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>直接使用<strong>xacro</strong>引用函数体，并传入参数即可。</p>
<h4 id="Include-Xacro-Files-in-Another-Xacro-File"><a href="#Include-Xacro-Files-in-Another-Xacro-File" class="headerlink" title="Include Xacro Files in Another Xacro File"></a>Include Xacro Files in Another Xacro File</h4><p>首先定义好xacro文件，然后利用<strong>xacro:include</strong>引入文件即可。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">&lt;xacro:include <span class="attribute">filename</span>=<span class="string">"mobile_base.xacro"</span>/&gt;</span><br></pre></td></tr></tbody></table></figure>

<h3 id="Meshes-for-RealRobot"><a href="#Meshes-for-RealRobot" class="headerlink" title="Meshes for RealRobot"></a>Meshes for RealRobot</h3><p><strong>urdf</strong>通过<strong>geometry</strong>的<strong>mesh</strong>接口引入真实的机器人形状结构，需要提供<strong>stl</strong>文件。</p>
<h3 id="Simulate-Robot-with-Gazebo"><a href="#Simulate-Robot-with-Gazebo" class="headerlink" title="Simulate Robot with Gazebo"></a>Simulate Robot with Gazebo</h3><p><strong>RViz</strong>不是一个仿真工具，而仅仅是一个3D可视化工具。<strong>Gazebo</strong>是仿真工具，可以模拟重力和物理属性。<br><strong>Gazebo</strong>是一个独立的工具，可以直接在terminal中启动。</p>
<figure class="highlight 1c"><table><tbody><tr><td class="code"><pre><span class="line">gazebo <span class="meta">&amp;</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>Gazebo</strong>通过<strong>gazebo_ros</strong>工具与ros环境通信。<br><strong>Gazebo</strong>有很多插件，例如<strong>Control plugin</strong>和<strong>Joint State Publisher plugin</strong>等等。</p>
<h4 id="Add-Inertia-Tags-in-URDF"><a href="#Add-Inertia-Tags-in-URDF" class="headerlink" title="Add Inertia Tags in URDF"></a>Add Inertia Tags in URDF</h4><p>要想在<strong>Gazebo</strong>中仿真，除了提供可视化的<strong>visual</strong>标签，还需要提供跟运动相关的<strong>inertial</strong>标签。规则且质量分布均匀的几何体的惯量一般可以根据其几何形状计算出来，因此我们通过<strong>xacro:macro</strong>定义惯量函数。<br><strong>inertial</strong>一般包含三部分：</p>
<ol>
<li><strong>origin</strong>，一般跟可视化的<strong>origin</strong>保持一致。</li>
<li><strong>mass</strong>，质量大小，提供value即可。</li>
<li><strong>inertia</strong>，转动惯量矩阵，通常是一个3x3的对称矩阵，为了方便，通常只需要提供上三角矩阵的数值。</li>
</ol>
<ul>
<li><p>立方体</p>
<figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">xacro:macro</span> <span class="attr">name</span>=<span class="string">"box_inertia"</span> <span class="attr">params</span>=<span class="string">"m l w h xyz rpy"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"$</span></span></span><span class="template-variable">{xyz}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">rpy</span>=<span class="string">"$</span></span></span><span class="template-variable">{rpy}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">mass</span> <span class="attr">value</span>=<span class="string">"$</span></span></span><span class="template-variable">{m}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">inertia</span> <span class="attr">ixx</span>=<span class="string">"$</span></span></span><span class="template-variable">{(m/12)*(h*h+l*l)}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">ixy</span>=<span class="string">"0"</span> <span class="attr">ixz</span>=<span class="string">"0"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">iyy</span>=<span class="string">"$</span></span></span><span class="template-variable">{(m/12)*(w*w+l*l)}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">iyz</span>=<span class="string">"0"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">izz</span>=<span class="string">"$</span></span></span><span class="template-variable">{(m/12)*(w*w+h*h)}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">xacro:macro</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>需要提供以下入参：m–质量，l–长度，w–宽度，h–高度，xyz–origin的原点平移向量，rpy–origin的旋转角度。</p>
</li>
<li><p>圆柱体</p>
<figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">xacro:macro</span> <span class="attr">name</span>=<span class="string">"cylinder_inertia"</span> <span class="attr">params</span>=<span class="string">"m r l xyz rpy"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"$</span></span></span><span class="template-variable">{xyz}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">rpy</span>=<span class="string">"$</span></span></span><span class="template-variable">{rpy}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">mass</span> <span class="attr">value</span>=<span class="string">"$</span></span></span><span class="template-variable">{m}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">inertia</span> <span class="attr">ixx</span>=<span class="string">"$</span></span></span><span class="template-variable">{(m/12.0)*(3*r*r+l*l)}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">ixy</span>=<span class="string">"$</span></span></span><span class="template-variable">{0}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">ixz</span>=<span class="string">"$</span></span></span><span class="template-variable">{0}</span><span class="language-xml"><span class="tag"><span class="string">"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">iyy</span>=<span class="string">"$</span></span></span><span class="template-variable">{(m/12.0)*(3*r*r+l*l)}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">iyz</span>=<span class="string">"$</span></span></span><span class="template-variable">{0}</span><span class="language-xml"><span class="tag"><span class="string">"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">izz</span>=<span class="string">"$</span></span></span><span class="template-variable">{(m/2.0)*(r*r)}</span><span class="language-xml"><span class="tag"><span class="string">"</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">xacro:macro</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>需要提供以下入参：m–质量，r–圆柱的半径，l–圆柱的高度，xyz和rpy同上。</p>
</li>
<li><p>球体</p>
<figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">xacro:macro</span> <span class="attr">name</span>=<span class="string">"sphere_inertia"</span> <span class="attr">params</span>=<span class="string">"m r xyz rpy"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"$</span></span></span><span class="template-variable">{xyz}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">rpy</span>=<span class="string">"$</span></span></span><span class="template-variable">{rpy}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">mass</span> <span class="attr">value</span>=<span class="string">"$</span></span></span><span class="template-variable">{m}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">inertia</span> <span class="attr">ixx</span>=<span class="string">"$</span></span></span><span class="template-variable">{(2/5*m)*(r*r)}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">ixy</span>=<span class="string">"0"</span> <span class="attr">ixz</span>=<span class="string">"0"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">iyy</span>=<span class="string">"$</span></span></span><span class="template-variable">{(2/5*m)*(r*r)}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">iyz</span>=<span class="string">"0"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">izz</span>=<span class="string">"$</span></span></span><span class="template-variable">{(2/5*m)*(r*r)}</span><span class="language-xml"><span class="tag"><span class="string">"</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">xacro:macro</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>需要提供以下入参：m–质量，r–球的半径，xyz和rpy同上。</p>
</li>
</ul>
<p>上述函数调用直接在<strong>link</strong>标签内通过<strong>xacro</strong>调用即可，传入名字和入参，具体如下所示。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">&lt;xacro:box_inertia <span class="attribute">m</span>=<span class="string">"5"</span> <span class="attribute">l</span>=<span class="string">"0.6"</span> <span class="attribute">w</span>=<span class="string">"0.4"</span> <span class="attribute">h</span>=<span class="string">"0.2"</span> <span class="attribute">xyz</span>=<span class="string">"0 0 0"</span> <span class="attribute">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Add-Collision-Tags-in-URDF"><a href="#Add-Collision-Tags-in-URDF" class="headerlink" title="Add Collision Tags in URDF"></a>Add Collision Tags in URDF</h4><p>碰撞检测在仿真中同样重要，用<strong>collision</strong>标签定义，一般与<strong>visual</strong>标签内定义的几何形状相同或者是简化的几何形状。</p>
<figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">box</span> <span class="attr">size</span>=<span class="string">"$</span></span></span><span class="template-variable">{base_length}</span><span class="language-xml"><span class="tag"><span class="string"> $</span></span></span><span class="template-variable">{base_width}</span><span class="language-xml"><span class="tag"><span class="string"> $</span></span></span><span class="template-variable">{base_height}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 $</span></span></span><span class="template-variable">{base_height/2.0}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">collision</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="Spawn-Robot-in-Gazebo"><a href="#Spawn-Robot-in-Gazebo" class="headerlink" title="Spawn Robot in Gazebo"></a>Spawn Robot in Gazebo</h4><h5 id="Step-by-Step"><a href="#Step-by-Step" class="headerlink" title="Step by Step"></a>Step by Step</h5><p>根<strong>RViz</strong>一样，<strong>Gazebo</strong>同样需要监听<strong>robot_description</strong>来获取机器人的信息，因此需要启动<strong>robot_states_publisher</strong>节点。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> robot_state_publisher robot_state_publisher --ros-args --param robot_description:=<span class="string">"<span class="variable">$(xacro ~/ros2_ws/src/my_robot_description/urdf/my_robot.urdf.xacro)</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<p>节点需要传入机器人的<strong>urdf</strong>信息。</p>
<p>然后启动支持<strong>ROS</strong>接口的<strong>Gazebo</strong>。</p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">launch</span> gazebo_ros gazebo.<span class="built_in">launch</span>.py</span><br></pre></td></tr></tbody></table></figure>
<p>需要启动<strong>gazebo_ros</strong>包的接口。</p>
<p>最后用<strong>gazebo_ros</strong>包的<strong>spawn_entity</strong>节点生成机器人。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">ros2 <span class="built_in">run</span> gazebo_ros spawn_entity.py -topic robot_description -entity my_robot</span><br></pre></td></tr></tbody></table></figure>
<p>需要监听<strong>robot_description</strong>主体，生成<strong>my_robot</strong>的<strong>entity</strong>。</p>
<h5 id="Using-a-Launch-File"><a href="#Using-a-Launch-File" class="headerlink" title="Using a Launch File"></a>Using a Launch File</h5><figure class="highlight abnf"><table><tbody><tr><td class="code"><pre><span class="line">&lt;launch&gt;</span><br><span class="line">    &lt;let name<span class="operator">=</span><span class="string">"urdf_path"</span> value<span class="operator">=</span><span class="string">"$(find-pkg-share my_robot_description)/urdf/my_robot.urdf.xacro"</span>/&gt;</span><br><span class="line">    &lt;let name<span class="operator">=</span><span class="string">"rviz_config_path"</span> value<span class="operator">=</span><span class="string">"$(find-pkg-share my_robot_description)/rviz/default.rviz"</span>/&gt;</span><br><span class="line">    &lt;node pkg<span class="operator">=</span><span class="string">"robot_state_publisher"</span> exec<span class="operator">=</span><span class="string">"robot_state_publisher"</span>&gt;</span><br><span class="line">        &lt;param name<span class="operator">=</span><span class="string">"robot_description"</span> value<span class="operator">=</span><span class="string">"$(command 'xacro $(var urdf_path)')"</span>/&gt;</span><br><span class="line">    &lt;/node&gt;</span><br><span class="line">    &lt;include file<span class="operator">=</span><span class="string">"$(find-pkg-share gazebo_ros)/launch/gazebo.launch.py"</span>/&gt;</span><br><span class="line"></span><br><span class="line">    &lt;node pkg<span class="operator">=</span><span class="string">"gazebo_ros"</span> exec<span class="operator">=</span><span class="string">"spawn_entity.py"</span> args<span class="operator">=</span><span class="string">"-topic robot_description -entity my_robot"</span>/&gt;</span><br><span class="line">    &lt;node pkg<span class="operator">=</span><span class="string">"rviz2"</span> exec<span class="operator">=</span><span class="string">"rviz2"</span> output<span class="operator">=</span><span class="string">"screen"</span> args<span class="operator">=</span><span class="string">"$(var rviz_config_path)"</span>/&gt;</span><br><span class="line">&lt;/launch&gt;</span><br></pre></td></tr></tbody></table></figure>
<p><strong>launch</strong>文件的结构跟之前的类似，不过添加了两个新的内容。</p>
<ol>
<li>可以在launch文件中引入其他的launch文件，直接用include标签提供文件的目录即可。</li>
<li>运行节点传入args（不是param）,可以直接使用args属性。</li>
</ol>
<h5 id="Add-Colors-in-Gazebo"><a href="#Add-Colors-in-Gazebo" class="headerlink" title="Add Colors in Gazebo"></a>Add Colors in Gazebo</h5><p>要想在<strong>Gazebo</strong>中显示每个刚体的颜色，需要使用<strong>gazebo</strong>标签对刚体的定义进行额外描述。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">robot</span> <span class="attr">xmlns:xacro</span>=<span class="string">"http://wwww.ros.org/wiki/xacro"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">gazebo</span> <span class="attr">reference</span>=<span class="string">"base_link"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">material</span>&gt;</span>Gazebo/Blue<span class="tag">&lt;/<span class="name">material</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">gazebo</span> <span class="attr">reference</span>=<span class="string">"right_wheel_link"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">material</span>&gt;</span>Gazebo/Green<span class="tag">&lt;/<span class="name">material</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">gazebo</span> <span class="attr">reference</span>=<span class="string">"left_wheel_link"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">material</span>&gt;</span>Gazebo/Green<span class="tag">&lt;/<span class="name">material</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">gazebo</span> <span class="attr">reference</span>=<span class="string">"caster_wheel_link"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">material</span>&gt;</span>Gazebo/Grey<span class="tag">&lt;/<span class="name">material</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">robot</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>用<strong>reference</strong>指明要描述的刚体（link）,然后用<strong>material</strong>标签去定义颜色。<br>还可以使用<strong>mu</strong>标签定义摩擦系数。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gazebo</span> <span class="attr">reference</span>=<span class="string">"caster_wheel_link"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">material</span>&gt;</span>Gazebo/Grey<span class="tag">&lt;/<span class="name">material</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mu1</span> <span class="attr">value</span>=<span class="string">"0.1"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mu2</span> <span class="attr">value</span>=<span class="string">"0.1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>

<h5 id="Add-a-Gazebo-Control-Plugin-to-Control-Robot"><a href="#Add-a-Gazebo-Control-Plugin-to-Control-Robot" class="headerlink" title="Add a Gazebo Control Plugin to Control Robot"></a>Add a Gazebo Control Plugin to Control Robot</h5><p><a href="https://classic.gazebosim.org/tutorials?tut=ros_gzplugins">官网教程</a><br><a href="git@github.com:ros-simulation/gazebo_ros_pkgs.git">Gazebo ros pkg源码</a></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">gazebo</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">name</span>=<span class="string">"diff_drive_controller"</span> <span class="attr">filename</span>=<span class="string">"libgazebo_ros_diff_drive.so"</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- Update rate in Hz --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">update_rate</span>&gt;</span>50<span class="tag">&lt;/<span class="name">update_rate</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- wheels --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">left_joint</span>&gt;</span>base_left_wheel_joint<span class="tag">&lt;/<span class="name">left_joint</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">right_joint</span>&gt;</span>base_right_wheel_joint<span class="tag">&lt;/<span class="name">right_joint</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- kinematics --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">wheel_separation</span>&gt;</span>0.45<span class="tag">&lt;/<span class="name">wheel_separation</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">wheel_diameter</span>&gt;</span>0.2<span class="tag">&lt;/<span class="name">wheel_diameter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- limits --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;max_wheel_torque&gt;200&lt;/max_wheel_torque&gt;</span></span><br><span class="line"><span class="comment">        &lt;max_wheel_acceleration&gt;10.0&lt;/max_wheel_acceleration&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- input --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;command_topic&gt;cmd_vel&lt;/command_topic&gt; --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- output --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">publish_odom</span>&gt;</span>true<span class="tag">&lt;/<span class="name">publish_odom</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">publish_odom_tf</span>&gt;</span>true<span class="tag">&lt;/<span class="name">publish_odom_tf</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">publish_wheel_tf</span>&gt;</span>true<span class="tag">&lt;/<span class="name">publish_wheel_tf</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">odometry_topic</span>&gt;</span>odom<span class="tag">&lt;/<span class="name">odometry_topic</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">odometry_frame</span>&gt;</span>odom<span class="tag">&lt;/<span class="name">odometry_frame</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">robot_base_frame</span>&gt;</span>base_footprint<span class="tag">&lt;/<span class="name">robot_base_frame</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">gazebo</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>直接使用<strong>gazebo</strong>标签和<strong>plugin</strong>标签定义插件。</p>
<h5 id="Create-a-World-in-Gazebo"><a href="#Create-a-World-in-Gazebo" class="headerlink" title="Create a World in Gazebo"></a>Create a World in Gazebo</h5><p>在Gazebo中编辑后保存即可。编辑既可以在<strong>insert</strong>页面插入物体，也可以在<strong>edit</strong>–&gt;<strong>Building Edit</strong>中插入建筑物。最后保存为一个后缀为<strong>world</strong>的文件。</p>
<h5 id="Launch-the-Robot-in-the-World"><a href="#Launch-the-Robot-in-the-World" class="headerlink" title="Launch the Robot in the World"></a>Launch the Robot in the World</h5><figure class="highlight abnf"><table><tbody><tr><td class="code"><pre><span class="line">&lt;include file<span class="operator">=</span><span class="string">"$(find-pkg-share gazebo_ros)/launch/gazebo.launch.py"</span>&gt;</span><br><span class="line">    &lt;arg name<span class="operator">=</span><span class="string">"world"</span> value<span class="operator">=</span><span class="string">"$(find-pkg-share my_robot_description)/world/my_world.world"</span>/&gt;</span><br><span class="line">&lt;/include&gt;</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Add-a-Camera-in-URDF"><a href="#Add-a-Camera-in-URDF" class="headerlink" title="Add a Camera in URDF"></a>Add a Camera in URDF</h4><h3 id="Control-Robot-in-Gazebo"><a href="#Control-Robot-in-Gazebo" class="headerlink" title="Control Robot in Gazebo"></a>Control Robot in Gazebo</h3><p>使用<strong>ros2_control</strong>库控制硬件设备，具体逻辑见下图。<br><img alt="ROS2 controller &amp; hardware" data-src="/2023/12/24/ROS2-Learning-Notes-RViz-Gazebo/controller-manager-hardware.png"><br>控制器的控制逻辑如下所示。<br><img alt="控制器逻辑图" data-src="/2023/12/24/ROS2-Learning-Notes-RViz-Gazebo/ros2-controller.png"><br>控制一般分为3种：</p>
<ul>
<li>position</li>
<li>velocity</li>
<li>effort</li>
</ul>
<h4 id="URDF"><a href="#URDF" class="headerlink" title="URDF"></a>URDF</h4><p><strong>urdf</strong>包括三部分，第一部分是机器人自身相关的<strong>robot.urdf.xacro</strong>，开始是<strong>xml</strong>文件的版本号，一般是<strong>1.0</strong>版本。</p>
<figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">robot</span> <span class="attr">xmlns:xacro</span>=<span class="string">"http://www.ros.org/wiki/xacro"</span> <span class="attr">name</span>=<span class="string">"robot"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:include</span> <span class="attr">filename</span>=<span class="string">"$(find robot_description)/urdf/robot_gazebo.xacro"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:include</span> <span class="attr">filename</span>=<span class="string">"$(find robot_description)/urdf/robot_ros2_control.xacro"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:property</span> <span class="attr">name</span>=<span class="string">"effort"</span> <span class="attr">value</span>=<span class="string">"30.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:property</span> <span class="attr">name</span>=<span class="string">"velocity"</span> <span class="attr">value</span>=<span class="string">"10.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:macro</span> <span class="attr">name</span>=<span class="string">"default_inertial"</span> <span class="attr">params</span>=<span class="string">"mass"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">mass</span> <span class="attr">value</span>=<span class="string">"$</span></span></span><span class="template-variable">{mass}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">inertia</span> <span class="attr">ixx</span>=<span class="string">"1.0"</span> <span class="attr">ixy</span>=<span class="string">"0.0"</span> <span class="attr">ixz</span>=<span class="string">"0.0"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                     <span class="attr">iyy</span>=<span class="string">"1.0"</span> <span class="attr">iyz</span>=<span class="string">"0.0"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                     <span class="attr">izz</span>=<span class="string">"1.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">xacro:macro</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:macro</span> <span class="attr">name</span>=<span class="string">"default_transmission"</span> <span class="attr">params</span>=<span class="string">"number"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">transmission</span> <span class="attr">name</span>=<span class="string">"transmission_$</span></span></span><span class="template-variable">{number}</span><span class="language-xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>transmission_interface/SimpleTransmission<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">actuator</span> <span class="attr">name</span>=<span class="string">"motor_$</span></span></span><span class="template-variable">{number}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">role</span>=<span class="string">"actuator1"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"joint_$</span></span></span><span class="template-variable">{number}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">role</span>=<span class="string">"joint1"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mechanical_reduction</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">mechanical_reduction</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">transmission</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">xacro:macro</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"world"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"base_link"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/basement.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.5 -0.5 0"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/basement.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.5 -0.5 0"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">xacro:default_inertial</span> <span class="attr">mass</span>=<span class="string">"1.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"virtual_joint"</span> <span class="attr">type</span>=<span class="string">"fixed"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"world"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"base_link"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 0"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"base_plate"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/base_plate.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span> <span class="attr">xyz</span>=<span class="string">"-0.39 -0.39 -0.56"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/base_plate.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span> <span class="attr">xyz</span>=<span class="string">"-0.39 -0.39 -0.56"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">xacro:default_inertial</span> <span class="attr">mass</span>=<span class="string">"1.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"joint_1"</span> <span class="attr">type</span>=<span class="string">"revolute"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"base_link"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"base_plate"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">axis</span> <span class="attr">xyz</span>=<span class="string">"0 0 1"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span> <span class="attr">xyz</span>=<span class="string">"0 0 0.307"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">limit</span> <span class="attr">lower</span>=<span class="string">"-$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">upper</span>=<span class="string">"$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">effort</span>=<span class="string">"$</span></span></span><span class="template-variable">{effort}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">velocity</span>=<span class="string">"$</span></span></span><span class="template-variable">{velocity}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"forward_drive_arm"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/forward_drive_arm.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 -$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string"> $</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">xyz</span>=<span class="string">"0.19 0.06 -0.08"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/forward_drive_arm.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 -$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string"> $</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">xyz</span>=<span class="string">"0.19 0.06 -0.08"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">xacro:default_inertial</span> <span class="attr">mass</span>=<span class="string">"1.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"joint_2"</span> <span class="attr">type</span>=<span class="string">"revolute"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"base_plate"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"forward_drive_arm"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">axis</span> <span class="attr">xyz</span>=<span class="string">"1 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span> <span class="attr">xyz</span>=<span class="string">"-0.02 0 0.35"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">limit</span> <span class="attr">lower</span>=<span class="string">"-$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">upper</span>=<span class="string">"$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">effort</span>=<span class="string">"$</span></span></span><span class="template-variable">{effort}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">velocity</span>=<span class="string">"$</span></span></span><span class="template-variable">{velocity}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"horizontal_arm"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/horizontal_arm.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string"> 0 $</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">xyz</span>=<span class="string">"-0.03 -0.4 -0.06"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/horizontal_arm.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string"> 0 $</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">xyz</span>=<span class="string">"-0.03 -0.4 -0.06"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">xacro:default_inertial</span> <span class="attr">mass</span>=<span class="string">"1.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"joint_3"</span> <span class="attr">type</span>=<span class="string">"revolute"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"forward_drive_arm"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"horizontal_arm"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">axis</span> <span class="attr">xyz</span>=<span class="string">"1 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span> <span class="attr">xyz</span>=<span class="string">"0 0 0.8"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">limit</span> <span class="attr">lower</span>=<span class="string">"-$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">upper</span>=<span class="string">"$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">effort</span>=<span class="string">"$</span></span></span><span class="template-variable">{effort}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">velocity</span>=<span class="string">"$</span></span></span><span class="template-variable">{velocity}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"claw_support"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/claw_support.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 0 $</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">xyz</span>=<span class="string">"0 -0.05 -0.15"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">collsion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/claw_support.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 0 $</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">xyz</span>=<span class="string">"0 -0.05 -0.15"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">collsion</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">xacro:default_inertial</span> <span class="attr">mass</span>=<span class="string">"0.05"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"horizontal_arm_to_claw_support"</span> <span class="attr">type</span>=<span class="string">"fixed"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"horizontal_arm"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"claw_support"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span> <span class="attr">xyz</span>=<span class="string">"0 0.82 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"gripper_right"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/right_finger.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.1 0.5 -0.1"</span> <span class="attr">rpy</span>=<span class="string">"0 0 -$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/right_finger.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.1 0.5 -0.1"</span> <span class="attr">rpy</span>=<span class="string">"0 0 -$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">xacro:default_inertial</span> <span class="attr">mass</span>=<span class="string">"0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"gripper_left"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/left_finger.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.04 0.5 -0.1"</span> <span class="attr">rpy</span>=<span class="string">"0 0 -$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/left_finger.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.04 0.5 -0.1"</span> <span class="attr">rpy</span>=<span class="string">"0 0 -$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">collision</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">xacro:default_inertial</span> <span class="attr">mass</span>=<span class="string">"0.01"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"joint_4"</span> <span class="attr">type</span>=<span class="string">"revolute"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"claw_support"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"gripper_right"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.04 0.13 -0.1"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">axis</span> <span class="attr">xyz</span>=<span class="string">"0 0 1"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">limit</span> <span class="attr">lower</span>=<span class="string">"-$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">upper</span>=<span class="string">"0"</span> <span class="attr">effort</span>=<span class="string">"$</span></span></span><span class="template-variable">{effort}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">velocity</span>=<span class="string">"$</span></span></span><span class="template-variable">{velocity}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"joint_5"</span> <span class="attr">type</span>=<span class="string">"revolute"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"claw_support"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"gripper_left"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.22 0.13 -0.1"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">axis</span> <span class="attr">xyz</span>=<span class="string">"0 0 1"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">mimic</span> <span class="attr">joint</span>=<span class="string">"joint_4"</span> <span class="attr">multiplier</span>=<span class="string">"-1"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">limit</span> <span class="attr">lower</span>=<span class="string">"0"</span> <span class="attr">upper</span>=<span class="string">"$</span></span></span><span class="template-variable">{pi/2}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">effort</span>=<span class="string">"$</span></span></span><span class="template-variable">{effort}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">velocity</span>=<span class="string">"$</span></span></span><span class="template-variable">{velocity}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:default_transmission</span> <span class="attr">number</span>=<span class="string">"1"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:default_transmission</span> <span class="attr">number</span>=<span class="string">"2"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:default_transmission</span> <span class="attr">number</span>=<span class="string">"3"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">xacro:default_transmission</span> <span class="attr">number</span>=<span class="string">"4"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">robot</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<p>具体参照<a href="robot.urdf.xacro">robot.urdf.xacro</a>，<a href="robot_gazebo.xacro">robot_gazebo.xacro</a>和<a href="robot_ros2_control.xacro">robot_ros2_control.xacro</a>。</p>
<h4 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h4><p>然后单独创建一个<strong>robot_controller</strong>包，在包中分别创建<strong>config</strong>和<strong>launch</strong>文件夹。</p>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">-- rcl</span></span><br><span class="line">ros2 pkg <span class="built_in">create</span> robot_controller <span class="comment">--build-type ament_cmake</span></span><br><span class="line">rm -rf include src</span><br><span class="line">mkdir <span class="built_in">config</span></span><br><span class="line">mkdir launch</span><br><span class="line"><span class="comment">-- CMakeLists.txt</span></span><br><span class="line">install(</span><br><span class="line">  DIRECTORY <span class="built_in">config</span> launch</span><br><span class="line">  DESTINATION share/${PROJECT_NAME}</span><br><span class="line">)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="Yaml-Configuration"><a href="#Yaml-Configuration" class="headerlink" title="Yaml Configuration"></a>Yaml Configuration</h4><p><strong>Yaml</strong>可读性很强，可以用于配置参数，具体可以参照<a href=""></a></p>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>ROS</category>
      </categories>
      <tags>
        <tag>ROS</tag>
        <tag>RViz</tag>
        <tag>Gazebo</tag>
      </tags>
  </entry>
  <entry>
    <title>ROS2 Learning Notes Advanced Concepts</title>
    <url>/2024/01/14/ROS2-Learning-Notes-Advanced-Concepts/</url>
    <content><![CDATA[<html><head></head><body><p>本文主要记录<strong>ROS2</strong>的高级概念，包括<strong>ROS2</strong>的核心概念，例如<strong>Action</strong>, <strong>Lifecycle Nodes</strong>, <strong>Executors</strong>和<strong>Components</strong>。</p>
<span id="more"></span>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">Ubuntu</span> <span class="number">22</span>.<span class="number">04</span></span><br><span class="line"><span class="attribute">ROS2</span> Humble</span><br></pre></td></tr></tbody></table></figure>
<h2 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h2><p><strong>Actions</strong>服务于执行时间较长的人物，同样以<strong>client/server</strong>的模式运行，执行过程中可以取消，也可以发送反馈信息。<br>通常是由三个<strong>Services</strong>和两个<strong>Topic</strong>组成。</p>
<ul>
<li>Services<ul>
<li>Send Goal</li>
<li>Cancel Goal Request</li>
<li>Request Result</li>
</ul>
</li>
<li>Topics<ul>
<li>Feedback</li>
<li>Goal status<br><strong>Actions</strong>可以有多个<strong>Clients</strong>，同一个<strong>Client</strong>也可发送多个<strong>Goal</strong>。</li>
</ul>
</li>
</ul>
<h3 id="定义Action"><a href="#定义Action" class="headerlink" title="定义Action"></a>定义Action</h3><h4 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> unittest <span class="keyword">import</span> result</span><br><span class="line"><span class="keyword">import</span> rclpy</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> rclpy.node <span class="keyword">import</span> Node</span><br><span class="line"><span class="keyword">from</span> rclpy.action <span class="keyword">import</span> ActionServer</span><br><span class="line"><span class="keyword">from</span> rclpy.action.server <span class="keyword">import</span> ServerGoalHandle</span><br><span class="line"><span class="keyword">from</span> my_robot_interfaces.action <span class="keyword">import</span> CountUntil</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CountUntilServerNode</span>(<span class="title class_ inherited__">Node</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(<span class="string">"count_until_server"</span>)</span><br><span class="line">        self.count_until_server_ = ActionServer(self, CountUntil, <span class="string">"count_until"</span>, execute_callback=self.execute_callback)</span><br><span class="line">        self.get_logger().info(<span class="string">"Action server has been started."</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">execute_callback</span>(<span class="params">self, goal_handle: ServerGoalHandle</span>):</span><br><span class="line">        <span class="comment"># Get request from goal</span></span><br><span class="line">        target_number = goal_handle.request.target_number</span><br><span class="line">        period = goal_handle.request.period</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Execute the action</span></span><br><span class="line">        self.get_logger().info(<span class="string">"Executing the goal"</span>)</span><br><span class="line">        counter = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(target_number):</span><br><span class="line">            counter += <span class="number">1</span></span><br><span class="line">            self.get_logger().info(<span class="string">"counter = "</span> + <span class="built_in">str</span>(counter))</span><br><span class="line">            time.sleep(period)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Once done, set goal final state</span></span><br><span class="line">        goal_handle.succeed()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># and send the result</span></span><br><span class="line">        result = CountUntil.Result()</span><br><span class="line">        result.reached_number = counter</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">args=<span class="literal">None</span></span>):</span><br><span class="line">    rclpy.init(args=args)</span><br><span class="line">    node = CountUntilServerNode()</span><br><span class="line">    rclpy.spin(node)</span><br><span class="line">    rclpy.shutdown()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure>
<p>使用<strong>ActionServer</strong>创建server, 指定类型、名称和回调函数。类型定义了Action数据传输的数据类型，名称为唯一的辨识符，回调函数则定义了server收到goal之后的处理逻辑。<br>回调函数的处理逻辑包含三部分，1. 处理goal中的request参数，2. 执行action， 3. 返回执行结果。</p>
<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">from</span> cgitb <span class="keyword">import</span> reset</span><br><span class="line"><span class="keyword">import</span> rclpy</span><br><span class="line"><span class="keyword">from</span> rclpy.node <span class="keyword">import</span> Node</span><br><span class="line"><span class="keyword">from</span> rclpy.action <span class="keyword">import</span> ActionClient</span><br><span class="line"><span class="keyword">from</span> rclpy.action.server <span class="keyword">import</span> ServerGoalHandle</span><br><span class="line"><span class="keyword">from</span> rclpy.action.client <span class="keyword">import</span> ClientGoalHandle</span><br><span class="line"><span class="keyword">from</span> my_robot_interfaces.action <span class="keyword">import</span> CountUntil</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CountUntilClientNode</span>(<span class="title class_ inherited__">Node</span>): <span class="comment"># MODIFY NAME</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(<span class="string">"count_until_client"</span>) <span class="comment"># MODIFY NAME</span></span><br><span class="line">        self.count_until_client_ = ActionClient(self, CountUntil, <span class="string">"count_until"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send_goal</span>(<span class="params">self, target_number, period</span>):</span><br><span class="line">        <span class="comment"># Wait for the server</span></span><br><span class="line">        self.count_until_client_.wait_for_server()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create a goal</span></span><br><span class="line">        goal = CountUntil.Goal()</span><br><span class="line">        goal.target_number = target_number</span><br><span class="line">        goal.period = period</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Send the goal</span></span><br><span class="line">        self.get_logger().info(<span class="string">"Sending goal"</span>)</span><br><span class="line">        future = self.count_until_client_.send_goal_async(goal=goal)</span><br><span class="line">        future.add_done_callback(self.goal_response_callback)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">goal_response_callback</span>(<span class="params">self, future</span>):</span><br><span class="line">        self.goal_handle_: ClientGoalHandle = future.result()</span><br><span class="line">        <span class="keyword">if</span> self.goal_handle_.accepted:</span><br><span class="line">                self.goal_handle_.get_result_async().add_done_callback(self.goal_result_callback)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">goal_result_callback</span>(<span class="params">self, future</span>):</span><br><span class="line">         result = future.result().result</span><br><span class="line">         self.get_logger().info(<span class="string">"Result: "</span> + <span class="built_in">str</span>(result.reached_number))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">args=<span class="literal">None</span></span>):</span><br><span class="line">    rclpy.init(args=args)</span><br><span class="line">    node = CountUntilClientNode()</span><br><span class="line">    node.send_goal(<span class="number">6</span>, <span class="number">1.0</span>)</span><br><span class="line">    rclpy.spin(node)</span><br><span class="line">    rclpy.shutdown()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure>
<p>使用<strong>ActionClient</strong>定义client, 主要包括类型，名称。发送goal的步骤是等待server就位，然后创建goal，赋值request参数，然后异步发送goal。异步发送接口会返回future对象，用来表明是未来才能执行完的。可是通过<strong>add_done_callback</strong>添加回调函数。回调函数有两层，第一层是server接收到goal之后accept/reject结果回调，第二层是accept之后，action执行结果的回调。</p>
<h4 id="Accept-x2F-Reject"><a href="#Accept-x2F-Reject" class="headerlink" title="Accept/Reject"></a>Accept/Reject</h4><figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">self.count_until_server_ = <span class="constructor">ActionServer(<span class="params">self</span>, CountUntil, <span class="string">"count_until"</span>, <span class="params">goal_callback</span>=<span class="params">self</span>.<span class="params">goal_callback</span>, <span class="params">execute_callback</span>=<span class="params">self</span>.<span class="params">execute_callback</span>)</span></span><br><span class="line">def goal<span class="constructor">_callback(<span class="params">self</span>, <span class="params">goal_request</span>: CountUntil.Goal)</span>:</span><br><span class="line">    self.get<span class="constructor">_logger()</span>.info(<span class="string">"Received a goal"</span>)</span><br><span class="line">    # Validate the goal request</span><br><span class="line">    <span class="keyword">if</span> goal_request.target_number &lt;= <span class="number">0</span>:</span><br><span class="line">        self.get<span class="constructor">_logger()</span>.info(<span class="string">"Rejecting the goal"</span>)</span><br><span class="line">        return GoalResponse.REJECT</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.get<span class="constructor">_logger()</span>.info(<span class="string">"Accepting the goal"</span>)</span><br><span class="line">        return GoalResponse.ACCEPT</span><br></pre></td></tr></tbody></table></figure>
<p>在定义server的时候，添加<strong>goal_callback</strong>来根据request参数处理accept和reject参数的情况。</p>
<h4 id="Goal-State-Machine"><a href="#Goal-State-Machine" class="headerlink" title="Goal State Machine"></a>Goal State Machine</h4><p>状态机是针对goal的，而不是针对client和server的。</p>
<h5 id="Goal"><a href="#Goal" class="headerlink" title="Goal"></a>Goal</h5><ul>
<li>Accepted<ul>
<li>Executing<ul>
<li>Succeed</li>
<li>Aborted</li>
</ul>
</li>
<li>Cancelled<ul>
<li>Succeed</li>
<li>Aborted</li>
<li>Cancelled</li>
</ul>
</li>
</ul>
</li>
<li>Rejected</li>
</ul>
<h4 id="Set-Goal-Result"><a href="#Set-Goal-Result" class="headerlink" title="Set Goal Result"></a>Set Goal Result</h4><ul>
<li>Server<figure class="highlight nix"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Once done, set goal final state</span></span><br><span class="line"><span class="comment"># goal_handle.succeed()</span></span><br><span class="line">goal_handle.<span class="built_in">abort</span>()</span><br></pre></td></tr></tbody></table></figure></li>
<li>Client<figure class="highlight scss"><table><tbody><tr><td class="code"><pre><span class="line">def <span class="built_in">goal_result_callback</span>(self, future):</span><br><span class="line">    status = future.<span class="built_in">result</span>().status</span><br><span class="line">    result = future.<span class="built_in">result</span>().result</span><br><span class="line">    if status == GoalStatus.STATUS_SUCCEEDED:</span><br><span class="line">        self.<span class="built_in">get_logger</span>().<span class="built_in">info</span>(<span class="string">"Goal succeeded."</span>)</span><br><span class="line">    elif status == GoalStatus.STATUS_ABORTED:</span><br><span class="line">        self.<span class="built_in">get_logger</span>().<span class="built_in">info</span>(<span class="string">"Goal aborted."</span>)</span><br><span class="line">    self.<span class="built_in">get_logger</span>().<span class="built_in">info</span>(<span class="string">"Result: "</span> + <span class="built_in">str</span>(result.reached_number))</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h4 id="Send-Goal-Feedback"><a href="#Send-Goal-Feedback" class="headerlink" title="Send Goal Feedback"></a>Send Goal Feedback</h4><ul>
<li>Server<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">execute_callback</span>(<span class="params">self, goal_handle: ServerGoalHandle</span>):</span><br><span class="line">    <span class="comment"># Get request from goal</span></span><br><span class="line">    target_number = goal_handle.request.target_number</span><br><span class="line">    period = goal_handle.request.period</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Execute the action</span></span><br><span class="line">    self.get_logger().info(<span class="string">"Executing the goal"</span>)</span><br><span class="line">    feedback = CountUntil.Feedback()</span><br><span class="line">    counter = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(target_number):</span><br><span class="line">        counter += <span class="number">1</span></span><br><span class="line">        self.get_logger().info(<span class="string">"counter = "</span> + <span class="built_in">str</span>(counter))</span><br><span class="line">        feedback.current_number = counter</span><br><span class="line">        goal_handle.publish_feedback(feedback=feedback)</span><br><span class="line">        time.sleep(period)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Once done, set goal final state</span></span><br><span class="line">    <span class="comment"># goal_handle.succeed()</span></span><br><span class="line">    goal_handle.abort()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># and send the result</span></span><br><span class="line">    result = CountUntil.Result()</span><br><span class="line">    result.reached_number = counter</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></tbody></table></figure></li>
<li>Client<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">future = self.count_until_client_.send<span class="constructor">_goal_async(<span class="params">goal</span>=<span class="params">goal</span>, <span class="params">feedback_callback</span>=<span class="params">self</span>.<span class="params">goal_feedback_callback</span>)</span></span><br><span class="line">def goal<span class="constructor">_feedback_callback(<span class="params">self</span>, <span class="params">feedback_msg</span>)</span>:</span><br><span class="line">    number = feedback_msg.feedback.current_number</span><br><span class="line">    self.get<span class="constructor">_logger()</span>.info(<span class="string">"Got feedback: "</span> + str(number))</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h4 id="Cancel-Goal"><a href="#Cancel-Goal" class="headerlink" title="Cancel Goal"></a>Cancel Goal</h4><ul>
<li>Server<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">self.count_until_server_ = <span class="constructor">ActionServer(<span class="params">self</span>, CountUntil, <span class="string">"count_until"</span>, <span class="params">goal_callback</span>=<span class="params">self</span>.<span class="params">goal_callback</span>, <span class="params">cancel_callback</span>=<span class="params">self</span>.<span class="params">cancel_callback</span>, <span class="params">execute_callback</span>=<span class="params">self</span>.<span class="params">execute_callback</span>, <span class="params">callback_group</span>=ReentrantCallbackGroup()</span>)</span><br><span class="line"></span><br><span class="line">def cancel<span class="constructor">_callback(<span class="params">self</span>, <span class="params">goal_handle</span>: ServerGoalHandle)</span>:</span><br><span class="line">    self.get<span class="constructor">_logger()</span>.info(<span class="string">"Received a cancel request."</span>)</span><br><span class="line">    return CancelResponse.ACCEPT # <span class="keyword">or</span> REJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(target_number):</span><br><span class="line"><span class="keyword">if</span> goal_handle.is_cancel_requested:</span><br><span class="line">    self.get<span class="constructor">_logger()</span>.info(<span class="string">"Canceling the goal"</span>)</span><br><span class="line">    goal_handle.canceled<span class="literal">()</span></span><br><span class="line">    result.reached_number = counter</span><br><span class="line">    return result</span><br></pre></td></tr></tbody></table></figure></li>
<li>Client<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable language_">self</span>.timer_ = <span class="variable language_">self</span>.create_timer(<span class="number">2.0</span>, <span class="variable language_">self</span>.cancel_goal)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cancel_goal</span>(<span class="params"><span class="variable language_">self</span></span>):</span><br><span class="line">    <span class="variable language_">self</span>.get_logger().info(<span class="string">"Send a cancel request"</span>)</span><br><span class="line">    <span class="variable language_">self</span>.goal_handle_.cancel_goal_async()</span><br><span class="line">    <span class="variable language_">self</span>.timer_.cancel()</span><br></pre></td></tr></tbody></table></figure></li>
<li>多线程</li>
</ul>
<h2 id="Lifecycle-Nodes"><a href="#Lifecycle-Nodes" class="headerlink" title="Lifecycle Nodes"></a>Lifecycle Nodes</h2><p>四种种状态： unconfigured, inactive, active, finalized<br>五种转换： on_configure, on_activate, on_deactivate, on_cleanup，on_shutdown<br>存在的意义：</p>
<ul>
<li>适用于硬件通信</li>
<li>重新配置更容易</li>
<li>按照顺序初始化</li>
<li>提前分配资源和内存</li>
<li>多节点之前同步初始化</li>
</ul>
<p><strong>Lifecycle Node</strong>在<strong>nav2</strong>和<strong>ros2_control</strong>中经常使用。</p>
<h3 id="实现Lifecycle-Node"><a href="#实现Lifecycle-Node" class="headerlink" title="实现Lifecycle Node"></a>实现Lifecycle Node</h3><h4 id="on-configure"><a href="#on-configure" class="headerlink" title="on_configure"></a>on_configure</h4><p>起到初始化的作用</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">on_configure</span>(<span class="params">self, previous_state: LifecycleState</span>):</span><br><span class="line">    self.get_logger().info(<span class="string">"In on_configure."</span>)</span><br><span class="line">    self.number_publisher_ = self.create_publisher(Int64, <span class="string">"number"</span>, <span class="number">10</span>)</span><br><span class="line">    self.number_timer_ = self.create_timer(</span><br><span class="line">        <span class="number">1.0</span> / self.publish_frequency_, self.publish_number)</span><br><span class="line">    self.get_logger().info(<span class="string">"Number publisher has been started."</span>)</span><br><span class="line">    <span class="keyword">return</span> TransitionCallbackReturn.SUCCESS</span><br></pre></td></tr></tbody></table></figure>
<h4 id="on-cleanup"><a href="#on-cleanup" class="headerlink" title="on_cleanup"></a>on_cleanup</h4><p>节点结束后，释放资源</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Destroy ROS2 communications , disconnect from HW</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_cleanup</span>(<span class="params"><span class="variable language_">self</span>, <span class="symbol">previous_state:</span> <span class="title class_">LifecycleState</span></span>):</span><br><span class="line">    <span class="variable language_">self</span>.get_logger().info(<span class="string">"In on_cleanup."</span>)</span><br><span class="line">    <span class="variable language_">self</span>.destroy_lifecycle_publisher(<span class="variable language_">self</span>.number_publisher_)</span><br><span class="line">    <span class="variable language_">self</span>.destroy_timer(<span class="variable language_">self</span>.number_timer_)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">TransitionCallbackReturn</span>.<span class="variable constant_">SUCCESS</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="on-activate"><a href="#on-activate" class="headerlink" title="on_activate"></a>on_activate</h4><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Activate/Enable HW</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_activate</span>(<span class="params"><span class="variable language_">self</span>, <span class="symbol">previous_state:</span> <span class="title class_">LifecycleState</span></span>):</span><br><span class="line">    <span class="variable language_">self</span>.get_logger().info(<span class="string">"In on_activate."</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">super</span>().on_activate(previous_state)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="on-deactivate"><a href="#on-deactivate" class="headerlink" title="on_deactivate"></a>on_deactivate</h4><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Deactivate/Disable HW</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_deactivate</span>(<span class="params"><span class="variable language_">self</span>, <span class="symbol">previous_state:</span> <span class="title class_">LifecycleState</span></span>):</span><br><span class="line">    <span class="variable language_">self</span>.get_logger().info(<span class="string">"In on_deactivate."</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">super</span>().on_deactivate(previous_state)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="on-shutdown"><a href="#on-shutdown" class="headerlink" title="on_shutdown"></a>on_shutdown</h4><figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">def on<span class="constructor">_shutdown(<span class="params">self</span>, <span class="params">previous_state</span>: LifecycleState)</span>:</span><br><span class="line">    self.get<span class="constructor">_logger()</span>.info(<span class="string">"In on_shutdown."</span>)</span><br><span class="line">    self.destroy<span class="constructor">_lifecycle_publisher(<span class="params">self</span>.<span class="params">number_publisher_</span>)</span></span><br><span class="line">    self.destroy<span class="constructor">_timer(<span class="params">self</span>.<span class="params">number_timer_</span>)</span></span><br><span class="line">    return TransitionCallbackReturn.SUCCESS</span><br></pre></td></tr></tbody></table></figure>
<h4 id="on-error"><a href="#on-error" class="headerlink" title="on_error"></a>on_error</h4><figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># Process errors, deactivate + cleanup</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_error</span>(<span class="params"><span class="variable language_">self</span>, <span class="symbol">previous_state:</span> <span class="title class_">LifecycleState</span></span>):</span><br><span class="line">    <span class="variable language_">self</span>.get_logger().info(<span class="string">"In on_error."</span>)</span><br><span class="line">    <span class="variable language_">self</span>.destroy_lifecycle_publisher(<span class="variable language_">self</span>.number_publisher_)</span><br><span class="line">    <span class="variable language_">self</span>.destroy_timer(<span class="variable language_">self</span>.number_timer_)</span><br><span class="line">    <span class="comment"># do some checks, if ok then return SUCCESS, if not FAILURE</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">TransitionCallbackReturn</span>.<span class="variable constant_">FAILURE</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="使用Lifecycle-Node"><a href="#使用Lifecycle-Node" class="headerlink" title="使用Lifecycle Node"></a>使用Lifecycle Node</h3><p>我们可是使用命令行控制<strong>Lifecycle Node</strong>的状态切换。</p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">ros2 lifecycle nodes <span class="comment">--查看所有lifecycle nodes</span></span><br><span class="line">ros2 lifecycle <span class="built_in">list</span> /number_publisher <span class="comment">--查看指定lifecycle node可以接受的命令</span></span><br><span class="line">ros2 lifecycle <span class="keyword">set</span> /number_publisher configure/<span class="built_in">activate</span>/deactivate/cleanup/shutdown <span class="comment">--设置指定lifecycle node的状态</span></span><br><span class="line">ros2 lifecycle <span class="keyword">get</span> /number_publisher <span class="comment">--查看指定lifecycle的状态</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>Lifecycle Node</strong>的接口都是<strong>service</strong>，所以可以使用<strong>service client</strong>访问。</p>
<h2 id="Executors"><a href="#Executors" class="headerlink" title="Executors"></a>Executors</h2><p><strong>Executors</strong>用于阻塞程序，等待程序的执行,分为<strong>SingleThreadExecutor</strong>和<strong>MultiThreadExecutor</strong>。<br><strong>rclpy.spin()<strong>默认调用的是</strong>SingleThreadExecutor</strong>。<br><strong>MultiThreadExecutor</strong>需要提供<strong>callback_groups</strong>。</p>
<ul>
<li>ReentrantCallbackGroup<br>真正的多线程，可以重新进入，无需等待callback执行完成</li>
<li>MutuallyExclusiveCallbackGroup<br>单线程，需要等待callback执行完成才能再进入</li>
</ul>
<h2 id="Components"><a href="#Components" class="headerlink" title="Components"></a>Components</h2><p>在一个可执行文件中，可以启动多个节点，</p>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>ROS</category>
      </categories>
      <tags>
        <tag>ROS</tag>
        <tag>Advanced Concepts</tag>
      </tags>
  </entry>
  <entry>
    <title>Config Frp Client And Auto-Start As A Service</title>
    <url>/2024/02/02/Config-Frp-Client-And-Auto-Start-As-A-Service/</url>
    <content><![CDATA[<html><head></head><body><p><strong>Frp</strong>是一个搭建隧道实现内网穿透的常用工具，在之前的<a href="https://youngsonzhao.github.io/2023/02/15/Expose-Local-Devices-Behind-A-NAT-To-The-Internet-Using-FRP/">笔记</a>中我们已经讲了如何在服务器配置<strong>frps</strong>和在路由器配置<strong>frpc</strong>。今天主要记录一下如何在<strong>Ubuntu 22.04</strong>系统上配置<strong>frpc</strong>，实现<strong>ssh</strong>远程登陆访问。</p>
<span id="more"></span>
<h3 id="Download"><a href="#Download" class="headerlink" title="Download"></a>Download</h3><p><a href="https://github.com/fatedier/frp">Frp</a>代码托管在github上，我们可以到<a href="https://github.com/fatedier/frp/releases">release</a>下载对应操作系统版本的最新包。</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">wget https:<span class="regexp">//gi</span>thub.com<span class="regexp">/fatedier/</span>frp<span class="regexp">/releases/</span>download<span class="regexp">/v0.54.0/</span>frp_0.<span class="number">54.0</span>_linux_amd64.tar.gz</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><p>下载好的包是已经编译好的可执行文件，我们只需要将其放置在指定文件夹下即可.</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">mkdir</span> .frp</span><br><span class="line"><span class="attribute">cd</span> .frp</span><br><span class="line"><span class="attribute">tar</span> -xzf frp_0.<span class="number">54</span>.<span class="number">0</span>_linux_amd64.tar.gz</span><br><span class="line"><span class="attribute">cd</span> frp_0.<span class="number">54</span>.<span class="number">0</span>_linux_amd64</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h3><p>配置客户端需要创建一个<strong>frpc.ini</strong>的配置文件，在配置中首先配置<strong>frps</strong>的ip地址，端口号和token，然后配置本地的端口号和服务端的转发端口即可。</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">server_addr</span> = <span class="number">192.168</span>.<span class="number">1.1</span></span><br><span class="line"><span class="attr">server_port</span> = <span class="number">1234</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for authentication</span></span><br><span class="line"><span class="attr">token</span> = <span class="number">12345678</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ssh]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">22</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">2222</span></span><br></pre></td></tr></tbody></table></figure>
<p>由于需要ssh登陆，所以本地端口为22，服务端端口为2222。</p>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>将<strong>frpc</strong>设置为服务的形式，可以保证开启自启动。<br>首先进入到目录内。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/systemd/system</span><br><span class="line">sudo <span class="built_in">touch</span> frpc.service</span><br><span class="line">sudo gedit frpc.service</span><br></pre></td></tr></tbody></table></figure>
<p>然后配置服务。</p>
<figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=My Frp Client Service - %i</span><br><span class="line"><span class="attr">After</span>=network.target syslog.target</span><br><span class="line"><span class="attr">Wants</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">5</span>s</span><br><span class="line"><span class="attr">ExecStart</span>=/bin/bash -c <span class="string">'/home/robot/.frp/frp_0.54.0_linux_amd64/frpc -c /home/robot/.frp/frp_0.54.0_linux_amd64/frpc.ini'</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></tbody></table></figure>
<p>最后运行服务。</p>
<figure class="highlight nsis"><table><tbody><tr><td class="code"><pre><span class="line">sudo <span class="params">system</span>ctl enable frpc.service</span><br><span class="line">sudo <span class="params">system</span>ctl start frpc.service</span><br><span class="line">sudo <span class="params">system</span>ctl status frpc.service</span><br></pre></td></tr></tbody></table></figure>
<h3 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h3><p>Ubuntu 22.04默认ssh连接是关闭的，需要打开端口，开启ssh连接。<br>首先明确指明ssh连接的端口为22。</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">sudo vi <span class="regexp">/etc/</span>ssh/ssh_config</span><br><span class="line">port <span class="number">22</span></span><br></pre></td></tr></tbody></table></figure>
<p>然后开启22端口。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install openssh-server</span><br><span class="line">ufw <span class="built_in">enable</span></span><br><span class="line">sudo ufw <span class="built_in">enable</span></span><br><span class="line">sudo ufw allow 22/tcp</span><br></pre></td></tr></tbody></table></figure>
<p>上述配置完成后，在任意终端，通过ssh指令登陆即可。</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">ssh</span> robot@<span class="number">192.168.1.2</span> -p <span class="number">2222</span></span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Ubuntu</category>
        <category>Frp</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>SSH</tag>
        <tag>Frp</tag>
      </tags>
  </entry>
  <entry>
    <title>ROS2 Learning Notes - Moveit</title>
    <url>/2024/02/03/ROS2-Learning-Notes-Moveit/</url>
    <content><![CDATA[<html><head></head><body><p><a href="https://moveit.ros.org/">MoveIt</a>是机器人运动规划与控制的重要开源包，本文主要讲解<strong>MoveIt</strong>的使用步骤和经验。</p>
<span id="more"></span>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-joint-trajectory-controller</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-forward-command-controller</span><br><span class="line">sudo apt-<span class="built_in">get</span> install ros-humble-joint-state-broadcaster</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>ROS</category>
      </categories>
      <tags>
        <tag>Tutorials</tag>
        <tag>ROS</tag>
        <tag>Moveit</tag>
      </tags>
  </entry>
  <entry>
    <title>ROS2 Learning Notes URDF &amp; Xacro</title>
    <url>/2024/01/21/ROS2-Learning-Notes-URDF-Xacro/</url>
    <content><![CDATA[<html><head></head><body><p><strong>URDF</strong>是“<strong>Unified Robot Description Format</strong>”的缩写，在<strong>ROS</strong>中用于定义机器人，格式为<strong>xml</strong>。<a href="http://wiki.ros.org/xacro">xacro</a>是”<strong>XML Macros</strong>“的缩写，可以扩展<strong>xml</strong>语言，通过定义变量、函数，引入文件的形式提升代码的可读性。本文主要讲解<strong>urdf</strong>和<strong>xacro</strong>的基本用法。</p>
<span id="more"></span>
<h2 id="URDF"><a href="#URDF" class="headerlink" title="URDF"></a>URDF</h2><h3 id="URDF的基本结构"><a href="#URDF的基本结构" class="headerlink" title="URDF的基本结构"></a>URDF的基本结构</h3><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">robot</span> <span class="attr">xmlns:xacro</span>=<span class="string">"http://www.ros.org/wiki/xacro"</span> <span class="attr">name</span>=<span class="string">"arduinobot"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"world"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"base_link"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/basement.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.5 -0.5 0"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collision</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/basement.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.5 -0.5 0"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collision</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xacro:default_inertial</span> <span class="attr">mass</span>=<span class="string">"1.0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"virtual_joint"</span> <span class="attr">type</span>=<span class="string">"fixed"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">parent</span> <span class="attr">link</span>=<span class="string">"world"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">child</span> <span class="attr">link</span>=<span class="string">"base_link"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 0"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">robot</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>开头的第一句声明<strong>xml</strong>文件的版本和编码格式。<br>最顶层的标签是<strong>robot</strong>，需要指明两个属性，一个是<strong>name</strong>，另外一个是<strong>xmlns:xacro</strong>。使用<strong>xacro</strong>，我们可以很方便地定义变量、函数，引入文件，提升xml文件的可读性和可扩展性。<br>里面的内容包含<strong>link</strong>，<strong>joint</strong>等模块，为机器人的具体定义。</p>
<h3 id="Link"><a href="#Link" class="headerlink" title="Link"></a>Link</h3><p><strong>Link</strong>定义基本的刚体结构，主要包括三部分内容： <strong>visual</strong>,<strong>collision</strong>和<strong>inertial</strong>三部分。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">name</span>=<span class="string">"base_link"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">visual</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collision</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collision</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">inertial</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">inertial</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="visual"><a href="#visual" class="headerlink" title="visual"></a>visual</h4><p><strong>visual</strong>标签主要用于定义刚体的几何形状，用于在<strong>rviz2</strong>中可视化。几何形状可以是简单的几何体，例如<strong>box</strong>, <strong>sphere</strong>和<strong>cylinder</strong>，也可以是负责的几何形状，通过<strong>mesh</strong>标签，引入<strong>STL</strong>文件。</p>
<h5 id="box"><a href="#box" class="headerlink" title="box"></a>box</h5><figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">box</span> <span class="attr">size</span>=<span class="string">"$</span></span></span><span class="template-variable">{arm_base_length}</span><span class="language-xml"><span class="tag"><span class="string"> $</span></span></span><span class="template-variable">{arm_base_width}</span><span class="language-xml"><span class="tag"><span class="string"> $</span></span></span><span class="template-variable">{arm_base_height}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 $</span></span></span><span class="template-variable">{arm_base_height/2.0}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">material</span> <span class="attr">name</span>=<span class="string">"orange"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="cylinder"><a href="#cylinder" class="headerlink" title="cylinder"></a>cylinder</h5><figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">cylinder</span> <span class="attr">radius</span>=<span class="string">"$</span></span></span><span class="template-variable">{forearm_radius}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">length</span>=<span class="string">"$</span></span></span><span class="template-variable">{forearm_length}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 $</span></span></span><span class="template-variable">{forearm_length/2.0}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">material</span> <span class="attr">name</span>=<span class="string">"yellow"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="sphere"><a href="#sphere" class="headerlink" title="sphere"></a>sphere</h5><figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">visual</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">sphere</span> <span class="attr">radius</span>=<span class="string">"$</span></span></span><span class="template-variable">{wheel_radius/2.0}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"0 0 0"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">material</span> <span class="attr">name</span>=<span class="string">"blue"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<h5 id="mesh"><a href="#mesh" class="headerlink" title="mesh"></a>mesh</h5><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">visual</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">geometry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mesh</span> <span class="attr">filename</span>=<span class="string">"package://robot_description/meshes/basement.STL"</span> <span class="attr">scale</span>=<span class="string">"0.01 0.01 0.01"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">geometry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">origin</span> <span class="attr">xyz</span>=<span class="string">"-0.5 -0.5 0"</span> <span class="attr">rpy</span>=<span class="string">"0 0 0"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">visual</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure>
<p>可视化部分除了定义几何形状，还需要指明坐标系。默认的坐标系为几何中心，通过<strong>origin</strong>标签去定义坐标系与默认坐标系的关系，<strong>xyz</strong>指明两个坐标系之间的平移关系，<strong>rpy</strong>指明两个坐标系之间的旋转关系。</p>
<h4 id="collision"><a href="#collision" class="headerlink" title="collision"></a>collision</h4><p><strong>collision</strong>标签主要用于定义碰撞检测的范围，在<strong>gazebo</strong>仿真中使用。其定义内容一般与<strong>visual</strong>部分相同，也可以使用简单的几何体代替复杂形状，以提升碰撞检测的性能。</p>
<h4 id="inertial"><a href="#inertial" class="headerlink" title="inertial"></a>inertial</h4><p><strong>inertial</strong>标签主要用于定义刚体的转动惯量，在<strong>gazebo</strong>仿真中用于运动建模。几何体的转动惯量由其质量分布和几何形状共同决定，计算复杂。对于质量分布均匀的简单几何体，其转动惯量有具体的公式表达。一般使用<strong>xacro:macro</strong>定义函数实现，具体可以参见后面章节。</p>
<h3 id="Joint"><a href="#Joint" class="headerlink" title="Joint"></a>Joint</h3><p>关节主要定义两个<strong>link</strong>之间的坐标系相对位置关系和相对运动关系。</p>
<figure class="highlight abnf"><table><tbody><tr><td class="code"><pre><span class="line">&lt;joint name<span class="operator">=</span><span class="string">"joint_4"</span> type<span class="operator">=</span><span class="string">"revolute"</span>&gt;</span><br><span class="line">    &lt;parent link<span class="operator">=</span><span class="string">"claw_support"</span>/&gt;</span><br><span class="line">    &lt;child link<span class="operator">=</span><span class="string">"gripper_right"</span>/&gt;</span><br><span class="line">    &lt;origin xyz<span class="operator">=</span><span class="string">"-0.04 0.13 -0.1"</span> rpy<span class="operator">=</span><span class="string">"0 0 0"</span>/&gt;</span><br><span class="line">    &lt;axis xyz<span class="operator">=</span><span class="string">"0 0 1"</span>/&gt;</span><br><span class="line">    &lt;limit lower<span class="operator">=</span><span class="string">"-${pi/2}"</span> upper<span class="operator">=</span><span class="string">"0"</span> effort<span class="operator">=</span><span class="string">"${effort}"</span> velocity<span class="operator">=</span><span class="string">"${velocity}"</span>/&gt;</span><br><span class="line">&lt;/joint&gt;</span><br></pre></td></tr></tbody></table></figure>
<p>其中<strong>parent</strong>和<strong>child</strong>分别指明了两个<strong>link</strong>，子link要在父link中运动。<strong>type</strong>指明了运动关系，包括固定式的<strong>fixed</strong>，关节旋转式的<strong>revolute</strong>等等。</p>
<h4 id="fixed"><a href="#fixed" class="headerlink" title="fixed"></a>fixed</h4><h4 id="revolute"><a href="#revolute" class="headerlink" title="revolute"></a>revolute</h4><h2 id="Xacro"><a href="#Xacro" class="headerlink" title="Xacro"></a>Xacro</h2><h3 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h3><figure class="highlight dust"><table><tbody><tr><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">xacro:property</span> <span class="attr">name</span>=<span class="string">"effort"</span> <span class="attr">value</span>=<span class="string">"30.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">xacro:property</span> <span class="attr">name</span>=<span class="string">"velocity"</span> <span class="attr">value</span>=<span class="string">"10.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">xacro:macro</span> <span class="attr">name</span>=<span class="string">"default_inertial"</span> <span class="attr">params</span>=<span class="string">"mass"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">mass</span> <span class="attr">value</span>=<span class="string">"$</span></span></span><span class="template-variable">{mass}</span><span class="language-xml"><span class="tag"><span class="string">"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">inertia</span> <span class="attr">ixx</span>=<span class="string">"1.0"</span> <span class="attr">ixy</span>=<span class="string">"0.0"</span> <span class="attr">ixz</span>=<span class="string">"0.0"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">iyy</span>=<span class="string">"1.0"</span> <span class="attr">iyz</span>=<span class="string">"0.0"</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">izz</span>=<span class="string">"1.0"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">inertial</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">xacro:macro</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">xacro:macro</span> <span class="attr">name</span>=<span class="string">"default_transmission"</span> <span class="attr">params</span>=<span class="string">"number"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">transmission</span> <span class="attr">name</span>=<span class="string">"transmission_$</span></span></span><span class="template-variable">{number}</span><span class="language-xml"><span class="tag"><span class="string">"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>transmission_interface/SimpleTransmission<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">actuator</span> <span class="attr">name</span>=<span class="string">"motor_$</span></span></span><span class="template-variable">{number}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">role</span>=<span class="string">"actuator1"</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">joint</span> <span class="attr">name</span>=<span class="string">"joint_$</span></span></span><span class="template-variable">{number}</span><span class="language-xml"><span class="tag"><span class="string">"</span> <span class="attr">role</span>=<span class="string">"joint1"</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">mechanical_reduction</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">mechanical_reduction</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">joint</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">transmission</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">xacro:macro</span>&gt;</span></span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="定义函数"><a href="#定义函数" class="headerlink" title="定义函数"></a>定义函数</h3><figure class="highlight clean"><table><tbody><tr><td class="code"><pre><span class="line">```</span><br><span class="line">### 引入文件</span><br></pre></td></tr></tbody></table></figure>
<p>&lt;xacro:include filename=”$(find robot_description)/urdf/robot_gazebo.xacro”/&gt;<br>&lt;xacro:include filename=”$(find robot_description)/urdf/robot_ros2_control.xacro”/&gt;</p>
<p>```<br>    <link name="base_plate"><br>        <visual><br>            <geometry><br>                <mesh filename="package://robot_description/meshes/base_plate.STL" scale="0.01 0.01 0.01"><br>            </mesh></geometry><br>            <origin rpy="0 0 0" xyz="-0.39 -0.39 -0.56"><br>        </origin></visual><br>        <collision><br>            <geometry><br>                <mesh filename="package://robot_description/meshes/base_plate.STL" scale="0.01 0.01 0.01"><br>            </mesh></geometry><br>            <origin rpy="0 0 0" xyz="-0.39 -0.39 -0.56"><br>        </origin></collision><br>        &lt;xacro:default_inertial mass=”1.0”/&gt;<br>    <br>    <joint name="joint_1" type="revolute"><br>        <parent link="base_link"><br>        <child link="base_plate"><br>        <axis xyz="0 0 1"><br>        <origin rpy="0 0 0" xyz="0 0 0.307"><br>        <limit lower="-${pi/2}" upper="${pi/2}" effort="${effort}" velocity="${velocity}"><br>    </limit></origin></axis></child></parent></joint></p>
<pre><code>&lt;link name="forward_drive_arm"&gt;
    &lt;visual&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/forward_drive_arm.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin rpy="0 -${pi/2} ${pi/2}" xyz="0.19 0.06 -0.08"/&gt;
    &lt;/visual&gt;
    &lt;collision&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/forward_drive_arm.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin rpy="0 -${pi/2} ${pi/2}" xyz="0.19 0.06 -0.08"/&gt;
    &lt;/collision&gt;
    &lt;xacro:default_inertial mass="1.0"/&gt;
&lt;/link&gt;

&lt;joint name="joint_2" type="revolute"&gt;
    &lt;parent link="base_plate"/&gt;
    &lt;child link="forward_drive_arm"/&gt;
    &lt;axis xyz="1 0 0"/&gt;
    &lt;origin rpy="0 0 0" xyz="-0.02 0 0.35"/&gt;
    &lt;limit lower="-${pi/2}" upper="${pi/2}" effort="${effort}" velocity="${velocity}"/&gt;
&lt;/joint&gt;

&lt;link name="horizontal_arm"&gt;
    &lt;visual&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/horizontal_arm.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin rpy="${pi/2} 0 ${pi/2}" xyz="-0.03 -0.4 -0.06"/&gt;
    &lt;/visual&gt;
    &lt;collision&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/horizontal_arm.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin rpy="${pi/2} 0 ${pi/2}" xyz="-0.03 -0.4 -0.06"/&gt;

    &lt;/collision&gt;
    &lt;xacro:default_inertial mass="1.0"/&gt;
&lt;/link&gt;
&lt;joint name="joint_3" type="revolute"&gt;
    &lt;parent link="forward_drive_arm"/&gt;
    &lt;child link="horizontal_arm"/&gt;
    &lt;axis xyz="1 0 0"/&gt;
    &lt;origin rpy="0 0 0" xyz="0 0 0.8"/&gt;
    &lt;limit lower="-${pi/2}" upper="${pi/2}" effort="${effort}" velocity="${velocity}"/&gt;
&lt;/joint&gt;

&lt;link name="claw_support"&gt;
    &lt;visual&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/claw_support.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin rpy="0 0 ${pi/2}" xyz="0 -0.05 -0.15"/&gt;
    &lt;/visual&gt;
    &lt;collsion&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/claw_support.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin rpy="0 0 ${pi/2}" xyz="0 -0.05 -0.15"/&gt;
    &lt;/collsion&gt;
    &lt;xacro:default_inertial mass="0.05"/&gt;
&lt;/link&gt;
&lt;joint name="horizontal_arm_to_claw_support" type="fixed"&gt;
    &lt;parent link="horizontal_arm"/&gt;
    &lt;child link="claw_support"/&gt;
    &lt;origin rpy="0 0 0" xyz="0 0.82 0"/&gt;
&lt;/joint&gt;

&lt;link name="gripper_right"&gt;
    &lt;visual&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/right_finger.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin xyz="-0.1 0.5 -0.1" rpy="0 0 -${pi/2}"/&gt;
    &lt;/visual&gt;
    &lt;collision&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/right_finger.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin xyz="-0.1 0.5 -0.1" rpy="0 0 -${pi/2}"/&gt;
    &lt;/collision&gt;
    &lt;xacro:default_inertial mass="0.01"/&gt;
&lt;/link&gt;
&lt;link name="gripper_left"&gt;
    &lt;visual&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/left_finger.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin xyz="-0.04 0.5 -0.1" rpy="0 0 -${pi/2}"/&gt;
    &lt;/visual&gt;
    &lt;collision&gt;
        &lt;geometry&gt;
            &lt;mesh filename="package://robot_description/meshes/left_finger.STL" scale="0.01 0.01 0.01"/&gt;
        &lt;/geometry&gt;
        &lt;origin xyz="-0.04 0.5 -0.1" rpy="0 0 -${pi/2}"/&gt;
    &lt;/collision&gt;
    &lt;xacro:default_inertial mass="0.01"/&gt;
&lt;/link&gt;
&lt;joint name="joint_5" type="revolute"&gt;
    &lt;parent link="claw_support"/&gt;
    &lt;child link="gripper_left"/&gt;
    &lt;origin xyz="-0.22 0.13 -0.1" rpy="0 0 0"/&gt;
    &lt;axis xyz="0 0 1"/&gt;
    &lt;mimic joint="joint_4" multiplier="-1"/&gt;
    &lt;limit lower="0" upper="${pi/2}" effort="${effort}" velocity="${velocity}"/&gt;
&lt;/joint&gt;
&lt;xacro:default_transmission number="1"/&gt;
&lt;xacro:default_transmission number="2"/&gt;
&lt;xacro:default_transmission number="3"/&gt;
&lt;xacro:default_transmission number="4"/&gt;
</code></pre>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>ROS</category>
      </categories>
      <tags>
        <tag>ROS</tag>
        <tag>URDF</tag>
        <tag>Xacro</tag>
      </tags>
  </entry>
  <entry>
    <title>Using Python Virtual Environment</title>
    <url>/2024/02/21/Using-Python-Virtual-Environment/</url>
    <content><![CDATA[<html><head></head><body><p>在Python中使用虚拟环境可以将包安装在独立的环境中，既不会污染主环境，也不会相互影响。因此在跑测试环境的时候，推荐使用虚拟环境。本文主要介绍虚拟环境的使用方法。</p>
<span id="more"></span>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>使用以下指令安装虚拟环境：</p>
<figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> virtualenv</span><br><span class="line">sudo apt-get <span class="keyword">install</span> python3.<span class="number">10</span>-venv</span><br></pre></td></tr></tbody></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="初始化环境"><a href="#初始化环境" class="headerlink" title="初始化环境"></a>初始化环境</h4><p>安装成功后，使用以下指令可以创建一个虚拟环境。</p>
<figure class="highlight jboss-cli"><table><tbody><tr><td class="code"><pre><span class="line">python -m venv <span class="string">.venv</span></span><br></pre></td></tr></tbody></table></figure>
<p>所创建的虚拟环境目录为：**.venv**</p>
<h4 id="激活环境"><a href="#激活环境" class="headerlink" title="激活环境"></a>激活环境</h4><p>创建环境后，可以使用以下指令激活环境，让Python在虚拟环境中运行。</p>
<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">source</span> ~<span class="regexp">/.venv/</span>bin/active</span><br></pre></td></tr></tbody></table></figure>
<p>激活后，我们可以在虚拟环境中正常运行python代码以及使用pip安装包。</p>
<h4 id="失活环境"><a href="#失活环境" class="headerlink" title="失活环境"></a>失活环境</h4><figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">deactive</span></span><br></pre></td></tr></tbody></table></figure>


</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Tutorials</tag>
        <tag>Python</tag>
        <tag>Venv</tag>
      </tags>
  </entry>
  <entry>
    <title>Using Python Virtual Environment In Jupyter Notebook</title>
    <url>/2024/06/27/Using-Python-Virtual-Environment-In-Jupyter-Notebook/</url>
    <content><![CDATA[<html><head></head><body><p>介绍如何在<strong>Jupyter Notebook</strong>中使用Python的虚拟环境。</p>
<span id="more"></span>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">pip install --<span class="keyword">user</span> <span class="title">ipykernel</span> -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></tbody></table></figure>
<h3 id="添加虚拟环境"><a href="#添加虚拟环境" class="headerlink" title="添加虚拟环境"></a>添加虚拟环境</h3><p>创建python虚拟环境请参照<a href="https://youngsonzhao.github.io/2024/02/21/Using-Python-Virtual-Environment/">Using Python Virtual Environment</a><br>创建好虚拟环境后，可以使用一下命令在Jupyter中注册虚拟环境。</p>
<figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><span class="line">python -m ipykernel install --<span class="keyword">user</span> <span class="title">--name</span>=.sam</span><br></pre></td></tr></tbody></table></figure>
<h3 id="在Jupyter-Notebook中使用虚拟环境"><a href="#在Jupyter-Notebook中使用虚拟环境" class="headerlink" title="在Jupyter Notebook中使用虚拟环境"></a>在Jupyter Notebook中使用虚拟环境</h3><p>在<strong>Jupyter Notebook</strong>页面的左下角按钮，可以切换kernel，如下图所示：<br><img alt="切换kernel" data-src="/2024/06/27/Using-Python-Virtual-Environment-In-Jupyter-Notebook/ipykernel.png"></p>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Python</category>
        <category>Jupyter Notebook</category>
      </categories>
      <tags>
        <tag>Tutorials</tag>
        <tag>Python</tag>
        <tag>Jupyter Notebook</tag>
        <tag>Venv</tag>
      </tags>
  </entry>
  <entry>
    <title>Using Baidu Yun Python Client In Ubuntu Server</title>
    <url>/2024/06/28/Using-Baidu-Yun-Python-Client-In-Ubuntu-Server/</url>
    <content><![CDATA[<html><head></head><body><p>百度云盘为Ubuntu Server提供了一个Python客户端<strong>pyby</strong>，可以在服务器上上传和下载百度云盘里面的文件。</p>
<span id="more"></span>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight awk"><table><tbody><tr><td class="code"><pre><span class="line">pip install requests bypy -i https:<span class="regexp">//</span>pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></tbody></table></figure>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>运行以下指令会生成一个用于授权的链接，复制链接在浏览器中打开并登陆，则会生成授权码，按照提示复制到terminal中即可。</p>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">python</span> -m bypy <span class="literal">info</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>百度云盘会为<strong>bypy</strong>客户端单独生成一个文件夹，使用相关指令可以查看文件夹的信息、上传文件、下载文件等。</p>
<h4 id="查看百度云盘的空间"><a href="#查看百度云盘的空间" class="headerlink" title="查看百度云盘的空间"></a>查看百度云盘的空间</h4><figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">bypy</span> info</span><br><span class="line"><span class="attribute">Quota</span>: <span class="number">5</span>.<span class="number">005</span>TB</span><br><span class="line"><span class="attribute">Used</span>: <span class="number">2</span>.<span class="number">416</span>GB</span><br></pre></td></tr></tbody></table></figure>
<h4 id="查看百度云盘的列表"><a href="#查看百度云盘的列表" class="headerlink" title="查看百度云盘的列表"></a>查看百度云盘的列表</h4><figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">bypy list</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h4><figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">bypy -v upload <span class="built_in">file</span>.path /remote_dir</span><br></pre></td></tr></tbody></table></figure>
<h4 id="其他指令"><a href="#其他指令" class="headerlink" title="其他指令"></a>其他指令</h4><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="variable">$</span> bypy downdir k8s <span class="comment">#直接下载bypy目录下k8s</span></span><br><span class="line"><span class="variable">$</span> bypy syncup <span class="comment">#把当前目录同步到云盘</span></span><br><span class="line"><span class="variable">$</span> bypy syncdown <span class="comment">#把云盘内容同步到当前目录</span></span><br><span class="line"><span class="variable">$</span> bypy downdir / <span class="comment">#把云盘内容同步到当前目录</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$</span> bypy <span class="built_in">compare</span> <span class="comment">#比较本地当前目录和云盘（程序的）根目录</span></span><br><span class="line"><span class="variable">$</span> bypy <span class="literal">-v</span> <span class="comment">#运行时添加-v参数，会显示进度详情。</span></span><br><span class="line"><span class="variable">$</span> bypy <span class="literal">-d</span> <span class="comment">#运行时添加-d，会显示一些调试信息</span></span><br><span class="line"><span class="variable">$</span> bypy <span class="literal">-ddd</span> <span class="comment">#显示更多http通讯信息</span></span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Ubuntu</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>Tutorials</tag>
      </tags>
  </entry>
  <entry>
    <title>Using Ngnix To Deploy A File Share Service</title>
    <url>/2024/06/28/Using-Ngnix-To-Deploy-A-File-Share-Service/</url>
    <content><![CDATA[<html><head></head><body><p>使用Nginx，可以在服务器上搭建一个文件分享服务，通过网络可以下载指定文件夹下的文件。</p>
<span id="more"></span>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install nginx</span><br></pre></td></tr></tbody></table></figure>
<h3 id="配置服务"><a href="#配置服务" class="headerlink" title="配置服务"></a>配置服务</h3><p>安装后nginx会自动运行，监听80端口，我们需要修改默认配置，指定端口和root目录，并开启autoindex。</p>
<figure class="highlight gradle"><table><tbody><tr><td class="code"><pre><span class="line">vi <span class="regexp">/etc/</span>nginx<span class="regexp">/sites-enabled/</span><span class="keyword">default</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">server</span> {</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">30001</span> default_server;</span><br><span class="line">        <span class="attribute">listen</span> [::]:<span class="number">30001</span> default_server;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># SSL configuration</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># listen 443 ssl default_server;</span></span><br><span class="line">        <span class="comment"># listen [::]:443 ssl default_server;</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Note: You should disable gzip for SSL traffic.</span></span><br><span class="line">        <span class="comment"># See: https://bugs.debian.org/773332</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Read up on ssl_ciphers to ensure a secure configuration.</span></span><br><span class="line">        <span class="comment"># See: https://bugs.debian.org/765782</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># Self signed certs generated by the ssl-cert package</span></span><br><span class="line">        <span class="comment"># Don't use them in a production server!</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment"># include snippets/snakeoil.conf;</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">root</span> /apprun/datasets/;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add index.php to the list if you are using PHP</span></span><br><span class="line">        <span class="attribute">index</span> index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">server_name</span> _;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / {</span><br><span class="line">                <span class="comment"># First attempt to serve request as file, then</span></span><br><span class="line">                <span class="comment"># as directory, then fall back to displaying a 404.</span></span><br><span class="line">                <span class="comment"># try_files $uri $uri/ =404;</span></span><br><span class="line">                <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment"># pass PHP scripts to FastCGI server</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ \.php$ {</span></span><br><span class="line">        <span class="comment">#       include snippets/fastcgi-php.conf;</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#       # With php-fpm (or other unix sockets):</span></span><br><span class="line">        <span class="comment">#       fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;</span></span><br><span class="line">        <span class="comment">#       # With php-cgi (or other tcp sockets):</span></span><br><span class="line">        <span class="comment">#       fastcgi_pass 127.0.0.1:9000;</span></span><br><span class="line">        <span class="comment">#}</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># deny access to .htaccess files, if Apache's document root</span></span><br><span class="line">        <span class="comment"># concurs with nginx's one</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="comment">#location ~ /\.ht {</span></span><br><span class="line">        <span class="comment">#       deny all;</span></span><br><span class="line">        <span class="comment">#}</span></span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h3><figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">sudo nginx -t</span></span><br><span class="line"><span class="attribute">sudo nginx -s reload</span></span><br></pre></td></tr></tbody></table></figure>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Ubuntu</category>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>Tutorials</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Training A Model Using Pytorch</title>
    <url>/2024/07/01/Training-A-Model-Using-Pytorch/</url>
    <content><![CDATA[<html><head></head><body><p><strong>Pytorch</strong>是目前主流的深度学习框架，本文主要介绍使用<strong>Pytorch</strong>训练模型的主要流程，包括超参数定义、训练数据准备、配置GPU、加载模型、加在模型参数、训练日志打印、模型参数保存等步骤。</p>
<span id="more"></span>
<h2 id="主流程"><a href="#主流程" class="headerlink" title="主流程"></a>主流程</h2><p>训练模型的主流程一般定义一个<strong>main</strong>函数作为函数执行的入口函数，具体如下所示：</p>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta"># train.py</span></span><br><span class="line"></span><br><span class="line"><span class="function">def <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line"><span class="function">    pass</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">if __name__ =</span>= <span class="string">"__main__"</span>:</span><br><span class="line">    <span class="built_in">main</span>()</span><br></pre></td></tr></tbody></table></figure>
<h3 id="定义训练模型的超参数"><a href="#定义训练模型的超参数" class="headerlink" title="定义训练模型的超参数"></a>定义训练模型的超参数</h3><p>通过<strong>argparser</strong>定义模型训练的超参数，具体如下所示：</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line"><span class="comment"># Required parameters</span></span><br><span class="line">parser.add_argument(<span class="string">"--name"</span>, <span class="attribute">required</span>=<span class="literal">True</span>,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Name of this run. Used for monitoring."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--dataset"</span>, choices=[<span class="string">"cifar10"</span>, <span class="string">"cifar100"</span>], <span class="attribute">default</span>=<span class="string">"cifar10"</span>,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Which downstream task."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--model_type"</span>, choices=[<span class="string">"ViT-B_16"</span>, <span class="string">"ViT-B_32"</span>, <span class="string">"ViT-L_16"</span>,</span><br><span class="line">                                                <span class="string">"ViT-L_32"</span>, <span class="string">"ViT-H_14"</span>, <span class="string">"R50-ViT-B_16"</span>],</span><br><span class="line">                    <span class="attribute">default</span>=<span class="string">"ViT-B_16"</span>,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Which variant to use."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--pretrained_dir"</span>, <span class="attribute">type</span>=str, <span class="attribute">default</span>=<span class="string">"checkpoint/ViT-B_16.npz"</span>,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Where to search for pretrained ViT models."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--output_dir"</span>, <span class="attribute">default</span>=<span class="string">"output"</span>, <span class="attribute">type</span>=str,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"The output directory where checkpoints will be written."</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">"--img_size"</span>, <span class="attribute">default</span>=224, <span class="attribute">type</span>=int,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Resolution size"</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--train_batch_size"</span>, <span class="attribute">default</span>=512, <span class="attribute">type</span>=int,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Total batch size for training."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--eval_batch_size"</span>, <span class="attribute">default</span>=64, <span class="attribute">type</span>=int,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Total batch size for eval."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--eval_every"</span>, <span class="attribute">default</span>=100, <span class="attribute">type</span>=int,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Run prediction on validation set every so many steps."</span></span><br><span class="line">                            <span class="string">"Will always run one evaluation at the end of training."</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">"--learning_rate"</span>, <span class="attribute">default</span>=3e-2, <span class="attribute">type</span>=float,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"The initial learning rate for SGD."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--weight_decay"</span>, <span class="attribute">default</span>=0, <span class="attribute">type</span>=float,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Weight deay if we apply some."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--num_steps"</span>, <span class="attribute">default</span>=10000, <span class="attribute">type</span>=int,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Total number of training epochs to perform."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--decay_type"</span>, choices=[<span class="string">"cosine"</span>, <span class="string">"linear"</span>], <span class="attribute">default</span>=<span class="string">"cosine"</span>,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"How to decay the learning rate."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--warmup_steps"</span>, <span class="attribute">default</span>=500, <span class="attribute">type</span>=int,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Step of training to perform learning rate warmup for."</span>)</span><br><span class="line">parser.add_argument(<span class="string">"--max_grad_norm"</span>, <span class="attribute">default</span>=1.0, <span class="attribute">type</span>=float,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Max gradient norm."</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">"--local_rank"</span>, <span class="attribute">type</span>=int, <span class="attribute">default</span>=-1,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"local_rank for distributed training on gpus"</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--seed'</span>, <span class="attribute">type</span>=int, <span class="attribute">default</span>=42,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"random seed for initialization"</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--gradient_accumulation_steps'</span>, <span class="attribute">type</span>=int, <span class="attribute">default</span>=1,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Number of updates steps to accumulate before performing a backward/update pass."</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--fp16'</span>, <span class="attribute">action</span>=<span class="string">'store_true'</span>,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Whether to use 16-bit float precision instead of 32-bit"</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--fp16_opt_level'</span>, <span class="attribute">type</span>=str, <span class="attribute">default</span>=<span class="string">'O2'</span>,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"For fp16: Apex AMP optimization level selected in ['O0', 'O1', 'O2', and 'O3']."</span></span><br><span class="line">                            <span class="string">"See details at https://nvidia.github.io/apex/amp.html"</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--loss_scale'</span>, <span class="attribute">type</span>=float, <span class="attribute">default</span>=0,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"Loss scaling to improve fp16 numeric stability. Only used when fp16 set to True.\n"</span></span><br><span class="line">                            <span class="string">"0 (default value): dynamic loss scaling.\n"</span></span><br><span class="line">                            <span class="string">"Positive power of 2: static loss scaling value.\n"</span>)</span><br><span class="line">args = parser.parse_args()</span><br></pre></td></tr></tbody></table></figure>
<h3 id="配置训练模型的GPU显卡"><a href="#配置训练模型的GPU显卡" class="headerlink" title="配置训练模型的GPU显卡"></a>配置训练模型的GPU显卡</h3><p>支持多卡和单卡训练，配置方法略有差异。</p>
<h4 id="单卡训练"><a href="#单卡训练" class="headerlink" title="单卡训练"></a>单卡训练</h4><p>单卡训练，默认的local_rank=-1</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">device = torch<span class="selector-class">.device</span>(<span class="string">"cuda"</span> <span class="keyword">if</span> torch<span class="selector-class">.cuda</span><span class="selector-class">.is_available</span>() <span class="keyword">else</span> <span class="string">"cpu"</span>)</span><br><span class="line">args<span class="selector-class">.n_gpu</span> = torch<span class="selector-class">.cuda</span><span class="selector-class">.device_count</span>()</span><br><span class="line">args<span class="selector-class">.device</span> = device</span><br></pre></td></tr></tbody></table></figure>
<h4 id="多卡训练"><a href="#多卡训练" class="headerlink" title="多卡训练"></a>多卡训练</h4><p>多卡训练的实现方式有多种，推荐使用<strong>分布式数据并行（Distributed Data Parallel）</strong>方式，既可以用于单机多卡训练，又可以用于多机多卡训练。由多进程实现，可以从以下方面理解：</p>
<ol>
<li><p>从一开始就会启动多个进程(进程数等于GPU数)，每个进程独享一个GPU，每个进程都会独立地执行代码。这意味着每个进程都独立地初始化模型、训练，当然，在每次迭代过程中会通过进程间通信共享梯度，整合梯度，然后独立地更新参数。</p>
</li>
<li><p>每个进程都会初始化一份训练数据集，当然它们会使用数据集中的不同记录做训练，这相当于同样的模型喂进去不同的数据做训练，也就是所谓的数据并行。这是通过torch.utils.data.distributed.DistributedSampler函数实现的，不过逻辑上也不难想到，只要做一下数据partition，不同进程拿到不同的partition就可以了。</p>
</li>
<li><p>进程通过local_rank变量来标识自己，local_rank为0的为master，其他是slave。local_rank表示的是当前的进程在当前节点的编号，因为我们设置了2个进程，因此进程的编号就是0和1。在使用启动命令时，torch.distributed.launch工具会默认地根据nproc_per_node传入local_rank参数。<br><img alt="pytorch多GPU训练的两种模式" data-src="https://blog.csdn.net/Mr_health/article/details/122822483"><br><img alt="pytorch-multi-gpu-training" data-src="https://github.com/jia-zhuang/pytorch-multi-gpu-training"></p>
</li>
</ol>
<ul>
<li>通过<strong>argparser</strong>定义local_rank参数<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">parser.add_argument(<span class="string">"--local_rank"</span>, <span class="attribute">type</span>=int, <span class="attribute">default</span>=-1,</span><br><span class="line">                    <span class="attribute">help</span>=<span class="string">"local_rank for distributed training on gpus"</span>)</span><br></pre></td></tr></tbody></table></figure></li>
<li>命令行注入local_rank参数<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">python -m torch.distributed.launch <span class="attribute">--nproc_per_node</span>=4 <span class="attribute">--nnodes</span>=1 train.py</span><br></pre></td></tr></tbody></table></figure>
上述命令表示启动一个训练节点，每个节点4张GPU卡。<strong>torch.distributed.launch</strong>就以命令行参数的方式将args.local_rank变量注入到每个进程中，每个进程得到的变量值都不相同。比如使用 4 个GPU的话，则 4 个进程获得的args.local_rank值分别为0、1、2、3。</li>
<li>调用GPU显卡<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">torch.cuda.set<span class="constructor">_device(<span class="params">args</span>.<span class="params">local_rank</span>)</span></span><br><span class="line">device = torch.device(<span class="string">"cuda"</span>, args.local_rank)</span><br><span class="line">torch.distributed.init<span class="constructor">_process_group(<span class="params">backend</span>='<span class="params">nccl</span>', <span class="params">timeout</span>=<span class="params">timedelta</span>(<span class="params">minutes</span>=60)</span>)</span><br><span class="line">args.n_gpu = <span class="number">1</span></span><br><span class="line">args.device = device</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="设置随机数种子"><a href="#设置随机数种子" class="headerlink" title="设置随机数种子"></a>设置随机数种子</h3><p>随机数影响了模型初始化，进而影响模型的训练效果，为了保证多次训练的结果一致性，通常将随机数种子设置为固定值。</p>
<figure class="highlight maxima"><table><tbody><tr><td class="code"><pre><span class="line">def set_seed(<span class="built_in">args</span>):</span><br><span class="line">    <span class="built_in">random</span>.seed(<span class="built_in">args</span>.seed)</span><br><span class="line">    <span class="built_in">np</span>.<span class="built_in">random</span>.seed(<span class="built_in">args</span>.seed)</span><br><span class="line">    torch.manual_seed(<span class="built_in">args</span>.seed)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">args</span>.n_gpu &gt; <span class="number">0</span>:</span><br><span class="line">        torch.cuda.manual_seed_all(<span class="built_in">args</span>.seed)</span><br></pre></td></tr></tbody></table></figure>

<h3 id="配置模型"><a href="#配置模型" class="headerlink" title="配置模型"></a>配置模型</h3><p>同一个模型结构，一般会预留一些超参数，用于生成模型参数量的模型。</p>
<h4 id="配置模型参数"><a href="#配置模型参数" class="headerlink" title="配置模型参数"></a>配置模型参数</h4><p>推荐使用<strong>ml_collections</strong>实现模型参数配置，具体如下所示：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ml_collections</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_model_config</span>():</span><br><span class="line">    <span class="string">"""Returns a minimal configuration for testing."""</span></span><br><span class="line">    config = ml_collections.ConfigDict()</span><br><span class="line">    config.patches = ml_collections.ConfigDict({<span class="string">'size'</span>: (<span class="number">16</span>, <span class="number">16</span>)})</span><br><span class="line">    config.hidden_size = <span class="number">1</span></span><br><span class="line">    config.transformer = ml_collections.ConfigDict()</span><br><span class="line">    config.transformer.mlp_dim = <span class="number">1</span></span><br><span class="line">    config.transformer.num_heads = <span class="number">1</span></span><br><span class="line">    config.transformer.num_layers = <span class="number">1</span></span><br><span class="line">    config.transformer.attention_dropout_rate = <span class="number">0.0</span></span><br><span class="line">    config.transformer.dropout_rate = <span class="number">0.1</span></span><br><span class="line">    config.classifier = <span class="string">'token'</span></span><br><span class="line">    config.representation_size = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">return</span> config</span><br></pre></td></tr></tbody></table></figure>
<p>上述代码可以生成如下所示的配置。</p>
<figure class="highlight nestedtext"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">classifier</span><span class="punctuation">:</span> <span class="string">token</span></span><br><span class="line"><span class="attribute">hidden_size</span><span class="punctuation">:</span> <span class="string">1</span></span><br><span class="line"><span class="attribute">patches</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">size</span><span class="punctuation">:</span> <span class="string">!!python/tuple</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">16</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">16</span></span><br><span class="line"><span class="attribute">representation_size</span><span class="punctuation">:</span> <span class="string">null</span></span><br><span class="line"><span class="attribute">transformer</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">attention_dropout_rate</span><span class="punctuation">:</span> <span class="string">0.0</span></span><br><span class="line">  <span class="attribute">dropout_rate</span><span class="punctuation">:</span> <span class="string">0.1</span></span><br><span class="line">  <span class="attribute">mlp_dim</span><span class="punctuation">:</span> <span class="string">1</span></span><br><span class="line">  <span class="attribute">num_heads</span><span class="punctuation">:</span> <span class="string">1</span></span><br><span class="line">  <span class="attribute">num_layers</span><span class="punctuation">:</span> <span class="string">1</span></span><br></pre></td></tr></tbody></table></figure>
<p>模型的多个配置，可以使用一个dict记录。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><span class="line">CONFIGS = {</span><br><span class="line">    <span class="string">'ViT-B_16'</span>: configs<span class="selector-class">.get_b16_config</span>(),</span><br><span class="line">    <span class="string">'ViT-B_32'</span>: configs<span class="selector-class">.get_b32_config</span>(),</span><br><span class="line">    <span class="string">'ViT-L_16'</span>: configs<span class="selector-class">.get_l16_config</span>(),</span><br><span class="line">    <span class="string">'ViT-L_32'</span>: configs<span class="selector-class">.get_l32_config</span>(),</span><br><span class="line">    <span class="string">'ViT-H_14'</span>: configs<span class="selector-class">.get_h14_config</span>(),</span><br><span class="line">    <span class="string">'R50-ViT-B_16'</span>: configs<span class="selector-class">.get_r50_b16_config</span>(),</span><br><span class="line">    <span class="string">'testing'</span>: configs<span class="selector-class">.get_testing</span>(),</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="生成并加载模型"><a href="#生成并加载模型" class="headerlink" title="生成并加载模型"></a>生成并加载模型</h4><p>首先，将配置传入模型构造函数中，生成模型；其次，模型可以载入之前保存好的参数；最后，将模型加载到device中。</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line">model = <span class="constructor">VisionTransformer(<span class="params">config</span>, <span class="params">args</span>.<span class="params">img_size</span>, <span class="params">zero_head</span>=True, <span class="params">num_classes</span>=<span class="params">num_classes</span>)</span></span><br><span class="line">model.load<span class="constructor">_from(<span class="params">np</span>.<span class="params">load</span>(<span class="params">args</span>.<span class="params">pretrained_dir</span>)</span>)</span><br><span class="line">model.<span class="keyword">to</span>(args.device)</span><br></pre></td></tr></tbody></table></figure>

<h4 id="统计模型参数量"><a href="#统计模型参数量" class="headerlink" title="统计模型参数量"></a>统计模型参数量</h4><p>模型参数一般指的是有梯度的参数。</p>
<figure class="highlight stan"><table><tbody><tr><td class="code"><pre><span class="line">def count_parameters(<span class="title">model</span>):</span><br><span class="line">    params = <span class="built_in">sum</span>(p.numel() <span class="keyword">for</span> p <span class="keyword">in</span> <span class="title">model</span>.<span class="title">parameters</span>() <span class="keyword">if</span> p.requires_grad)</span><br><span class="line">    <span class="keyword">return</span> params/<span class="number">1000000</span> <span class="comment"># in million（M）</span></span><br></pre></td></tr></tbody></table></figure>

<h3 id="训练模型"><a href="#训练模型" class="headerlink" title="训练模型"></a>训练模型</h3><p>模型训练一般由一个<strong>train</strong>函数实现。</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train</span>(<span class="params">args, model</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure>
<h4 id="保存训练过程"><a href="#保存训练过程" class="headerlink" title="保存训练过程"></a>保存训练过程</h4><ul>
<li>通过<strong>SummaryWriter</strong>保存训练过程数据日志，并可以通过<strong>TensorBoard</strong>查看。<br>一般由单卡或者master卡保存训练日志，多卡训练的slave节点不保存日志。<figure class="highlight reasonml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> args.local_rank <span class="keyword">in</span> <span class="literal">[-<span class="number">1</span>, <span class="number">0</span>]</span>:</span><br><span class="line">    os.makedirs(args.output_dir, exist_ok=True)</span><br><span class="line">    writer = <span class="constructor">SummaryWriter(<span class="params">log_dir</span>=<span class="params">os</span>.<span class="params">path</span>.<span class="params">join</span>(<span class="string">"logs"</span>, <span class="params">args</span>.<span class="params">name</span>)</span>)</span><br><span class="line"></span><br><span class="line"># train loop</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.local_rank <span class="keyword">in</span> <span class="literal">[-<span class="number">1</span>, <span class="number">0</span>]</span>:</span><br><span class="line">        writer.close<span class="literal">()</span></span><br></pre></td></tr></tbody></table></figure></li>
<li>在terminal中打印日志<br>推荐使用<strong>logging</strong>包实现，具体如下所示：<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">import<span class="built_in"> logging</span></span><br><span class="line"><span class="built_in"></span>logger = logging.getLogger(__name__)</span><br><span class="line">logger.<span class="built_in">info</span>(<span class="string">"***** Running training *****"</span>)</span><br><span class="line">logger.<span class="built_in">info</span>(<span class="string">"  Total optimization steps = %d"</span>, args.num_steps)</span><br><span class="line">logger.<span class="built_in">info</span>(<span class="string">"  Instantaneous batch size per GPU = %d"</span>, args.train_batch_size)</span><br><span class="line">logger.<span class="built_in">info</span>(<span class="string">"  Total train batch size (w. parallel, distributed &amp; accumulation) = %d"</span>,</span><br><span class="line">                args.train_batch_size * args.gradient_accumulation_steps * (</span><br><span class="line">                    torch.distributed.get_world_size() <span class="keyword">if</span> args.local_rank != -1 <span class="keyword">else</span> 1))</span><br><span class="line">logger.<span class="built_in">info</span>(<span class="string">"  Gradient Accumulation steps = %d"</span>, args.gradient_accumulation_steps)</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h4 id="准备数据集"><a href="#准备数据集" class="headerlink" title="准备数据集"></a>准备数据集</h4><p>通过一个<strong>data_loader</strong>函数实现，返回<strong>train_loader</strong>和<strong>test_loader</strong>，具体参照！(数据集准备)[]</p>
<figure class="highlight autohotkey"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">train_loader,</span> test_loader = dat<span class="built_in">a_loader</span>(args)</span><br></pre></td></tr></tbody></table></figure>
<h4 id="准备优化器和训练计划"><a href="#准备优化器和训练计划" class="headerlink" title="准备优化器和训练计划"></a>准备优化器和训练计划</h4><p>需要使用<strong>apex</strong>库。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> apex import amp</span><br><span class="line"><span class="keyword">from</span> apex.parallel import DistributedDataParallel as DDP</span><br><span class="line"><span class="comment"># Prepare optimizer and scheduler</span></span><br><span class="line">optimizer = torch.optim.SGD(model.parameters(),</span><br><span class="line">                            <span class="attribute">lr</span>=args.learning_rate,</span><br><span class="line">                            <span class="attribute">momentum</span>=0.9,</span><br><span class="line">                            <span class="attribute">weight_decay</span>=args.weight_decay)</span><br><span class="line">t_total = args.num_steps</span><br><span class="line"><span class="keyword">if</span> args.decay_type == <span class="string">"cosine"</span>:</span><br><span class="line">   <span class="built_in"> scheduler </span>= WarmupCosineSchedule(optimizer, <span class="attribute">warmup_steps</span>=args.warmup_steps, <span class="attribute">t_total</span>=t_total)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">   <span class="built_in"> scheduler </span>= WarmupLinearSchedule(optimizer, <span class="attribute">warmup_steps</span>=args.warmup_steps, <span class="attribute">t_total</span>=t_total)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.fp16:</span><br><span class="line">    model, optimizer = amp.initialize(<span class="attribute">models</span>=model,</span><br><span class="line">                                        <span class="attribute">optimizers</span>=optimizer,</span><br><span class="line">                                        <span class="attribute">opt_level</span>=args.fp16_opt_level)</span><br><span class="line">    amp._amp_state.loss_scalers[0]._loss_scale = 2*<span class="number">*20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Distributed training</span></span><br><span class="line"><span class="keyword">if</span> args.local_rank != -1:</span><br><span class="line">    model = DDP(model, <span class="attribute">message_size</span>=250000000, <span class="attribute">gradient_predivide_factor</span>=get_world_size())</span><br></pre></td></tr></tbody></table></figure>

<h4 id="开始训练"><a href="#开始训练" class="headerlink" title="开始训练"></a>开始训练</h4><ul>
<li>valid<br>在训练过程中一般会每隔一定时间用测试集评估一下模型的训练结果，过程如下所示：<figure class="highlight scss"><table><tbody><tr><td class="code"><pre><span class="line">def <span class="built_in">valid</span>(args, model, writer, test_loader, global_step):</span><br><span class="line">    # Validation!</span><br><span class="line">    eval_losses = <span class="built_in">AverageMeter</span>()</span><br><span class="line"></span><br><span class="line">    logger.<span class="built_in">info</span>(<span class="string">"***** Running Validation *****"</span>)</span><br><span class="line">    logger.<span class="built_in">info</span>(<span class="string">"  Num steps = %d"</span>, <span class="built_in">len</span>(test_loader))</span><br><span class="line">    logger.<span class="built_in">info</span>(<span class="string">"  Batch size = %d"</span>, args.eval_batch_size)</span><br><span class="line"></span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    all_preds, all_label = [], []</span><br><span class="line">    epoch_iterator = <span class="built_in">tqdm</span>(test_loader,</span><br><span class="line">                          desc=<span class="string">"Validating... (loss=X.X)"</span>,</span><br><span class="line">                          bar_format=<span class="string">"{l_bar}{r_bar}"</span>,</span><br><span class="line">                          dynamic_ncols=True,</span><br><span class="line">                          disable=args.local_rank not in [-<span class="number">1</span>, <span class="number">0</span>])</span><br><span class="line">    loss_fct = torch.nn.<span class="built_in">CrossEntropyLoss</span>()</span><br><span class="line">    for step, batch in <span class="built_in">enumerate</span>(epoch_iterator):</span><br><span class="line">        batch = <span class="built_in">tuple</span>(t.<span class="built_in">to</span>(args.device) for t in batch)</span><br><span class="line">        x, y = batch</span><br><span class="line">        with torch.<span class="built_in">no_grad</span>():</span><br><span class="line">            logits = <span class="built_in">model</span>(x)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">            eval_loss = <span class="built_in">loss_fct</span>(logits, y)</span><br><span class="line">            eval_losses.<span class="built_in">update</span>(eval_loss.<span class="built_in">item</span>())</span><br><span class="line"></span><br><span class="line">            preds = torch.<span class="built_in">argmax</span>(logits, dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        if <span class="built_in">len</span>(all_preds) == <span class="number">0</span>:</span><br><span class="line">            all_preds.<span class="built_in">append</span>(preds.<span class="built_in">detach</span>().<span class="built_in">cpu</span>().<span class="built_in">numpy</span>())</span><br><span class="line">            all_label.<span class="built_in">append</span>(y.<span class="built_in">detach</span>().<span class="built_in">cpu</span>().<span class="built_in">numpy</span>())</span><br><span class="line">        else:</span><br><span class="line">            all_preds[<span class="number">0</span>] = np.<span class="built_in">append</span>(</span><br><span class="line">                all_preds[<span class="number">0</span>], preds.<span class="built_in">detach</span>().<span class="built_in">cpu</span>().<span class="built_in">numpy</span>(), axis=<span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">            all_label[<span class="number">0</span>] = np.<span class="built_in">append</span>(</span><br><span class="line">                all_label[<span class="number">0</span>], y.<span class="built_in">detach</span>().<span class="built_in">cpu</span>().<span class="built_in">numpy</span>(), axis=<span class="number">0</span></span><br><span class="line">            )</span><br><span class="line">        epoch_iterator.<span class="built_in">set_description</span>(<span class="string">"Validating... (loss=%2.5f)"</span> % eval_losses.val)</span><br><span class="line"></span><br><span class="line">    all_preds, all_label = all_preds[<span class="number">0</span>], all_label[<span class="number">0</span>]</span><br><span class="line">    accuracy = <span class="built_in">simple_accuracy</span>(all_preds, all_label)</span><br><span class="line"></span><br><span class="line">    logger.<span class="built_in">info</span>(<span class="string">"\n"</span>)</span><br><span class="line">    logger.<span class="built_in">info</span>(<span class="string">"Validation Results"</span>)</span><br><span class="line">    logger.<span class="built_in">info</span>(<span class="string">"Global Steps: %d"</span> % global_step)</span><br><span class="line">    logger.<span class="built_in">info</span>(<span class="string">"Valid Loss: %2.5f"</span> % eval_losses.avg)</span><br><span class="line">    logger.<span class="built_in">info</span>(<span class="string">"Valid Accuracy: %2.5f"</span> % accuracy)</span><br><span class="line"></span><br><span class="line">    writer.<span class="built_in">add_scalar</span>(<span class="string">"test/accuracy"</span>, scalar_value=accuracy, global_step=global_step)</span><br><span class="line">    return accuracy</span><br><span class="line"></span><br><span class="line">def <span class="built_in">simple_accuracy</span>(preds, labels):</span><br><span class="line">    return (preds == labels).<span class="built_in">mean</span>()</span><br></pre></td></tr></tbody></table></figure></li>
<li>train<br>首先，在while循环开始训练之前，定义loss, global_step, best_acc等全局变量；然后开启while循环，开始训练；最后通过global_step和total_step结束训练。训练过程中需要用到<strong>tqdm</strong>库。<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">model.zero_grad()</span><br><span class="line">set_seed(args)  # Added here <span class="keyword">for</span> reproducibility (even between python 2 <span class="keyword">and</span> 3)</span><br><span class="line">losses = AverageMeter()</span><br><span class="line">global_step, best_acc = 0, 0</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    model.train()</span><br><span class="line">    epoch_iterator = tqdm(train_loader,</span><br><span class="line">                            <span class="attribute">desc</span>=<span class="string">"Training (X / X Steps) (loss=X.X)"</span>,</span><br><span class="line">                            <span class="attribute">bar_format</span>=<span class="string">"{l_bar}{r_bar}"</span>,</span><br><span class="line">                            <span class="attribute">dynamic_ncols</span>=<span class="literal">True</span>,</span><br><span class="line">                            <span class="attribute">disable</span>=args.local_rank <span class="keyword">not</span> <span class="keyword">in</span> [-1, 0])</span><br><span class="line">    <span class="keyword">for</span> <span class="keyword">step</span>, batch <span class="keyword">in</span> enumerate(epoch_iterator):</span><br><span class="line">        batch = tuple(t.<span class="keyword">to</span>(args.device) <span class="keyword">for</span> t <span class="keyword">in</span> batch)</span><br><span class="line">        x, y = batch</span><br><span class="line">        loss = model(x, y)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> args.gradient_accumulation_steps &gt; 1:</span><br><span class="line">            loss = loss / args.gradient_accumulation_steps</span><br><span class="line">        <span class="keyword">if</span> args.fp16:</span><br><span class="line">            with amp.scale_loss(loss, optimizer) as scaled_loss:</span><br><span class="line">                scaled_loss.backward()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            loss.backward()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">step</span> + 1) % args.gradient_accumulation_steps == 0:</span><br><span class="line">            losses.update(loss.item()<span class="number">*a</span>rgs.gradient_accumulation_steps)</span><br><span class="line">            <span class="keyword">if</span> args.fp16:</span><br><span class="line">                torch.nn.utils.clip_grad_norm_(amp.master_params(optimizer), args.max_grad_norm)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                torch.nn.utils.clip_grad_norm_(model.parameters(), args.max_grad_norm)</span><br><span class="line">            scheduler.<span class="keyword">step</span>()</span><br><span class="line">            optimizer.<span class="keyword">step</span>()</span><br><span class="line">            optimizer.zero_grad()</span><br><span class="line">            global_step += 1</span><br><span class="line"></span><br><span class="line">            epoch_iterator.set_description(</span><br><span class="line">                <span class="string">"Training (%d / %d Steps) (loss=%2.5f)"</span> % (global_step, t_total, losses.val)</span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> args.local_rank <span class="keyword">in</span> [-1, 0]:</span><br><span class="line">                writer.add_scalar(<span class="string">"train/loss"</span>, <span class="attribute">scalar_value</span>=losses.val, <span class="attribute">global_step</span>=global_step)</span><br><span class="line">                writer.add_scalar(<span class="string">"train/lr"</span>, <span class="attribute">scalar_value</span>=scheduler.get_lr()[0], <span class="attribute">global_step</span>=global_step)</span><br><span class="line">            <span class="keyword">if</span> global_step % args.eval_every == 0 <span class="keyword">and</span> args.local_rank <span class="keyword">in</span> [-1, 0]:</span><br><span class="line">                accuracy = valid(args, model, writer, test_loader, global_step)</span><br><span class="line">                <span class="keyword">if</span> best_acc &lt; accuracy:</span><br><span class="line">                    save_model(args, model)</span><br><span class="line">                    best_acc = accuracy</span><br><span class="line">                model.train()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> global_step % t_total == 0:</span><br><span class="line">                break</span><br><span class="line">    losses.reset()</span><br><span class="line">    <span class="keyword">if</span> global_step % t_total == 0:</span><br><span class="line">        break</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Deep Learning</category>
        <category>Pytorch</category>
      </categories>
      <tags>
        <tag>Deep Learning</tag>
        <tag>Tutorials</tag>
        <tag>Pytorch</tag>
      </tags>
  </entry>
  <entry>
    <title>Learning Note Of Vision Transformer</title>
    <url>/2024/07/05/Learning-Note-Of-Vision-Transformer/</url>
    <content><![CDATA[<html><head></head><body><p>本文将相机详解Vision Transformer模型的结构。</p>
<span id="more"></span>
<h3 id="Embedding"><a href="#Embedding" class="headerlink" title="Embedding"></a>Embedding</h3><p>该模块的作用是将图像转换为序列特征。</p>
<ul>
<li>超参数 – patch_size，决定了将图像切分为patch的大小<br>patch的数量由输入图像的尺寸$[width, height]$和patch的尺寸共同决定：<br>$$patch_num=\frac{width}{patch_size} * \frac{height}{patch_size}$$</li>
<li>超参数 – hidden_size，决定了embedding特征的长度</li>
<li>超参数 – dropout_rate，决定了embedding特征dropout的比率<br>切分patch通过二维卷积实现，拼接上类目编码之后再加上位置编码。<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Embeddings</span>(nn.Module):</span><br><span class="line">    <span class="string">"""Construct the embeddings from patch, position embeddings.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config, img_size, in_channels=<span class="number">3</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Embeddings, self).__init__()</span><br><span class="line">        self.hybrid = <span class="literal">None</span></span><br><span class="line">        img_size = _pair(img_size)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> config.patches.get(<span class="string">"grid"</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            grid_size = config.patches[<span class="string">"grid"</span>]</span><br><span class="line">            patch_size = (img_size[<span class="number">0</span>] // <span class="number">16</span> // grid_size[<span class="number">0</span>], img_size[<span class="number">1</span>] // <span class="number">16</span> // grid_size[<span class="number">1</span>])</span><br><span class="line">            n_patches = (img_size[<span class="number">0</span>] // <span class="number">16</span>) * (img_size[<span class="number">1</span>] // <span class="number">16</span>)</span><br><span class="line">            self.hybrid = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            patch_size = _pair(config.patches[<span class="string">"size"</span>])</span><br><span class="line">            n_patches = (img_size[<span class="number">0</span>] // patch_size[<span class="number">0</span>]) * (img_size[<span class="number">1</span>] // patch_size[<span class="number">1</span>])</span><br><span class="line">            self.hybrid = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.hybrid:</span><br><span class="line">            self.hybrid_model = ResNetV2(block_units=config.resnet.num_layers,</span><br><span class="line">                                         width_factor=config.resnet.width_factor)</span><br><span class="line">            in_channels = self.hybrid_model.width * <span class="number">16</span></span><br><span class="line">        self.patch_embeddings = Conv2d(in_channels=in_channels,</span><br><span class="line">                                       out_channels=config.hidden_size,</span><br><span class="line">                                       kernel_size=patch_size,</span><br><span class="line">                                       stride=patch_size)</span><br><span class="line">        self.position_embeddings = nn.Parameter(torch.zeros(<span class="number">1</span>, n_patches+<span class="number">1</span>, config.hidden_size))</span><br><span class="line">        self.cls_token = nn.Parameter(torch.zeros(<span class="number">1</span>, <span class="number">1</span>, config.hidden_size))</span><br><span class="line"></span><br><span class="line">        self.dropout = Dropout(config.transformer[<span class="string">"dropout_rate"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># input x shape is [b,c,h,w]</span></span><br><span class="line">        B = x.shape[<span class="number">0</span>]</span><br><span class="line">        <span class="comment"># cls_token shape: [1, 1, emb_len] ==&gt; [b, 1, emb_len]</span></span><br><span class="line">        cls_tokens = self.cls_token.expand(B, -<span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.hybrid:</span><br><span class="line">            x = self.hybrid_model(x)</span><br><span class="line">        <span class="comment"># x shape: [b,c,h,w] ==&gt; [b, emb_len, h//patch_size, w//patch_size]</span></span><br><span class="line">        x = self.patch_embeddings(x)</span><br><span class="line">        <span class="comment"># x shape: [b, emb_len, h_p, w_p] ==&gt; [b, emb_len, h_p * w_p] ==&gt; [b, emb_len, n_patches]</span></span><br><span class="line">        x = x.flatten(<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># x shape: [b, emb_len, n_patches] ==&gt; [b, n_patches, emb_len]</span></span><br><span class="line">        x = x.transpose(-<span class="number">1</span>, -<span class="number">2</span>)</span><br><span class="line">        <span class="comment"># x shape: [b, n_patches, emb_len] ==&gt; [b, n_patches+1, emb_len]</span></span><br><span class="line">        x = torch.cat((cls_tokens, x), dim=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># x shape: [b, n_patches+1, emb_len] ==&gt; [b, n_patches+1, emb_len], add is auto broadcasting</span></span><br><span class="line">        embeddings = x + self.position_embeddings</span><br><span class="line">        embeddings = self.dropout(embeddings)</span><br><span class="line">        <span class="keyword">return</span> embeddings</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="Attention"><a href="#Attention" class="headerlink" title="Attention"></a>Attention</h3><p><strong>Self-Attention</strong>模块是<strong>Transformer</strong>的核心基础模块。</p>
<ul>
<li>超参数 – num_heads，多头注意力机制的头数量</li>
<li>超参数 – hidden_size，决定了输入的embedding特征长度<br><strong>hidden_size</strong>和<strong>num_heads</strong>共同决定了多头注意力机制每一头的特征长度。<br>$$attention_head_size = \frac{hidden_size}{num_heads}$$<br>一般需要确保上述公式是整除的。</li>
<li>超参数 – attention_dropout_rate，决定了attention_score和output的dropout比率<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Attention</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, config, vis</span>):</span><br><span class="line">        <span class="built_in">super</span>(Attention, self).__init__()</span><br><span class="line">        self.vis = vis</span><br><span class="line">        self.num_attention_heads = config.transformer[<span class="string">"num_heads"</span>]</span><br><span class="line">        self.attention_head_size = <span class="built_in">int</span>(config.hidden_size / self.num_attention_heads)</span><br><span class="line">        self.all_head_size = self.num_attention_heads * self.attention_head_size</span><br><span class="line"></span><br><span class="line">        self.query = Linear(config.hidden_size, self.all_head_size)</span><br><span class="line">        self.key = Linear(config.hidden_size, self.all_head_size)</span><br><span class="line">        self.value = Linear(config.hidden_size, self.all_head_size)</span><br><span class="line"></span><br><span class="line">        self.out = Linear(config.hidden_size, config.hidden_size)</span><br><span class="line">        self.attn_dropout = Dropout(config.transformer[<span class="string">"attention_dropout_rate"</span>])</span><br><span class="line">        self.proj_dropout = Dropout(config.transformer[<span class="string">"attention_dropout_rate"</span>])</span><br><span class="line"></span><br><span class="line">        self.softmax = Softmax(dim=-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">transpose_for_scores</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># x size: [b, seq, all_head_len], new_x_shape: [b, seq, num_heads, head_len]</span></span><br><span class="line">        new_x_shape = x.size()[:-<span class="number">1</span>] + (self.num_attention_heads, self.attention_head_size)</span><br><span class="line">        <span class="comment"># reshape: [b, seq, all_head_len] ==&gt; [b, seq, num_heads, head_len]</span></span><br><span class="line">        x = x.view(*new_x_shape)</span><br><span class="line">        <span class="comment"># x: [b, seq, num_heads, head_len] ==&gt; [b, hum_heads, seq, head_len]</span></span><br><span class="line">        <span class="keyword">return</span> x.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, hidden_states</span>):</span><br><span class="line">        <span class="comment"># input: [b, seq, emb_len] ==&gt; [b, seq, all_head_len]</span></span><br><span class="line">        mixed_query_layer = self.query(hidden_states)</span><br><span class="line">        mixed_key_layer = self.key(hidden_states)</span><br><span class="line">        mixed_value_layer = self.value(hidden_states)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># transpose_for_scores: 切分为多头</span></span><br><span class="line">        <span class="comment"># input: [b, seq, all_head_len] ==&gt; [b, num_heads, seq, head_len]</span></span><br><span class="line">        query_layer = self.transpose_for_scores(mixed_query_layer)</span><br><span class="line">        key_layer = self.transpose_for_scores(mixed_key_layer)</span><br><span class="line">        value_layer = self.transpose_for_scores(mixed_value_layer)</span><br><span class="line">        <span class="comment"># [b, num_heads, seq, head_len] * [b, num_heads, head_len, seq] ==&gt; [b, num_heads, seq, seq]</span></span><br><span class="line">        <span class="comment"># 本质上是在num_heads个通道上，计算一个[seq, seq]维度的协方差矩阵，表征序列特征之间的相似度</span></span><br><span class="line">        attention_scores = torch.matmul(query_layer, key_layer.transpose(-<span class="number">1</span>, -<span class="number">2</span>))</span><br><span class="line">        <span class="comment"># scaling factor: sqrt(head_len)</span></span><br><span class="line">        attention_scores = attention_scores / math.sqrt(self.attention_head_size)</span><br><span class="line">        <span class="comment"># 在最后维度softmax</span></span><br><span class="line">        attention_probs = self.softmax(attention_scores)</span><br><span class="line">        <span class="comment"># 返回可视化的attention_score [b, num_heads, seq, seq]</span></span><br><span class="line">        weights = attention_probs <span class="keyword">if</span> self.vis <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">        <span class="comment"># dropout</span></span><br><span class="line">        attention_probs = self.attn_dropout(attention_probs)</span><br><span class="line">        <span class="comment"># [b, num_heads, seq, seq] * [b, num_heads, seq, head_len] ==&gt; [b, num_heads, seq, head_len]</span></span><br><span class="line">        <span class="comment"># 本质上是用序列相似度加权平均序列特征</span></span><br><span class="line">        context_layer = torch.matmul(attention_probs, value_layer)</span><br><span class="line">        <span class="comment"># [b, num_heads, seq, head_len] ==&gt; [b, seq, num_heads, head_len]</span></span><br><span class="line">        context_layer = context_layer.permute(<span class="number">0</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>).contiguous()</span><br><span class="line">        <span class="comment"># [b, seq, num_heads, head_len] ==&gt; [b, seq, all_head_size]</span></span><br><span class="line">        <span class="comment"># 合并多头，形成attention特征</span></span><br><span class="line">        new_context_layer_shape = context_layer.size()[:-<span class="number">2</span>] + (self.all_head_size,)</span><br><span class="line">        context_layer = context_layer.view(*new_context_layer_shape)</span><br><span class="line">        <span class="comment"># 线性变换</span></span><br><span class="line">        attention_output = self.out(context_layer)</span><br><span class="line">        <span class="comment"># dropout</span></span><br><span class="line">        attention_output = self.proj_dropout(attention_output)</span><br><span class="line">        <span class="keyword">return</span> attention_output, weights</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<h3 id="Mlp"><a href="#Mlp" class="headerlink" title="Mlp"></a>Mlp</h3><p>该模块为两层全联接层，本质上是将Attention输出的特征映射到更高维度（第一层）之后再映射回统一维度（第二层）。</p>
<ul>
<li>超参数 – hidden_state，定义了输入输出的特征维度</li>
<li>超参数 –</li>
</ul>
<h3 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h3></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Deep Learning</category>
        <category>Pytorch</category>
        <category>Vision Transformer</category>
      </categories>
      <tags>
        <tag>Deep Learning</tag>
        <tag>Tutorials</tag>
        <tag>Pytorch</tag>
        <tag>Vision Transformer</tag>
      </tags>
  </entry>
  <entry>
    <title>Vision Servo Control For Robot Manipulation</title>
    <url>/2024/10/02/Vision-Servo-Control-For-Robot-Manipulation/</url>
    <content><![CDATA[<html><head></head><body><p>视觉伺服是多自由度机械臂灵巧作业领域经典运动控制算法之一，常用于对精细作业和范化作业，例如利用视觉伺服实现对接线面板和USB接口的插拔。视觉伺服算法的核心思想是利用视觉反馈信息，对机械臂末端执行器进行实时位置和姿态调整，以实现精确的运动控制。视觉伺服通常分为两类，一类是基于图像特征的视觉伺服（IBVS），另一类是基于位置姿态的视觉伺服（PBVS）。本文将介绍这两种视觉伺服算法的基本原理和实现方法。</p>
<span id="more"></span>
<h2 id="背景理论"><a href="#背景理论" class="headerlink" title="背景理论"></a>背景理论</h2><p>视觉伺服本质上是一个在坐标转换（平移、旋转）运动空间的非线性优化问题，因此会用到<strong>Gauss-Newton</strong>非线性优化算法和<strong>Jacobian矩阵</strong>。</p>
<h3 id="非线性优化问题"><a href="#非线性优化问题" class="headerlink" title="非线性优化问题"></a>非线性优化问题</h3><p>将最优化问题的目标函数表示为$f(x)$，其中$f(x)$二阶连续可微，那么最优化的问题可以转化：<br>$${argmin}_{x}f(x)$$<br>即求解$f(x)$的最小值以及对应的$x^{*}$。<br>复杂的非线性最优化问题，$f(x)$一般为高维非线性方程组，$x$为多维向量，即$x \in \mathbb{R}^n$，$f(x) \in \mathbb{R}^m$，其中$m \geq n$。</p>
<p>对于机械臂视觉伺服运动控制问题，上述非线性优化问题可以表示为：<br>$$x = \begin{bmatrix}t &amp; r \end{bmatrix}$$<br>其中$t$表示坐标转换空间中的平移向量，维度为$[3x1]$，$r$表示坐标转换空间中的旋转向量，维度为$[3x1]$。<br>$$f(x) = x_{target} - x_{current}$$<br>或者<br>$$f(x) = x_{target}^{-1} x_{current}$$<br>公式选择取决于参考坐标系的选择，已经视觉伺服方式的选择，具体请见<strong>视觉伺服</strong>章节。</p>
<h3 id="Jacobian矩阵"><a href="#Jacobian矩阵" class="headerlink" title="Jacobian矩阵"></a>Jacobian矩阵</h3><p>对于复杂的非线性目标函数，在数学上直接求解解析解比较复杂，一般通过一级泰勒公式展开进行线性化近似，即：<br>$$f(x+\Delta x) \approx f(x) + J(x)\Delta x$$<br>其中，$J(x)$为$f(x)$在$x$处偏导数$\frac{\partial f(x)}{\partial x}$，称为Jacobian矩阵，$\Delta x$为增量。</p>
<p>假设$f(x) \in \mathbb{R}^m$，$x \in \mathbb{R}^n$，则雅可比矩阵表示的是$\mathbb{R}^n$空间到$\mathbb{R}^m$空间的线性映射，是一个$[m×n]$的矩阵，换句话讲其重要意义在于它表现了一个多变数向量函数的最佳线性逼近，公式为：<br>$$J(x) = \frac{\partial f(x)}{\partial x} =<br>\begin{bmatrix}<br>\frac{\partial f(x)}{\partial x_{1}} &amp; \cdots &amp; \frac{\partial f(x)}{\partial x_{n}}<br>\end{bmatrix} =<br>\begin{bmatrix}<br>\frac{\partial f_{1}(x)}{\partial x_{1}} &amp; \cdots &amp; \frac{\partial f_{1}(x)}{\partial x_{n}} \<br>\vdots &amp; \ddots &amp; \vdots \<br>\frac{\partial f_{m}(x)}{\partial x_{1}} &amp; \cdots &amp; \frac{\partial f_{m}(x)}{\partial x_{n}} \<br>\end{bmatrix}$$<br>一级泰勒公式展开线性逼近公式可以描述为矩阵形式：<br>$$<br>\begin{bmatrix}<br>f_{1}(x + \Delta x) \ \vdots \ f_{m}(x + \Delta x)<br>\end{bmatrix} =<br>\begin{bmatrix}<br>f_{1}(x) \ \vdots \ f_{m}(x)<br>\end{bmatrix} +<br>\begin{bmatrix}<br>\frac{\partial f_{1}(x)}{\partial x_{1}} &amp; \cdots &amp; \frac{\partial f_{1}(x)}{\partial x_{n}} \<br>\vdots &amp; \ddots &amp; \vdots \<br>\frac{\partial f_{m}(x)}{\partial x_{1}} &amp; \cdots &amp; \frac{\partial f_{m}(x)}{\partial x_{n}} \<br>\end{bmatrix}<br>\begin{bmatrix}<br>\Delta x_{1} \ \vdots \ \Delta x_{n}<br>\end{bmatrix}<br>$$</p>
<p>如果 $m = n$，那么雅可比矩阵是一个$[nxn]$方阵。于是我们可以取它的行列式，称为雅可比行列式。</p>
<ul>
<li>参考链接</li>
</ul>
<p><a href="https://zh.wikipedia.org/zh-hans/%E9%9B%85%E5%8F%AF%E6%AF%94%E7%9F%A9%E9%98%B5">Jacobian Matrix</a></p>
<p><a href="https://blog.csdn.net/gwplovekimi/article/details/104977255">雅各比矩阵和机械臂关节坐标转换</a></p>
<h3 id="Gauss-Newton非线性优化"><a href="#Gauss-Newton非线性优化" class="headerlink" title="Gauss-Newton非线性优化"></a>Gauss-Newton非线性优化</h3><p>对于大部分非线性优化问题，一般很难直接得到解析解。在数学上可以使用<strong>Gauss-Newton</strong>算法通过循环迭代地方式获取非线性方程组的数值解，其基本思想是从给定的初始值$x^{0}$开始，沿着梯度下降的方向，循环迭代直至目标函数达到或者接近最优值。</p>
<p>基于一级泰勒公式展开线性逼近方程，可以将最优化问题转换为关于$\Delta x$的线性最小二乘问题：<br>$$argmin_{x}\frac{1}{2} \Vert f(x) + J(x)\Delta x \Vert^2$$<br>其中，$J(x)$为$f(x)$在$x$处偏导数$\frac{\partial f(x)}{\partial x}$，称为Jacobian矩阵，$\Delta x$为增量。</p>
<p>注意：<strong>Gauss-Newton</strong>算法必须要转换成最小二乘问题进行求解。</p>
<p>求取上述公式相对于$\Delta x$的导数，并令导数等于0，即可得到最优解。推导过程如下所示：</p>
<p>已知公式：$\Vert X \Vert^2 = X^TX$，其中$X$为矩阵。</p>
<p>可以将最小二乘函数转化为：<br>$$<br>\begin{align}<br>\frac{1}{2} \Vert f(x) + J(x)\Delta x \Vert^2 &amp;= (f(x) + J(x)\Delta x)^T(f(x) + J(x)\Delta x) \<br>&amp;= f(x)^Tf(x) + \Delta x^TJ(x)^Tf(x) + f(x)^TJ(x)\Delta x + \Delta x^TJ(x)^TJ(x)\Delta x<br>\end{align}<br>$$<br>已知矩阵求导公式$\frac{\partial x^Ta}{\partial x}=\frac{\partial a^Tx}{\partial x} = a$，$\frac{}{}$<br>$$</p>
<p>$$<br>迭代公式为：</p>
<ul>
<li>参考链接</li>
</ul>
<p><a href="https://zhuanlan.zhihu.com/p/482540286?utm_id=0">Bundle Adjustment 重投影误差模型及相应雅克比公式推导</a></p>
<p><a href="https://www.cnblogs.com/bingjianing/p/9093054.html">Jacobian矩阵、Hessian矩阵和Newton’s method</a></p>
<p><a href="https://loopvoid.github.io/2018/04/28/Jacobian%E7%9F%A9%E9%98%B5%E4%B8%8EHessian%E7%9F%A9%E9%98%B5%E4%B8%8E%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98/">Jacobian矩阵与Hessian矩阵与最小二乘</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/273729929">矩阵求导</a></p>
<h2 id="视觉伺服"><a href="#视觉伺服" class="headerlink" title="视觉伺服"></a>视觉伺服</h2><h3 id="基于位置的视觉伺服（PBVS）"><a href="#基于位置的视觉伺服（PBVS）" class="headerlink" title="基于位置的视觉伺服（PBVS）"></a>基于位置的视觉伺服（PBVS）</h3><h3 id="基于图像的视觉伺服（IBVS）"><a href="#基于图像的视觉伺服（IBVS）" class="headerlink" title="基于图像的视觉伺服（IBVS）"></a>基于图像的视觉伺服（IBVS）</h3></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Algorithms</category>
        <category>Robotics</category>
      </categories>
      <tags>
        <tag>Vision Servo</tag>
        <tag>PBVS</tag>
        <tag>IBVS</tag>
      </tags>
  </entry>
  <entry>
    <title>Usage Of Testing Tool Locust</title>
    <url>/2024/08/22/Usage-Of-Testing-Tool-Locust/</url>
    <content><![CDATA[<html><head></head><body><p>完成后端服务开发后，在业务上线之前，通常需要进行压力测试，以评估目前的服务器算力在不同QPS请求下的负载承受能力，以此做系统后端可靠性分析。<strong>Locust</strong>是基于Python接口的开源压力测试工具，本文将介绍如何使用该工具对后端服务器进行压力测试。</p>
<span id="more"></span>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>可以直接使用<strong>pip</strong>包管理工具进行安装，如下所示：</p>
<figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><span class="line">pip <span class="keyword">install</span> locust</span><br></pre></td></tr></tbody></table></figure>
<p>需要将<strong>Locust</strong>安装目录添加到<strong>PATH</strong>中，这样可以直接在<strong>terminal</strong>中使用<strong>locust</strong>指令。</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><span class="line">vi ~/.zshrc</span><br><span class="line"><span class="built_in">export</span> <span class="attribute">PATH</span>=<span class="string">"/home/parallels/.local/bin:<span class="variable">$PATH</span>"</span></span><br></pre></td></tr></tbody></table></figure>
<p>安装完成后，可以通过如下指令查看并确认安装是否成功：</p>
<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">locust -V</span></span><br></pre></td></tr></tbody></table></figure>
<p>如果看到以下信息，则表明安装成功。</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">locust</span> <span class="number">2</span>.<span class="number">31</span>.<span class="number">3</span> from /home/parallels/.local/lib/python3.<span class="number">10</span>/site-packages/locust (Python <span class="number">3</span>.<span class="number">10</span>.<span class="number">12</span>, OpenSSL <span class="number">3</span>.<span class="number">0</span>.<span class="number">2</span>)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="压测用例"><a href="#压测用例" class="headerlink" title="压测用例"></a>压测用例</h3><ul>
<li>HttpUser<br>首先创建一个<strong>locustfile.py</strong>文件，并实现一个继承<strong>HttpUser</strong>的自定义测试类，<strong>Locust</strong>程序在同目录启动后会默认执行该测试用例。<figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> response</span><br><span class="line"><span class="keyword">from</span> locust <span class="keyword">import</span> HttpUser, task, between, constant</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ServoApiUser</span>(<span class="title class_ inherited__">HttpUser</span>):</span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    User class that does requests to the locust web server running on localhost,</span></span><br><span class="line"><span class="string">    using the fast HTTP client</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    host = <span class="string">"https://www.yourwebsite.com"</span></span><br><span class="line">    wait_time = between(<span class="number">2</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="comment"># wait_time = constant(1)</span></span><br><span class="line">    <span class="comment"># some things you can configure on FastHttpUser</span></span><br><span class="line">    <span class="comment"># connection_timeout = 60.0</span></span><br><span class="line">    <span class="comment"># insecure = True</span></span><br><span class="line">    <span class="comment"># max_redirects = 5</span></span><br><span class="line">    <span class="comment"># max_retries = 1</span></span><br><span class="line">    <span class="comment"># network_timeout = 60.0</span></span><br><span class="line">    <span class="comment"># proxy_host = my-proxy.com</span></span><br><span class="line">    <span class="comment"># proxy_port = 8080</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">on_start</span>(<span class="params">self</span>):</span><br><span class="line">        self.client.headers = {</span><br><span class="line">            <span class="string">'Accept'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">            <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>,</span><br><span class="line">            <span class="string">'Authorization'</span>: <span class="string">'TOKEN xxxxxxxxx'</span>,</span><br><span class="line">            <span class="string">'Cookie'</span>: <span class="string">'csrftoken=xxxxxxx'</span></span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line"><span class="meta">    @task</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_card_info</span>(<span class="params">self</span>):</span><br><span class="line">        url = <span class="string">"/api/card_info/?stage=pregnancy&amp;level=user"</span></span><br><span class="line">        response = self.client.get(url=url, name=<span class="string">'get_card_info'</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"status code: {}"</span>.<span class="built_in">format</span>(response.status_code))</span><br><span class="line">        <span class="comment"># print("data: {}".format(response.json()))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># @task</span></span><br><span class="line">    <span class="comment"># def stats(self):</span></span><br><span class="line">    <span class="comment">#     self.client.get("/stats/requests")</span></span><br></pre></td></tr></tbody></table></figure>
<strong>host</strong>参数可以设置测试服务器的地址。<br><strong>wait_time</strong>参数可以设置每个用户实例完成一个task之后，执行下一个task需要的等待时间，<strong>constant</strong>为固定等待时间，<strong>between</strong>为随机等待时间。该参数可以模拟不同用户随机访问的情况。<br><strong>on_start</strong>函数会在测试任务启动时运行一次，通常用户配置一些频繁使用但是测试过程中保持不变的参数变量，例如header。<br><strong>task</strong>decorator用于定义一个具体的测试任务，通常为一个<strong>api</strong>接口的<strong>POST</strong>、<strong>GET</strong>、<strong>DELETE、</strong>等request请求任务，用于用户自定义测试任务。</li>
</ul>
<h3 id="压测"><a href="#压测" class="headerlink" title="压测"></a>压测</h3><p>在<strong>locustfile.py</strong>同目录的<strong>terminal</strong>输入以下指令，即可启动压测。</p>
<figure class="highlight ebnf"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attribute">locust</span></span><br></pre></td></tr></tbody></table></figure>
<p>在浏览器中访问<strong><a href="http://0.0.0.0:8089/">http://0.0.0.0:8089</a></strong>即可开始压测。<br><strong>Number of Users</strong>用于配制压测的最高用户数量，配合<strong>wait_time</strong>即可估算出最高QPS<br>$$qps = \frac{UV}{wait_time}$$<br><strong>Ramp Up</strong>用户每秒钟用户增长的数量，用于测试访问用户不断增长情况下，服务器的性能表现。</p>
</body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Testing Tool</category>
      </categories>
      <tags>
        <tag>Tutorials</tag>
        <tag>Testing Tool</tag>
      </tags>
  </entry>
  <entry>
    <title>Basic Usage of Hexo</title>
    <url>/2019/11/30/Basic-Usage-of-Hexo/</url>
    <content><![CDATA[<html><head></head><body><p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<span id="more"></span>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></tbody></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></tbody></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></tbody></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></tbody></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
<h2 id="Writing"><a href="#Writing" class="headerlink" title="Writing"></a>Writing</h2><p>Basically, <a href="https://hexo.io/">Hexo</a> supports <a href="https://en.wikipedia.org/wiki/Markdown">Markdown</a> and it can automatically compile Markdown to static webpage. </p>
<h3 id="Insert-Images"><a href="#Insert-Images" class="headerlink" title="Insert Images"></a>Insert Images</h3><p>There are multiple ways that can insert images in Markdown, such as using absolute path, relative path, or url path. In Hexo, we can simply put the images we want to inert in <strong>source/images</strong> and insert it using the following command.</p>
<figure class="highlight arcade"><table><tbody><tr><td class="code"><pre><span class="line">![descriptions](<span class="regexp">/images/im</span>age_example.jpg)</span><br></pre></td></tr></tbody></table></figure>
<p>This method is easy to use. However, if we have huge amounts of images in our blog, it would be difficult to efficiently manage them.<br>Luckily, Hexo provides a more organized way to many images on a post-per-post basis. We first turn on this convenient approach by setting the <strong>post_assert_folder</strong> setting in <strong>_config.yml</strong> to true.</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">post_assert_folder:</span> <span class="literal">true</span></span><br></pre></td></tr></tbody></table></figure>
<p>With asset folder management enabled, Hexo will create a folder every time you make a new post with the <strong>hexo new [layout] <title></title></strong> command. This asset folder will have the same name as the markdown file associated with the post. Place all assets related to your post into the associated folder, and you will be able to reference them using a relative path, making for an easier and more convenient workflow. Then we can insert images using the following command.</p>
<figure class="highlight scss"><table><tbody><tr><td class="code"><pre><span class="line">!<span class="selector-attr">[descriptions]</span>(image.jpg)</span><br></pre></td></tr></tbody></table></figure>
<p>More info: <a href="https://hexo.io/docs/asset-folders.html">Assert Folders</a></p>
<h3 id="File-download-links"><a href="#File-download-links" class="headerlink" title="File download links"></a>File download links</h3><p>Similar with inserting images, we can put files we want to share in the same fold and share it using the following markdown command.</p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><span class="line">[Download <span class="built_in">file</span>](<span class="built_in">file</span>.example)</span><br></pre></td></tr></tbody></table></figure></body></html>]]></content>
      <categories>
        <category>Tutorials</category>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>NexT</tag>
        <tag>Markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>Roadmap To Learn Large Language Model Of GPT Series</title>
    <url>/2024/12/21/Roadmap-To-Learn-Large-Language-Model-Of-GPT-Series/</url>
    <content><![CDATA[<html><head></head><body><p>本文主要是OpenAI的GPT系列论文的阅读笔记。</p>
<span id="more"></span>
<h2 id="GPT-1-Improving-Language-Understanding-by-Generative-Pre-Training"><a href="#GPT-1-Improving-Language-Understanding-by-Generative-Pre-Training" class="headerlink" title="GPT-1: Improving Language Understanding by Generative Pre-Training"></a>GPT-1: Improving Language Understanding by Generative Pre-Training</h2><p>GPT-1的论文在2018年6月发布，GPT-1的模型参数量达到了1.17亿，训练数据量达到了40GB，训练成本达到了12.5万美元。</p>
<h2 id="GPT-2-Language-Models-are-Unsupervised-Multitask-Learners"><a href="#GPT-2-Language-Models-are-Unsupervised-Multitask-Learners" class="headerlink" title="GPT-2: Language Models are Unsupervised Multitask Learners"></a>GPT-2: Language Models are Unsupervised Multitask Learners</h2><p>GPT-2的论文在2018年11月发布，GPT-2的模型参数量达到了1.5亿，训练数据量达到了1.5TB，训练成本达到了100万美元。</p>
<h2 id="GPT-3-Language-Models-are-Few-Shot-Learners"><a href="#GPT-3-Language-Models-are-Few-Shot-Learners" class="headerlink" title="GPT-3: Language Models are Few-Shot Learners"></a>GPT-3: Language Models are Few-Shot Learners</h2><p>GPT-3的论文在2021年12月发布，GPT-3的模型参数量达到了1750亿，训练数据量达到了45TB，训练成本达到了1200万美元。GPT-3主要解决的是语言模型中的少样本学习问题。</p>
<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><ul>
<li>In-Context Learning<br>In-Context Learning (ICL)是将预训练模型的文本输入作为一种任务具象化的形式，将自然语言指令或者示例作为条件，然后预测后面输出的文本。</li>
<li>Zero-shot VS. One-shot VS. Few-shot Learning<br>取决于模型推理时输入的示例数量。<br>![In-Context示例数量、模型大小与模型准确度的关系](n-Context Examples – Accuracy.png)<br>从上图可以的出结论：</li>
</ul>
<ol>
<li>模型参数量越大，模型的准确度越高。</li>
<li>不需要梯度训练和微调，仅仅提供更多的In-Context示例，也能显著提升模型的准确度。</li>
<li>模型参数量越大，In-Context示例数量的边际收益越大。</li>
</ol>
<h2 id="GPT-4-GPT-4-Technical-Report"><a href="#GPT-4-GPT-4-Technical-Report" class="headerlink" title="GPT-4: GPT-4 Technical Report"></a>GPT-4: GPT-4 Technical Report</h2></body></html>]]></content>
      <categories>
        <category>Notes</category>
        <category>Deep Learning</category>
        <category>Papers</category>
      </categories>
      <tags>
        <tag>GPT</tag>
        <tag>LLM</tag>
        <tag>NLP</tag>
      </tags>
  </entry>
</search>
